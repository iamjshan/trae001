<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>标准物质管理助手 - Supabase版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <!-- Supabase客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', primaryDark: '#2563eb',
                        success: '#22c55e', danger: '#ef4444',
                        warning: '#f59e0b', info: '#0ea5e9',
                        background: '#f1f5f9', surface: '#ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'PingFang SC', sans-serif; background: #f1f5f9; }
        
        .page { display: none; min-height: 100vh; padding-bottom: 80px; }
        .page.active { display: block; }
        
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }
        
        .content { margin-top: 4.5rem; padding: 1rem; }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .quick-action-btn {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-action-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-item.active { color: #3b82f6; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .nav-item span { font-size: 0.75rem; }
        
        .footer {
            background: white;
            border-top: 1px solid #e2e8f0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 28rem;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #3b82f6;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-normal { background: #dcfce7; color: #166534; }
        .status-warning { background: #fef3c7; color: #92400e; }
        .status-danger { background: #fee2e2; color: #991b1b; }
        .status-info { background: #dbeafe; color: #1e40af; }
        
        .stock-group { border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem; }
        .stock-group-header { background: #f8fafc; padding: 1rem; cursor: pointer; }
        .stock-item { border-bottom: 1px solid #f1f5f9; padding: 1rem; }
        .stock-item:last-child { border-bottom: none; }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .activity-item:last-child { border-bottom: none; }
        
        .message-item {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            background: white;
        }
        
        .message-item:hover { 
            background: #f8fafc; 
            transform: translateX(4px);
        }
        
        .message-item.unread { 
            background: #eff6ff; 
            border-left: 4px solid #3b82f6;
        }
        
        .message-item.read {
            background: white;
            border-left: 4px solid transparent;
            opacity: 0.9;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-sender {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .message-content {
            color: #374151;
            line-height: 1.5;
            word-break: break-word;
        }
        
        .message-to {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #e2e8f0;
        }
        
        .unread-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .personnel-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .personnel-item:last-child { border-bottom: none; }
        
        .record-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .record-item:last-child { border-bottom: none; }
        
        .setting-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .setting-item:last-child { border-bottom: none; }
        
        .login-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            background: #ef4444;
            color: white;
            font-size: 0.625rem;
            min-width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.25rem;
        }
        
        .empty-state { text-align: center; padding: 2rem; color: #9ca3af; }
        
        .image-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 100%; height: 6rem; object-fit: cover; border-radius: 0.375rem; }
        
        .tab-nav { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .tab-nav-item { flex: 1; padding: 0.75rem; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-nav-item.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        
        .record-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .record-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        
        .record-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .record-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.75rem;
        }
        
        .image-viewer-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .image-viewer-modal.show { display: flex; }
        
        .image-viewer-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .image-viewer-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        
        .message-detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .message-detail-modal.show { display: flex; }
        
        .message-detail-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.show { display: flex; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 预警闪烁动画 */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .blink-animation {
            animation: blink 1s ease-in-out infinite;
        }

        /* 消息图标闪烁动画 */
        @keyframes messageBlink {
            0%, 100% { color: #64748b; }
            50% { color: #ef4444; }
        }

        .message-blink {
            animation: messageBlink 1s ease-in-out infinite;
        }

        /* 消息列表样式 */
        .message-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-item:hover {
            background: #f8fafc;
        }

        .message-item.unread {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .message-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            color: #1e293b;
        }

        .message-time {
            font-size: 12px;
            color: #64748b;
        }

        .message-preview {
            font-size: 14px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-item.unread .message-preview {
            color: #1e293b;
            font-weight: 500;
        }

        .unread-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">加载中...</p>
    </div>

    <!-- 登录页面 -->
    <div id="loginPage" class="page active" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%);">
        <div class="login-container">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-cubes text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-500 to-blue-700 bg-clip-text text-transparent">标准物质管理助手</h1>
                <p class="text-gray-500 mt-1">Supabase云端版 v2.0.0</p>
            </div>
            
            <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg mb-4 text-sm"></div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <div class="relative">
                        <input type="email" id="loginEmail" class="form-input pl-10" placeholder="请输入邮箱" required>
                        <i class="fa fa-envelope absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="form-input pl-10 pr-10" placeholder="请输入密码" required>
                        <i class="fa fa-lock absolute left-3 top-3 text-gray-400"></i>
                        <button type="button" onclick="togglePassword()" class="absolute right-3 top-3 text-gray-400">
                            <i class="fa fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="w-4 h-4 text-primary rounded">
                        <span class="ml-2 text-sm text-gray-600">记住我</span>
                    </label>
                </div>
                
                <button type="submit" class="w-full btn btn-primary py-3 text-base">
                    <i class="fa fa-sign-in mr-2"></i>登录
                </button>
            </form>
            
            <button onclick="showRegisterModal()" class="w-full mt-6 btn btn-secondary">
                <i class="fa fa-user-plus mr-2"></i>注册新账户
            </button>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="registerModal" class="modal" onclick="closeModalOnBg(event, 'registerModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">注册新账户</h2>
                <button onclick="closeRegisterModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">邮箱 <span class="text-red-500">*</span></label>
                            <input type="email" name="email" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="password" class="form-input" required minlength="6">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                            <select name="role" class="form-input">
                                <option value="user">普通用户</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeRegisterModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">注册</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="appContainer" style="display: none;">
        <!-- 头部 -->
        <div class="header flex items-center justify-between">
            <h1 id="pageTitle" class="text-xl font-bold flex items-center">
                <i class="fa fa-cubes mr-2"></i>
                <span>标准物质管理</span>
            </h1>
            <div class="flex items-center space-x-4">
                <button onclick="logout()" class="flex items-center p-2">
                    <i class="fa fa-user-circle text-xl mr-1"></i>
                    <span id="currentUserName" class="text-sm">管理员</span>
                </button>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content">
            <!-- 首页 -->
            <div id="dashboardPage" class="page active">
                <!-- 统计卡片 -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="stat-card">
                        <div>
                            <p class="text-sm text-gray-500">总库存</p>
                            <p id="totalStock" class="text-3xl font-bold text-primary">0</p>
                        </div>
                        <div class="stat-icon bg-blue-100">
                            <i class="fa fa-cubes text-primary"></i>
                        </div>
                    </div>
                    <div class="stat-card" onclick="navigateTo('stock')" style="cursor: pointer;">
                        <div>
                            <p id="nearestExpiryName" class="text-sm text-gray-500">近效期预警</p>
                            <p id="expiryWarning" class="text-3xl font-bold text-warning">0</p>
                        </div>
                        <div class="stat-icon bg-yellow-100">
                            <i id="warningTriangleIcon" class="fa fa-exclamation-triangle text-warning"></i>
                        </div>
                    </div>
                </div>

                <!-- 库存状态图表 -->
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-pie-chart text-primary mr-2"></i>
                        库存状态分布
                    </h2>
                    <div class="h-56">
                        <canvas id="stockStatusChart"></canvas>
                    </div>
                </div>

                <!-- 快速操作 -->
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-bolt text-warning mr-2"></i>
                        快速操作
                    </h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="quick-action-btn py-6" onclick="showAddStockModal()">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                                <i class="fa fa-archive text-primary text-2xl"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">入库登记</span>
                            <span class="text-xs text-gray-400 mt-1">新增标准物质</span>
                        </div>
                        <div class="quick-action-btn py-6" onclick="showScanModal()">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-3">
                                <i class="fa fa-qrcode text-success text-2xl"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">扫码查询</span>
                            <span class="text-xs text-gray-400 mt-1">扫描/查询出库</span>
                        </div>
                    </div>
                </div>

                <!-- 最近活动 -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-clock-o text-info mr-2"></i>
                            最近活动
                        </h2>
                        <button onclick="switchPage('records')" class="text-primary text-sm hover:underline">查看全部</button>
                    </div>
                    <div id="recentActivities">
                        <div class="empty-state">
                            <i class="fa fa-inbox text-4xl mb-2"></i>
                            <p>暂无活动记录</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 库存页面 -->
            <div id="stockPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="stockSearchInput" placeholder="搜索标准物质..." class="form-input pl-10" oninput="renderStockList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="tab-nav">
                    <div class="tab-nav-item active" onclick="switchStockTab('all', this)">全部</div>
                    <div class="tab-nav-item" onclick="switchStockTab('normal', this)">正常</div>
                    <div class="tab-nav-item" onclick="switchStockTab('warning', this)">临期</div>
                    <div class="tab-nav-item" onclick="switchStockTab('expired', this)">过期</div>
                </div>

                <div id="stockList">
                    <div class="empty-state">
                        <i class="fa fa-inbox text-4xl mb-2"></i>
                        <p>暂无库存数据</p>
                    </div>
                </div>
            </div>

            <!-- 消息页面 -->
            <div id="messagesPage" class="page">
                <div class="card mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold">消息中心</h2>
                        <button onclick="showSendMessageModal()" class="btn btn-primary btn-sm">
                            <i class="fa fa-plus mr-1"></i>发消息
                        </button>
                    </div>
                </div>

                <div class="tab-nav mb-4">
                    <div class="tab-nav-item active" onclick="switchMessageTab('received', this)">收到的消息</div>
                    <div class="tab-nav-item" onclick="switchMessageTab('sent', this)">发送的消息</div>
                </div>

                <div id="messagesList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-comments text-4xl mb-2"></i>
                        <p>暂无消息</p>
                    </div>
                </div>
            </div>

            <!-- 人员页面 -->
            <div id="personnelPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="personnelSearchInput" placeholder="搜索人员..." class="form-input pl-10" oninput="renderPersonnelList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">人员列表</h2>
                    <button onclick="showAddPersonnelModal()" class="btn btn-primary">
                        <i class="fa fa-plus mr-1"></i>添加
                    </button>
                </div>

                <div id="personnelList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-users text-4xl mb-2"></i>
                        <p>暂无人员数据</p>
                    </div>
                </div>
            </div>

            <!-- 记录页面 -->
            <div id="recordsPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="recordsSearchInput" placeholder="搜索记录..." class="form-input pl-10" oninput="renderRecordsList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div id="recordsList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-history text-4xl mb-2"></i>
                        <p>暂无操作记录</p>
                    </div>
                </div>
            </div>

            <!-- 设置页面 -->
            <div id="settingsPage" class="page">
                <div class="card mb-4">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-primary text-white rounded-full flex items-center justify-center text-2xl font-bold mr-4">
                            <span id="settingUserInitial">管</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="settingUserName">管理员</h2>
                            <p class="text-sm text-gray-500" id="settingUserRole">系统管理员</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="setting-item" onclick="showChangePasswordModal()">
                        <div class="flex items-center">
                            <i class="fa fa-lock text-primary mr-3"></i>
                            <span>修改密码</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="exportData()">
                        <div class="flex items-center">
                            <i class="fa fa-download text-success mr-3"></i>
                            <span>数据导出(Excel)</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="importData()">
                        <div class="flex items-center">
                            <i class="fa fa-upload text-primary mr-3"></i>
                            <span>数据导入(Excel)</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="toggleOfflineMode()">
                        <div class="flex items-center">
                            <i class="fa fa-wifi text-warning mr-3"></i>
                            <span>切换离线模式</span>
                        </div>
                        <span id="offlineStatus" class="text-sm text-gray-500">当前: 在线</span>
                    </div>
                    <div class="setting-item" onclick="clearAllData()">
                        <div class="flex items-center">
                            <i class="fa fa-trash text-danger mr-3"></i>
                            <span>清空数据</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item">
                        <div class="flex items-center">
                            <i class="fa fa-info-circle text-info mr-3"></i>
                            <span>关于系统</span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">v2.0.0 Supabase版</span>
                            <i class="fa fa-chevron-right text-gray-400 ml-2"></i>
                        </div>
                    </div>
                </div>

                <button onclick="logout()" class="w-full bg-white text-danger font-semibold py-3 rounded-lg mt-6 border border-gray-200">
                    <i class="fa fa-sign-out mr-2"></i>退出登录
                </button>
            </div>
        </div>

        <!-- 底部导航 -->
        <div class="footer">
            <div class="flex justify-around">
                <div class="nav-item active" onclick="switchPage('dashboard')">
                    <i class="fa fa-home"></i>
                    <span>首页</span>
                </div>
                <div class="nav-item" onclick="switchPage('stock')">
                    <i class="fa fa-cubes"></i>
                    <span>库存</span>
                </div>
                <div class="nav-item relative" onclick="switchPage('messages')">
                    <i class="fa fa-comments" id="messageNavIcon"></i>
                    <span>消息</span>
                    <span id="unreadBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </div>
                <div class="nav-item" onclick="switchPage('personnel')">
                    <i class="fa fa-users"></i>
                    <span>人员</span>
                </div>
                <div class="nav-item" onclick="switchPage('settings')">
                    <i class="fa fa-cog"></i>
                    <span>设置</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div id="scanModal" class="modal" onclick="closeModalOnBg(event, 'scanModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">扫码查询</h2>
                <button onclick="closeScanModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- 摄像头扫描区域 -->
                <div id="cameraScanArea" class="mb-4">
                    <div class="relative bg-black rounded-lg overflow-hidden" style="height: 250px;">
                        <video id="scanVideo" class="w-full h-full object-cover" playsinline></video>
                        <canvas id="scanCanvas" class="hidden"></canvas>
                        <div id="scanOverlay" class="absolute inset-0 flex items-center justify-center">
                            <div class="border-2 border-white/50 rounded-lg w-48 h-48 relative">
                                <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-primary -mt-1 -ml-1"></div>
                                <div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-primary -mt-1 -mr-1"></div>
                                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-primary -mb-1 -ml-1"></div>
                                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-primary -mb-1 -mr-1"></div>
                                <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-primary/50 animate-pulse"></div>
                            </div>
                        </div>
                        <div id="scanLoading" class="absolute inset-0 bg-black/80 flex items-center justify-center hidden">
                            <div class="text-white text-center">
                                <i class="fa fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>正在启动摄像头...</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="startCameraScan()" class="btn btn-primary flex-1">
                            <i class="fa fa-camera mr-1"></i>开始扫描
                        </button>
                        <button onclick="stopCameraScan()" class="btn btn-secondary flex-1">
                            <i class="fa fa-stop mr-1"></i>停止
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">将二维码对准扫描框即可自动识别</p>
                </div>
                
                <!-- 手动输入区域 -->
                <div class="border-t border-gray-200 pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">或手动输入唯一标识</label>
                    <div class="flex gap-2">
                        <input type="text" id="scanInput" class="form-input flex-1" placeholder="请输入唯一标识码" autofocus>
                        <button onclick="handleScan()" class="btn btn-primary">
                            <i class="fa fa-search mr-1"></i>查询
                        </button>
                    </div>
                </div>
                
                <div id="scanResult" class="hidden mt-4">
                    <!-- 扫描结果将显示在这里 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 二维码显示弹窗 -->
    <div id="qrCodeModal" class="modal" onclick="closeModalOnBg(event, 'qrCodeModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">物品二维码</h2>
                <button onclick="closeQRCodeModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 text-center">
                <div id="qrCodeContainer" class="mb-4 flex justify-center">
                    <!-- 二维码将显示在这里 -->
                </div>
                <div class="text-left bg-gray-50 p-3 rounded-lg mb-4">
                    <p class="text-sm"><span class="text-gray-500">名称：</span><span id="qrItemName" class="font-medium"></span></p>
                    <p class="text-sm"><span class="text-gray-500">唯一标识：</span><span id="qrItemUniqueId" class="font-medium"></span></p>
                </div>
                <p class="text-xs text-gray-400 mb-4">使用扫码功能扫描此二维码可快速出库</p>
                <!-- 打印按钮 -->
                <div class="flex gap-2 justify-center">
                    <button onclick="printLabelWithWeida()" class="btn btn-primary">
                        <i class="fa fa-print mr-1"></i>打印标签 (40×30mm)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="addStockModal" class="modal" onclick="closeModalOnBg(event, 'addStockModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">入库登记</h2>
                <button onclick="closeAddStockModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="addStockForm" onsubmit="handleStockIn(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准物质名称 <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准物质编号 <span class="text-red-500">*</span></label>
                            <input type="text" name="code" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">批次号</label>
                            <input type="text" name="batchNumber" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">唯一性标识方式</label>
                            <div class="flex space-x-4 mb-2">
                                <label class="flex items-center">
                                    <input type="radio" name="uniqueIdType" value="auto" checked class="mr-2" onchange="toggleUniqueIdInput()">
                                    <span>自动生成</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="uniqueIdType" value="manual" class="mr-2" onchange="toggleUniqueIdInput()">
                                    <span>手动输入</span>
                                </label>
                            </div>
                            <input type="text" name="uniqueId" id="manualUniqueId" class="form-input hidden" placeholder="请输入唯一性标识">
                        </div>
                        <!-- 混标组分表格 -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">组分信息（单标/混标）</label>
                                <button type="button" onclick="addComponentRow()" class="text-xs text-primary hover:text-blue-700">
                                    <i class="fa fa-plus mr-1"></i>添加组分
                                </button>
                            </div>
                            <div id="componentsContainer" class="space-y-2">
                                <!-- 表头 -->
                                <div class="grid grid-cols-12 gap-2 text-xs text-gray-500 text-center">
                                    <div class="col-span-3">组分名称</div>
                                    <div class="col-span-3">标准值</div>
                                    <div class="col-span-3">单位</div>
                                    <div class="col-span-2">不确定度</div>
                                    <div class="col-span-1"></div>
                                </div>
                                <!-- 默认第一行 -->
                                <div class="component-row grid grid-cols-12 gap-2">
                                    <div class="col-span-3">
                                        <input type="text" name="componentName[]" class="form-input text-sm py-1" placeholder="如：铜">
                                    </div>
                                    <div class="col-span-3">
                                        <input type="text" name="componentValue[]" class="form-input text-sm py-1" placeholder="如：100">
                                    </div>
                                    <div class="col-span-3">
                                        <input type="text" name="componentUnit[]" class="form-input text-sm py-1" placeholder="如：μg/mL">
                                    </div>
                                    <div class="col-span-2">
                                        <input type="text" name="componentUncertainty[]" class="form-input text-sm py-1" placeholder="如：0.5%">
                                    </div>
                                    <div class="col-span-1 flex items-center justify-center">
                                        <button type="button" onclick="removeComponentRow(this)" class="text-red-500 hover:text-red-700 hidden">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" name="manufacturer" class="form-input">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">保存条件</label>
                                <input type="text" name="storageCondition" class="form-input" placeholder="如：2-8℃冷藏">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">稀释条件</label>
                                <input type="text" name="dilutionCondition" class="form-input" placeholder="如：使用前用纯水稀释">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">数量 <span class="text-red-500">*</span></label>
                                <input type="number" name="quantity" class="form-input" min="1" value="1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">有效期 <span class="text-red-500">*</span></label>
                                <input type="date" name="expiryDate" class="form-input" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">图片/PDF上传</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary" onclick="document.getElementById('stockImages').click()">
                                <input type="file" id="stockImages" multiple accept="image/*,.pdf" class="hidden" onchange="handleStockImagesWithPDF(this, 'stockImagePreview', 'stockUploadPlaceholder')">
                                <div id="stockImagePreview" class="image-preview-grid mb-2 hidden"></div>
                                <div id="stockUploadPlaceholder">
                                    <i class="fa fa-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-sm">点击上传图片或PDF（最多3张）</p>
                                    <p class="text-xs text-gray-400">支持 JPG, PNG, PDF 格式</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddStockModal()" class="btn btn-secondary">取消</button>
                        <button type="button" onclick="showAIRecognizeModal()" class="btn btn-success">
                            <i class="fa fa-magic mr-1"></i>AI识别
                        </button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI识别模态框 -->
    <div id="aiRecognizeModal" class="modal" onclick="closeModalOnBg(event, 'aiRecognizeModal')">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="text-lg font-bold">
                    <i class="fa fa-magic mr-2"></i>AI智能识别
                </h2>
                <button onclick="closeAIRecognizeModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- 步骤1：上传 -->
                <div id="aiStep1" class="text-center">
                    <!-- 图片预览区域 -->
                    <div class="mb-4">
                        <div id="aiPreviewContainer" class="grid grid-cols-2 gap-2 hidden">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-2">
                                <img id="aiPreviewImg1" class="max-h-32 mx-auto">
                                <p class="text-xs text-gray-500 mt-1">图片1</p>
                            </div>
                            <div id="aiPreview2Container" class="border-2 border-dashed border-gray-300 rounded-lg p-2 hidden">
                                <img id="aiPreviewImg2" class="max-h-32 mx-auto">
                                <p class="text-xs text-gray-500 mt-1">图片2</p>
                            </div>
                        </div>
                        <div id="aiPlaceholder" class="border-2 border-dashed border-gray-300 rounded-lg p-8">
                            <i class="fa fa-file-image-o text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-500">上传图片或PDF文件</p>
                            <p class="text-xs text-gray-400 mt-1">支持 JPG, PNG, PDF 格式</p>
                            <p class="text-xs text-gray-400">最多2张图片或1个PDF</p>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex justify-center gap-3 flex-wrap">
                        <button type="button" onclick="document.getElementById('aiFileInput').click()" class="btn btn-primary">
                            <i class="fa fa-upload mr-1"></i>选择图片/PDF
                        </button>
                        <button type="button" onclick="startAICamera()" class="btn btn-info">
                            <i class="fa fa-camera mr-1"></i>拍照
                        </button>
                        <button type="button" id="aiAddPhotoBtn" onclick="startAICamera()" class="btn btn-warning hidden">
                            <i class="fa fa-plus mr-1"></i>再拍一张
                        </button>
                    </div>
                    
                    <input type="file" id="aiFileInput" accept="image/*,.pdf" class="hidden" onchange="handleAIFileSelect(event)">
                    <video id="aiVideo" class="w-full rounded-lg hidden" autoplay playsinline></video>
                    <canvas id="aiCanvas" class="hidden"></canvas>
                    <div id="aiCameraControls" class="hidden mt-3">
                        <button type="button" onclick="captureAIPhoto()" class="btn btn-success">
                            <i class="fa fa-camera mr-1"></i>拍照
                        </button>
                        <button type="button" onclick="stopAICamera()" class="btn btn-secondary ml-2">
                            取消
                        </button>
                    </div>
                </div>

                <!-- 步骤2：识别中 -->
                <div id="aiStep2" class="hidden text-center py-8">
                    <div class="spinner mb-4"></div>
                    <p class="text-gray-600" id="aiStatus">正在AI识别...</p>
                </div>

                <!-- 步骤3：结果预览 -->
                <div id="aiStep3" class="hidden">
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg max-h-60 overflow-y-auto">
                        <h4 class="font-semibold mb-2 text-sm text-gray-700">识别结果：</h4>
                        <div id="aiResultPreview" class="text-sm space-y-1"></div>
                    </div>
                    <div class="flex justify-between gap-3">
                        <button type="button" onclick="backToAIStep1()" class="btn btn-secondary flex-1">
                            <i class="fa fa-refresh mr-1"></i>重新上传
                        </button>
                        <button type="button" onclick="applyAIResult()" class="btn btn-primary flex-1">
                            <i class="fa fa-check mr-1"></i>填入表单
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="outStockModal" class="modal" onclick="closeModalOnBg(event, 'outStockModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">出库登记</h2>
                <button onclick="closeOutStockModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="outStockForm" onsubmit="handleStockOut(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">选择标准物质 <span class="text-red-500">*</span></label>
                            <select name="stockId" id="outStockSelect" class="form-input" required>
                                <option value="">请选择</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">出库用途</label>
                            <input type="text" name="purpose" class="form-input" placeholder="请输入出库用途">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">图片/PDF上传</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary" onclick="document.getElementById('outStockImages').click()">
                                <input type="file" id="outStockImages" multiple accept="image/*,.pdf" class="hidden" onchange="handleStockImagesWithPDF(this, 'outStockImagePreview', 'outStockUploadPlaceholder')">
                                <div id="outStockImagePreview" class="image-preview-grid mb-2 hidden"></div>
                                <div id="outStockUploadPlaceholder">
                                    <i class="fa fa-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-sm">点击上传图片或PDF（最多3张）</p>
                                    <p class="text-xs text-gray-400">支持 JPG, PNG, PDF 格式</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeOutStockModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-warning">确认出库</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 发送消息模态框 -->
    <div id="sendMessageModal" class="modal" onclick="closeModalOnBg(event, 'sendMessageModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">发送消息</h2>
                <button onclick="closeSendMessageModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="sendMessageForm" onsubmit="handleSendMessage(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">发送给 <span class="text-red-500">*</span></label>
                            <select id="messageRecipient" name="recipient_id" class="form-input" required>
                                <option value="">选择接收人</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">消息内容 <span class="text-red-500">*</span></label>
                            <textarea id="messageContent" name="content" class="form-input" rows="4" placeholder="请输入消息内容..." required></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeSendMessageModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">发送</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 查看消息详情模态框 -->
    <div id="messageDetailModal" class="modal" onclick="closeModalOnBg(event, 'messageDetailModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">消息详情</h2>
                <button onclick="closeMessageDetailModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <div id="messageDetailContent" class="space-y-4">
                    <!-- 动态填充 -->
                </div>
                <div id="messageReplySection" class="mt-4 pt-4 border-t border-gray-200">
                    <textarea id="replyContent" class="form-input" rows="3" placeholder="回复消息..."></textarea>
                    <div class="flex justify-end mt-3">
                        <button onclick="sendReply()" class="btn btn-primary">回复</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addPersonnelModal" class="modal" onclick="closeModalOnBg(event, 'addPersonnelModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">添加人员</h2>
                <button onclick="closeAddPersonnelModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="addPersonnelForm" onsubmit="handleAddPersonnel(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">邮箱 <span class="text-red-500">*</span></label>
                            <input type="email" name="email" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="password" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">角色 <span class="text-red-500">*</span></label>
                            <select name="role" class="form-input" required>
                                <option value="admin">管理员</option>
                                <option value="user">普通用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddPersonnelModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal" onclick="closeModalOnBg(event, 'changePasswordModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">修改密码</h2>
                <button onclick="closeChangePasswordModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">新密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="newPassword" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">确认新密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="confirmPassword" class="form-input" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeChangePasswordModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="viewDetailModal" class="modal" onclick="closeModalOnBg(event, 'viewDetailModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">标准物质详情</h2>
                <button onclick="closeViewDetailModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="viewDetailContent" class="p-4"></div>
        </div>
    </div>

    <div id="imageViewerModal" class="image-viewer-modal" onclick="closeImageViewer()">
        <div class="image-viewer-content text-center">
            <button onclick="closeImageViewer()" class="absolute top-4 right-4 text-white text-2xl">
                <i class="fa fa-times"></i>
            </button>
            <img id="viewerImage" src="" alt="查看图片">
            <p id="viewerCaption" class="text-white mt-4"></p>
        </div>
    </div>

    <script>
        // 设置PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
        
        // ==================== Supabase配置 ====================
        const SUPABASE_URL = 'https://ljshpxahaxemssxdtjtv.supabase.co'
        const SUPABASE_ANON_KEY = 'sb_publishable_7D5tnogliJUvQ_Pp2ASMwQ__RmVrE-T'
        
        // 初始化Supabase客户端
        let supabaseClient = null
        let currentUser = null
        let isOfflineMode = false
        
        // ==================== 数据缓存 ====================
        const DataCache = {
            stock: null,
            records: null,
            personnel: null,
            lastUpdate: 0,
            CACHE_DURATION: 300000, // 缓存5分钟
            
            get(key) {
                if (Date.now() - this.lastUpdate > this.CACHE_DURATION) {
                    this.clear()
                    return null
                }
                return this[key]
            },
            
            set(key, value) {
                this[key] = value
                this.lastUpdate = Date.now()
            },
            
            clear() {
                this.stock = null
                this.records = null
                this.personnel = null
                this.lastUpdate = 0
            }
        }
        
        // ==================== IndexedDB 存储（用于大数据）====================
        const DB_NAME = 'SRM_DB'
        const DB_VERSION = 1
        let db = null
        
        // 初始化 IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION)
                
                request.onerror = () => reject(request.error)
                request.onsuccess = () => {
                    db = request.result
                    resolve(db)
                }
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result
                    // 创建对象存储
                    if (!db.objectStoreNames.contains('stock')) {
                        db.createObjectStore('stock', { keyPath: 'key' })
                    }
                    if (!db.objectStoreNames.contains('records')) {
                        db.createObjectStore('records', { keyPath: 'key' })
                    }
                    if (!db.objectStoreNames.contains('personnel')) {
                        db.createObjectStore('personnel', { keyPath: 'key' })
                    }
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' })
                    }
                }
            })
        }
        
        // IndexedDB 操作
        const IndexedDB = {
            async get(storeName, key) {
                if (!db) await initIndexedDB()
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly')
                    const store = transaction.objectStore(storeName)
                    const request = store.get(key)
                    
                    request.onsuccess = () => {
                        const result = request.result
                        resolve(result ? result.value : null)
                    }
                    request.onerror = () => reject(request.error)
                })
            },
            
            async set(storeName, key, value) {
                if (!db) await initIndexedDB()
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite')
                    const store = transaction.objectStore(storeName)
                    const request = store.put({ key, value })
                    
                    request.onsuccess = () => resolve()
                    request.onerror = () => reject(request.error)
                })
            },
            
            async remove(storeName, key) {
                if (!db) await initIndexedDB()
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite')
                    const store = transaction.objectStore(storeName)
                    const request = store.delete(key)
                    
                    request.onsuccess = () => resolve()
                    request.onerror = () => reject(request.error)
                })
            }
        }
        
        // ==================== 离线模式存储 ====================
        // 小数据用 localStorage，大数据用 IndexedDB
        const LocalStorage = {
            get(key) {
                const data = localStorage.getItem('srm_' + key)
                return data ? JSON.parse(data) : null
            },
            set(key, value) {
                localStorage.setItem('srm_' + key, JSON.stringify(value))
            },
            remove(key) {
                localStorage.removeItem('srm_' + key)
            }
        }
        
        // 大数据存储（自动选择 IndexedDB 或 localStorage）
        const DataStorage = {
            async get(key) {
                // 优先从 IndexedDB 读取
                try {
                    const data = await IndexedDB.get('metadata', key)
                    if (data !== null) return data
                } catch (e) {
                    console.warn('IndexedDB读取失败，回退到localStorage:', e)
                }
                // 回退到 localStorage
                return LocalStorage.get(key)
            },
            
            async set(key, value) {
                // 尝试保存到 IndexedDB
                try {
                    await IndexedDB.set('metadata', key, value)
                    return
                } catch (e) {
                    console.warn('IndexedDB保存失败，回退到localStorage:', e)
                }
                // 回退到 localStorage
                try {
                    LocalStorage.set(key, value)
                } catch (e) {
                    console.error('保存失败，数据可能太大:', e)
                    throw e
                }
            },
            
            async remove(key) {
                try {
                    await IndexedDB.remove('metadata', key)
                } catch (e) {}
                LocalStorage.remove(key)
            }
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 首先检查URL参数（微信扫码进入）
                const urlParams = new URLSearchParams(window.location.search)
                const scanId = urlParams.get('id')
                const scanUniqueId = urlParams.get('uniqueId')

                if (scanId || scanUniqueId) {
                    // 微信扫码进入，显示物品详情
                    handleScanFromQRCode(urlParams)
                    return  // 不继续初始化应用
                }

                // 检查离线模式设置
                isOfflineMode = LocalStorage.get('offlineMode') || false

                // 更新离线模式状态显示（如果存在）
                const offlineStatus = document.getElementById('offlineStatus')
                if (offlineStatus) {
                    offlineStatus.textContent = isOfflineMode ? '当前: 离线' : '当前: 在线'
                }

                if (!isOfflineMode) {
                    // 初始化Supabase
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: false
                        }
                    })

                    // 检查登录状态
                    const { data: { session } } = await supabaseClient.auth.getSession()
                    if (session) {
                        await loadUserProfile(session.user)
                        showApp()
                    }
                } else {
                    // 离线模式：检查本地登录
                    const offlineUser = LocalStorage.get('currentUser')
                    if (offlineUser) {
                        currentUser = offlineUser
                        showApp()
                    }
                }
            } catch (error) {
                console.error('初始化失败:', error)
                // 如果Supabase初始化失败，显示错误但不自动切换
                const errorMsg = error.message || '未知错误'
                if (errorMsg.includes('Failed to fetch')) {
                    alert('无法连接到服务器，请检查网络连接。您可以切换到离线模式继续使用。')
                } else {
                    alert('初始化失败: ' + errorMsg)
                }
            }
        })

        // ==================== 微信扫码查看功能 ====================
        // 处理从二维码扫码进入的页面
        async function handleScanFromQRCode(urlParams) {
            // 隐藏登录页面，显示扫码结果页面
            document.getElementById('loginPage').style.display = 'none'
            document.getElementById('appContainer').style.display = 'none'

            // 创建扫码结果展示页面
            const scanResultHtml = `
                <div id="scanResultPage" class="min-h-screen bg-gray-100 p-4">
                    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-primary text-white p-4 text-center">
                            <h1 class="text-xl font-bold">标准物质信息</h1>
                        </div>
                        <div class="p-4" id="scanItemDetails">
                            <div class="text-center py-8">
                                <i class="fa fa-spinner fa-spin text-3xl text-primary"></i>
                                <p class="mt-2 text-gray-500">正在加载信息...</p>
                            </div>
                        </div>
                        <div class="p-4 border-t">
                            <button onclick="window.location.href=window.location.pathname" class="w-full btn btn-primary">
                                <i class="fa fa-home mr-1"></i>返回首页
                            </button>
                        </div>
                    </div>
                </div>
            `
            document.body.insertAdjacentHTML('beforeend', scanResultHtml)

            // 从URL参数获取信息
            const itemInfo = {
                id: urlParams.get('id'),
                uniqueId: urlParams.get('uniqueId'),
                name: urlParams.get('name'),
                code: urlParams.get('code'),
                batch: urlParams.get('batch'),
                mfg: urlParams.get('mfg'),
                exp: urlParams.get('exp'),
                comp: urlParams.get('comp')
            }

            // 如果有ID，尝试从数据库获取完整信息
            if (itemInfo.id && !isOfflineMode) {
                try {
                    const { data, error } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', itemInfo.id)
                        .single()

                    if (data && !error) {
                        // 使用数据库中的完整信息
                        displayScanResult(data)
                        return
                    }
                } catch (e) {
                    console.warn('无法从数据库获取信息，使用URL参数:', e)
                }
            }

            // 使用URL参数中的信息
            displayScanResultFromParams(itemInfo)
        }

        // 从URL参数显示扫码结果
        function displayScanResultFromParams(info) {
            const container = document.getElementById('scanItemDetails')

            // 解析组分信息
            let componentsHtml = ''
            if (info.comp) {
                const comps = info.comp.split(',').map(c => {
                    const parts = c.split(':')
                    return { name: parts[0] || '', value: parts[1] || '' }
                })
                componentsHtml = `
                    <div class="mt-4">
                        <h3 class="font-semibold text-gray-700 mb-2">组分信息</h3>
                        <div class="bg-gray-50 rounded p-2">
                            ${comps.map(c => `
                                <div class="flex justify-between py-1 border-b border-gray-200 last:border-0">
                                    <span class="text-gray-600">${c.name}</span>
                                    <span class="font-medium">${c.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
            }

            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">名称</span>
                        <span class="font-medium text-right">${decodeURIComponent(info.name || 'N/A')}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">编号</span>
                        <span class="font-medium">${info.code || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">批次号</span>
                        <span class="font-medium">${info.batch || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">唯一标识</span>
                        <span class="font-medium text-primary">${info.uniqueId || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">生产厂家</span>
                        <span class="font-medium">${decodeURIComponent(info.mfg || 'N/A')}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">有效期</span>
                        <span class="font-medium">${info.exp || 'N/A'}</span>
                    </div>
                    ${componentsHtml}
                </div>
            `
        }

        // 从数据库数据显示扫码结果
        function displayScanResult(item) {
            const container = document.getElementById('scanItemDetails')

            // 计算状态
            const currentStatus = calculateItemStatus(item.expiry_date || item.expiryDate)
            const statusText = {
                normal: '正常',
                warning: '临期',
                expired: '过期'
            }[currentStatus]
            const statusColor = {
                normal: 'text-green-600',
                warning: 'text-yellow-600',
                expired: 'text-red-600'
            }[currentStatus]

            // 渲染组分信息
            let componentsHtml = ''
            if (item.components && item.components.length > 0) {
                componentsHtml = `
                    <div class="mt-4">
                        <h3 class="font-semibold text-gray-700 mb-2">组分信息</h3>
                        <div class="bg-gray-50 rounded p-2">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-gray-600 border-b">
                                        <th class="text-left py-1">组分</th>
                                        <th class="text-left py-1">标准值</th>
                                        <th class="text-left py-1">单位</th>
                                        <th class="text-left py-1">不确定度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${item.components.map(c => `
                                        <tr class="border-b border-gray-100 last:border-0">
                                            <td class="py-1">${c.name || '-'}</td>
                                            <td class="py-1">${c.value || '-'}</td>
                                            <td class="py-1">${c.unit || '-'}</td>
                                            <td class="py-1">${c.uncertainty || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `
            }

            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">名称</span>
                        <span class="font-medium text-right">${item.name}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">编号</span>
                        <span class="font-medium">${item.code || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">批次号</span>
                        <span class="font-medium">${item.batch_number || item.batchNumber || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">唯一标识</span>
                        <span class="font-medium text-primary">${item.unique_id || item.uniqueId}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">生产厂家</span>
                        <span class="font-medium">${item.manufacturer || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">有效期</span>
                        <span class="font-medium">${item.expiry_date || item.expiryDate || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">状态</span>
                        <span class="font-medium ${statusColor}">${statusText}</span>
                    </div>
                    ${componentsHtml}
                </div>
            `
        }

        // ==================== 认证功能 ====================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault()
            showLoading(true)
            
            const email = document.getElementById('loginEmail').value
            const password = document.getElementById('loginPassword').value
            
            try {
                if (isOfflineMode || !supabaseClient) {
                    // 离线模式验证
                    const personnel = LocalStorage.get('personnel') || []
                    const user = personnel.find(p => p.username === email && p.password === password)
                    if (user) {
                        currentUser = user
                        LocalStorage.set('currentUser', user)
                        showApp()
                    } else {
                        throw new Error('用户名或密码错误')
                    }
                } else {
                    // 在线模式使用Supabase Auth
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    })
                    
                    if (error) throw error
                    
                    await loadUserProfile(data.user)
                    showApp()
                }
            } catch (error) {
                console.error('登录错误:', error)
                let errorMsg = error.message
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = '网络连接失败，请检查网络或切换到离线模式'
                } else if (error.message.includes('Invalid login')) {
                    errorMsg = '邮箱或密码错误'
                } else if (error.message.includes('Email not confirmed')) {
                    errorMsg = '邮箱未验证，请检查邮件'
                }
                showLoginError(errorMsg)
            } finally {
                showLoading(false)
            }
        })

        async function loadUserProfile(user) {
            if (isOfflineMode) return
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single()
                
                if (error) {
                    console.warn('获取用户资料失败:', error)
                    // 如果没有profile，使用基本用户信息
                    currentUser = {
                        id: user.id,
                        email: user.email,
                        name: user.user_metadata?.name || user.email,
                        role: 'user'
                    }
                } else {
                    currentUser = {
                        id: user.id,
                        email: user.email,
                        ...profile
                    }
                }
            } catch (error) {
                console.error('加载用户资料失败:', error)
                // 使用基本用户信息
                currentUser = {
                    id: user.id,
                    email: user.email,
                    name: user.user_metadata?.name || user.email,
                    role: 'user'
                }
            }
        }

        async function handleRegister(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            }
            
            try {
                if (isOfflineMode) {
                    // 离线模式注册
                    const personnel = LocalStorage.get('personnel') || []
                    if (personnel.some(p => p.username === userData.email)) {
                        throw new Error('邮箱已存在')
                    }
                    
                    const newUser = {
                        id: Date.now().toString(),
                        name: userData.name,
                        username: userData.email,
                        password: userData.password,
                        role: userData.role
                    }
                    
                    personnel.push(newUser)
                    LocalStorage.set('personnel', personnel)
                    
                    alert('注册成功！请登录')
                    closeRegisterModal()
                } else {
                    // 在线模式使用Supabase Auth
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: userData.email,
                        password: userData.password,
                        options: {
                            data: {
                                name: userData.name,
                                role: userData.role
                            }
                        }
                    })
                    
                    if (error) throw error
                    
                    alert('注册成功！请检查邮箱验证邮件')
                    closeRegisterModal()
                }
            } catch (error) {
                alert('注册失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        function togglePassword() {
            const input = document.getElementById('loginPassword')
            const icon = document.getElementById('passwordToggleIcon')
            if (input.type === 'password') {
                input.type = 'text'
                icon.className = 'fa fa-eye-slash'
            } else {
                input.type = 'password'
                icon.className = 'fa fa-eye'
            }
        }

        function showLoginError(msg) {
            const error = document.getElementById('loginError')
            error.textContent = msg
            error.classList.remove('hidden')
            setTimeout(() => error.classList.add('hidden'), 3000)
        }

        async function logout() {
            if (!confirm('确定要退出登录吗？')) return
            
            if (!isOfflineMode && supabaseClient) {
                await supabaseClient.auth.signOut()
            }
            
            currentUser = null
            LocalStorage.remove('currentUser')
            document.getElementById('appContainer').style.display = 'none'
            document.getElementById('loginPage').style.display = 'flex'
            document.getElementById('loginPage').classList.add('active')
            document.getElementById('loginForm').reset()

            // 停止消息轮询
            stopMessagePolling()
        }

        // ==================== 页面切换 ====================
        function showApp() {
            try {
                document.getElementById('loginPage').classList.remove('active')
                document.getElementById('loginPage').style.display = 'none'
                document.getElementById('appContainer').style.display = 'block'
                
                // 更新用户信息
                document.getElementById('currentUserName').textContent = currentUser?.name || '用户'
                document.getElementById('settingUserName').textContent = currentUser?.name || '用户'
                document.getElementById('settingUserRole').textContent = currentUser?.role === 'admin' ? '系统管理员' : '普通用户'
                document.getElementById('settingUserInitial').textContent = (currentUser?.name || '用').charAt(0)
                
                // 初始化图表
                initChart()
                
                // 刷新数据
                refreshAllData()
                
                // 设置实时订阅
                if (!isOfflineMode && supabaseClient) {
                    setupRealtimeSubscriptions()
                }

                // 启动消息轮询
                startMessagePolling()
            } catch (error) {
                console.error('showApp错误:', error)
                alert('页面加载出错: ' + error.message)
            }
        }

        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active')
                p.style.display = 'none'
            })
            
            const targetPage = document.getElementById(page + 'Page')
            if (targetPage) {
                targetPage.classList.add('active')
                targetPage.style.display = 'block'
            }
            
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active')
                const pages = ['dashboard', 'stock', 'messages', 'personnel', 'settings']
                if (pages[index] === page) {
                    item.classList.add('active')
                }
            })
            
            const titles = {
                dashboard: '标准物质管理',
                stock: '库存管理',
                messages: '消息中心',
                personnel: '人员管理',
                records: '操作记录',
                settings: '系统设置'
            }
            document.querySelector('#pageTitle span').textContent = titles[page] || '标准物质管理'
            
            // 使用全局数据渲染页面，避免重复查询
            if (page === 'dashboard') {
                if (globalStockData !== null && globalRecordsData !== null) {
                    updateDashboardWithData(globalStockData, globalRecordsData)
                } else {
                    refreshDashboard()
                }
            }
            if (page === 'stock') {
                console.log('切换到库存页面, globalStockData:', globalStockData ? globalStockData.length : 0, '条')
                // 强制重新获取数据，确保状态计算正确
                renderStockList()
            }
            if (page === 'personnel') {
                if (globalPersonnelData !== null) {
                    renderPersonnelListWithData(globalPersonnelData)
                } else {
                    renderPersonnelList()
                }
            }
            if (page === 'records') {
                if (globalRecordsData !== null) {
                    renderRecordsListWithData(globalRecordsData)
                } else {
                    renderRecordsList()
                }
            }
            if (page === 'messages') {
                renderMessagesList()
                // 进入消息页面后，清除闪烁提醒
                document.getElementById('messageNavIcon').classList.remove('message-blink')
            }
        }

        // ==================== 图表功能 ====================
        let stockStatusChart = null
        
        function initChart() {
            // 检查Chart.js是否已加载
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js未加载，跳过图表初始化')
                return
            }
            
            // 如果图表已存在，先销毁
            if (stockStatusChart) {
                stockStatusChart.destroy()
            }
            
            const ctx = document.getElementById('stockStatusChart').getContext('2d')
            stockStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['正常', '临期', '过期'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, usePointStyle: true }
                        }
                    }
                }
            })
        }

        // ==================== 数据操作 ====================
        // 全局数据存储，避免重复查询
        let globalStockData = null
        let globalRecordsData = null
        let globalPersonnelData = null
        let isDataLoading = false
        let isSyncing = false
        
        // 本地优先加载策略：先显示本地数据，后台同步云端数据
        async function refreshAllData(forceRefresh = false) {
            // 如果数据正在加载中，等待完成
            if (isDataLoading) {
                console.log('数据正在加载中，等待...')
                while (isDataLoading) {
                    await new Promise(resolve => setTimeout(resolve, 100))
                }
                // 使用已加载的数据渲染页面
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                renderPersonnelListWithData(globalPersonnelData)
                return
            }
            
            isDataLoading = true
            const totalStartTime = Date.now()
            
            try {
                console.log('开始刷新数据...', new Date().toLocaleTimeString())
                
                if (isOfflineMode) {
                    // 离线模式：从本地存储获取
                    globalStockData = await DataStorage.get('stock') || []
                    globalRecordsData = await DataStorage.get('records') || []
                    globalPersonnelData = await DataStorage.get('personnel') || []
                    
                    // 渲染页面
                    updateDashboardWithData(globalStockData, globalRecordsData)
                    renderStockListWithData(globalStockData)
                    renderRecordsListWithData(globalRecordsData)
                    renderPersonnelListWithData(globalPersonnelData)
                } else {
                    // 在线模式：本地优先策略
                    
                    // 1. 首先尝试从本地存储加载（立即显示）
                    const localStartTime = Date.now()
                    const localStock = await DataStorage.get('stock')
                    const localRecords = await DataStorage.get('records')
                    const localPersonnel = await DataStorage.get('personnel')
                    
                    if (localStock && !forceRefresh) {
                        console.log(`从本地存储加载数据，耗时: ${Date.now() - localStartTime}ms`)
                        globalStockData = localStock
                        globalRecordsData = localRecords || []
                        globalPersonnelData = localPersonnel || []
                        
                        // 立即渲染页面
                        const renderStartTime = Date.now()
                        updateDashboardWithData(globalStockData, globalRecordsData)
                        renderStockListWithData(globalStockData)
                        renderRecordsListWithData(globalRecordsData)
                        renderPersonnelListWithData(globalPersonnelData)
                        console.log(`页面渲染耗时: ${Date.now() - renderStartTime}ms`)
                        console.log(`首屏加载总耗时: ${Date.now() - totalStartTime}ms`)
                        
                        // 2. 后台同步云端数据（不阻塞UI）
                        setTimeout(() => syncWithCloud(), 100)
                        return
                    }
                    
                    // 3. 如果没有本地数据，从云端加载（首次加载）
                    console.log('本地无数据，从云端加载...')
                    await loadFromCloud()
                }
                
                const totalTime = Date.now() - totalStartTime
                console.log(`数据刷新总耗时: ${totalTime}ms`, new Date().toLocaleTimeString())
            } catch (error) {
                console.error('刷新数据失败:', error)
            } finally {
                isDataLoading = false
            }
        }
        
        // 从云端加载数据
        async function loadFromCloud() {
            const startTime = Date.now()
            
            try {
                // 并行加载所有数据
                const [stockResult, recordsResult, personnelResult] = await Promise.all([
                    supabaseClient.from('stock_items').select('*').limit(1000),
                    supabaseClient.from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100),
                    supabaseClient.from('profiles').select('*')
                ])
                
                globalStockData = stockResult.data || []
                globalRecordsData = recordsResult.data || []
                globalPersonnelData = personnelResult.data || []
                
                console.log(`云端数据加载完成: 库存${globalStockData.length}条, 记录${globalRecordsData.length}条, 人员${globalPersonnelData.length}条, 耗时: ${Date.now() - startTime}ms`)
                
                // 保存到本地
                await saveToLocal()
                
                // 渲染页面
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                renderPersonnelListWithData(globalPersonnelData)
                
            } catch (error) {
                console.error('从云端加载失败:', error)
                // 如果云端加载失败，使用本地数据
                globalStockData = await DataStorage.get('stock') || []
                globalRecordsData = await DataStorage.get('records') || []
                globalPersonnelData = await DataStorage.get('personnel') || []
                
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                renderPersonnelListWithData(globalPersonnelData)
            }
        }
        
        // 后台同步云端数据
        async function syncWithCloud() {
            if (isSyncing) return
            isSyncing = true
            
            console.log('开始后台同步云端数据...')
            const startTime = Date.now()
            
            try {
                // 并行加载所有数据
                const [stockResult, recordsResult, personnelResult] = await Promise.all([
                    supabaseClient.from('stock_items').select('*').limit(1000),
                    supabaseClient.from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100),
                    supabaseClient.from('profiles').select('*')
                ])
                
                const cloudStock = stockResult.data || []
                const cloudRecords = recordsResult.data || []
                const cloudPersonnel = personnelResult.data || []
                
                const syncTime = Date.now() - startTime
                console.log(`后台同步完成: 库存${cloudStock.length}条, 记录${cloudRecords.length}条, 人员${cloudPersonnel.length}条, 耗时: ${syncTime}ms`)
                
                // 检查数据是否有变化
                const stockChanged = JSON.stringify(globalStockData) !== JSON.stringify(cloudStock)
                const recordsChanged = JSON.stringify(globalRecordsData) !== JSON.stringify(cloudRecords)
                const personnelChanged = JSON.stringify(globalPersonnelData) !== JSON.stringify(cloudPersonnel)
                
                if (stockChanged || recordsChanged || personnelChanged) {
                    console.log('检测到数据变化，更新页面...')
                    globalStockData = cloudStock
                    globalRecordsData = cloudRecords
                    globalPersonnelData = cloudPersonnel
                    
                    // 保存到本地
                    await saveToLocal()
                    
                    // 更新缓存
                    DataCache.set('stock', globalStockData)
                    DataCache.set('records', globalRecordsData)
                    DataCache.set('personnel', globalPersonnelData)
                    
                    // 更新页面
                    updateDashboardWithData(globalStockData, globalRecordsData)
                    renderStockListWithData(globalStockData)
                    renderRecordsListWithData(globalRecordsData)
                    renderPersonnelListWithData(globalPersonnelData)
                    
                    console.log('页面已更新为最新数据')
                } else {
                    console.log('数据无变化，无需更新')
                }
                
            } catch (error) {
                console.error('后台同步失败:', error)
            } finally {
                isSyncing = false
            }
        }
        
        // 保存数据到本地存储
        async function saveToLocal() {
            try {
                await DataStorage.set('stock', globalStockData)
                await DataStorage.set('records', globalRecordsData)
                await DataStorage.set('personnel', globalPersonnelData)
                await DataStorage.set('lastSyncTime', Date.now())
                console.log('数据已保存到本地存储')
            } catch (error) {
                console.error('保存到本地失败:', error)
            }
        }
        
        // 操作后同步数据（从云端获取最新数据并更新本地）
        async function syncAfterOperation() {
            console.log('操作完成，开始同步最新数据...')
            try {
                // 从云端获取最新数据
                const [stockResult, recordsResult, personnelResult] = await Promise.all([
                    supabaseClient.from('stock_items').select('*').limit(1000),
                    supabaseClient.from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100),
                    supabaseClient.from('profiles').select('*')
                ])
                
                globalStockData = stockResult.data || []
                globalRecordsData = recordsResult.data || []
                globalPersonnelData = personnelResult.data || []
                
                // 保存到本地
                await saveToLocal()
                
                // 更新缓存
                DataCache.set('stock', globalStockData)
                DataCache.set('records', globalRecordsData)
                DataCache.set('personnel', globalPersonnelData)
                
                // 更新页面
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                renderPersonnelListWithData(globalPersonnelData)
                
                console.log('同步完成')
            } catch (error) {
                console.error('同步失败:', error)
                // 同步失败不影响用户体验，数据已经在云端保存成功
            }
        }

        // 使用共享数据更新仪表板
        function updateDashboardWithData(stock, records) {
            if (!stock) stock = []
            if (!records) records = []
            
            // 计算统计数据
            const totalStock = stock.reduce((sum, item) => sum + (item.quantity || 0), 0)
            document.getElementById('totalStock').textContent = totalStock
            
            const today = new Date()
            // 计算距离过期的天数
            const oneDay = 24 * 60 * 60 * 1000
            
            // 找出即将过期的物品（30天内过期）
            const warningItems = stock.filter(item => {
                const dateStr = item.expiry_date || item.expiryDate
                const expiryDate = new Date(dateStr)
                // 计算距离过期的天数（过期日期 - 今天）
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                // 临期：0-30天内过期（包括今天过期）
                const isWarning = daysUntilExpiry >= 0 && daysUntilExpiry <= 30 && item.quantity > 0
                return isWarning
            })
            
            const expiryWarning = warningItems.length
            document.getElementById('expiryWarning').textContent = expiryWarning
            
            // 更新最近临期标准物质名称和闪烁效果
            updateNearestExpiryWarning(warningItems)
            
            // 计算状态分布（只统计正常、临期、过期三种状态）
            let normal = 0, warning = 0, expired = 0
            stock.forEach(item => {
                const dateStr = item.expiry_date || item.expiryDate
                const expiryDate = new Date(dateStr)
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                
                if (daysUntilExpiry < 0) {
                    // 已过期
                    expired++
                } else if (daysUntilExpiry <= 30) {
                    // 临期（0-30天）
                    warning++
                } else {
                    // 正常（>30天）
                    normal++
                }
            })

            if (stockStatusChart) {
                stockStatusChart.data.datasets[0].data = [normal, warning, expired]
                stockStatusChart.update()
            }
            
            // 加载最近活动
            const recentActivities = document.getElementById('recentActivities')
            if (records.length === 0) {
                recentActivities.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无活动记录</p></div>'
            } else {
                recentActivities.innerHTML = records.slice(0, 5).map(record => {
                    const icons = { in: 'fa-archive text-primary', out: 'fa-sign-out text-success', warning: 'fa-exclamation-triangle text-warning' }
                    const actions = { in: '入库', out: '出库', warning: '预警' }
                    return `
                        <div class="activity-item">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fa ${icons[record.type] || 'fa-info-circle'}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">${record.material_name || record.materialName} ${actions[record.type]}</p>
                                <p class="text-xs text-gray-500">${record.operator_name || record.operator} · ${new Date(record.created_at || record.date).toLocaleString('zh-CN')}</p>
                            </div>
                        </div>
                    `
                }).join('')
            }
        }
        
        async function refreshDashboard() {
            let stock = []
            let records = []
            
            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
                records = LocalStorage.get('records') || []
            } else {
                // 先检查缓存
                stock = DataCache.get('stock')
                records = DataCache.get('records')
                
                // 如果缓存不存在或过期，从Supabase获取
                if (!stock) {
                    const { data: stockData } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                    stock = stockData || []
                    DataCache.set('stock', stock)
                }
                
                if (!records) {
                    const { data: recordsData } = await supabaseClient
                        .from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(5)
                    records = recordsData || []
                    DataCache.set('records', records)
                }
            }
            
            // 计算统计数据
            const totalStock = stock.reduce((sum, item) => sum + (item.quantity || 0), 0)
            document.getElementById('totalStock').textContent = totalStock
            
            const today = new Date()
            const oneDay = 24 * 60 * 60 * 1000
            
            // 找出即将过期的物品（30天内过期）
            const warningItems = stock.filter(item => {
                const expiryDate = new Date(item.expiry_date || item.expiryDate)
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                return daysUntilExpiry >= 0 && daysUntilExpiry <= 30 && item.quantity > 0
            })
            
            const expiryWarning = warningItems.length
            document.getElementById('expiryWarning').textContent = expiryWarning
            
            // 更新最近临期标准物质名称和闪烁效果
            updateNearestExpiryWarning(warningItems)
            
            // 计算状态分布（只统计正常、临期、过期三种状态）
            let normal = 0, warning = 0, expired = 0
            stock.forEach(item => {
                const expiryDate = new Date(item.expiry_date || item.expiryDate)
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                if (daysUntilExpiry < 0) {
                    expired++
                } else if (daysUntilExpiry <= 30) {
                    warning++
                } else {
                    normal++
                }
            })

            if (stockStatusChart) {
                stockStatusChart.data.datasets[0].data = [normal, warning, expired]
                stockStatusChart.update()
            }
            
            // 加载最近活动
            const recentActivities = document.getElementById('recentActivities')
            if (records.length === 0) {
                recentActivities.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无活动记录</p></div>'
            } else {
                recentActivities.innerHTML = records.map(record => {
                    const icons = { in: 'fa-archive text-primary', out: 'fa-sign-out text-success', warning: 'fa-exclamation-triangle text-warning' }
                    const actions = { in: '入库', out: '出库', warning: '预警' }
                    return `
                        <div class="activity-item">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fa ${icons[record.type] || 'fa-info-circle'}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">${record.material_name || record.materialName} ${actions[record.type]}</p>
                                <p class="text-xs text-gray-500">${record.operator_name || record.operator} · ${new Date(record.created_at || record.date).toLocaleString('zh-CN')}</p>
                            </div>
                        </div>
                    `
                }).join('')
            }
        }

        // ==================== 库存管理 ====================
        let currentStockTab = 'all'

        // 分页相关变量
        let stockCurrentPage = 1
        const stockPageSize = 10
        let stockTotalPages = 1

        // 计算物品状态（根据有效期动态计算）
        function calculateItemStatus(expiryDateStr) {
            if (!expiryDateStr) return 'normal'
            const today = new Date()
            today.setHours(0, 0, 0, 0)  // 重置时间为当天零点
            const expiryDate = new Date(expiryDateStr)
            expiryDate.setHours(0, 0, 0, 0)  // 重置时间为当天零点
            const oneDay = 24 * 60 * 60 * 1000
            const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)

            console.log('计算状态:', '有效期:', expiryDateStr, '距离过期:', daysUntilExpiry, '天')

            if (daysUntilExpiry < 0) {
                return 'expired'  // 已过期
            } else if (daysUntilExpiry <= 30) {
                return 'warning'  // 临期（0-30天）
            } else {
                return 'normal'   // 正常（>30天）
            }
        }

        // 使用共享数据渲染库存列表
        function renderStockListWithData(stock) {
            if (!stock) stock = []

            console.log('renderStockListWithData 被调用, 数据条数:', stock.length)

            // 为每个物品计算当前状态
            stock = stock.map(item => {
                const status = calculateItemStatus(item.expiry_date || item.expiryDate)
                if (item.name && (item.name.includes('汞') || item.name.includes('铜'))) {
                    console.log('物品:', item.name, '有效期:', item.expiry_date || item.expiryDate, '计算状态:', status)
                }
                return {
                    ...item,
                    currentStatus: status
                }
            })

            const search = document.getElementById('stockSearchInput')?.value?.toLowerCase() || ''

            let filtered = stock
            if (search) {
                filtered = filtered.filter(item =>
                    (item.name || '').toLowerCase().includes(search) ||
                    (item.code || '').toLowerCase().includes(search)
                )
                // 搜索时重置到第一页
                stockCurrentPage = 1
            }

            if (currentStockTab !== 'all') {
                filtered = filtered.filter(item => item.currentStatus === currentStockTab)
                // 切换标签时重置到第一页
                stockCurrentPage = 1
            }

            // 按名称分组
            const grouped = {}
            filtered.forEach(item => {
                if (!grouped[item.name]) {
                    grouped[item.name] = { items: [], total: 0 }
                }
                grouped[item.name].items.push(item)
                grouped[item.name].total += item.quantity
            })
            
            // 计算分页
            const groupNames = Object.keys(grouped)
            stockTotalPages = Math.ceil(groupNames.length / stockPageSize)
            if (stockTotalPages === 0) stockTotalPages = 1
            if (stockCurrentPage > stockTotalPages) stockCurrentPage = stockTotalPages
            if (stockCurrentPage < 1) stockCurrentPage = 1
            
            // 获取当前页的数据
            const startIndex = (stockCurrentPage - 1) * stockPageSize
            const endIndex = startIndex + stockPageSize
            const currentPageGroups = groupNames.slice(startIndex, endIndex)
            
            const container = document.getElementById('stockList')
            if (groupNames.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无库存数据</p></div>'
                return
            }
            
            let html = currentPageGroups.map(name => {
                const group = grouped[name]
                const statusCounts = { normal: 0, warning: 0, expired: 0, low: 0 }
                group.items.forEach(item => {
                    // 使用动态计算的状态
                    statusCounts[item.currentStatus] = (statusCounts[item.currentStatus] || 0) + item.quantity
                })

                // 调试输出
                if (name.includes('汞') || name.includes('铜')) {
                    console.log(name + '分组状态统计:', statusCounts)
                    console.log(name + '物品列表:', group.items.map(i => ({name: i.name, expiry: i.expiry_date || i.expiryDate, status: i.currentStatus})))
                }

                let statusLabels = ''
                if (statusCounts.normal > 0) statusLabels += `<span class="ml-2 status-badge status-normal">正常:${statusCounts.normal}</span>`
                if (statusCounts.warning > 0) statusLabels += `<span class="ml-2 status-badge status-warning">临期:${statusCounts.warning}</span>`
                if (statusCounts.expired > 0) statusLabels += `<span class="ml-2 status-badge status-danger">过期:${statusCounts.expired}</span>`

                const groupId = 'group-' + name.replace(/\s+/g, '-')

                return `
                    <div class="stock-group">
                        <div class="stock-group-header flex justify-between items-center" onclick="toggleGroup('${groupId}')">
                            <div class="flex items-center">
                                <i class="fa fa-chevron-down mr-2 text-gray-400 transition-transform" id="arrow-${groupId}"></i>
                                <h3 class="font-semibold">${name}${statusLabels}</h3>
                            </div>
                            <span class="text-lg font-bold">${group.total}</span>
                        </div>
                        <div id="${groupId}" class="hidden">
                            ${group.items.map(item => `
                                <div class="stock-item">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium">唯一性标识: ${item.unique_id || item.uniqueId}</p>
                                            <p class="text-xs text-gray-500">有效期: ${item.expiry_date || item.expiryDate} | ${renderComponentsSummary(item)}</p>
                                            <span class="status-badge status-${item.currentStatus} mt-1">
                                                ${item.currentStatus === 'normal' ? '正常' : item.currentStatus === 'warning' ? '临期' : item.currentStatus === 'expired' ? '过期' : '库存不足'}
                                            </span>
                                        </div>
                                        <div class="flex space-x-1">
                                            <button onclick="showQRCode('${item.id}', '${item.unique_id || item.uniqueId}', '${item.name}')" class="px-2 py-1 bg-purple-500 text-white text-xs rounded" title="显示二维码">
                                                <i class="fa fa-qrcode"></i>
                                            </button>
                                            <button onclick="viewStockDetail('${item.id}')" class="px-2 py-1 bg-info text-white text-xs rounded">查看</button>
                                            <button onclick="quickOut('${item.id}')" class="px-2 py-1 bg-warning text-white text-xs rounded">出库</button>
                                            ${currentUser?.role === 'admin' ? `<button onclick="deleteStock('${item.id}')" class="px-2 py-1 bg-danger text-white text-xs rounded">删除</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
            }).join('')
            
            // 添加分页控件
            if (stockTotalPages > 1) {
                html += `
                    <div class="flex justify-center items-center mt-4 space-x-2">
                        <button onclick="changeStockPage(${stockCurrentPage - 1})" 
                            class="px-3 py-1 bg-gray-200 rounded ${stockCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${stockCurrentPage === 1 ? 'disabled' : ''}>
                            <i class="fa fa-chevron-left"></i> 上一页
                        </button>
                        <span class="text-sm text-gray-600">
                            第 ${stockCurrentPage} / ${stockTotalPages} 页
                        </span>
                        <button onclick="changeStockPage(${stockCurrentPage + 1})" 
                            class="px-3 py-1 bg-gray-200 rounded ${stockCurrentPage === stockTotalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${stockCurrentPage === stockTotalPages ? 'disabled' : ''}>
                            下一页 <i class="fa fa-chevron-right"></i>
                        </button>
                    </div>
                `
            }
            
            container.innerHTML = html
        }
        
        // 原来的renderStockList函数，用于单独调用时
        async function renderStockList() {
            console.log('renderStockList 被调用')
            let stock = []

            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
            } else {
                // 先检查缓存
                stock = DataCache.get('stock')
                console.log('从缓存获取数据:', stock ? stock.length : 0, '条')

                // 如果缓存不存在，从Supabase获取
                if (!stock) {
                    console.log('缓存为空，从Supabase获取')
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .order('created_at', { ascending: false })
                    stock = data || []
                    DataCache.set('stock', stock)
                }
            }

            // 调用统一的渲染函数
            renderStockListWithData(stock)
        }
        
        // 切换库存列表页码
        function changeStockPage(page) {
            stockCurrentPage = page
            renderStockList()
            // 滚动到列表顶部
            document.getElementById('stockList').scrollIntoView({ behavior: 'smooth', block: 'start' })
        }

        function switchStockTab(tab, element) {
            currentStockTab = tab
            document.querySelectorAll('.tab-nav-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')
            renderStockList()
        }

        function toggleGroup(id) {
            const el = document.getElementById(id)
            const arrow = document.getElementById('arrow-' + id)
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden')
                arrow.style.transform = 'rotate(180deg)'
            } else {
                el.classList.add('hidden')
                arrow.style.transform = 'rotate(0)'
            }
        }

        // ==================== 入库功能 ====================
        function showAddStockModal() {
            document.getElementById('addStockModal').classList.add('show')
            const date = new Date()
            date.setDate(date.getDate() + 30)
            document.querySelector('input[name="expiryDate"]').value = date.toISOString().split('T')[0]
        }

        function closeAddStockModal() {
            document.getElementById('addStockModal').classList.remove('show')
            document.getElementById('addStockForm').reset()
            document.getElementById('stockImagePreview').innerHTML = ''
            document.getElementById('stockImagePreview').classList.add('hidden')
            document.getElementById('stockUploadPlaceholder').classList.remove('hidden')
        }

        function toggleUniqueIdInput() {
            const type = document.querySelector('input[name="uniqueIdType"]:checked').value
            const input = document.getElementById('manualUniqueId')
            if (type === 'manual') {
                input.classList.remove('hidden')
                input.required = true
            } else {
                input.classList.add('hidden')
                input.required = false
            }
        }

        // 添加组分行
        function addComponentRow() {
            const container = document.getElementById('componentsContainer')
            const rows = container.querySelectorAll('.component-row')
            const newRow = document.createElement('div')
            newRow.className = 'component-row grid grid-cols-12 gap-2'
            newRow.innerHTML = `
                <div class="col-span-3">
                    <input type="text" name="componentName[]" class="form-input text-sm py-1" placeholder="如：锌">
                </div>
                <div class="col-span-3">
                    <input type="text" name="componentValue[]" class="form-input text-sm py-1" placeholder="如：100">
                </div>
                <div class="col-span-3">
                    <input type="text" name="componentUnit[]" class="form-input text-sm py-1" placeholder="如：μg/mL">
                </div>
                <div class="col-span-2">
                    <input type="text" name="componentUncertainty[]" class="form-input text-sm py-1" placeholder="如：0.5%">
                </div>
                <div class="col-span-1 flex items-center justify-center">
                    <button type="button" onclick="removeComponentRow(this)" class="text-red-500 hover:text-red-700">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `
            container.appendChild(newRow)
            updateRemoveButtons()
        }

        // 删除组分行
        function removeComponentRow(btn) {
            const row = btn.closest('.component-row')
            const container = document.getElementById('componentsContainer')
            const rows = container.querySelectorAll('.component-row')

            if (rows.length > 1) {
                row.remove()
                updateRemoveButtons()
            }
        }

        // 更新删除按钮显示状态
        function updateRemoveButtons() {
            const container = document.getElementById('componentsContainer')
            const rows = container.querySelectorAll('.component-row')
            const deleteButtons = container.querySelectorAll('.component-row button[onclick="removeComponentRow(this)"]')

            deleteButtons.forEach((btn, index) => {
                if (rows.length === 1) {
                    btn.classList.add('hidden')
                } else {
                    btn.classList.remove('hidden')
                }
            })
        }

        // 获取组分数据
        function getComponentsData() {
            const names = document.querySelectorAll('input[name="componentName[]"]')
            const values = document.querySelectorAll('input[name="componentValue[]"]')
            const units = document.querySelectorAll('input[name="componentUnit[]"]')
            const uncertainties = document.querySelectorAll('input[name="componentUncertainty[]"]')

            const components = []
            for (let i = 0; i < names.length; i++) {
                if (names[i].value || values[i].value) {
                    components.push({
                        name: names[i].value,
                        value: values[i].value,
                        unit: units[i].value,
                        uncertainty: uncertainties[i].value
                    })
                }
            }
            return components
        }

        // 将文件转换为Base64（带大小限制）
        function fileToBase64(file, maxSizeMB = 2) {
            return new Promise((resolve, reject) => {
                // 检查文件大小
                const maxSizeBytes = maxSizeMB * 1024 * 1024
                if (file.size > maxSizeBytes) {
                    reject(new Error(`文件大小超过${maxSizeMB}MB限制`))
                    return
                }

                const reader = new FileReader()
                reader.onload = () => resolve(reader.result)
                reader.onerror = reject
                reader.readAsDataURL(file)
            })
        }

        // 压缩图片
        async function compressImage(base64, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image()
                img.onload = () => {
                    const canvas = document.createElement('canvas')
                    let width = img.width
                    let height = img.height

                    // 按比例缩放
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width
                        width = maxWidth
                    }

                    canvas.width = width
                    canvas.height = height
                    const ctx = canvas.getContext('2d')
                    ctx.drawImage(img, 0, 0, width, height)

                    // 转换为压缩后的base64
                    const compressed = canvas.toDataURL('image/jpeg', quality)
                    resolve(compressed)
                }
                img.src = base64
            })
        }

        async function handleStockIn(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const quantity = parseInt(formData.get('quantity')) || 1
            const baseTime = Date.now()
            
            try {
                // 处理图片上传 - 从预览区域获取所有图片（包括PDF转换后的图片）
                const previewDiv = document.getElementById('stockImagePreview')
                const imageUrls = []
                
                // 获取所有预览图片的src
                const previewImages = previewDiv.querySelectorAll('img')
                previewImages.forEach(img => {
                    if (img.src && img.src.startsWith('data:')) {
                        imageUrls.push(img.src)
                    }
                })
                
                // 如果没有预览图片，则尝试从文件输入获取
                if (imageUrls.length === 0) {
                    const imageFiles = document.getElementById('stockImages').files
                    if (imageFiles.length > 0) {
                        for (let i = 0; i < imageFiles.length && i < 3; i++) {
                            const file = imageFiles[i]
                            try {
                                const base64 = await fileToBase64(file, 5) // 最大5MB
                                // 压缩图片以减少传输大小
                                const compressed = await compressImage(base64, 1200, 0.7)
                                imageUrls.push(compressed)
                            } catch (err) {
                                console.warn('图片处理失败:', err.message)
                                alert(`图片处理失败: ${err.message}`)
                                showLoading(false)
                                return
                            }
                        }
                    }
                } else {
                    // 压缩预览区域的图片
                    const compressedUrls = []
                    for (const url of imageUrls) {
                        try {
                            const compressed = await compressImage(url, 1200, 0.7)
                            compressedUrls.push(compressed)
                        } catch (err) {
                            compressedUrls.push(url) // 压缩失败使用原图
                        }
                    }
                    imageUrls.length = 0
                    imageUrls.push(...compressedUrls)
                }
                
                // 创建库存记录
                const records = []
                for (let i = 0; i < quantity; i++) {
                    const uniqueId = formData.get('uniqueIdType') === 'manual' 
                        ? `${formData.get('uniqueId')}-${String(i + 1).padStart(2, '0')}`
                        : `${formData.get('batchNumber') || 'BATCH'}-${baseTime.toString().slice(-4)}-${String(i + 1).padStart(2, '0')}`
                    
                    // 获取组分数据
                    const components = getComponentsData()

                    const stockItem = {
                        name: formData.get('name'),
                        code: formData.get('code'),
                        batch_number: formData.get('batchNumber'),
                        unique_id: uniqueId,
                        manufacturer: formData.get('manufacturer'),
                        // 保留旧字段用于兼容
                        concentration: components.length > 0 ? components[0].value : '',
                        unit: components.length > 0 ? components[0].unit : '',
                        uncertainty: components.length > 0 ? components[0].uncertainty : '',
                        // 新增组分字段（JSON格式存储所有组分）
                        components: components,
                        storage_condition: formData.get('storageCondition'),
                        dilution_condition: formData.get('dilutionCondition'),
                        quantity: 1,
                        expiry_date: formData.get('expiryDate'),
                        operator_id: currentUser?.id,
                        images: i === 0 ? imageUrls : []
                    }
                    
                    if (isOfflineMode) {
                        stockItem.id = Date.now() + i
                        stockItem.status = 'normal'
                        stockItem.created_at = new Date().toISOString()
                        const stock = LocalStorage.get('stock') || []
                        stock.push(stockItem)
                        LocalStorage.set('stock', stock)
                    } else {
                        // 检查 supabaseClient 是否可用
                        if (!supabaseClient) {
                            throw new Error('Supabase客户端未初始化，请刷新页面重试')
                        }

                        console.log('正在插入库存记录:', stockItem)

                        // 带重试机制的插入
                        let lastError = null
                        for (let retry = 0; retry < 3; retry++) {
                            try {
                                const { data, error } = await supabaseClient
                                    .from('stock_items')
                                    .insert([stockItem])
                                    .select()
                                if (error) throw error
                                records.push(data[0])
                                lastError = null
                                break
                            } catch (err) {
                                lastError = err
                                console.warn(`插入失败，第${retry + 1}次重试:`, err.message)
                                if (retry < 2) {
                                    await new Promise(r => setTimeout(r, 1000 * (retry + 1)))
                                }
                            }
                        }

                        if (lastError) {
                            console.error('插入库存记录失败:', lastError)
                            throw new Error('保存到数据库失败: ' + lastError.message)
                        }
                    }
                }
                
                // 添加操作记录
                try {
                    await addRecord('in', formData.get('name'), quantity, `批次号: ${formData.get('batchNumber') || 'N/A'}，入库${quantity}瓶`, imageUrls)
                } catch (recordError) {
                    console.error('添加操作记录失败:', recordError)
                    // 记录失败不影响入库成功
                }

                closeAddStockModal()
                // 操作成功后同步数据（使用setTimeout避免阻塞）
                setTimeout(() => {
                    syncAfterOperation().catch(err => console.error('后台同步失败:', err))
                }, 100)
                alert(`入库成功！已添加${quantity}瓶标准物质`)
            } catch (error) {
                console.error('入库错误详情:', error)
                let errorMsg = error.message
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = '网络连接失败，请检查网络后重试'
                }
                alert('入库失败: ' + errorMsg)
            } finally {
                showLoading(false)
            }
        }

        // ==================== 出库功能 ====================
        function showOutStockModal() {
            document.getElementById('outStockModal').classList.add('show')
            loadOutStockOptions()
        }

        function closeOutStockModal() {
            document.getElementById('outStockModal').classList.remove('show')
            document.getElementById('outStockForm').reset()
        }

        async function loadOutStockOptions() {
            const select = document.getElementById('outStockSelect')
            select.innerHTML = '<option value="">请选择</option>'
            
            let stock = []
            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
            } else {
                const { data } = await supabaseClient.from('stock_items').select('*')
                stock = data || []
            }
            
            stock.forEach(item => {
                select.innerHTML += `<option value="${item.id}">${item.name}（${item.unique_id || item.uniqueId}）</option>`
            })
        }

        // 快速出库 - 直接出库当前物品
        async function quickOut(id) {
            if (!confirm('确定要出库该物品吗？')) return
            
            showLoading(true)
            try {
                let stockItem = null
                
                if (isOfflineMode) {
                    const stock = LocalStorage.get('stock') || []
                    stockItem = stock.find(s => s.id == id)
                    if (stockItem) {
                        const newStock = stock.filter(s => s.id != id)
                        LocalStorage.set('stock', newStock)
                    }
                } else {
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', id)
                        .single()
                    stockItem = data
                    
                    if (stockItem) {
                        await supabaseClient
                            .from('stock_items')
                            .delete()
                            .eq('id', id)
                    }
                }
                
                if (!stockItem) throw new Error('库存不存在')
                
                // 添加出库记录
                await addRecord('out', stockItem.name, 1, `快速出库，唯一性标识: ${stockItem.unique_id || stockItem.uniqueId}`, [])
                
                // 操作成功后同步数据
                await syncAfterOperation()
                alert('出库成功！')
            } catch (error) {
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        async function handleStockOut(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const stockId = formData.get('stockId')
            
            try {
                // 获取库存信息
                let stockItem = null
                if (isOfflineMode) {
                    const stock = LocalStorage.get('stock') || []
                    stockItem = stock.find(s => s.id == stockId)
                } else {
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', stockId)
                        .single()
                    stockItem = data
                }
                
                if (!stockItem) throw new Error('库存不存在')
                
                // 处理图片
                const imageFiles = document.getElementById('outStockImages').files
                const imageUrls = []
                
                if (imageFiles.length > 0) {
                    for (let i = 0; i < imageFiles.length && i < 3; i++) {
                        const file = imageFiles[i]
                        
                        if (isOfflineMode) {
                            // 离线模式：转换为Base64存储
                            const base64 = await fileToBase64(file)
                            imageUrls.push(base64)
                        } else {
                            // 在线模式：上传到Supabase Storage
                            try {
                                const fileName = `out/${Date.now()}_${i}_${file.name}`
                                const { data, error } = await supabaseClient.storage
                                    .from('stock-images')
                                    .upload(fileName, file)
                                
                                if (error) {
                                    console.warn('Storage上传失败，使用Base64:', error)
                                    const base64 = await fileToBase64(file)
                                    imageUrls.push(base64)
                                } else {
                                    const { data: { publicUrl } } = supabaseClient.storage
                                        .from('stock-images')
                                        .getPublicUrl(fileName)
                                    imageUrls.push(publicUrl)
                                }
                            } catch (storageError) {
                                console.warn('Storage不可用，使用Base64:', storageError)
                                const base64 = await fileToBase64(file)
                                imageUrls.push(base64)
                            }
                        }
                    }
                }
                
                // 删除库存
                if (isOfflineMode) {
                    let stock = LocalStorage.get('stock') || []
                    stock = stock.filter(s => s.id != stockId)
                    LocalStorage.set('stock', stock)
                } else {
                    const { error } = await supabaseClient
                        .from('stock_items')
                        .delete()
                        .eq('id', stockId)
                    if (error) throw error
                }
                
                // 添加记录
                await addRecord('out', stockItem.name, 1, `唯一性标识: ${stockItem.unique_id || stockItem.uniqueId}，用途: ${formData.get('purpose') || '未填写'}`, imageUrls)
                
                closeOutStockModal()
                // 操作成功后同步数据
                await syncAfterOperation()
                alert('出库成功！')
            } catch (error) {
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        async function deleteStock(id) {
            if (!confirm('确定要删除这个标准物质吗？')) return
            
            try {
                if (isOfflineMode) {
                    let stock = LocalStorage.get('stock') || []
                    stock = stock.filter(s => s.id != id)
                    LocalStorage.set('stock', stock)
                } else {
                    const { error } = await supabaseClient
                        .from('stock_items')
                        .delete()
                        .eq('id', id)
                    if (error) throw error
                }
                
                // 操作成功后同步数据
                await syncAfterOperation()
                alert('删除成功！')
            } catch (error) {
                alert('删除失败: ' + error.message)
            }
        }

        // 渲染组分摘要（用于列表显示）
        function renderComponentsSummary(item) {
            const components = item.components || []

            if (components.length > 0) {
                if (components.length === 1) {
                    const c = components[0]
                    return `${c.name || ''} ${c.value || ''} ${c.unit || ''}`
                } else {
                    // 混标显示组分数量和第一个组分示例
                    const firstComp = components[0]
                    return `混标(${components.length}组分): ${firstComp.name || ''}等`
                }
            }

            // 兼容旧格式
            return `标准值: ${item.concentration || ''} ${item.unit || ''}`
        }

        // 渲染组分信息HTML
        function renderComponentsHtml(item) {
            const components = item.components || []

            // 如果有新格式的components字段
            if (components.length > 0) {
                return `
                    <div class="col-span-2">
                        <span class="text-gray-500">组分信息:</span>
                        <div class="mt-1 bg-gray-50 rounded p-2">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-gray-600 border-b">
                                        <th class="text-left py-1">组分</th>
                                        <th class="text-left py-1">标准值</th>
                                        <th class="text-left py-1">单位</th>
                                        <th class="text-left py-1">不确定度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${components.map(c => `
                                        <tr class="border-b border-gray-100 last:border-0">
                                            <td class="py-1">${c.name || '-'}</td>
                                            <td class="py-1">${c.value || '-'}</td>
                                            <td class="py-1">${c.unit || '-'}</td>
                                            <td class="py-1">${c.uncertainty || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `
            }

            // 兼容旧格式
            return `
                <div><span class="text-gray-500">标准值:</span> ${item.concentration || 'N/A'} ${item.unit || ''}</div>
                <div><span class="text-gray-500">不确定度:</span> ${item.uncertainty || 'N/A'}</div>
            `
        }

        async function viewStockDetail(id) {
            let item = null
            if (isOfflineMode) {
                const stock = LocalStorage.get('stock') || []
                item = stock.find(s => s.id == id)
            } else {
                const { data } = await supabaseClient
                    .from('stock_items')
                    .select('*')
                    .eq('id', id)
                    .single()
                item = data
            }
            
            if (!item) return

            // 动态计算状态
            const currentStatus = calculateItemStatus(item.expiry_date || item.expiryDate)

            const statusText = {
                normal: '正常',
                warning: '临期',
                expired: '过期',
                low: '库存不足'
            }[currentStatus]
            
            let imagesHtml = ''
            const images = item.images || []
            if (images.length > 0) {
                imagesHtml = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">相关图片</h3>
                        <div class="record-images">
                            ${images.map((img, idx) => `
                                <div class="record-image-item" onclick="viewImage('${img}', '图片 ${idx + 1}')">
                                    <img src="${img}" alt="图片">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
            }
            
            document.getElementById('viewDetailContent').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-500">标准物质名称:</span> ${item.name}</div>
                        <div><span class="text-gray-500">标准物质编号:</span> ${item.code}</div>
                        <div><span class="text-gray-500">批次号:</span> ${item.batch_number || item.batchNumber || 'N/A'}</div>
                        <div><span class="text-gray-500">唯一性标识:</span> ${item.unique_id || item.uniqueId}</div>
                        <div><span class="text-gray-500">生产厂家:</span> ${item.manufacturer || 'N/A'}</div>
                        ${renderComponentsHtml(item)}
                        <div><span class="text-gray-500">保存条件:</span> ${item.storage_condition || item.storageCondition || 'N/A'}</div>
                        <div><span class="text-gray-500">稀释条件:</span> ${item.dilution_condition || item.dilutionCondition || 'N/A'}</div>
                        <div><span class="text-gray-500">数量:</span> ${item.quantity}</div>
                        <div><span class="text-gray-500">有效期:</span> ${item.expiry_date || item.expiryDate}</div>
                        <div><span class="text-gray-500">状态:</span> <span class="status-badge status-${currentStatus}">${statusText}</span></div>
                        <div><span class="text-gray-500">创建时间:</span> ${new Date(item.created_at || item.createdAt).toLocaleString('zh-CN')}</div>
                    </div>
                    
                    ${imagesHtml}
                    
                    <div class="flex space-x-3">
                        <button onclick="quickOut('${item.id}'); closeViewDetailModal();" class="flex-1 btn btn-warning">出库</button>
                        <button onclick="closeViewDetailModal()" class="flex-1 btn btn-secondary">关闭</button>
                    </div>
                </div>
            `
            
            document.getElementById('viewDetailModal').classList.add('show')
        }

        function closeViewDetailModal() {
            document.getElementById('viewDetailModal').classList.remove('show')
        }

        // ==================== 记录管理 ====================
        async function addRecord(type, materialName, quantity, note, images = []) {
            const record = {
                type,
                material_name: materialName,
                quantity,
                operator_id: currentUser?.id,
                operator_name: currentUser?.name,
                note,
                images: images || []
            }
            
            if (isOfflineMode) {
                record.id = Date.now()
                record.created_at = new Date().toISOString()
                const records = LocalStorage.get('records') || []
                records.push(record)
                LocalStorage.set('records', records)
            } else {
                try {
                    const { error } = await supabaseClient.from('operation_records').insert([record])
                    if (error) {
                        console.error('添加记录失败:', error)
                        // 如果插入失败（可能是images字段不存在），尝试不带images插入
                        const recordWithoutImages = { ...record }
                        delete recordWithoutImages.images
                        await supabaseClient.from('operation_records').insert([recordWithoutImages])
                    }
                } catch (err) {
                    console.error('添加记录异常:', err)
                }
            }
        }

        // 使用共享数据渲染记录列表
        function renderRecordsListWithData(records) {
            if (!records) records = []
            renderRecordsListCore(records)
        }
        
        // 核心渲染函数
        function renderRecordsListCore(records) {
            const search = document.getElementById('recordsSearchInput')?.value?.toLowerCase() || ''
            
            if (search) {
                records = records.filter(r => 
                    (r.material_name || r.materialName || '').toLowerCase().includes(search) ||
                    (r.operator_name || r.operator || '').toLowerCase().includes(search)
                )
            }
            
            const container = document.getElementById('recordsList')
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-history text-4xl mb-2"></i><p>暂无操作记录</p></div>'
                return
            }
            
            const icons = { in: 'fa-archive text-blue-500', out: 'fa-sign-out text-green-500', warning: 'fa-exclamation-triangle text-yellow-500' }
            const types = { in: '入库', out: '出库', warning: '预警' }
            const badges = { in: 'bg-blue-100 text-blue-800', out: 'bg-green-100 text-green-800', warning: 'bg-yellow-100 text-yellow-800' }
            
            container.innerHTML = records.map(record => {
                let imagesHtml = ''
                const images = record.images || []
                if (images.length > 0) {
                    imagesHtml = `
                        <div class="record-images mt-3">
                            ${images.map((img, idx) => {
                                let imageUrl = img || ''
                                const isValidDataUrl = imageUrl.startsWith('data:image') || imageUrl.startsWith('data:application/pdf')
                                return `
                                    <div class="record-image-item" onclick="viewImage('${imageUrl}', '${types[record.type]}图片 ${idx + 1}')" title="点击查看大图">
                                        ${isValidDataUrl ? `
                                            <img src="${imageUrl}" alt="记录图片" 
                                                onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full bg-gray-100 text-gray-400 text-xs p-2\\'>图片加载失败</div>'">
                                        ` : `
                                            <div class="flex items-center justify-center h-full bg-gray-100 text-gray-400 text-xs p-2">
                                                <i class="fa fa-file-o mr-1"></i>文件
                                            </div>
                                        `}
                                    </div>
                                `
                            }).join('')}
                        </div>
                    `
                }
                
                return `
                    <div class="record-item">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                    <i class="fa ${icons[record.type]}"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">${record.material_name || record.materialName}</h3>
                                    <p class="text-sm text-gray-500">${record.operator_name || record.operator} · ${new Date(record.created_at || record.date).toLocaleString('zh-CN')}</p>
                                </div>
                            </div>
                            <span class="status-badge ${badges[record.type] || 'bg-gray-100 text-gray-600'}">${types[record.type]}</span>
                        </div>
                        <div class="mt-2">
                            <p class="text-sm">数量: ${record.quantity}</p>
                            <p class="text-sm text-gray-500">备注: ${record.note}</p>
                            ${imagesHtml}
                        </div>
                    </div>
                `
            }).join('')
        }
        
        async function renderRecordsList() {
            let records = []
            
            if (isOfflineMode) {
                records = LocalStorage.get('records') || []
            } else {
                // 先检查全局数据
                if (globalRecordsData) {
                    records = globalRecordsData
                } else {
                    const { data } = await supabaseClient
                        .from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                    records = data || []
                }
            }
            
            renderRecordsListCore(records)
        }

        // ==================== 人员管理 ====================
        // 使用共享数据渲染人员列表
        function renderPersonnelListWithData(personnel) {
            if (!personnel) personnel = []
            renderPersonnelListCore(personnel)
        }
        
        // 核心渲染函数
        function renderPersonnelListCore(personnel) {
            const search = document.getElementById('personnelSearchInput')?.value?.toLowerCase() || ''
            
            if (search) {
                personnel = personnel.filter(p => 
                    (p.name || '').toLowerCase().includes(search) ||
                    (p.username || '').toLowerCase().includes(search)
                )
            }
            
            const container = document.getElementById('personnelList')
            if (personnel.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-users text-4xl mb-2"></i><p>暂无人员数据</p></div>'
                return
            }
            
            container.innerHTML = personnel.map(person => `
                <div class="personnel-item">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${person.name}</h3>
                            <p class="text-sm text-gray-500">${person.username || person.email}</p>
                        </div>
                        <span class="status-badge ${person.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${person.role === 'admin' ? '管理员' : '普通用户'}
                        </span>
                    </div>
                    ${currentUser?.role === 'admin' && person.id !== currentUser?.id ? `
                        <div class="flex justify-end space-x-2 mt-3">
                            <button onclick="deletePersonnel('${person.id}')" class="text-danger text-sm">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('')
        }
        
        async function renderPersonnelList() {
            let personnel = []
            
            if (isOfflineMode) {
                personnel = LocalStorage.get('personnel') || []
            } else {
                // 先检查全局数据
                if (globalPersonnelData) {
                    personnel = globalPersonnelData
                } else {
                    const { data } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .order('created_at', { ascending: false })
                    personnel = data || []
                }
            }
            
            renderPersonnelListCore(personnel)
        }

        function showAddPersonnelModal() {
            document.getElementById('addPersonnelModal').classList.add('show')
        }

        function closeAddPersonnelModal() {
            document.getElementById('addPersonnelModal').classList.remove('show')
            document.getElementById('addPersonnelForm').reset()
        }

        async function deletePersonnel(id) {
            if (!confirm('确定要删除这个人员吗？')) return
            
            try {
                if (isOfflineMode) {
                    let personnel = LocalStorage.get('personnel') || []
                    personnel = personnel.filter(p => p.id != id)
                    LocalStorage.set('personnel', personnel)
                } else {
                    // 注意：删除auth用户需要service role，这里仅删除profile
                    const { error } = await supabaseClient
                        .from('profiles')
                        .delete()
                        .eq('id', id)
                    if (error) throw error
                }
                
                await renderPersonnelList()
                alert('删除成功！')
            } catch (error) {
                alert('删除失败: ' + error.message)
            }
        }

        // ==================== 扫码功能 ====================
        let scanStream = null
        let isScanning = false

        function showScanModal() {
            document.getElementById('scanModal').classList.add('show')
            document.getElementById('scanInput').value = ''
            document.getElementById('scanResult').classList.add('hidden')
            // 自动聚焦输入框
            setTimeout(() => document.getElementById('scanInput').focus(), 100)
        }

        function closeScanModal() {
            stopCameraScan()
            document.getElementById('scanModal').classList.remove('show')
        }

        // 启动摄像头扫描
        async function startCameraScan() {
            const video = document.getElementById('scanVideo')
            const loading = document.getElementById('scanLoading')
            
            loading.classList.remove('hidden')
            
            try {
                scanStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                })
                video.srcObject = scanStream
                video.play()
                isScanning = true
                loading.classList.add('hidden')
                scanFrame()
            } catch (error) {
                console.error('摄像头启动失败:', error)
                loading.classList.add('hidden')
                alert('无法启动摄像头，请确保已授予摄像头权限，或使用手动输入方式')
            }
        }

        // 停止摄像头扫描
        function stopCameraScan() {
            isScanning = false
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop())
                scanStream = null
            }
            const video = document.getElementById('scanVideo')
            video.srcObject = null
        }

        // 扫描帧
        function scanFrame() {
            if (!isScanning) return
            
            const video = document.getElementById('scanVideo')
            const canvas = document.getElementById('scanCanvas')
            const ctx = canvas.getContext('2d')
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth
                canvas.height = video.videoHeight
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'attemptBoth'
                })
                
                if (code) {
                    // 扫描成功
                    stopCameraScan()
                    handleScannedCode(code.data)
                    return
                }
            }
            
            requestAnimationFrame(scanFrame)
        }

        // 处理扫描到的二维码
        async function handleScannedCode(data) {
            // 尝试解析二维码数据
            let searchTerm = data.trim()
            
            // 如果二维码包含URL，尝试提取唯一标识
            try {
                const url = new URL(searchTerm)
                const params = new URLSearchParams(url.search)
                if (params.has('id')) {
                    searchTerm = params.get('id')
                }
            } catch (e) {
                // 不是URL，直接使用
            }
            
            document.getElementById('scanInput').value = searchTerm
            await searchAndShowResult(searchTerm)
        }

        // 处理扫码输入
        async function handleScan() {
            const input = document.getElementById('scanInput').value.trim()
            if (!input) {
                alert('请输入唯一标识码')
                return
            }
            
            await searchAndShowResult(input)
        }

        // 监听回车键
        document.addEventListener('DOMContentLoaded', function() {
            const scanInput = document.getElementById('scanInput')
            if (scanInput) {
                scanInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleScan()
                    }
                })
            }
        })

        // 搜索并显示结果
        async function searchAndShowResult(searchTerm) {
            let stock = []
            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
            } else {
                const { data } = await supabaseClient.from('stock_items').select('*')
                stock = data || []
            }
            
            // 搜索匹配项（支持唯一标识、名称、编号）
            const item = stock.find(s => 
                (s.unique_id || s.uniqueId) === searchTerm ||
                s.name === searchTerm ||
                s.code === searchTerm ||
                s.id == searchTerm
            )
            
            const resultDiv = document.getElementById('scanResult')
            
            if (item) {
                // 动态计算状态
                const currentStatus = calculateItemStatus(item.expiry_date || item.expiryDate)

                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-lg text-green-800">${item.name}</h3>
                            <span class="px-2 py-1 rounded text-xs ${currentStatus === 'normal' ? 'bg-green-100 text-green-700' : currentStatus === 'expired' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${currentStatus === 'normal' ? '正常' : currentStatus === 'expired' ? '过期' : '临期'}
                            </span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <p><span class="text-gray-500">编号：</span>${item.code}</p>
                            <p><span class="text-gray-500">唯一标识：</span>${item.unique_id || item.uniqueId}</p>
                            <p><span class="text-gray-500">批次号：</span>${item.batch_number || item.batchNumber}</p>
                            <p><span class="text-gray-500">有效期：</span>${item.expiry_date || item.expiryDate}</p>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="directOut('${item.id}')" class="btn btn-success flex-1">
                                <i class="fa fa-sign-out mr-1"></i>直接出库
                            </button>
                            <button onclick="scanViewDetail('${item.id}')" class="btn btn-secondary flex-1">
                                <i class="fa fa-eye mr-1"></i>详情
                            </button>
                        </div>
                    </div>
                `
                resultDiv.classList.remove('hidden')
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-exclamation-circle text-red-500 mr-2 text-xl"></i>
                            <div>
                                <p class="font-medium text-red-800">未找到匹配项</p>
                                <p class="text-sm text-red-600">未找到唯一标识为 "${searchTerm}" 的标准物质</p>
                            </div>
                        </div>
                    </div>
                `
                resultDiv.classList.remove('hidden')
            }
        }

        // 直接出库（无需选择）
        async function directOut(id) {
            if (!confirm('确定要出库该物品吗？')) return
            
            showLoading(true)
            try {
                let stockItem = null
                
                if (isOfflineMode) {
                    const stock = LocalStorage.get('stock') || []
                    stockItem = stock.find(s => s.id == id)
                    if (stockItem) {
                        const newStock = stock.filter(s => s.id != id)
                        LocalStorage.set('stock', newStock)
                    }
                } else {
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', id)
                        .single()
                    stockItem = data
                    
                    if (stockItem) {
                        await supabaseClient
                            .from('stock_items')
                            .delete()
                            .eq('id', id)
                    }
                }
                
                if (!stockItem) throw new Error('库存不存在')
                
                // 添加出库记录
                await addRecord('out', stockItem.name, 1, `扫码出库，唯一性标识: ${stockItem.unique_id || stockItem.uniqueId}`, [])
                
                closeScanModal()
                // 操作成功后同步数据
                await syncAfterOperation()
                alert('出库成功！')
            } catch (error) {
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 扫码后查看详情
        function scanViewDetail(id) {
            closeScanModal()
            viewStockDetail(id)
        }

        // ==================== 二维码功能 ====================
        let currentQRItem = null  // 存储当前二维码对应的物品信息

        async function showQRCode(id, uniqueId, name) {
            const modal = document.getElementById('qrCodeModal')
            const container = document.getElementById('qrCodeContainer')

            // 获取完整的物品信息
            let item = null
            if (isOfflineMode) {
                const stock = LocalStorage.get('stock') || []
                item = stock.find(s => s.id == id)
            } else {
                const { data } = await supabaseClient
                    .from('stock_items')
                    .select('*')
                    .eq('id', id)
                    .single()
                item = data
            }

            if (!item) {
                alert('无法获取物品信息')
                return
            }

            // 保存当前物品信息供打印使用
            currentQRItem = item

            document.getElementById('qrItemName').textContent = name
            document.getElementById('qrItemUniqueId').textContent = uniqueId

            // 生成二维码数据 - 使用网页链接格式，微信扫码可直接打开
            // 格式: https://你的域名/?scan=true&id=xxx&uniqueId=xxx
            // 如果没有域名，则使用 data URL 格式包含物品信息
            const qrData = generateQRCodeData(item)

            // 使用 QRCode.js 生成二维码
            container.innerHTML = ''

            // 创建 canvas 元素
            const canvas = document.createElement('canvas')
            container.appendChild(canvas)

            QRCode.toCanvas(canvas, qrData, {
                width: 200,
                height: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) {
                    console.error('二维码生成失败:', error)
                    container.innerHTML = '<p class="text-red-500">二维码生成失败</p>'
                }
            })

            modal.classList.add('show')
        }

        // 生成二维码数据 - 使用网页链接格式，微信扫码可直接打开查看
        function generateQRCodeData(item) {
            // 方案1：如果有部署的网页服务器，使用URL Scheme
            // 格式: https://your-domain.com/item?id=xxx&uniqueId=xxx
            // 这样微信扫码会直接打开网页显示详细信息

            // 方案2：使用 data URL 方式，将信息编码到URL中
            // 创建包含物品信息的查询参数
            const params = new URLSearchParams()
            params.set('id', item.id)
            params.set('uniqueId', item.unique_id || item.uniqueId)
            params.set('name', item.name)
            params.set('code', item.code || '')
            params.set('batch', item.batch_number || item.batchNumber || '')
            params.set('mfg', item.manufacturer || '')
            params.set('exp', item.expiry_date || item.expiryDate || '')

            // 如果有组分信息，简化后添加
            if (item.components && item.components.length > 0) {
                const compStr = item.components.map(c =>
                    `${c.name || ''}:${c.value || ''}${c.unit || ''}`
                ).join(',')
                params.set('comp', compStr)
            }

            // 生成当前页面的URL + 查询参数
            // 这样微信扫码会打开同一个页面，页面根据参数显示详情
            const baseUrl = window.location.origin + window.location.pathname
            const fullUrl = baseUrl + '?' + params.toString()

            // 如果URL太长，使用简化的唯一标识格式
            if (fullUrl.length > 300) {
                // 简化格式：只包含ID和唯一标识
                const simpleParams = new URLSearchParams()
                simpleParams.set('id', item.id)
                simpleParams.set('uniqueId', item.unique_id || item.uniqueId)
                return baseUrl + '?' + simpleParams.toString()
            }

            return fullUrl
        }

        function closeQRCodeModal() {
            document.getElementById('qrCodeModal').classList.remove('show')
        }

        // ==================== 蓝牙标签打印机功能 ====================
        // 支持德佟、微打等便携标签打印机 - 40x30mm 热敏标签纸

        // 打印机配置
        const PRINTER_CONFIG = {
            width: 40,          // 标签宽度 mm
            height: 30,         // 标签高度 mm
            dpi: 203,           // 打印分辨率
            // 德佟打印机蓝牙服务UUID
            detongServiceUUID: '0000ff00-0000-1000-8000-00805f9b34fb',
            detongWriteUUID: '0000ff02-0000-1000-8000-00805f9b34fb',
            // 微打打印机蓝牙服务UUID
            weidaServiceUUID: '000018f0-0000-1000-8000-00805f9b34fb',
            weidaWriteUUID: '00002af1-0000-1000-8000-00805f9b34fb',
            // 通用SPP服务UUID
            sppServiceUUID: '00001101-0000-1000-8000-00805f9b34fa'
        }

        let bluetoothPrinter = null  // 打印机连接实例
        let printerType = null       // 打印机类型: 'detong', 'weida', 'generic'

        // 打印标签（40x30mm）- 二维码 + 唯一性标识
        async function printLabelWithWeida() {
            if (!currentQRItem) {
                alert('请先选择要打印的物品')
                return
            }

            try {
                // 检查浏览器是否支持蓝牙
                if (!navigator.bluetooth) {
                    alert('您的浏览器不支持蓝牙功能，将使用浏览器打印方式')
                    printLabelWithBrowser()
                    return
                }

                // 尝试连接蓝牙打印机
                const connected = await connectBluetoothPrinter()
                if (connected) {
                    await printWithBluetooth()
                } else {
                    // 蓝牙连接失败，使用浏览器打印
                    printLabelWithBrowser()
                }
            } catch (error) {
                console.error('打印失败:', error)

                // 根据错误类型给出不同的提示
                if (error.name === 'NotFoundError') {
                    // 用户取消了选择或没有找到设备
                    console.log('用户取消了蓝牙设备选择')
                    return  // 静默返回，不打扰用户
                } else if (error.name === 'SecurityError') {
                    alert('蓝牙权限被拒绝，请检查浏览器权限设置')
                } else if (error.message && error.message.includes('没有找到')) {
                    alert('未找到蓝牙打印机，请确保打印机已开机并处于可配对状态')
                } else {
                    alert('蓝牙打印失败: ' + error.message + '\n将使用浏览器打印方式')
                }

                // 对于非取消操作，使用浏览器打印作为备选
                if (error.name !== 'NotFoundError') {
                    printLabelWithBrowser()
                }
            }
        }

        // 连接蓝牙打印机（支持德佟、微打等）
        async function connectBluetoothPrinter() {
            try {
                console.log('正在搜索蓝牙打印机...')

                // 请求蓝牙设备 - 搜索常见的标签打印机
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'Detong' },
                        { namePrefix: 'DETONG' },
                        { namePrefix: '德佟' },
                        { namePrefix: 'WEIDA' },
                        { namePrefix: 'Weida' },
                        { namePrefix: '微打' },
                        { namePrefix: 'Printer' },
                        { namePrefix: 'printer' },
                        { namePrefix: '标签' }
                    ],
                    optionalServices: [
                        PRINTER_CONFIG.detongServiceUUID,
                        PRINTER_CONFIG.weidaServiceUUID,
                        PRINTER_CONFIG.sppServiceUUID,
                        '0000ff00-0000-1000-8000-00805f9b34fb',
                        '000018f0-0000-1000-8000-00805f9b34fb',
                        '00001101-0000-1000-8000-00805f9b34fa'
                    ]
                })

                console.log('找到设备:', device.name)

                // 判断打印机类型
                const deviceName = device.name.toUpperCase()
                if (deviceName.includes('DETONG') || deviceName.includes('德佟')) {
                    printerType = 'detong'
                    console.log('识别为德佟打印机')
                } else if (deviceName.includes('WEIDA') || deviceName.includes('微打')) {
                    printerType = 'weida'
                    console.log('识别为微打打印机')
                } else {
                    printerType = 'generic'
                    console.log('识别为通用打印机')
                }

                // 连接GATT服务器
                const server = await device.gatt.connect()
                console.log('已连接到GATT服务器')

                // 尝试获取服务
                let service = null
                let writeCharacteristic = null

                try {
                    // 尝试德佟服务
                    service = await server.getPrimaryService(PRINTER_CONFIG.detongServiceUUID)
                    writeCharacteristic = await service.getCharacteristic(PRINTER_CONFIG.detongWriteUUID)
                    printerType = 'detong'
                    console.log('使用德佟打印机协议')
                } catch (e1) {
                    console.log('德佟服务不可用，尝试微打服务...')
                    try {
                        // 尝试微打服务
                        service = await server.getPrimaryService(PRINTER_CONFIG.weidaServiceUUID)
                        writeCharacteristic = await service.getCharacteristic(PRINTER_CONFIG.weidaWriteUUID)
                        printerType = 'weida'
                        console.log('使用微打打印机协议')
                    } catch (e2) {
                        console.log('微打服务不可用，尝试通用SPP服务...')
                        // 尝试获取所有服务
                        const services = await server.getPrimaryServices()
                        console.log('可用服务:', services.map(s => s.uuid))

                        // 使用第一个可用的服务
                        if (services.length > 0) {
                            service = services[0]
                            const characteristics = await service.getCharacteristics()
                            console.log('可用特征值:', characteristics.map(c => c.uuid))

                            // 找到可写的特征值
                            writeCharacteristic = characteristics.find(c => c.properties.write || c.properties.writeWithoutResponse)
                            if (!writeCharacteristic && characteristics.length > 0) {
                                writeCharacteristic = characteristics[0]
                            }
                        }
                    }
                }

                if (!service || !writeCharacteristic) {
                    throw new Error('无法找到打印机的服务或特征值')
                }

                bluetoothPrinter = {
                    device: device,
                    server: server,
                    service: service,
                    characteristic: writeCharacteristic,
                    type: printerType
                }

                console.log('打印机连接成功:', printerType)
                return true

            } catch (error) {
                console.error('蓝牙连接失败:', error)

                // 根据错误类型给出友好的提示
                if (error.name === 'NotFoundError') {
                    // 用户取消了选择，不抛出错误
                    console.log('用户取消了蓝牙设备选择')
                    return false
                } else if (error.name === 'SecurityError') {
                    throw new Error('蓝牙权限被拒绝，请检查浏览器权限设置')
                } else if (error.name === 'NetworkError') {
                    throw new Error('蓝牙连接失败，请确保打印机在附近并已开机')
                } else if (error.message && error.message.includes('没有找到打印机的服务')) {
                    throw new Error('打印机连接失败，请确保选择的是标签打印机')
                } else {
                    throw new Error('蓝牙连接失败: ' + (error.message || '未知错误'))
                }
            }
        }

        // 使用蓝牙打印机打印
        async function printWithBluetooth() {
            if (!bluetoothPrinter) {
                throw new Error('打印机未连接')
            }

            try {
                // 根据打印机类型生成对应的打印指令
                let printData
                if (bluetoothPrinter.type === 'detong') {
                    printData = generateDetongPrintCommands()
                } else {
                    printData = generateGenericPrintCommands()
                }

                // 分段发送数据（蓝牙LE有MTU限制）
                const chunkSize = 512  // 蓝牙LE通常的MTU大小
                for (let i = 0; i < printData.length; i += chunkSize) {
                    const chunk = printData.slice(i, i + chunkSize)
                    await bluetoothPrinter.characteristic.writeValue(chunk)
                    // 小延迟确保打印机处理
                    await new Promise(r => setTimeout(r, 50))
                }

                console.log('打印指令已发送')
                alert('打印任务已发送！')

            } catch (error) {
                console.error('蓝牙打印失败:', error)
                throw error
            }
        }

        // 生成德佟打印机指令（CPCL指令集）
        function generateDetongPrintCommands() {
            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''
            const name = currentQRItem.name || ''

            // CPCL指令集 - 德佟打印机使用
            // 40x30mm 标签，203dpi
            // 40mm = 320点, 30mm = 240点

            let commands = ''

            // 初始化标签
            commands += '! 0 200 200 240 1\r\n'  // 宽度320点，高度240点，1份

            // 设置打印方向
            commands += 'PAGE-WIDTH 320\r\n'

            // 打印名称（居中，字体放大）
            const shortName = name.length > 10 ? name.substring(0, 10) : name
            commands += `CENTER\r\n`
            commands += `SETMAG 2 2\r\n`  // 字体放大2倍
            commands += `TEXT 4 0 0 10 ${shortName}\r\n`  // 字体4，x=0, y=10
            commands += `SETMAG 0 0\r\n`  // 恢复字体大小

            // 打印唯一标识
            commands += `TEXT 2 0 0 50 ${uniqueId}\r\n`  // 字体2，x=0, y=50

            // 打印二维码（居中）
            // QR码指令: BARCODE QR x y M U E S data
            // M=2(模式), U=5(单元大小), E=0(纠错级别), S=0(掩码)
            const qrData = generateQRCodeData(currentQRItem)
            commands += `BARCODE QR 110 90 M 4 U 0 M 0 S0 "${qrData}"
`

            // 打印命令
            commands += 'PRINT\r\n'

            // 转换为Uint8Array
            const encoder = new TextEncoder()
            return encoder.encode(commands)
        }

        // 生成通用ESC/POS打印指令
        function generateGenericPrintCommands() {
            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''
            const name = currentQRItem.name || ''

            // 创建打印指令数组
            const commands = []

            // ESC @ - 初始化打印机
            commands.push(0x1B, 0x40)

            // 设置标签尺寸（40x30mm）
            // 不同打印机指令不同，这里使用通用设置

            // ESC a 1 - 居中对齐
            commands.push(0x1B, 0x61, 0x01)

            // 设置字体大小（放大2倍）
            commands.push(0x1D, 0x21, 0x11)

            // 打印名称
            const shortName = name.length > 8 ? name.substring(0, 8) : name
            commands.push(...stringToBytes(shortName))
            commands.push(0x0A)  // 换行

            // 恢复正常字体大小
            commands.push(0x1D, 0x21, 0x00)

            // 打印唯一标识
            commands.push(...stringToBytes(uniqueId))
            commands.push(0x0A, 0x0A)  // 换两行

            // 打印QR码（如果打印机支持）
            // GS k m n d1...dn - 打印QR码
            const qrData = generateQRCodeData(currentQRItem)
            const qrBytes = stringToBytes(qrData)

            // QR码模型选择 (GS ( k pL pH cn fn n1)
            commands.push(0x1D, 0x28, 0x6B, 0x04, 0x00, 0x31, 0x41, 0x32, 0x00)

            // QR码大小设置
            commands.push(0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x43, 0x05)

            // QR码错误纠正级别
            commands.push(0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x45, 0x30)

            // QR码数据存储
            const dataLen = qrBytes.length + 3
            commands.push(0x1D, 0x28, 0x6B, dataLen & 0xFF, (dataLen >> 8) & 0xFF, 0x31, 0x50, 0x30)
            commands.push(...qrBytes)

            // QR码打印
            commands.push(0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x51, 0x30)

            // 换行
            commands.push(0x0A)

            // GS V 0 - 切纸（如果支持）
            // commands.push(0x1D, 0x56, 0x00)

            return new Uint8Array(commands)
        }

        // 字符串转字节数组（UTF-8）
        function stringToBytes(str) {
            const encoder = new TextEncoder()
            return Array.from(encoder.encode(str))
        }

        // 使用浏览器打印（备选方案）
        function printLabelWithBrowser() {
            if (!currentQRItem) {
                alert('请先选择要打印的物品')
                return
            }

            // 创建打印窗口
            const printWindow = window.open('', '_blank', 'width=400,height=300')
            if (!printWindow) {
                alert('请允许弹出窗口以进行打印')
                return
            }

            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''
            const name = currentQRItem.name || ''

            // 获取二维码图片数据
            const canvas = document.querySelector('#qrCodeContainer canvas')
            const qrImageData = canvas ? canvas.toDataURL('image/png') : ''

            // 创建40x30mm标签的打印HTML
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>标签打印 - ${uniqueId}</title>
                    <style>
                        @page {
                            size: 40mm 30mm;
                            margin: 0;
                        }
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            width: 40mm;
                            height: 30mm;
                            font-family: Arial, sans-serif;
                            font-size: 8pt;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 2mm;
                        }
                        .label-container {
                            width: 100%;
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: space-between;
                        }
                        .qr-code {
                            width: 18mm;
                            height: 18mm;
                            object-fit: contain;
                        }
                        .unique-id {
                            font-size: 7pt;
                            font-weight: bold;
                            text-align: center;
                            word-break: break-all;
                            line-height: 1.2;
                        }
                        .material-name {
                            font-size: 6pt;
                            text-align: center;
                            color: #666;
                            max-width: 100%;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="label-container">
                        <div class="material-name">${name}</div>
                        ${qrImageData ? `<img class="qr-code" src="${qrImageData}" alt="二维码">` : '<div style="width:18mm;height:18mm;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:6pt;">二维码</div>'}
                        <div class="unique-id">${uniqueId}</div>
                    </div>
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `)

            printWindow.document.close()
        }

        // ==================== AI智能识别功能 ====================
        // 豆包大模型配置 - 火山方舟
        // 使用API Key认证（Bearer Token）
        const DOUBAO_CONFIG = {
            API_KEY: '7b4f3ff4-1ee0-4b4c-8551-0441674dbdbe',
            ENDPOINT: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
            MODEL: 'doubao-seed-1-6-vision-250815'
        }

        // AI识别相关变量
        let aiStream = null
        let aiImages = []  // 存储多张图片
        let aiExtractedData = {}
        let isPDF = false

        // 显示AI识别模态框
        function showAIRecognizeModal() {
            document.getElementById('aiRecognizeModal').classList.add('show')
            resetAIRecognizeModal()
        }

        // 关闭AI识别模态框
        function closeAIRecognizeModal() {
            stopAICamera()
            document.getElementById('aiRecognizeModal').classList.remove('show')
        }

        // 重置AI识别模态框
        function resetAIRecognizeModal() {
            document.getElementById('aiStep1').classList.remove('hidden')
            document.getElementById('aiStep2').classList.add('hidden')
            document.getElementById('aiStep3').classList.add('hidden')
            document.getElementById('aiPreviewContainer').classList.add('hidden')
            document.getElementById('aiPreview2Container').classList.add('hidden')
            document.getElementById('aiPlaceholder').classList.remove('hidden')
            document.getElementById('aiVideo').classList.add('hidden')
            document.getElementById('aiCameraControls').classList.add('hidden')
            document.getElementById('aiAddPhotoBtn').classList.add('hidden')
            aiImages = []
            aiExtractedData = {}
            isPDF = false
        }

        // 返回步骤1
        function backToAIStep1() {
            resetAIRecognizeModal()
        }

        // 启动摄像头
        async function startAICamera() {
            const video = document.getElementById('aiVideo')
            try {
                aiStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                })
                video.srcObject = aiStream
                video.play()
                video.classList.remove('hidden')
                document.getElementById('aiPlaceholder').classList.add('hidden')
                document.getElementById('aiPreviewContainer').classList.add('hidden')
                document.getElementById('aiCameraControls').classList.remove('hidden')
            } catch (error) {
                alert('无法启动摄像头，请确保已授予权限')
            }
        }

        // 停止摄像头
        function stopAICamera() {
            if (aiStream) {
                aiStream.getTracks().forEach(track => track.stop())
                aiStream = null
            }
            document.getElementById('aiVideo').classList.add('hidden')
            document.getElementById('aiCameraControls').classList.add('hidden')
            if (aiImages.length === 0) {
                document.getElementById('aiPlaceholder').classList.remove('hidden')
            }
        }

        // 拍照
        function captureAIPhoto() {
            const video = document.getElementById('aiVideo')
            const canvas = document.getElementById('aiCanvas')
            const ctx = canvas.getContext('2d')
            canvas.width = video.videoWidth
            canvas.height = video.videoHeight
            ctx.drawImage(video, 0, 0)
            const imageData = canvas.toDataURL('image/jpeg', 0.9)
            
            addAIImage(imageData)
            stopAICamera()
            
            // 如果只有1张图片，显示"再拍一张"按钮
            if (aiImages.length === 1) {
                document.getElementById('aiAddPhotoBtn').classList.remove('hidden')
            } else if (aiImages.length >= 2) {
                // 2张图片后开始识别
                document.getElementById('aiAddPhotoBtn').classList.add('hidden')
                startAIRecognition(aiImages)
            }
        }

        // 添加图片到列表
        function addAIImage(imageData) {
            aiImages.push(imageData)
            updateAIPreview()
        }

        // 更新预览显示
        function updateAIPreview() {
            document.getElementById('aiPlaceholder').classList.add('hidden')
            document.getElementById('aiPreviewContainer').classList.remove('hidden')
            
            if (aiImages.length >= 1) {
                document.getElementById('aiPreviewImg1').src = aiImages[0]
            }
            if (aiImages.length >= 2) {
                document.getElementById('aiPreviewImg2').src = aiImages[1]
                document.getElementById('aiPreview2Container').classList.remove('hidden')
            }
        }

        // 处理文件选择（支持PDF）
        async function handleAIFileSelect(event) {
            const file = event.target.files[0]
            if (!file) return
            
            // 检查文件类型
            if (file.type === 'application/pdf') {
                isPDF = true
                await handlePDFUpload(file)
            } else {
                // 图片文件
                isPDF = false
                const reader = new FileReader()
                reader.onload = function(e) {
                    addAIImage(e.target.result)
                    // 单张图片直接识别
                    if (aiImages.length === 1) {
                        startAIRecognition(aiImages)
                    }
                }
                reader.readAsDataURL(file)
            }
        }

        // 处理PDF上传
        async function handlePDFUpload(file) {
            try {
                console.log('开始处理PDF文件:', file.name, '大小:', file.size, '类型:', file.type)
                
                // 检查文件大小
                if (file.size === 0) {
                    throw new Error('PDF文件为空')
                }
                
                // 使用PDF.js解析PDF
                const pdfData = await file.arrayBuffer()
                console.log('PDF数据读取成功, 大小:', pdfData.byteLength)
                
                if (pdfData.byteLength === 0) {
                    throw new Error('PDF数据为空')
                }
                
                // 检查PDF文件头
                const header = new Uint8Array(pdfData.slice(0, 5))
                const headerStr = String.fromCharCode(...header)
                console.log('PDF文件头:', headerStr)
                
                if (headerStr !== '%PDF-') {
                    console.warn('PDF文件头可能不正确:', headerStr)
                }
                
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise
                console.log('PDF解析成功, 总页数:', pdf.numPages)
                
                const totalPages = pdf.numPages
                if (totalPages === 0) {
                    throw new Error('PDF没有页面')
                }
                
                const pagesToExtract = Math.min(2, totalPages)
                console.log('将提取', pagesToExtract, '页')
                
                // 提取每一页为图片
                for (let pageNum = 1; pageNum <= pagesToExtract; pageNum++) {
                    console.log('正在处理第', pageNum, '页...')
                    const page = await pdf.getPage(pageNum)
                    const scale = 2
                    const viewport = page.getViewport({ scale })
                    
                    const canvas = document.createElement('canvas')
                    const ctx = canvas.getContext('2d')
                    canvas.width = viewport.width
                    canvas.height = viewport.height
                    
                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.9)
                    addAIImage(imageData)
                    console.log('第', pageNum, '页转换完成')
                }
                
                // 开始识别
                startAIRecognition(aiImages)
                
            } catch (error) {
                console.error('PDF解析失败:', error)
                console.error('错误详情:', error.message, error.stack)
                alert('PDF解析失败: ' + error.message)
            }
        }

        // CORS代理
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ]
        
        async function fetchWithProxy(url, options = {}) {
            let lastError = null
            
            for (const proxy of CORS_PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url)
                    const response = await fetch(proxyUrl, options)
                    const text = await response.text()
                    
                    if (text.trim().startsWith('<') || text.includes('<!DOCTYPE')) {
                        console.warn(`代理 ${proxy} 返回HTML错误，尝试下一个`)
                        continue
                    }
                    
                    return {
                        ok: response.ok,
                        status: response.status,
                        text: () => Promise.resolve(text),
                        json: () => {
                            try {
                                return Promise.resolve(JSON.parse(text))
                            } catch (e) {
                                return Promise.reject(new Error('JSON解析失败'))
                            }
                        }
                    }
                } catch (error) {
                    console.warn(`代理 ${proxy} 失败:`, error.message)
                    lastError = error
                }
            }
            
            throw new Error('所有代理都失败: ' + (lastError?.message || '未知错误'))
        }

        // 豆包API使用AK/SK签名认证
        // 参考文档：https://www.volcengine.com/docs/82379/1298458
        
        // Base64解码函数
        function base64Decode(base64) {
            const binaryString = atob(base64)
            const bytes = new Uint8Array(binaryString.length)
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i)
            }
            return bytes
        }

        // 生成火山方舟签名
        async function generateVolcanoSignature(method, uri, body) {
            const accessKeyId = DOUBAO_CONFIG.ACCESS_KEY_ID
            // Secret Key是Base64编码的，需要解码
            const secretKey = base64Decode(DOUBAO_CONFIG.SECRET_ACCESS_KEY)
            
            // 调试：打印解码后的Secret Key长度
            console.log('Secret Key长度:', secretKey.length)
            console.log('Secret Key (hex):', Array.from(secretKey).map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32) + '...')
            
            // 1. 生成时间戳
            const now = new Date()
            const date = now.toISOString().slice(0, 10).replace(/-/g, '')  // YYYYMMDD
            const xDate = now.toUTCString()  // RFC1123格式
            
            // 2. 计算body的SHA256哈希
            const bodyHash = await sha256Hash(body || '')
            
            // 3. 构建规范请求
            const contentType = 'application/json'
            const canonicalHeaders = `content-type:${contentType}\n` +
                `host:ark.cn-beijing.volces.com\n` +
                `x-content-sha256:${bodyHash}\n` +
                `x-date:${xDate}\n`
            const signedHeaders = 'content-type;host;x-content-sha256;x-date'
            
            // 4. 构建待签名字符串
            const credentialScope = `${date}/cn-beijing/ark/request`
            const canonicalRequest = `${method}\n${uri}\n\n${canonicalHeaders}\n${signedHeaders}\n${bodyHash}`
            const canonicalRequestHash = await sha256Hash(canonicalRequest)
            const stringToSign = `HMAC-SHA256\n${xDate}\n${credentialScope}\n${canonicalRequestHash}`
            
            // 调试信息
            console.log('Canonical Request:', canonicalRequest)
            console.log('String to Sign:', stringToSign)
            
            // 5. 计算签名
            // kDate = HMAC_SHA256(secretKey, date)
            const kDate = await hmacSha256(secretKey, date)
            const kRegion = await hmacSha256(kDate, 'cn-beijing')
            const kService = await hmacSha256(kRegion, 'ark')
            const kSigning = await hmacSha256(kService, 'request')
            const signature = await hmacSha256Hex(kSigning, stringToSign)
            
            console.log('Signature:', signature)
            
            // 6. 构建Authorization头
            const authorization = `HMAC-SHA256 Credential=${accessKeyId}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`
            
            const headers = {
                'Authorization': authorization,
                'X-Date': xDate,
                'X-Content-Sha256': bodyHash,
                'Host': 'ark.cn-beijing.volces.com',
                'Content-Type': 'application/json'
            }
            
            console.log('请求头:', headers)
            
            return headers
        }

        // SHA256哈希
        async function sha256Hash(message) {
            const msgBuffer = new TextEncoder().encode(message)
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer)
            const hashArray = Array.from(new Uint8Array(hashBuffer))
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        }

        // HMAC-SHA256 (返回ArrayBuffer)
        async function hmacSha256(key, message) {
            let keyBuffer
            if (typeof key === 'string') {
                keyBuffer = new TextEncoder().encode(key)
            } else if (key instanceof Uint8Array) {
                keyBuffer = key
            } else if (key instanceof ArrayBuffer) {
                keyBuffer = new Uint8Array(key)
            } else {
                keyBuffer = new Uint8Array(key)
            }
            
            const msgBuffer = new TextEncoder().encode(message)
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBuffer,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            )
            
            return crypto.subtle.sign('HMAC', cryptoKey, msgBuffer)
        }

        // HMAC-SHA256 (返回Hex字符串)
        async function hmacSha256Hex(key, message) {
            const signature = await hmacSha256(key, message)
            const hashArray = Array.from(new Uint8Array(signature))
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        }

        // 开始AI识别
        async function startAIRecognition(images) {
            document.getElementById('aiStep1').classList.add('hidden')
            document.getElementById('aiStep2').classList.remove('hidden')
            document.getElementById('aiStatus').textContent = `正在AI分析${images.length}张图片...`
            
            try {
                aiExtractedData = await callDoubaoVisionAI(images)
                displayAIResult(aiExtractedData)
                
                document.getElementById('aiStep2').classList.add('hidden')
                document.getElementById('aiStep3').classList.remove('hidden')
            } catch (error) {
                console.error('AI识别失败:', error)
                alert('识别失败: ' + error.message)
                backToAIStep1()
            }
        }

        // 调用豆包多模态模型
        async function callDoubaoVisionAI(images) {
            // 处理多张图片
            const imageContents = images.map(imgData => {
                let base64 = imgData
                if (base64.includes(',')) {
                    base64 = base64.split(',')[1]
                }
                return {
                    type: 'image_url',
                    image_url: {
                        url: `data:image/jpeg;base64,${base64}`
                    }
                }
            })
            
            const prompt = `提取标准物质标签信息，直接返回JSON：

单标格式：
{"name":"","code":"","batchNumber":"","manufacturer":"","isMixedStandard":false,"components":[{"name":"","value":"","unit":"","uncertainty":""}],"storageCondition":"","dilutionCondition":"","expiryDate":""}

混标格式（多个组分）：
{"name":"","code":"","batchNumber":"","manufacturer":"","isMixedStandard":true,"components":[{"name":"铜","value":"100","unit":"μg/mL","uncertainty":"0.5%"},{"name":"锌","value":"100","unit":"μg/mL","uncertainty":"0.5%"},{"name":"铅","value":"100","unit":"μg/mL","uncertainty":"0.5%"}],"storageCondition":"","dilutionCondition":"","expiryDate":""}

规则：
1. 只输出JSON，不要任何其他内容
2. isMixedStandard: true表示混标，false表示单标
3. components数组包含所有组分，每个组分有name(组分名)、value(标准值)、unit(单位)、uncertainty(不确定度)
4. 单标时components数组只有1个元素
5. 混标时components数组有多个元素
6. 日期格式YYYY-MM-DD
7. 找不到的字段留空
8. 禁止解释、禁止思考过程`

            const requestBody = JSON.stringify({
                model: DOUBAO_CONFIG.MODEL,
                messages: [
                    {
                        role: 'system',
                        content: '你只输出JSON，禁止任何解释、思考过程、markdown格式。直接返回纯JSON文本。'
                    },
                    {
                        role: 'user',
                        content: [
                            ...imageContents,
                            {
                                type: 'text',
                                text: prompt
                            }
                        ]
                    }
                ],
                temperature: 0,
                max_tokens: 400,
                stream: false
            })
            
            // 使用API Key认证（Bearer Token）
            const authHeaders = {
                'Authorization': `Bearer ${DOUBAO_CONFIG.API_KEY}`,
                'Content-Type': 'application/json'
            }
            
            let responseText = ''
            try {
                // 先尝试直接调用，看具体错误
                let response
                try {
                    response = await fetch(DOUBAO_CONFIG.ENDPOINT, {
                        method: 'POST',
                        headers: authHeaders,
                        body: requestBody
                    })
                } catch (directError) {
                    console.log('直接调用失败，尝试代理:', directError.message)
                    response = await fetchWithProxy(DOUBAO_CONFIG.ENDPOINT, {
                        method: 'POST',
                        headers: authHeaders,
                        body: requestBody
                    })
                }
                
                responseText = await response.text()
                console.log('豆包API原始响应:', responseText)
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} - ${responseText.substring(0, 200)}`)
                }
            } catch (fetchError) {
                console.error('API请求错误:', fetchError)
                throw new Error('API请求失败: ' + fetchError.message)
            }
            
            let result
            try {
                result = JSON.parse(responseText)
            } catch (parseError) {
                console.error('JSON解析失败:', responseText)
                throw new Error('返回格式错误')
            }
            
            const aiContent = result.choices?.[0]?.message?.content || ''
            console.log('AI返回内容:', aiContent)
            
            if (!aiContent) {
                throw new Error('AI返回内容为空')
            }
            
            try {
                return JSON.parse(aiContent)
            } catch (e) {
                const jsonMatch = aiContent.match(/\{[\s\S]*?\}/)
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0])
                }
                throw new Error('无法解析JSON')
            }
        }

        // 显示AI识别结果
        function displayAIResult(data) {
            const preview = document.getElementById('aiResultPreview')

            // 基础字段
            const fields = [
                { key: 'name', label: '名称' },
                { key: 'code', label: '编号' },
                { key: 'batchNumber', label: '批号' },
                { key: 'manufacturer', label: '厂家' },
                { key: 'storageCondition', label: '保存条件' },
                { key: 'dilutionCondition', label: '稀释条件' },
                { key: 'expiryDate', label: '有效期' }
            ]

            let html = ''

            // 显示基础字段
            fields.forEach(field => {
                const value = data[field.key]
                if (value) {
                    html += `<div class="flex justify-between py-1 border-b border-gray-200">
                        <span class="text-gray-500">${field.label}:</span>
                        <span class="font-medium">${value}</span>
                    </div>`
                }
            })

            // 显示组分信息（支持混标）
            if (data.components && Array.isArray(data.components) && data.components.length > 0) {
                const isMixed = data.isMixedStandard || data.components.length > 1
                html += `<div class="py-2 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-500">${isMixed ? '混标组分' : '组分信息'}:</span>
                        <span class="text-xs text-primary">${data.components.length}个组分</span>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-600 text-xs">
                                    <th class="text-left py-1">组分</th>
                                    <th class="text-left py-1">标准值</th>
                                    <th class="text-left py-1">单位</th>
                                    <th class="text-left py-1">不确定度</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.components.map(c => `
                                    <tr class="border-t border-gray-200">
                                        <td class="py-1">${c.name || '-'}</td>
                                        <td class="py-1">${c.value || c.concentration || '-'}</td>
                                        <td class="py-1">${c.unit || '-'}</td>
                                        <td class="py-1">${c.uncertainty || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`
            } else if (data.concentration) {
                // 兼容旧格式
                html += `<div class="flex justify-between py-1 border-b border-gray-200">
                    <span class="text-gray-500">标准值:</span>
                    <span class="font-medium">${data.concentration} ${data.unit || ''}</span>
                </div>`
                if (data.uncertainty) {
                    html += `<div class="flex justify-between py-1 border-b border-gray-200">
                        <span class="text-gray-500">不确定度:</span>
                        <span class="font-medium">${data.uncertainty}</span>
                    </div>`
                }
            }

            if (!html) {
                html = '<p class="text-gray-400">未能识别到有效信息</p>'
            }

            preview.innerHTML = html
        }

        // 应用AI结果到表单
        function applyAIResult() {
            const form = document.getElementById('addStockForm')

            if (aiExtractedData.name) form.querySelector('[name="name"]').value = aiExtractedData.name
            if (aiExtractedData.code) form.querySelector('[name="code"]').value = aiExtractedData.code
            if (aiExtractedData.batchNumber) form.querySelector('[name="batchNumber"]').value = aiExtractedData.batchNumber
            if (aiExtractedData.manufacturer) form.querySelector('[name="manufacturer"]').value = aiExtractedData.manufacturer
            if (aiExtractedData.storageCondition) form.querySelector('[name="storageCondition"]').value = aiExtractedData.storageCondition
            if (aiExtractedData.dilutionCondition) form.querySelector('[name="dilutionCondition"]').value = aiExtractedData.dilutionCondition
            if (aiExtractedData.expiryDate) form.querySelector('[name="expiryDate"]').value = aiExtractedData.expiryDate

            // 处理组分信息（支持混标）
            if (aiExtractedData.components && Array.isArray(aiExtractedData.components)) {
                fillComponentsWithAIData(aiExtractedData.components)
            } else if (aiExtractedData.concentration) {
                // 兼容旧格式：单标
                fillComponentsWithAIData([{
                    name: '',
                    value: aiExtractedData.concentration,
                    unit: aiExtractedData.unit || '',
                    uncertainty: aiExtractedData.uncertainty || ''
                }])
            }

            closeAIRecognizeModal()
            const isMixed = aiExtractedData.isMixedStandard || (aiExtractedData.components && aiExtractedData.components.length > 1)
            alert(`识别结果已填入表单${isMixed ? '（检测到混标，已自动添加' + aiExtractedData.components.length + '个组分）' : ''}，请核对后保存`)
        }

        // 使用AI数据填充组分表格
        function fillComponentsWithAIData(components) {
            const container = document.getElementById('componentsContainer')

            // 清除现有的组分行（保留表头）
            const rows = container.querySelectorAll('.component-row')
            rows.forEach(row => row.remove())

            // 为每个组分创建一行
            components.forEach((comp, index) => {
                const newRow = document.createElement('div')
                newRow.className = 'component-row grid grid-cols-12 gap-2'
                newRow.innerHTML = `
                    <div class="col-span-3">
                        <input type="text" name="componentName[]" class="form-input text-sm py-1" placeholder="如：铜" value="${comp.name || ''}">
                    </div>
                    <div class="col-span-3">
                        <input type="text" name="componentValue[]" class="form-input text-sm py-1" placeholder="如：100" value="${comp.value || comp.concentration || ''}">
                    </div>
                    <div class="col-span-3">
                        <input type="text" name="componentUnit[]" class="form-input text-sm py-1" placeholder="如：μg/mL" value="${comp.unit || ''}">
                    </div>
                    <div class="col-span-2">
                        <input type="text" name="componentUncertainty[]" class="form-input text-sm py-1" placeholder="如：0.5%" value="${comp.uncertainty || ''}">
                    </div>
                    <div class="col-span-1 flex items-center justify-center">
                        <button type="button" onclick="removeComponentRow(this)" class="text-red-500 hover:text-red-700 ${index === 0 ? 'hidden' : ''}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `
                container.appendChild(newRow)
            })

            updateRemoveButtons()
        }

        // ==================== 设置功能 ====================
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show')
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show')
            document.getElementById('changePasswordForm').reset()
        }

        async function handleChangePassword(e) {
            e.preventDefault()
            showLoading(true)
            
            const newPassword = e.target.newPassword.value
            const confirmPassword = e.target.confirmPassword.value
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的密码不一致！')
                showLoading(false)
                return
            }
            
            try {
                if (isOfflineMode) {
                    // 离线模式更新密码
                    let personnel = LocalStorage.get('personnel') || []
                    const user = personnel.find(p => p.id == currentUser.id)
                    if (user) {
                        user.password = newPassword
                        LocalStorage.set('personnel', personnel)
                        currentUser.password = newPassword
                        LocalStorage.set('currentUser', currentUser)
                    }
                } else {
                    const { error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    })
                    if (error) throw error
                }
                
                closeChangePasswordModal()
                alert('密码修改成功！')
            } catch (error) {
                alert('修改失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // ==================== Excel导出 ====================
        async function exportData() {
            showLoading(true)
            try {
                let stock = []
                let records = []
                let personnel = []
                
                if (isOfflineMode) {
                    stock = LocalStorage.get('stock') || []
                    records = LocalStorage.get('records') || []
                    personnel = LocalStorage.get('personnel') || []
                } else {
                    // 在线模式下从Supabase获取数据
                    const [{ data: stockData }, { data: recordsData }, { data: personnelData }] = await Promise.all([
                        supabaseClient.from('stock_items').select('*'),
                        supabaseClient.from('operation_records').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('profiles').select('*')
                    ])
                    stock = stockData || []
                    records = recordsData || []
                    personnel = personnelData || []
                }
                
                const wb = XLSX.utils.book_new()
                
                // 库存数据
                const stockData = stock.map(item => ({
                    '标准物质名称': item.name,
                    '编号': item.code,
                    '批次号': item.batch_number || item.batchNumber,
                    '唯一标识': item.unique_id || item.uniqueId,
                    '数量': item.quantity,
                    '有效期': item.expiry_date || item.expiryDate,
                    '状态': item.status
                }))
                
                const stockWS = XLSX.utils.json_to_sheet(stockData)
                XLSX.utils.book_append_sheet(wb, stockWS, "库存数据")
                
                // 记录数据
                const recordsData = records.map(r => ({
                    '类型': r.type === 'in' ? '入库' : '出库',
                    '物质名称': r.material_name || r.materialName,
                    '数量': r.quantity,
                    '操作人': r.operator_name || r.operator,
                    '时间': new Date(r.created_at || r.date).toLocaleString('zh-CN'),
                    '备注': r.note
                }))
                
                const recordsWS = XLSX.utils.json_to_sheet(recordsData)
                XLSX.utils.book_append_sheet(wb, recordsWS, "操作记录")
                
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' })
                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' })
                const link = document.createElement('a')
                link.href = URL.createObjectURL(blob)
                link.download = `标准物质管理数据_${new Date().toISOString().slice(0, 10)}.xlsx`
                link.click()
                
                showToast('数据导出成功', 'success')
            } catch (error) {
                console.error('导出失败:', error)
                showToast('导出失败: ' + error.message, 'error')
            } finally {
                showLoading(false)
            }
        }

        function s2ab(s) {
            const buf = new ArrayBuffer(s.length)
            const view = new Uint8Array(buf)
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF
            return buf
        }

        // ==================== Excel导入 ====================
        function importData() {
            const input = document.createElement('input')
            input.type = 'file'
            input.accept = '.xlsx,.xls'
            input.onchange = async (e) => {
                const file = e.target.files[0]
                if (!file) return
                
                showLoading(true)
                try {
                    const data = await file.arrayBuffer()
                    const workbook = XLSX.read(data, { type: 'array' })
                    
                    let importCount = 0
                    
                    // 导入库存数据
                    const stockSheet = workbook.Sheets['库存数据']
                    if (stockSheet) {
                        const stockData = XLSX.utils.sheet_to_json(stockSheet)
                        const formattedStock = stockData.map(row => ({
                            id: generateId(),
                            name: row['标准物质名称'] || '',
                            code: row['编号'] || '',
                            batch_number: row['批次号'] || '',
                            unique_id: row['唯一标识'] || '',
                            quantity: parseInt(row['数量']) || 0,
                            expiry_date: row['有效期'] || '',
                            status: row['状态'] || '正常',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }))
                        
                        if (isOfflineMode) {
                            const existing = LocalStorage.get('stock') || []
                            LocalStorage.set('stock', [...existing, ...formattedStock])
                        } else {
                            // 在线模式：批量插入到Supabase
                            for (const item of formattedStock) {
                                await supabaseClient.from('stock_items').insert([item])
                            }
                        }
                        importCount += formattedStock.length
                    }
                    
                    // 导入记录数据
                    const recordsSheet = workbook.Sheets['操作记录']
                    if (recordsSheet) {
                        const recordsData = XLSX.utils.sheet_to_json(recordsSheet)
                        const formattedRecords = recordsData.map(row => ({
                            id: generateId(),
                            type: row['类型'] === '入库' ? 'in' : 'out',
                            material_name: row['物质名称'] || '',
                            quantity: parseInt(row['数量']) || 0,
                            operator_name: row['操作人'] || '',
                            note: row['备注'] || '',
                            created_at: new Date().toISOString()
                        }))
                        
                        if (isOfflineMode) {
                            const existing = LocalStorage.get('records') || []
                            LocalStorage.set('records', [...existing, ...formattedRecords])
                        } else {
                            // 在线模式：批量插入到Supabase
                            for (const record of formattedRecords) {
                                await supabaseClient.from('operation_records').insert([record])
                            }
                        }
                        importCount += formattedRecords.length
                    }
                    
                    showToast(`成功导入 ${importCount} 条数据`, 'success')
                    
                    // 刷新页面数据
                    if (typeof loadDashboardData === 'function') loadDashboardData()
                    if (typeof loadStockData === 'function') loadStockData()
                    if (typeof loadRecordsData === 'function') loadRecordsData()
                    
                } catch (error) {
                    console.error('导入失败:', error)
                    showToast('导入失败: ' + error.message, 'error')
                } finally {
                    showLoading(false)
                }
            }
            input.click()
        }

        // ==================== 离线模式切换 ====================
        function toggleOfflineMode() {
            // 切换离线模式状态
            isOfflineMode = !isOfflineMode
            LocalStorage.set('offlineMode', isOfflineMode)
            
            const status = document.getElementById('offlineStatus')
            if (status) status.textContent = isOfflineMode ? '当前: 离线' : '当前: 在线'
            
            if (isOfflineMode) {
                // 切换到离线模式，初始化本地数据
                if (!LocalStorage.get('personnel')) {
                    LocalStorage.set('personnel', [
                        { id: '1', name: '系统管理员', username: 'admin@example.com', password: 'admin123', role: 'admin' }
                    ])
                }
                alert('已切换到离线模式，数据将保存在本地')
            } else {
                alert('已切换到在线模式，请重新登录')
                location.reload()
            }
        }

        // ==================== 数据管理 ====================
        function clearAllData() {
            if (!confirm('确定要清空所有数据吗？此操作不可恢复！')) return
            
            if (isOfflineMode) {
                LocalStorage.set('stock', [])
                LocalStorage.set('records', [])
                LocalStorage.set('messages', [])
            } else {
                alert('在线模式下无法一键清空，请使用Supabase Dashboard')
                return
            }
            
            refreshAllData()
            alert('所有数据已清空！')
        }

        // ==================== 实时订阅 ====================
        function setupRealtimeSubscriptions() {
            try {
                // 订阅库存变化
                supabaseClient
                    .channel('stock_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'stock_items' },
                        (payload) => {
                            console.log('库存变化:', payload)
                            refreshDashboard()
                            renderStockList()
                        }
                    )
                    .subscribe()
            } catch (error) {
                console.error('设置实时订阅失败:', error)
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body })
            }
        }

        // 更新最近临期预警显示（在统计卡片中）
        function updateNearestExpiryWarning(warningItems) {
            const nameElement = document.getElementById('nearestExpiryName')
            const countElement = document.getElementById('expiryWarning')
            const iconElement = document.getElementById('warningTriangleIcon')
            
            if (warningItems.length > 0) {
                // 按过期日期排序，找出最近要过期的
                warningItems.sort((a, b) => {
                    const dateA = new Date(a.expiry_date || a.expiryDate)
                    const dateB = new Date(b.expiry_date || b.expiryDate)
                    return dateA - dateB
                })
                
                // 获取最近要过期的标准物质
                const nearestItem = warningItems[0]
                const nearestExpiryName = nearestItem.name
                const nearestExpiryDate = new Date(nearestItem.expiry_date || nearestItem.expiryDate)
                
                // 计算剩余天数
                const today = new Date()
                today.setHours(0, 0, 0, 0)
                nearestExpiryDate.setHours(0, 0, 0, 0)
                const daysRemaining = Math.ceil((nearestExpiryDate - today) / (1000 * 60 * 60 * 24))
                
                // 统计该标准物质的即将过期数量
                const nameCount = warningItems.filter(item => item.name === nearestExpiryName)
                    .reduce((sum, item) => sum + (item.quantity || 0), 0)
                
                // 更新显示：名称+剩余天数显示在上方，数量显示在下方
                nameElement.textContent = `${nearestExpiryName} · 剩余${daysRemaining}天过期`
                countElement.textContent = nameCount
                
                // 添加闪烁动画到三角叹号
                iconElement.classList.add('blink-animation')
            } else {
                // 没有预警时恢复默认显示
                nameElement.textContent = '近效期预警'
                countElement.textContent = '0'
                iconElement.classList.remove('blink-animation')
            }
        }

        // ==================== 通用功能 ====================
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay')
            if (show) overlay.classList.add('show')
            else overlay.classList.remove('show')
        }

        function closeModalOnBg(event, modalId) {
            if (event.target.id === modalId) {
                document.getElementById(modalId).classList.remove('show')
            }
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show')
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('show')
            document.getElementById('registerForm').reset()
        }

        // ==================== 人员消息功能 ====================
        let currentMessageTab = 'received'
        let currentMessages = []
        let currentReplyMessageId = null

        // 切换消息标签
        function switchMessageTab(tab, element) {
            currentMessageTab = tab

            // 更新标签样式
            document.querySelectorAll('#messagesPage .tab-nav-item').forEach(item => {
                item.classList.remove('active')
            })
            element.classList.add('active')

            // 重新渲染消息列表
            renderMessagesList()
        }

        // 渲染消息列表
        async function renderMessagesList() {
            const container = document.getElementById('messagesList')

            if (isOfflineMode) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-wifi text-4xl mb-2 text-gray-400"></i>
                        <p>离线模式下无法查看消息</p>
                    </div>
                `
                return
            }

            try {
                showLoading(true)

                let query = supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })

                if (currentMessageTab === 'received') {
                    query = query.eq('recipient_id', currentUser.id)
                } else {
                    query = query.eq('sender_id', currentUser.id)
                }

                const { data: messages, error } = await query

                if (error) throw error

                currentMessages = messages || []

                if (currentMessages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fa fa-comments text-4xl mb-2"></i>
                            <p>暂无${currentMessageTab === 'received' ? '收到' : '发送'}的消息</p>
                        </div>
                    `
                    return
                }

                container.innerHTML = currentMessages.map(msg => {
                    const isUnread = currentMessageTab === 'received' && !msg.is_read
                    const senderName = msg.sender_name || '未知用户'
                    const recipientName = msg.recipient_name || '未知用户'
                    const displayName = currentMessageTab === 'received' ? senderName : `发给: ${recipientName}`
                    const time = new Date(msg.created_at).toLocaleString('zh-CN')
                    const preview = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '')

                    return `
                        <div class="message-item ${isUnread ? 'unread' : ''}" onclick="openMessageDetail('${msg.id}')">
                            <div class="message-item-header">
                                <span class="message-sender">
                                    ${escapeHtml(displayName)}
                                    ${isUnread ? '<span class="unread-dot"></span>' : ''}
                                </span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-preview">${escapeHtml(preview)}</div>
                        </div>
                    `
                }).join('')

            } catch (error) {
                console.error('加载消息失败:', error)
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-exclamation-circle text-4xl mb-2 text-red-500"></i>
                        <p>加载消息失败</p>
                    </div>
                `
            } finally {
                showLoading(false)
            }
        }

        // 显示发送消息模态框
        async function showSendMessageModal() {
            if (isOfflineMode) {
                alert('离线模式下无法发送消息')
                return
            }

            // 加载人员列表
            const recipientSelect = document.getElementById('messageRecipient')
            recipientSelect.innerHTML = '<option value="">选择接收人</option>'

            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('id, name')
                    .neq('id', currentUser.id)

                if (error) throw error

                users.forEach(user => {
                    const option = document.createElement('option')
                    option.value = user.id
                    option.textContent = user.name || '未命名用户'
                    recipientSelect.appendChild(option)
                })
            } catch (error) {
                console.error('加载人员列表失败:', error)
            }

            document.getElementById('sendMessageModal').classList.add('show')
        }

        function closeSendMessageModal() {
            document.getElementById('sendMessageModal').classList.remove('show')
            document.getElementById('sendMessageForm').reset()
        }

        // 处理发送消息
        async function handleSendMessage(event) {
            event.preventDefault()

            const formData = new FormData(event.target)
            const recipientId = formData.get('recipient_id')
            const content = formData.get('content')

            if (!recipientId || !content.trim()) {
                alert('请填写完整信息')
                return
            }

            try {
                showLoading(true)

                // 获取接收人名称
                const { data: recipient } = await supabaseClient
                    .from('profiles')
                    .select('name')
                    .eq('id', recipientId)
                    .single()

                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        sender_id: currentUser.id,
                        sender_name: currentUser.name || currentUser.email,
                        recipient_id: recipientId,
                        recipient_name: recipient?.name || '未知用户',
                        content: content.trim(),
                        is_read: false
                    }])

                if (error) throw error

                alert('消息发送成功！')
                closeSendMessageModal()

                // 如果当前在发送的消息标签页，刷新列表
                if (currentMessageTab === 'sent') {
                    renderMessagesList()
                }

            } catch (error) {
                console.error('发送消息失败:', error)
                alert('发送消息失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 打开消息详情
        async function openMessageDetail(messageId) {
            const message = currentMessages.find(m => m.id === messageId)
            if (!message) return

            currentReplyMessageId = messageId

            const isReceived = currentMessageTab === 'received'
            const senderName = message.sender_name || '未知用户'
            const recipientName = message.recipient_name || '未知用户'
            const time = new Date(message.created_at).toLocaleString('zh-CN')

            // 如果是收到的消息，标记为已读
            if (isReceived && !message.is_read) {
                try {
                    await supabaseClient
                        .from('messages')
                        .update({ is_read: true })
                        .eq('id', messageId)

                    message.is_read = true
                    renderMessagesList()
                    updateUnreadBadge()
                } catch (error) {
                    console.error('标记已读失败:', error)
                }
            }

            document.getElementById('messageDetailContent').innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-500 mb-2">
                        <span><strong>发送人:</strong> ${escapeHtml(senderName)}</span>
                        <span>${time}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500 mb-4">
                        <span><strong>接收人:</strong> ${escapeHtml(recipientName)}</span>
                        <span>${message.is_read ? '已读' : '未读'}</span>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="whitespace-pre-wrap">${escapeHtml(message.content)}</p>
                    </div>
                </div>
            `

            // 只有在收到的消息中才显示回复区域
            document.getElementById('messageReplySection').style.display = isReceived ? 'block' : 'none'
            document.getElementById('replyContent').value = ''

            document.getElementById('messageDetailModal').classList.add('show')
        }

        function closeMessageDetailModal() {
            document.getElementById('messageDetailModal').classList.remove('show')
            currentReplyMessageId = null
        }

        // 发送回复
        async function sendReply() {
            const content = document.getElementById('replyContent').value.trim()

            if (!content) {
                alert('请输入回复内容')
                return
            }

            if (!currentReplyMessageId) return

            const originalMessage = currentMessages.find(m => m.id === currentReplyMessageId)
            if (!originalMessage) return

            try {
                showLoading(true)

                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        sender_id: currentUser.id,
                        sender_name: currentUser.name || currentUser.email,
                        recipient_id: originalMessage.sender_id,
                        recipient_name: originalMessage.sender_name,
                        content: content,
                        is_read: false,
                        parent_id: currentReplyMessageId
                    }])

                if (error) throw error

                alert('回复发送成功！')
                closeMessageDetailModal()

                // 刷新消息列表
                if (currentMessageTab === 'sent') {
                    renderMessagesList()
                }

            } catch (error) {
                console.error('发送回复失败:', error)
                alert('发送回复失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 更新未读消息徽章
        async function updateUnreadBadge() {
            if (isOfflineMode || !currentUser) {
                document.getElementById('unreadBadge').classList.add('hidden')
                document.getElementById('messageNavIcon').classList.remove('message-blink')
                return
            }

            try {
                const { count, error } = await supabaseClient
                    .from('messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('recipient_id', currentUser.id)
                    .eq('is_read', false)

                if (error) throw error

                const badge = document.getElementById('unreadBadge')
                const icon = document.getElementById('messageNavIcon')

                if (count && count > 0) {
                    badge.textContent = count > 99 ? '99+' : count
                    badge.classList.remove('hidden')
                    icon.classList.add('message-blink')
                } else {
                    badge.classList.add('hidden')
                    icon.classList.remove('message-blink')
                }

            } catch (error) {
                console.error('更新未读徽章失败:', error)
            }
        }

        // 启动消息轮询
        let messagePollingInterval = null

        function startMessagePolling() {
            // 立即更新一次
            updateUnreadBadge()

            // 每30秒轮询一次
            messagePollingInterval = setInterval(() => {
                updateUnreadBadge()
            }, 30000)
        }

        function stopMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval)
                messagePollingInterval = null
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }

        function previewImages(input, previewId) {
            const preview = document.getElementById(previewId)
            const placeholder = preview.nextElementSibling
            
            if (input.files.length > 3) {
                alert('最多只能上传3张图片')
                input.value = ''
                return
            }
            
            preview.innerHTML = ''
            preview.classList.remove('hidden')
            placeholder.classList.add('hidden')
            
            Array.from(input.files).forEach((file) => {
                const reader = new FileReader()
                reader.onload = function(e) {
                    preview.innerHTML += `
                        <div class="image-preview-item">
                            <img src="${e.target.result}" alt="">
                            <button type="button" onclick="this.parentElement.remove(); checkPreviewEmpty('${previewId}')" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    `
                }
                reader.readAsDataURL(file)
            })
        }

        // 处理入库表单图片/PDF上传
        async function handleStockImagesWithPDF(input, previewId, placeholderId) {
            const preview = document.getElementById(previewId)
            const placeholder = document.getElementById(placeholderId)
            
            if (input.files.length > 3) {
                alert('最多只能上传3个文件')
                input.value = ''
                return
            }
            
            preview.innerHTML = ''
            preview.classList.remove('hidden')
            placeholder.classList.add('hidden')
            
            let fileCount = 0
            
            for (const file of Array.from(input.files)) {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // 处理PDF文件
                    try {
                        console.log('开始解析PDF:', file.name, '大小:', file.size, '类型:', file.type)
                        
                        if (file.size === 0) {
                            throw new Error('PDF文件为空')
                        }
                        
                        const pdfData = await file.arrayBuffer()
                        console.log('PDF数据读取成功, 大小:', pdfData.byteLength)
                        
                        if (pdfData.byteLength === 0) {
                            throw new Error('PDF数据为空')
                        }
                        
                        // 检查PDF文件头
                        const header = new Uint8Array(pdfData.slice(0, 5))
                        const headerStr = String.fromCharCode(...header)
                        console.log('PDF文件头:', headerStr)
                        
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise
                        console.log('PDF解析成功, 总页数:', pdf.numPages)
                        
                        // 只提取PDF第一页作为预览
                        const page = await pdf.getPage(1)
                        const scale = 1.5
                        const viewport = page.getViewport({ scale })
                        
                        const canvas = document.createElement('canvas')
                        const ctx = canvas.getContext('2d')
                        canvas.width = viewport.width
                        canvas.height = viewport.height
                        
                        await page.render({
                            canvasContext: ctx,
                            viewport: viewport
                        }).promise
                        
                        const imageData = canvas.toDataURL('image/jpeg', 0.9)
                        console.log('PDF转换成功，图片数据长度:', imageData.length)
                        
                        // 创建预览元素
                        const previewDiv = document.createElement('div')
                        previewDiv.className = 'image-preview-item relative'
                        previewDiv.innerHTML = `
                            <img src="${imageData}" alt="PDF预览" onload="console.log('PDF预览图片加载成功')" onerror="console.error('PDF预览图片加载失败')">
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 text-center">
                                <i class="fa fa-file-pdf-o"></i> ${file.name.substring(0, 15)}...
                            </div>
                            <button type="button" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs pdf-remove-btn">
                                <i class="fa fa-times"></i>
                            </button>
                        `
                        // 使用事件监听器而不是onclick
                        previewDiv.querySelector('.pdf-remove-btn').addEventListener('click', function() {
                            previewDiv.remove()
                            checkPreviewEmpty(previewId)
                        })
                        
                        preview.appendChild(previewDiv)
                        fileCount++
                    } catch (error) {
                        console.error('PDF解析失败:', error)
                        console.error('错误详情:', error.message, error.stack)
                        alert(`PDF文件 "${file.name}" 解析失败: ${error.message}`)
                    }
                } else {
                    // 处理图片文件
                    const reader = new FileReader()
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div')
                        previewDiv.className = 'image-preview-item relative'
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="">
                            <button type="button" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs img-remove-btn">
                                <i class="fa fa-times"></i>
                            </button>
                        `
                        previewDiv.querySelector('.img-remove-btn').addEventListener('click', function() {
                            previewDiv.remove()
                            checkPreviewEmpty(previewId)
                        })
                        preview.appendChild(previewDiv)
                    }
                    reader.readAsDataURL(file)
                    fileCount++
                }
            }
        }

        function checkPreviewEmpty(previewId) {
            const preview = document.getElementById(previewId)
            const placeholder = preview.nextElementSibling
            if (preview.children.length === 0) {
                preview.classList.add('hidden')
                placeholder.classList.remove('hidden')
            }
        }

        function viewImage(imageData, caption) {
            const viewerImage = document.getElementById('viewerImage')
            const viewerCaption = document.getElementById('viewerCaption')
            
            // 显示加载中
            viewerImage.style.opacity = '0.5'
            viewerCaption.textContent = caption + ' (加载中...)'
            document.getElementById('imageViewerModal').classList.add('show')
            
            // 创建新图片对象预加载
            const img = new Image()
            img.onload = function() {
                viewerImage.src = imageData
                viewerImage.style.opacity = '1'
                viewerCaption.textContent = caption
            }
            img.onerror = function() {
                viewerImage.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="400" height="300" fill="%23f0f0f0"/><text x="200" y="150" text-anchor="middle" font-size="16" fill="%23999">图片加载失败</text></svg>'
                viewerImage.style.opacity = '1'
                viewerCaption.textContent = caption + ' (加载失败)'
                console.error('图片加载失败:', imageData.substring(0, 100) + '...')
            }
            img.src = imageData
        }

        // 查看PDF预览
        function viewPDF(pdfData) {
            // 在新窗口打开PDF预览
            const newWindow = window.open()
            if (newWindow) {
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>PDF预览</title>
                        <style>
                            body { margin: 0; padding: 20px; background: #f5f5f5; text-align: center; }
                            img { max-width: 100%; max-height: 90vh; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                        </style>
                    </head>
                    <body>
                        <img src="${pdfData}" alt="PDF预览">
                    </body>
                    </html>
                `)
            } else {
                alert('请允许弹出窗口以查看PDF')
            }
        }

        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.remove('show')
        }
    </script>
</body>
<