<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>标准物质管理助手 - Supabase版</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- 核心样式 - 内联关键CSS避免阻塞 -->
    <style>
        /* 关键CSS内联，避免等待Tailwind加载 */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif; background: #f1f5f9; }
        .page { display: none; min-height: 100vh; padding-bottom: 80px; }
        .page.active { display: block; }
        .header { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3); }
        .content { padding-top: 80px; padding-bottom: 80px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .card { background: white; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.875rem; }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .text-primary { color: #3b82f6; }
        .text-danger { color: #ef4444; }
        .text-success { color: #22c55e; }
        .text-warning { color: #f59e0b; }
        .bg-primary { background-color: #3b82f6; }
        .bg-danger { background-color: #ef4444; }
        .bg-success { background-color: #22c55e; }
        .bg-warning { background-color: #f59e0b; }
        .bg-info { background-color: #0ea5e9; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .min-h-screen { min-height: 100vh; }
        .fixed { position: fixed; }
        .absolute { position: absolute; }
        .relative { position: relative; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-50 { z-index: 50; }
        .z-100 { z-index: 100; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        /* 登录页面样式 */
        #loginPage { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #loginPage > div { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; margin: 1rem; }
    </style>
    
    <!-- 异步加载非关键CSS -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></noscript>
    
    <!-- 加载核心库（优先） -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <!-- 异步加载其他库 -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'PingFang SC', sans-serif; background: #f1f5f9; }
        
        .page { display: none; min-height: 100vh; padding-bottom: 80px; }
        .page.active { display: block; }
        
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }
        
        .content { margin-top: 4.5rem; padding: 1rem; }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .quick-action-btn {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .quick-action-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .quick-action-btn:active { transform: scale(0.98); }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-item.active { color: #3b82f6; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .nav-item span { font-size: 0.75rem; }
        
        .footer {
            background: white;
            border-top: 1px solid #e2e8f0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 28rem;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 3px solid #3b82f6;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #3b82f6;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-normal { background: #dcfce7; color: #166534; }
        .status-warning { background: #fef3c7; color: #92400e; }
        .status-danger { background: #fee2e2; color: #991b1b; }
        .status-info { background: #dbeafe; color: #1e40af; }
        
        .stock-group { border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem; }
        .stock-group-header { background: #f8fafc; padding: 1rem; cursor: pointer; }
        .stock-item { border-bottom: 1px solid #f1f5f9; padding: 1rem; }
        .stock-item:last-child { border-bottom: none; }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .activity-item:last-child { border-bottom: none; }
        
        .message-item {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            background: white;
        }
        
        .message-item:hover { 
            background: #f8fafc; 
            transform: translateX(4px);
        }
        
        .message-item.unread { 
            background: #eff6ff; 
            border-left: 4px solid #3b82f6;
        }
        
        .message-item.read {
            background: white;
            border-left: 4px solid transparent;
            opacity: 0.9;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-sender {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .message-content {
            color: #374151;
            line-height: 1.5;
            word-break: break-word;
        }
        
        .message-to {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #e2e8f0;
        }
        
        .unread-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .personnel-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .personnel-item:last-child { border-bottom: none; }
        
        .record-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .record-item:last-child { border-bottom: none; }
        
        .setting-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .setting-item:last-child { border-bottom: none; }
        
        .login-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            background: #ef4444;
            color: white;
            font-size: 0.625rem;
            min-width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.25rem;
        }
        
        .empty-state { text-align: center; padding: 2rem; color: #9ca3af; }
        
        .image-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 100%; height: 6rem; object-fit: cover; border-radius: 0.375rem; }
        
        .tab-nav { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .tab-nav-item { flex: 1; padding: 0.75rem; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-nav-item.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        
        .record-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .record-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .record-image-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .record-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 库存列表项预览样式 */
        .stock-item-preview {
            width: 60px;
            height: 60px;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            flex-shrink: 0;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stock-item-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stock-item-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .stock-item-preview.pdf-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fee2e2;
        }
        
        .stock-item-preview.pdf-preview i {
            font-size: 24px;
            color: #dc2626;
        }
        
        .preview-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #3b82f6;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        .record-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.75rem;
        }
        
        .image-viewer-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .image-viewer-modal.show { 
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .image-viewer-content {
            max-width: 95%;
            max-height: 95%;
            position: relative;
            animation: zoomIn 0.3s ease;
        }
        
        @keyframes zoomIn {
            from { 
                opacity: 0;
                transform: scale(0.9);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .image-viewer-content img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 101;
        }
        
        .image-viewer-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .image-viewer-caption {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            max-width: 80%;
            text-align: center;
        }
        
        .message-detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .message-detail-modal.show { display: flex; }
        
        .message-detail-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.show { display: flex; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 预警闪烁动画 */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .blink-animation {
            animation: blink 1s ease-in-out infinite;
        }

        /* 消息图标闪烁动画 */
        @keyframes messageBlink {
            0%, 100% { color: #64748b; }
            50% { color: #ef4444; }
        }

        .message-blink {
            animation: messageBlink 1s ease-in-out infinite;
        }

        /* 消息列表样式 */
        .message-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-item:hover {
            background: #f8fafc;
        }

        .message-item.unread {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .message-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            color: #1e293b;
        }

        .message-time {
            font-size: 12px;
            color: #64748b;
        }

        .message-preview {
            font-size: 14px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-item.unread .message-preview {
            color: #1e293b;
            font-weight: 500;
        }

        .unread-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">加载中...</p>
    </div>

    <!-- 登录页面 -->
    <div id="loginPage" class="page active" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%);">
        <div class="login-container">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-cubes text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-500 to-blue-700 bg-clip-text text-transparent">标准物质管理助手</h1>
                <p class="text-gray-500 mt-1">Supabase云端版 v2.0.0</p>
            </div>
            
            <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg mb-4 text-sm"></div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <div class="relative">
                        <input type="email" id="loginEmail" class="form-input pl-10" placeholder="请输入邮箱" required>
                        <i class="fa fa-envelope absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="form-input pl-10 pr-10" placeholder="请输入密码" required>
                        <i class="fa fa-lock absolute left-3 top-3 text-gray-400"></i>
                        <button type="button" onclick="togglePassword()" class="absolute right-3 top-3 text-gray-400">
                            <i class="fa fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="w-4 h-4 text-primary rounded">
                        <span class="ml-2 text-sm text-gray-600">记住我</span>
                    </label>
                </div>
                
                <button type="submit" class="w-full btn btn-primary py-3 text-base">
                    <i class="fa fa-sign-in mr-2"></i>登录
                </button>
            </form>
            
            <button onclick="showRegisterModal()" class="w-full mt-6 btn btn-secondary">
                <i class="fa fa-user-plus mr-2"></i>注册新账户
            </button>
            
            <!-- 网络诊断和离线模式 -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <div id="connectionStatus" class="text-xs text-gray-500 mb-2 text-center">
                    正在检查网络连接...
                </div>
                <div class="flex gap-2">
                    <button onclick="testConnection()" class="flex-1 py-2 px-3 bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs rounded transition-colors">
                        <i class="fa fa-stethoscope mr-1"></i>网络诊断
                    </button>
                    <button onclick="switchToOfflineMode()" class="flex-1 py-2 px-3 bg-orange-100 hover:bg-orange-200 text-orange-600 text-xs rounded transition-colors">
                        <i class="fa fa-wifi-slash mr-1"></i>离线模式
                    </button>
                </div>
                <div id="diagnosticInfo" class="hidden mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600 font-mono"></div>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="registerModal" class="modal" onclick="closeModalOnBg(event, 'registerModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">注册新账户</h2>
                <button onclick="closeRegisterModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">邮箱 <span class="text-red-500">*</span></label>
                            <input type="email" name="email" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="password" class="form-input" required minlength="6">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                            <select name="role" class="form-input">
                                <option value="user">普通用户</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeRegisterModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">注册</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="appContainer" style="display: none;">
        <!-- 头部 -->
        <div class="header flex items-center justify-between">
            <h1 id="pageTitle" class="text-xl font-bold flex items-center">
                <i class="fa fa-cubes mr-2"></i>
                <span>标准物质管理</span>
            </h1>
            <div class="flex items-center space-x-3">
                <!-- 刷新/同步按钮 -->
                <button onclick="refreshAndSyncData()" class="flex items-center p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" title="刷新并同步数据">
                    <i id="refreshIcon" class="fa fa-refresh mr-1"></i>
                    <span class="text-sm">刷新</span>
                </button>
                <button onclick="logout()" class="flex items-center p-2">
                    <i class="fa fa-user-circle text-xl mr-1"></i>
                    <span id="currentUserName" class="text-sm">管理员</span>
                </button>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content">
            <!-- 首页 -->
            <div id="dashboardPage" class="page active">
                <!-- 统计卡片 -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="stat-card">
                        <div>
                            <p class="text-sm text-gray-500">总库存</p>
                            <p id="totalStock" class="text-3xl font-bold text-primary">0</p>
                        </div>
                        <div class="stat-icon bg-blue-100">
                            <i class="fa fa-cubes text-primary"></i>
                        </div>
                    </div>
                    <div class="stat-card" onclick="navigateTo('stock')" style="cursor: pointer;">
                        <div>
                            <p id="nearestExpiryName" class="text-sm text-gray-500">近效期预警</p>
                            <p id="expiryWarning" class="text-3xl font-bold text-warning">0</p>
                        </div>
                        <div class="stat-icon bg-yellow-100">
                            <i id="warningTriangleIcon" class="fa fa-exclamation-triangle text-warning"></i>
                        </div>
                    </div>
                </div>

                <!-- 库存状态图表 -->
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-pie-chart text-primary mr-2"></i>
                        库存状态分布
                    </h2>
                    <div class="h-56">
                        <canvas id="stockStatusChart"></canvas>
                    </div>
                </div>

                <!-- 快速操作 -->
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-bolt text-warning mr-2"></i>
                        快速操作
                    </h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="quick-action-btn py-6" onclick="showAddStockModal()" ontouchstart="">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-3 pointer-events-none">
                                <i class="fa fa-archive text-primary text-2xl"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 pointer-events-none">入库登记</span>
                            <span class="text-xs text-gray-400 mt-1 pointer-events-none">新增标准物质</span>
                        </div>
                        <div class="quick-action-btn py-6" onclick="showScanModal()" ontouchstart="">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-3 pointer-events-none">
                                <i class="fa fa-qrcode text-success text-2xl"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 pointer-events-none">扫码查询</span>
                            <span class="text-xs text-gray-400 mt-1 pointer-events-none">扫描/查询出库</span>
                        </div>
                    </div>
                </div>

                <!-- 最近活动 -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-clock-o text-info mr-2"></i>
                            最近活动
                        </h2>
                        <button onclick="switchPage('records')" class="text-primary text-sm hover:underline">查看全部</button>
                    </div>
                    <div id="recentActivities">
                        <div class="empty-state">
                            <i class="fa fa-inbox text-4xl mb-2"></i>
                            <p>暂无活动记录</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 库存页面 -->
            <div id="stockPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="stockSearchInput" placeholder="搜索标准物质..." class="form-input pl-10" oninput="renderStockList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="tab-nav">
                    <div class="tab-nav-item active" onclick="switchStockTab('all', this)">全部</div>
                    <div class="tab-nav-item" onclick="switchStockTab('normal', this)">正常</div>
                    <div class="tab-nav-item" onclick="switchStockTab('warning', this)">临期</div>
                    <div class="tab-nav-item" onclick="switchStockTab('expired', this)">过期</div>
                </div>

                <div id="stockList">
                    <div class="empty-state">
                        <i class="fa fa-inbox text-4xl mb-2"></i>
                        <p>暂无库存数据</p>
                    </div>
                </div>
            </div>

            <!-- 消息页面 -->
            <div id="messagesPage" class="page">
                <div class="card mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold">消息中心</h2>
                        <button onclick="showSendMessageModal()" class="btn btn-primary btn-sm">
                            <i class="fa fa-plus mr-1"></i>发消息
                        </button>
                    </div>
                </div>

                <div class="tab-nav mb-4">
                    <div class="tab-nav-item active" onclick="switchMessageTab('received', this)">收到的消息</div>
                    <div class="tab-nav-item" onclick="switchMessageTab('sent', this)">发送的消息</div>
                </div>

                <div id="messagesList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-comments text-4xl mb-2"></i>
                        <p>暂无消息</p>
                    </div>
                </div>
            </div>

            <!-- 人员页面 -->
            <div id="personnelPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="personnelSearchInput" placeholder="搜索人员..." class="form-input pl-10" oninput="renderPersonnelList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">人员列表</h2>
                    <button onclick="showAddPersonnelModal()" class="btn btn-primary">
                        <i class="fa fa-plus mr-1"></i>添加
                    </button>
                </div>

                <div id="personnelList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-users text-4xl mb-2"></i>
                        <p>暂无人员数据</p>
                    </div>
                </div>
            </div>

            <!-- 记录页面 -->
            <div id="recordsPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="recordsSearchInput" placeholder="搜索记录..." class="form-input pl-10" oninput="renderRecordsList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div id="recordsList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-history text-4xl mb-2"></i>
                        <p>暂无操作记录</p>
                    </div>
                </div>
            </div>

            <!-- 设置页面 -->
            <div id="settingsPage" class="page">
                <div class="card mb-4">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-primary text-white rounded-full flex items-center justify-center text-2xl font-bold mr-4">
                            <span id="settingUserInitial">管</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="settingUserName">管理员</h2>
                            <p class="text-sm text-gray-500" id="settingUserRole">系统管理员</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="setting-item" onclick="showChangePasswordModal()">
                        <div class="flex items-center">
                            <i class="fa fa-lock text-primary mr-3"></i>
                            <span>修改密码</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="exportData()">
                        <div class="flex items-center">
                            <i class="fa fa-download text-success mr-3"></i>
                            <span>数据导出(Excel)</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="importData()">
                        <div class="flex items-center">
                            <i class="fa fa-upload text-primary mr-3"></i>
                            <span>数据导入(Excel)</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="toggleOfflineMode()">
                        <div class="flex items-center">
                            <i class="fa fa-wifi text-warning mr-3"></i>
                            <span>切换离线模式</span>
                        </div>
                        <span id="offlineStatus" class="text-sm text-gray-500">当前: 在线</span>
                    </div>
                    <div class="setting-item" onclick="clearAllData()">
                        <div class="flex items-center">
                            <i class="fa fa-trash text-danger mr-3"></i>
                            <span>清空数据</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item">
                        <div class="flex items-center">
                            <i class="fa fa-info-circle text-info mr-3"></i>
                            <span>关于系统</span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">v2.0.0 Supabase版</span>
                            <i class="fa fa-chevron-right text-gray-400 ml-2"></i>
                        </div>
                    </div>
                </div>

                <button onclick="logout()" class="w-full bg-white text-danger font-semibold py-3 rounded-lg mt-6 border border-gray-200">
                    <i class="fa fa-sign-out mr-2"></i>退出登录
                </button>
            </div>
        </div>

        <!-- 底部导航 -->
        <div class="footer">
            <div class="flex justify-around">
                <div class="nav-item active" onclick="switchPage('dashboard')">
                    <i class="fa fa-home"></i>
                    <span>首页</span>
                </div>
                <div class="nav-item" onclick="switchPage('stock')">
                    <i class="fa fa-cubes"></i>
                    <span>库存</span>
                </div>
                <div class="nav-item relative" onclick="switchPage('messages')">
                    <i class="fa fa-comments" id="messageNavIcon"></i>
                    <span>消息</span>
                    <span id="unreadBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </div>
                <div class="nav-item" onclick="switchPage('personnel')">
                    <i class="fa fa-users"></i>
                    <span>人员</span>
                </div>
                <div class="nav-item" onclick="switchPage('settings')">
                    <i class="fa fa-cog"></i>
                    <span>设置</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 扫码模态框 - 优化移动端适配 -->
    <div id="scanModal" class="modal" onclick="closeModalOnBg(event, 'scanModal')">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="text-lg font-bold">扫码出库</h2>
                <button onclick="closeScanModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- 手动输入区域 - 在移动端这是主要方式 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa fa-keyboard mr-1"></i>输入唯一标识码
                    </label>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="scanInput" 
                            class="form-input flex-1" 
                            placeholder="请输入唯一标识码（如：SM-2024-001）"
                            autocomplete="off"
                            inputmode="text"
                        >
                        <button onclick="handleScan()" class="btn btn-primary px-6">
                            <i class="fa fa-search mr-1"></i>查询
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">提示：输入唯一标识码后点击查询按钮</p>
                </div>

                <!-- 摄像头扫描区域 - 仅在HTTPS环境显示 -->
                <div id="cameraScanArea" class="mb-4 hidden">
                    <div class="relative bg-black rounded-lg overflow-hidden" style="height: 200px; max-height: 40vh;">
                        <video 
                            id="scanVideo" 
                            class="w-full h-full object-cover" 
                            playsinline
                            webkit-playsinline
                            muted
                        ></video>
                        <canvas id="scanCanvas" class="hidden"></canvas>
                        <div id="scanOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="border-2 border-white/50 rounded-lg w-40 h-40 relative">
                                <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-primary -mt-1 -ml-1"></div>
                                <div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-primary -mt-1 -mr-1"></div>
                                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-primary -mb-1 -ml-1"></div>
                                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-primary -mb-1 -mr-1"></div>
                                <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-primary/50 animate-pulse"></div>
                            </div>
                        </div>
                        <div id="scanLoading" class="absolute inset-0 bg-black/80 flex items-center justify-center hidden">
                            <div class="text-white text-center">
                                <i class="fa fa-spinner fa-spin text-3xl mb-2"></i>
                                <p class="text-sm">正在启动摄像头...</p>
                            </div>
                        </div>
                        <!-- 点击启动摄像头提示 -->
                        <div id="cameraStartHint" class="absolute inset-0 bg-black/60 flex items-center justify-center cursor-pointer" onclick="startCameraScan()">
                            <div class="text-white text-center p-4">
                                <i class="fa fa-camera text-4xl mb-2"></i>
                                <p class="text-sm">点击启动摄像头</p>
                                <p class="text-xs text-gray-300 mt-1">需要摄像头权限</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="startCameraScan()" class="btn btn-primary flex-1 py-2">
                            <i class="fa fa-camera mr-1"></i>启动摄像头
                        </button>
                        <button onclick="stopCameraScan()" class="btn btn-secondary flex-1 py-2">
                            <i class="fa fa-stop mr-1"></i>停止
                        </button>
                    </div>
                </div>

                <!-- 扫描结果显示区域 -->
                <div id="scanResult" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <!-- 扫描结果将显示在这里 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 二维码显示弹窗 -->
    <div id="qrCodeModal" class="modal" onclick="closeModalOnBg(event, 'qrCodeModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">物品二维码</h2>
                <button onclick="closeQRCodeModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 text-center">
                <div id="qrCodeContainer" class="mb-4 flex justify-center">
                    <!-- 二维码将显示在这里 -->
                </div>
                <div class="text-left bg-gray-50 p-3 rounded-lg mb-4">
                    <p class="text-sm"><span class="text-gray-500">名称：</span><span id="qrItemName" class="font-medium"></span></p>
                    <p class="text-sm"><span class="text-gray-500">唯一标识：</span><span id="qrItemUniqueId" class="font-medium"></span></p>
                </div>
                <p class="text-xs text-gray-400 mb-4">使用扫码功能扫描此二维码可快速出库</p>
                <!-- 打印按钮 -->
                <div class="flex gap-2 justify-center flex-wrap">
                    <button onclick="printLabelWithDetongDTPWeb()" class="btn btn-primary">
                        <i class="fa fa-print mr-1"></i>德佟打印
                    </button>
                    <button onclick="printLabelWithBrowser()" class="btn btn-secondary">
                        <i class="fa fa-chrome mr-1"></i>浏览器打印
                    </button>
                    <button onclick="printLabelSimple()" class="btn btn-secondary bg-green-50 text-green-600 border-green-200 hover:bg-green-100">
                        <i class="fa fa-qrcode mr-1"></i>简版打印
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">推荐使用德佟打印直接连接蓝牙打印机</p>
            </div>
        </div>
    </div>

    <div id="addStockModal" class="modal" onclick="closeModalOnBg(event, 'addStockModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">入库登记</h2>
                <button onclick="closeAddStockModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="addStockForm" onsubmit="handleStockIn(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准物质名称 <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准物质编号 <span class="text-red-500">*</span></label>
                            <input type="text" name="code" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">批次号</label>
                            <input type="text" name="batchNumber" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">唯一性标识方式</label>
                            <div class="flex space-x-4 mb-2">
                                <label class="flex items-center">
                                    <input type="radio" name="uniqueIdType" value="auto" checked class="mr-2" onchange="toggleUniqueIdInput()">
                                    <span>自动生成</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="uniqueIdType" value="manual" class="mr-2" onchange="toggleUniqueIdInput()">
                                    <span>手动输入</span>
                                </label>
                            </div>
                            <input type="text" name="uniqueId" id="manualUniqueId" class="form-input hidden" placeholder="请输入唯一性标识">
                        </div>
                        <!-- 混标组分表格 -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">组分信息（单标/混标）</label>
                                <button type="button" onclick="addComponentRow()" class="text-xs text-primary hover:text-blue-700">
                                    <i class="fa fa-plus mr-1"></i>添加组分
                                </button>
                            </div>
                            <div id="componentsContainer" class="space-y-2">
                                <!-- 表头 -->
                                <div class="grid grid-cols-12 gap-2 text-xs text-gray-500 text-center">
                                    <div class="col-span-3">组分名称</div>
                                    <div class="col-span-3">标准值</div>
                                    <div class="col-span-3">单位</div>
                                    <div class="col-span-2">不确定度</div>
                                    <div class="col-span-1"></div>
                                </div>
                                <!-- 默认第一行 -->
                                <div class="component-row grid grid-cols-12 gap-2">
                                    <div class="col-span-3">
                                        <input type="text" name="componentName[]" class="form-input text-sm py-1" placeholder="如：铜">
                                    </div>
                                    <div class="col-span-3">
                                        <input type="text" name="componentValue[]" class="form-input text-sm py-1" placeholder="如：100">
                                    </div>
                                    <div class="col-span-3">
                                        <input type="text" name="componentUnit[]" class="form-input text-sm py-1" placeholder="如：μg/mL">
                                    </div>
                                    <div class="col-span-2">
                                        <input type="text" name="componentUncertainty[]" class="form-input text-sm py-1" placeholder="如：0.5%">
                                    </div>
                                    <div class="col-span-1 flex items-center justify-center">
                                        <button type="button" onclick="removeComponentRow(this)" class="text-red-500 hover:text-red-700 hidden">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" name="manufacturer" class="form-input">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">保存条件</label>
                                <input type="text" name="storageCondition" class="form-input" placeholder="如：2-8℃冷藏">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">稀释条件</label>
                                <input type="text" name="dilutionCondition" class="form-input" placeholder="如：使用前用纯水稀释">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">数量 <span class="text-red-500">*</span></label>
                                <input type="number" name="quantity" class="form-input" min="1" value="1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">有效期 <span class="text-red-500">*</span></label>
                                <input type="date" name="expiryDate" class="form-input" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">图片/PDF上传</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary" onclick="document.getElementById('stockImages').click()">
                                <input type="file" id="stockImages" multiple accept="image/*,.pdf" class="hidden" onchange="handleStockImagesWithPDF(this, 'stockImagePreview', 'stockUploadPlaceholder')">
                                <div id="stockImagePreview" class="image-preview-grid mb-2 hidden"></div>
                                <div id="stockUploadPlaceholder">
                                    <i class="fa fa-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-sm">点击上传图片或PDF（最多3张）</p>
                                    <p class="text-xs text-gray-400">支持 JPG, PNG, PDF 格式</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddStockModal()" class="btn btn-secondary">取消</button>
                        <button type="button" onclick="showAIRecognizeModal()" class="btn btn-success">
                            <i class="fa fa-magic mr-1"></i>AI识别
                        </button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI识别模态框 -->
    <div id="aiRecognizeModal" class="modal" onclick="closeModalOnBg(event, 'aiRecognizeModal')">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="text-lg font-bold">
                    <i class="fa fa-magic mr-2"></i>AI智能识别
                </h2>
                <button onclick="closeAIRecognizeModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- 步骤1：上传 -->
                <div id="aiStep1" class="text-center">
                    <!-- 图片预览区域 -->
                    <div class="mb-4">
                        <div id="aiPreviewContainer" class="grid grid-cols-2 gap-2 hidden">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-2">
                                <img id="aiPreviewImg1" class="max-h-32 mx-auto">
                                <p class="text-xs text-gray-500 mt-1">图片1</p>
                            </div>
                            <div id="aiPreview2Container" class="border-2 border-dashed border-gray-300 rounded-lg p-2 hidden">
                                <img id="aiPreviewImg2" class="max-h-32 mx-auto">
                                <p class="text-xs text-gray-500 mt-1">图片2</p>
                            </div>
                        </div>
                        <div id="aiPlaceholder" class="border-2 border-dashed border-gray-300 rounded-lg p-8">
                            <i class="fa fa-file-image-o text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-500">上传图片或PDF文件</p>
                            <p class="text-xs text-gray-400 mt-1">支持 JPG, PNG, PDF 格式</p>
                            <p class="text-xs text-gray-400">最多2张图片或1个PDF</p>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex justify-center gap-3 flex-wrap">
                        <button type="button" onclick="document.getElementById('aiFileInput').click()" class="btn btn-primary">
                            <i class="fa fa-upload mr-1"></i>选择图片/PDF
                        </button>
                        <button type="button" onclick="startAICamera()" class="btn btn-info">
                            <i class="fa fa-camera mr-1"></i>拍照
                        </button>
                        <button type="button" id="aiAddPhotoBtn" onclick="startAICamera()" class="btn btn-warning hidden">
                            <i class="fa fa-plus mr-1"></i>再拍一张
                        </button>
                    </div>
                    
                    <input type="file" id="aiFileInput" accept="image/*,.pdf" class="hidden" onchange="handleAIFileSelect(event)">
                    <video id="aiVideo" class="w-full rounded-lg hidden" autoplay playsinline></video>
                    <canvas id="aiCanvas" class="hidden"></canvas>
                    <div id="aiCameraControls" class="hidden mt-3">
                        <button type="button" onclick="captureAIPhoto()" class="btn btn-success">
                            <i class="fa fa-camera mr-1"></i>拍照
                        </button>
                        <button type="button" onclick="stopAICamera()" class="btn btn-secondary ml-2">
                            取消
                        </button>
                    </div>
                </div>

                <!-- 步骤2：识别中 -->
                <div id="aiStep2" class="hidden text-center py-8">
                    <div class="spinner mb-4"></div>
                    <p class="text-gray-600" id="aiStatus">正在AI识别...</p>
                </div>

                <!-- 步骤3：结果预览 -->
                <div id="aiStep3" class="hidden">
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg max-h-60 overflow-y-auto">
                        <h4 class="font-semibold mb-2 text-sm text-gray-700">识别结果：</h4>
                        <div id="aiResultPreview" class="text-sm space-y-1"></div>
                    </div>
                    <div class="flex justify-between gap-3">
                        <button type="button" onclick="backToAIStep1()" class="btn btn-secondary flex-1">
                            <i class="fa fa-refresh mr-1"></i>重新上传
                        </button>
                        <button type="button" onclick="applyAIResult()" class="btn btn-primary flex-1">
                            <i class="fa fa-check mr-1"></i>填入表单
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="outStockModal" class="modal" onclick="closeModalOnBg(event, 'outStockModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">出库登记</h2>
                <button onclick="closeOutStockModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="outStockForm" onsubmit="handleStockOut(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">选择标准物质 <span class="text-red-500">*</span></label>
                            <select name="stockId" id="outStockSelect" class="form-input" required>
                                <option value="">请选择</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">出库用途</label>
                            <input type="text" name="purpose" class="form-input" placeholder="请输入出库用途">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">图片/PDF上传</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary" onclick="document.getElementById('outStockImages').click()">
                                <input type="file" id="outStockImages" multiple accept="image/*,.pdf" class="hidden" onchange="handleStockImagesWithPDF(this, 'outStockImagePreview', 'outStockUploadPlaceholder')">
                                <div id="outStockImagePreview" class="image-preview-grid mb-2 hidden"></div>
                                <div id="outStockUploadPlaceholder">
                                    <i class="fa fa-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-sm">点击上传图片或PDF（最多3张）</p>
                                    <p class="text-xs text-gray-400">支持 JPG, PNG, PDF 格式</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeOutStockModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-warning">确认出库</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 发送消息模态框 -->
    <div id="sendMessageModal" class="modal" onclick="closeModalOnBg(event, 'sendMessageModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">发送消息</h2>
                <button onclick="closeSendMessageModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="sendMessageForm" onsubmit="handleSendMessage(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">发送给 <span class="text-red-500">*</span></label>
                            <select id="messageRecipient" name="recipient_id" class="form-input" required>
                                <option value="">选择接收人</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">消息内容 <span class="text-red-500">*</span></label>
                            <textarea id="messageContent" name="content" class="form-input" rows="4" placeholder="请输入消息内容..." required></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeSendMessageModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">发送</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 查看消息详情模态框 -->
    <div id="messageDetailModal" class="modal" onclick="closeModalOnBg(event, 'messageDetailModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">消息详情</h2>
                <button onclick="closeMessageDetailModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <div id="messageDetailContent" class="space-y-4">
                    <!-- 动态填充 -->
                </div>
                <div id="messageReplySection" class="mt-4 pt-4 border-t border-gray-200">
                    <textarea id="replyContent" class="form-input" rows="3" placeholder="回复消息..."></textarea>
                    <div class="flex justify-end mt-3">
                        <button onclick="sendReply()" class="btn btn-primary">回复</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addPersonnelModal" class="modal" onclick="closeModalOnBg(event, 'addPersonnelModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">添加人员</h2>
                <button onclick="closeAddPersonnelModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="addPersonnelForm" onsubmit="handleAddPersonnel(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">邮箱 <span class="text-red-500">*</span></label>
                            <input type="email" name="email" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="password" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">角色 <span class="text-red-500">*</span></label>
                            <select name="role" class="form-input" required>
                                <option value="admin">标准物质管理员</option>
                                <option value="chemist">化验员</option>
                                <option value="user">普通用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddPersonnelModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal" onclick="closeModalOnBg(event, 'changePasswordModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">修改密码</h2>
                <button onclick="closeChangePasswordModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">新密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="newPassword" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">确认新密码 <span class="text-red-500">*</span></label>
                            <input type="password" name="confirmPassword" class="form-input" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeChangePasswordModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="viewDetailModal" class="modal" onclick="closeModalOnBg(event, 'viewDetailModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">标准物质详情</h2>
                <button onclick="closeViewDetailModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="viewDetailContent" class="p-4"></div>
        </div>
    </div>

    <!-- 编辑标准物质模态框 -->
    <div id="editStockModal" class="modal" onclick="closeModalOnBg(event, 'editStockModal')">
        <div class="modal-content" style="max-height: 85vh; width: 95%; max-width: 600px; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="text-lg font-bold">编辑标准物质</h2>
                <button onclick="closeEditStockModal()" class="text-white hover:text-gray-200 p-2">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4" style="overflow-y: auto; flex: 1; max-height: calc(85vh - 140px);">
                <form id="editStockForm" onsubmit="handleEditStock(event)">
                    <input type="hidden" id="editStockId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准物质名称</label>
                            <input type="text" id="editStockName" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">唯一性标识 <span class="text-xs text-orange-500">(谨慎修改)</span></label>
                            <input type="text" id="editStockUniqueId" class="form-input border-orange-300" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准物质编号</label>
                            <input type="text" id="editStockCode" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">批次号</label>
                            <input type="text" id="editStockBatchNumber" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" id="editStockManufacturer" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">有效期</label>
                            <input type="date" id="editStockExpiryDate" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">保存条件</label>
                            <input type="text" id="editStockStorageCondition" class="form-input" placeholder="如：4℃冷藏、常温、避光等">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">稀释条件</label>
                            <input type="text" id="editStockDilutionCondition" class="form-input" placeholder="如：用纯水稀释、用甲醇稀释等">
                        </div>
                        
                        <!-- 组分信息 -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-medium text-gray-700">组分信息</h4>
                                <button type="button" onclick="addEditComponent()" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">
                                    <i class="fa fa-plus mr-1"></i>添加组分
                                </button>
                            </div>
                            <div id="editComponentsList" class="space-y-2">
                                <!-- 动态添加组分 -->
                            </div>
                        </div>
                        
                        <!-- 附件上传 -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">附件（图片/PDF）</h4>
                            <div class="space-y-3">
                                <input type="file" id="editStockFiles" multiple accept="image/*,.pdf" 
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    onchange="handleEditFilePreview(this)">
                                <p class="text-xs text-gray-400">支持 JPG、PNG、GIF、PDF 格式，最多5个文件</p>
                                
                                <!-- 现有附件列表 -->
                                <div id="editExistingFiles" class="grid grid-cols-3 gap-2">
                                    <!-- 动态显示现有附件 -->
                                </div>
                                
                                <!-- 新上传文件预览 -->
                                <div id="editNewFilesPreview" class="grid grid-cols-3 gap-2">
                                    <!-- 动态显示新文件预览 -->
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="flex space-x-3 mt-6 mb-4" style="position: sticky; bottom: 0; background: white; padding: 16px 0; border-top: 1px solid #e5e7eb;">
                        <button type="submit" class="flex-1 btn btn-primary">保存修改</button>
                        <button type="button" onclick="closeEditStockModal()" class="flex-1 btn btn-secondary">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 修改角色模态框 -->
    <div id="editRoleModal" class="modal" onclick="closeModalOnBg(event, 'editRoleModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">修改角色</h2>
                <button onclick="closeEditRoleModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <p class="text-sm text-gray-600 mb-4">正在修改 <span id="editRoleUserName" class="font-medium"></span> 的角色</p>
                <form id="editRoleForm" onsubmit="handleEditRole(event)">
                    <input type="hidden" id="editRoleUserId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选择角色</label>
                        <select id="editRoleSelect" class="form-input" required>
                            <option value="admin">标准物质管理员</option>
                            <option value="chemist">化验员</option>
                            <option value="user">普通用户</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditRoleModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="image-viewer-modal" onclick="closeImageViewer()">
        <button onclick="closeImageViewer()" class="image-viewer-close">
            <i class="fa fa-times"></i>
        </button>
        <div class="image-viewer-content" onclick="event.stopPropagation()">
            <img id="viewerImage" src="" alt="查看图片">
            <p id="viewerCaption" class="image-viewer-caption"></p>
        </div>
    </div>

    <script>
        // 设置PDF.js worker（如果pdfjsLib已加载）
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
        } else {
            console.warn('PDF.js库未加载，PDF功能将不可用')
        }
        
        // ==================== Supabase配置 ====================
        const SUPABASE_URL = 'https://ljshpxahaxemssxdtjtv.supabase.co'
        const SUPABASE_ANON_KEY = 'sb_publishable_7D5tnogliJUvQ_Pp2ASMwQ__RmVrE-T'
        
        // 初始化Supabase客户端
        let supabaseClient = null
        let currentUser = null
        let isOfflineMode = false
        
        // ==================== IndexedDB 存储（用于大数据）====================
        const DB_NAME = 'SRM_DB'
        const DB_VERSION = 1
        let db = null
        
        // 初始化 IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION)
                
                request.onerror = () => reject(request.error)
                request.onsuccess = () => {
                    db = request.result
                    resolve(db)
                }
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result
                    // 创建对象存储
                    if (!db.objectStoreNames.contains('stock')) {
                        db.createObjectStore('stock', { keyPath: 'key' })
                    }
                    if (!db.objectStoreNames.contains('records')) {
                        db.createObjectStore('records', { keyPath: 'key' })
                    }
                    if (!db.objectStoreNames.contains('personnel')) {
                        db.createObjectStore('personnel', { keyPath: 'key' })
                    }
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' })
                    }
                }
            })
        }
        
        // IndexedDB 操作
        const IndexedDB = {
            async get(storeName, key) {
                if (!db) await initIndexedDB()
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly')
                    const store = transaction.objectStore(storeName)
                    const request = store.get(key)
                    
                    request.onsuccess = () => {
                        const result = request.result
                        resolve(result ? result.value : null)
                    }
                    request.onerror = () => reject(request.error)
                })
            },
            
            async set(storeName, key, value) {
                if (!db) await initIndexedDB()
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite')
                    const store = transaction.objectStore(storeName)
                    const request = store.put({ key, value })
                    
                    request.onsuccess = () => resolve()
                    request.onerror = () => reject(request.error)
                })
            },
            
            async remove(storeName, key) {
                if (!db) await initIndexedDB()
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite')
                    const store = transaction.objectStore(storeName)
                    const request = store.delete(key)
                    
                    request.onsuccess = () => resolve()
                    request.onerror = () => reject(request.error)
                })
            }
        }
        
        // ==================== 离线模式存储 ====================
        // 小数据用 localStorage，大数据用 IndexedDB
        const LocalStorage = {
            get(key) {
                const data = localStorage.getItem('srm_' + key)
                return data ? JSON.parse(data) : null
            },
            set(key, value) {
                localStorage.setItem('srm_' + key, JSON.stringify(value))
            },
            remove(key) {
                localStorage.removeItem('srm_' + key)
            }
        }
        
        // 大数据存储（自动选择 IndexedDB 或 localStorage）
        const DataStorage = {
            async get(key) {
                // 优先从 IndexedDB 读取
                try {
                    const data = await IndexedDB.get('metadata', key)
                    if (data !== null) return data
                } catch (e) {
                    console.warn('IndexedDB读取失败，回退到localStorage:', e)
                }
                // 回退到 localStorage
                return LocalStorage.get(key)
            },
            
            async set(key, value) {
                // 尝试保存到 IndexedDB
                try {
                    await IndexedDB.set('metadata', key, value)
                    return
                } catch (e) {
                    console.warn('IndexedDB保存失败，回退到localStorage:', e)
                }
                // 回退到 localStorage
                try {
                    LocalStorage.set(key, value)
                } catch (e) {
                    console.error('保存失败，数据可能太大:', e)
                    throw e
                }
            },
            
            async remove(key) {
                try {
                    await IndexedDB.remove('metadata', key)
                } catch (e) {}
                LocalStorage.remove(key)
            }
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', async function() {
            const initStartTime = Date.now()
            console.log('【初始化】开始加载应用...')
            
            try {
                // 首先检查URL参数（微信扫码进入）
                const urlParams = new URLSearchParams(window.location.search)
                const scanId = urlParams.get('id')
                const scanUniqueId = urlParams.get('uniqueId')

                if (scanId || scanUniqueId) {
                    // 微信扫码进入，显示物品详情
                    handleScanFromQRCode(urlParams)
                    return  // 不继续初始化应用
                }

                // 检查离线模式设置
                isOfflineMode = LocalStorage.get('offlineMode') || false

                // 更新离线模式状态显示（如果存在）
                const offlineStatus = document.getElementById('offlineStatus')
                if (offlineStatus) {
                    offlineStatus.textContent = isOfflineMode ? '当前: 离线' : '当前: 在线'
                }

                // 首先尝试从缓存加载数据（快速显示）
                const cachedStock = DataCache.get(DataCache.keys.STOCK)
                const cachedRecords = DataCache.get(DataCache.keys.RECORDS)
                const cachedPersonnel = DataCache.get(DataCache.keys.PERSONNEL)
                
                if (cachedStock) {
                    console.log('【初始化】从缓存加载数据')
                    globalStockData = cachedStock
                    globalRecordsData = cachedRecords || []
                    globalPersonnelData = cachedPersonnel || []
                }

                if (!isOfflineMode) {
                    // 检查supabase对象是否可用
                    console.log('检查supabase对象:', typeof supabase, typeof window.supabase)
                    const supabaseGlobal = typeof supabase !== 'undefined' ? supabase : (typeof window.supabase !== 'undefined' ? window.supabase : null)
                    
                    if (!supabaseGlobal) {
                        console.error('Supabase库未加载，切换到离线模式')
                        // 如果有缓存数据，显示应用
                        if (globalStockData) {
                            showAppWithCachedData()
                        } else {
                            alert('Supabase库未加载，将切换到离线模式')
                            isOfflineMode = true
                            LocalStorage.set('offlineMode', true)
                            const offlineUser = LocalStorage.get('currentUser')
                            if (offlineUser) {
                                currentUser = offlineUser
                                showApp()
                            }
                        }
                        return
                    }
                    
                    // 初始化Supabase，添加全局错误处理
                    supabaseClient = supabaseGlobal.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: false
                        },
                        global: {
                            fetch: (url, options) => {
                                // 添加超时控制
                                const controller = new AbortController()
                                const timeoutId = setTimeout(() => controller.abort(), 30000) // 30秒超时
                                
                                return fetch(url, {
                                    ...options,
                                    signal: controller.signal
                                }).then(response => {
                                    clearTimeout(timeoutId)
                                    return response
                                }).catch(err => {
                                    clearTimeout(timeoutId)
                                    if (err.name === 'AbortError') {
                                        console.warn('【Supabase】请求超时')
                                        throw new Error('请求超时，请检查网络连接')
                                    }
                                    if (err.message === 'Failed to fetch') {
                                        console.warn('【Supabase】网络连接失败')
                                        // 自动切换到离线模式
                                        if (!isOfflineMode) {
                                            setTimeout(() => {
                                                autoSwitchToOfflineMode('Failed to fetch')
                                            }, 100)
                                        }
                                        throw new Error('网络连接失败，已自动切换到离线模式')
                                    }
                                    throw err
                                })
                            }
                        }
                    })
                    
                    console.log('【初始化】Supabase客户端已创建，耗时:', Date.now() - initStartTime, 'ms')

                    // 检查登录状态
                    const { data: { session } } = await supabaseClient.auth.getSession()
                    if (session) {
                        await loadUserProfile(session.user)
                        
                        // 如果有缓存数据，先显示缓存，后台同步
                        if (globalStockData) {
                            console.log('【初始化】使用缓存数据快速显示')
                            showAppWithCachedData()
                            // 后台同步最新数据
                            setTimeout(() => syncDataInBackground(), 500)
                        } else {
                            showApp()
                        }
                    }
                } else {
                    // 离线模式：检查本地登录
                    const offlineUser = LocalStorage.get('currentUser')
                    if (offlineUser) {
                        currentUser = offlineUser
                        if (globalStockData) {
                            showAppWithCachedData()
                        } else {
                            showApp()
                        }
                    }
                }
                
                console.log('【初始化】应用加载完成，总耗时:', Date.now() - initStartTime, 'ms')
              } catch (error) {
                  console.error('初始化失败:', error)
                // 如果有缓存数据，仍然显示应用
                if (globalStockData) {
                    console.log('【初始化】出错但使用缓存数据显示')
                    showAppWithCachedData()
                } else {
                    const errorMsg = error.message || '未知错误'
                    if (errorMsg.includes('Failed to fetch')) {
                        alert('无法连接到服务器，请检查网络连接。您可以切换到离线模式继续使用。')
                    } else {
                        alert('初始化失败: ' + errorMsg)
                    }
                }
            }
        })
        
        // 使用缓存数据显示应用
        function showAppWithCachedData() {
            showApp()
            // 数据已经在全局变量中，页面会自动渲染
            console.log('【初始化】使用缓存数据显示应用')
        }
        
        // 后台同步数据
        async function syncDataInBackground() {
            console.log('【后台同步】开始同步数据...')
            try {
                await loadFromCloud()
                console.log('【后台同步】数据同步完成')
            } catch (error) {
                console.warn('【后台同步】失败:', error.message)
            }
        }

        // ==================== 微信扫码查看功能 ====================
        // 处理从二维码扫码进入的页面
        async function handleScanFromQRCode(urlParams) {
            // 隐藏登录页面，显示扫码结果页面
            document.getElementById('loginPage').style.display = 'none'
            document.getElementById('appContainer').style.display = 'none'

            // 创建扫码结果展示页面
            const scanResultHtml = `
                <div id="scanResultPage" class="min-h-screen bg-gray-100 p-4">
                    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-primary text-white p-4 text-center">
                            <h1 class="text-xl font-bold">标准物质信息</h1>
                        </div>
                        <div class="p-4" id="scanItemDetails">
                            <div class="text-center py-8">
                                <i class="fa fa-spinner fa-spin text-3xl text-primary"></i>
                                <p class="mt-2 text-gray-500">正在加载信息...</p>
                            </div>
                        </div>
                        <div class="p-4 border-t">
                            <button onclick="window.location.href=window.location.pathname" class="w-full btn btn-primary">
                                <i class="fa fa-home mr-1"></i>返回首页
                            </button>
                        </div>
                    </div>
                </div>
            `
            document.body.insertAdjacentHTML('beforeend', scanResultHtml)

            // 从URL参数获取信息
            const itemInfo = {
                id: urlParams.get('id'),
                uniqueId: urlParams.get('uniqueId'),
                name: urlParams.get('name'),
                code: urlParams.get('code'),
                batch: urlParams.get('batch'),
                mfg: urlParams.get('mfg'),
                exp: urlParams.get('exp'),
                comp: urlParams.get('comp')
            }

            // 如果有ID，尝试从数据库获取完整信息
            if (itemInfo.id && !isOfflineMode) {
                try {
                    const { data, error } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', itemInfo.id)
                        .single()

                    if (data && !error) {
                        // 使用数据库中的完整信息
                        displayScanResult(data)
                        return
                    }
                } catch (e) {
                    console.warn('无法从数据库获取信息，使用URL参数:', e)
                }
            }

            // 使用URL参数中的信息
            displayScanResultFromParams(itemInfo)
        }

        // 从URL参数显示扫码结果
        function displayScanResultFromParams(info) {
            const container = document.getElementById('scanItemDetails')

            // 解码所有参数
            const name = safeDecode(info.name)
            const code = safeDecode(info.code)
            const batch = safeDecode(info.batch)
            const mfg = safeDecode(info.mfg)
            const exp = safeDecode(info.exp)
            const std = safeDecode(info.std)
            const unit = safeDecode(info.unit)
            const unc = safeDecode(info.unc)
            const storage = safeDecode(info.storage)

            // 计算状态
            let statusHtml = ''
            if (exp && exp !== 'N/A') {
                const status = calculateStatusFromDate(exp)
                const statusClass = status === '正常' ? 'text-green-600' : status === '临期' ? 'text-yellow-600' : 'text-red-600'
                statusHtml = `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">状态</span>
                        <span class="font-medium ${statusClass}">${status}</span>
                    </div>
                `
            }

            // 解析组分信息
            let componentsHtml = ''
            if (info.comp) {
                const comps = info.comp.split(';').map(c => {
                    const parts = c.split(':')
                    return {
                        name: safeDecode(parts[0]),
                        value: safeDecode(parts[1]),
                        unit: safeDecode(parts[2]),
                        uncertainty: safeDecode(parts[3])
                    }
                }).filter(c => c.name)

                if (comps.length > 0) {
                    componentsHtml = `
                        <div class="mt-4">
                            <h3 class="font-semibold text-gray-700 mb-2">组分信息</h3>
                            <div class="bg-gray-50 rounded p-2">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-gray-600 border-b">
                                            <th class="text-left py-1">组分</th>
                                            <th class="text-left py-1">标准值</th>
                                            <th class="text-left py-1">单位</th>
                                            <th class="text-left py-1">不确定度</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${comps.map(c => `
                                            <tr class="border-b border-gray-100 last:border-0">
                                                <td class="py-1">${c.name || '-'}</td>
                                                <td class="py-1">${c.value || '-'}</td>
                                                <td class="py-1">${c.unit || '-'}</td>
                                                <td class="py-1">${c.uncertainty || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `
                }
            }

            // 构建完整信息HTML
            let html = `
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">名称</span>
                        <span class="font-medium text-right">${name || 'N/A'}</span>
                    </div>
            `

            if (code && code !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">编号</span>
                        <span class="font-medium">${code}</span>
                    </div>
                `
            }

            if (batch && batch !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">批次号</span>
                        <span class="font-medium">${batch}</span>
                    </div>
                `
            }

            html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">唯一标识</span>
                        <span class="font-medium text-primary">${info.uniqueId || 'N/A'}</span>
                    </div>
            `

            if (mfg && mfg !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">生产厂家</span>
                        <span class="font-medium">${mfg}</span>
                    </div>
                `
            }

            if (exp && exp !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">有效期</span>
                        <span class="font-medium">${exp}</span>
                    </div>
                `
            }

            html += statusHtml

            if (std && std !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">标准值</span>
                        <span class="font-medium">${std}</span>
                    </div>
                `
            }

            if (unit && unit !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">单位</span>
                        <span class="font-medium">${unit}</span>
                    </div>
                `
            }

            if (unc && unc !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">不确定度</span>
                        <span class="font-medium">${unc}</span>
                    </div>
                `
            }

            if (storage && storage !== 'N/A') {
                html += `
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">保存条件</span>
                        <span class="font-medium">${storage}</span>
                    </div>
                `
            }

            html += `${componentsHtml}</div>`

            container.innerHTML = html
        }

        // 安全解码函数
        function safeDecode(str) {
            if (!str || str === 'N/A') return ''
            try {
                return decodeURIComponent(str)
            } catch (e) {
                return str
            }
        }

        // 从日期计算状态
        function calculateStatusFromDate(expDateStr) {
            try {
                const expDate = new Date(expDateStr)
                const today = new Date()
                const diffTime = expDate - today
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))

                if (diffDays < 0) return '过期'
                if (diffDays <= 30) return '临期'
                return '正常'
            } catch (e) {
                return '未知'
            }
        }

        // 从数据库数据显示扫码结果
        function displayScanResult(item) {
            const container = document.getElementById('scanItemDetails')

            // 计算状态
            const currentStatus = calculateItemStatus(item.expiry_date || item.expiryDate)
            const statusText = {
                normal: '正常',
                warning: '临期',
                expired: '过期'
            }[currentStatus]
            const statusColor = {
                normal: 'text-green-600',
                warning: 'text-yellow-600',
                expired: 'text-red-600'
            }[currentStatus]

            // 渲染组分信息
            let componentsHtml = ''
            if (item.components && item.components.length > 0) {
                componentsHtml = `
                    <div class="mt-4">
                        <h3 class="font-semibold text-gray-700 mb-2">组分信息</h3>
                        <div class="bg-gray-50 rounded p-2">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-gray-600 border-b">
                                        <th class="text-left py-1">组分</th>
                                        <th class="text-left py-1">标准值</th>
                                        <th class="text-left py-1">单位</th>
                                        <th class="text-left py-1">不确定度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${item.components.map(c => `
                                        <tr class="border-b border-gray-100 last:border-0">
                                            <td class="py-1">${c.name || '-'}</td>
                                            <td class="py-1">${c.value || '-'}</td>
                                            <td class="py-1">${c.unit || '-'}</td>
                                            <td class="py-1">${c.uncertainty || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `
            }

            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">名称</span>
                        <span class="font-medium text-right">${item.name}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">编号</span>
                        <span class="font-medium">${item.code || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">批次号</span>
                        <span class="font-medium">${item.batch_number || item.batchNumber || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">唯一标识</span>
                        <span class="font-medium text-primary">${item.unique_id || item.uniqueId}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">生产厂家</span>
                        <span class="font-medium">${item.manufacturer || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">有效期</span>
                        <span class="font-medium">${item.expiry_date || item.expiryDate || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span class="text-gray-500">状态</span>
                        <span class="font-medium ${statusColor}">${statusText}</span>
                    </div>
                    ${componentsHtml}
                </div>
            `
        }

        // ==================== 认证功能 ====================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault()
            showLoading(true)
            
            const email = document.getElementById('loginEmail').value
            const password = document.getElementById('loginPassword').value
            
            try {
                if (isOfflineMode || !supabaseClient) {
                    // 离线模式验证
                    const personnel = LocalStorage.get('personnel') || []
                    const user = personnel.find(p => p.username === email && p.password === password)
                    if (user) {
                        currentUser = user
                        LocalStorage.set('currentUser', user)
                        showApp()
                    } else {
                        throw new Error('用户名或密码错误')
                    }
                } else {
                    // 在线模式使用Supabase Auth
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    })
                    
                    if (error) throw error
                    
                    await loadUserProfile(data.user)
                    showApp()
                }
            } catch (error) {
                console.error('登录错误:', error)
                let errorMsg = error.message
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = '网络连接失败，请检查网络或切换到离线模式'
                } else if (error.message.includes('Invalid login')) {
                    errorMsg = '邮箱或密码错误'
                } else if (error.message.includes('Email not confirmed')) {
                    errorMsg = '邮箱未验证，请检查邮件'
                }
                showLoginError(errorMsg)
            } finally {
                showLoading(false)
            }
        })

        async function loadUserProfile(user) {
            if (isOfflineMode) return
            
            console.log('【loadUserProfile】加载用户资料:', user.id)
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single()
                
                if (error) {
                    console.warn('【loadUserProfile】获取用户资料失败:', error)
                    // 如果没有profile，使用基本用户信息，优先从user_metadata读取角色
                    currentUser = {
                        id: user.id,
                        email: user.email,
                        name: user.user_metadata?.name || user.email,
                        role: user.user_metadata?.role || 'user'
                    }
                    console.log('【loadUserProfile】使用user_metadata角色:', currentUser.role)
                } else {
                    console.log('【loadUserProfile】获取到profile:', profile)
                    currentUser = {
                        id: user.id,
                        email: user.email,
                        ...profile
                    }
                    // 如果profile中没有name，使用username或email
                    if (!currentUser.name) {
                        currentUser.name = profile.username || profile.name || user.user_metadata?.name || user.email
                        console.log('【loadUserProfile】profile中无name，使用:', currentUser.name)
                    }
                    // 如果profile中没有role，使用user_metadata中的role
                    if (!currentUser.role && user.user_metadata?.role) {
                        currentUser.role = user.user_metadata.role
                        console.log('【loadUserProfile】profile中无role，使用user_metadata:', currentUser.role)
                    }
                }
                
                console.log('【loadUserProfile】当前用户角色:', currentUser.role)
            } catch (error) {
                console.error('【loadUserProfile】加载用户资料失败:', error)
                // 使用基本用户信息，优先从user_metadata读取角色
                currentUser = {
                    id: user.id,
                    email: user.email,
                    name: user.user_metadata?.name || user.email,
                    role: user.user_metadata?.role || 'user'
                }
                console.log('【loadUserProfile】异常处理，使用user_metadata角色:', currentUser.role)
            }
        }

        async function handleRegister(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            }
            
            try {
                if (isOfflineMode) {
                    // 离线模式注册
                    const personnel = LocalStorage.get('personnel') || []
                    if (personnel.some(p => p.username === userData.email)) {
                        throw new Error('邮箱已存在')
                    }
                    
                    const newUser = {
                        id: Date.now().toString(),
                        name: userData.name,
                        username: userData.email,
                        password: userData.password,
                        role: userData.role
                    }
                    
                    personnel.push(newUser)
                    LocalStorage.set('personnel', personnel)
                    
                    alert('注册成功！请登录')
                    closeRegisterModal()
                } else {
                    // 在线模式使用Supabase Auth
                    console.log('【注册】开始Supabase注册:', userData.email)
                    
                    try {
                        const { data, error } = await supabaseClient.auth.signUp({
                            email: userData.email,
                            password: userData.password,
                            options: {
                                data: {
                                    name: userData.name,
                                    role: userData.role
                                }
                            }
                        })
                        
                        if (error) {
                            console.error('【注册】Supabase错误:', error)
                            
                            // 处理特定错误
                            if (error.message.includes('rate limit') || error.message.includes('rate_limit')) {
                                // 频率限制时，自动切换到离线模式注册
                                console.log('【注册】遇到频率限制，自动切换到离线模式注册')
                                throw new Error('RATE_LIMIT_FALLBACK')
                            }
                            if (error.message.includes('already registered') || error.message.includes('already exists')) {
                                throw new Error('该邮箱已被注册')
                            }
                            if (error.message.includes('password')) {
                                throw new Error('密码强度不足，请使用至少6位密码')
                            }
                            
                            throw error
                        }
                        
                        console.log('【注册】注册成功:', data)
                        alert('注册成功！请使用邮箱和密码登录')
                        closeRegisterModal()
                        
                    } catch (err) {
                        // 如果是频率限制错误或连接问题，使用离线模式注册
                        if (err.message === 'RATE_LIMIT_FALLBACK' || 
                            err.message.includes('Failed to fetch') ||
                            err.message.includes('network')) {
                            
                            console.log('【注册】切换到离线模式注册')
                            
                            // 离线模式注册
                            const personnel = LocalStorage.get('personnel') || []
                            if (personnel.some(p => p.username === userData.email)) {
                                throw new Error('该邮箱已被注册')
                            }
                            
                            const newUser = {
                                id: Date.now().toString(),
                                name: userData.name,
                                username: userData.email,
                                password: userData.password,
                                role: userData.role
                            }
                            
                            personnel.push(newUser)
                            LocalStorage.set('personnel', personnel)
                            
                            // 同时保存当前用户，可以直接登录
                            LocalStorage.set('currentUser', newUser)
                            currentUser = newUser
                            
                            alert('注册成功！（离线模式）')
                            closeRegisterModal()
                            
                            // 自动登录
                            await loadUserProfile({ id: newUser.id, email: newUser.username })
                            showApp()
                            
                        } else {
                            throw err
                        }
                    }
                }
            } catch (error) {
                alert('注册失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        function togglePassword() {
            const input = document.getElementById('loginPassword')
            const icon = document.getElementById('passwordToggleIcon')
            if (input.type === 'password') {
                input.type = 'text'
                icon.className = 'fa fa-eye-slash'
            } else {
                input.type = 'password'
                icon.className = 'fa fa-eye'
            }
        }

        function showLoginError(msg) {
            const error = document.getElementById('loginError')
            error.textContent = msg
            error.classList.remove('hidden')
            setTimeout(() => error.classList.add('hidden'), 3000)
        }

        async function logout() {
            if (!confirm('确定要退出登录吗？')) return
            
            if (!isOfflineMode && supabaseClient) {
                await supabaseClient.auth.signOut()
            }
            
            currentUser = null
            LocalStorage.remove('currentUser')
            document.getElementById('appContainer').style.display = 'none'
            document.getElementById('loginPage').style.display = 'flex'
            document.getElementById('loginPage').classList.add('active')
            document.getElementById('loginForm').reset()

            // 停止消息轮询
            stopMessagePolling()
        }

        // ==================== 页面切换 ====================
        function showApp() {
            try {
                document.getElementById('loginPage').classList.remove('active')
                document.getElementById('loginPage').style.display = 'none'
                document.getElementById('appContainer').style.display = 'block'
                
                // 更新用户信息 - 确保有正确的回退
                const displayName = currentUser?.name || currentUser?.username || currentUser?.email || '用户'
                document.getElementById('currentUserName').textContent = displayName
                document.getElementById('settingUserName').textContent = displayName
                document.getElementById('settingUserRole').textContent = getRoleDisplayName(currentUser?.role)
                document.getElementById('settingUserInitial').textContent = (displayName).charAt(0)
                
                console.log('【showApp】当前用户显示名:', displayName, '角色:', currentUser?.role)
                
                // 初始化图表
                initChart()
                
                // 刷新数据
                refreshAllData()
                
                // 设置实时订阅
                if (!isOfflineMode && supabaseClient) {
                    setupRealtimeSubscriptions()
                }

                // 启动消息轮询
                startMessagePolling()
            } catch (error) {
                console.error('showApp错误:', error)
                alert('页面加载出错: ' + error.message)
            }
        }

        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active')
                p.style.display = 'none'
            })
            
            const targetPage = document.getElementById(page + 'Page')
            if (targetPage) {
                targetPage.classList.add('active')
                targetPage.style.display = 'block'
            }
            
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active')
                const pages = ['dashboard', 'stock', 'messages', 'personnel', 'settings']
                if (pages[index] === page) {
                    item.classList.add('active')
                }
            })
            
            const titles = {
                dashboard: '标准物质管理',
                stock: '库存管理',
                messages: '消息中心',
                personnel: '人员管理',
                records: '操作记录',
                settings: '系统设置'
            }
            document.querySelector('#pageTitle span').textContent = titles[page] || '标准物质管理'
            
            // 使用全局数据渲染页面，避免重复查询
            if (page === 'dashboard') {
                // 优先使用全局数据，如果没有则尝试从缓存获取
                let stock = globalStockData
                let records = globalRecordsData
                
                if (stock === null || stock === undefined) {
                    stock = DataCache.get('stock') || []
                    globalStockData = stock
                    console.log('【switchPage】首页从缓存获取库存数据:', stock.length, '条')
                }
                if (records === null || records === undefined) {
                    records = DataCache.get('records') || []
                    globalRecordsData = records
                    console.log('【switchPage】首页从缓存获取记录数据:', records.length, '条')
                }
                
                updateDashboardWithData(stock, records)
            }
            if (page === 'stock') {
                console.log('切换到库存页面, globalStockData:', globalStockData ? globalStockData.length : 0, '条')
                // 强制重新获取数据，确保状态计算正确
                renderStockList()
            }
            if (page === 'personnel') {
                if (globalPersonnelData !== null) {
                    renderPersonnelListWithData(globalPersonnelData)
                } else {
                    renderPersonnelList()
                }
            }
            if (page === 'records') {
                if (globalRecordsData !== null) {
                    renderRecordsListWithData(globalRecordsData)
                } else {
                    renderRecordsList()
                }
            }
            if (page === 'messages') {
                renderMessagesList()
                // 进入消息页面后，清除闪烁提醒
                document.getElementById('messageNavIcon').classList.remove('message-blink')
            }
        }

        // ==================== 图表功能 ====================
        let stockStatusChart = null
        
        function initChart() {
            // 检查Chart.js是否已加载
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js未加载，跳过图表初始化')
                return
            }
            
            // 如果图表已存在，先销毁
            if (stockStatusChart) {
                stockStatusChart.destroy()
            }
            
            const ctx = document.getElementById('stockStatusChart').getContext('2d')
            stockStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['正常', '临期', '过期'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, usePointStyle: true }
                        }
                    }
                }
            })
        }

        // ==================== 数据操作 ====================
        // 全局数据存储，避免重复查询
        let globalStockData = null
        let globalRecordsData = null
        let globalPersonnelData = null
        let isDataLoading = false
        let isSyncing = false
        
        // 数据缓存管理
        const DataCache = {
            keys: {
                STOCK: 'cache_stock',
                RECORDS: 'cache_records',
                PERSONNEL: 'cache_personnel',
                STOCK_TIME: 'cache_stock_time',
                RECORDS_TIME: 'cache_records_time',
                PERSONNEL_TIME: 'cache_personnel_time'
            },
            TTL: 5 * 60 * 1000, // 5分钟缓存
            
            get(key) {
                try {
                    // 首先检查内存缓存
                    if (window._memoryCache && window._memoryCache[key]) {
                        const memCache = window._memoryCache[key]
                        // 检查内存缓存是否过期
                        if (Date.now() - memCache.time > this.TTL) {
                            delete window._memoryCache[key]
                            return null
                        }
                        console.log('【DataCache】从内存缓存读取:', key)
                        return memCache.data
                    }
                    
                    const data = localStorage.getItem(key)
                    const time = localStorage.getItem(key + '_time')
                    if (!data || !time) return null
                    
                    // 检查是否过期
                    if (Date.now() - parseInt(time) > this.TTL) {
                        this.clear(key)
                        return null
                    }
                    return JSON.parse(data)
                } catch (e) {
                    return null
                }
            },
            
            set(key, data) {
                // 对于大数据（如库存），跳过localStorage缓存，避免QuotaExceededError
                if (key === this.keys.STOCK && data && data.length > 30) {
                    console.log('【DataCache】库存数据量大(' + data.length + '条)，跳过localStorage缓存，使用内存缓存')
                    // 存储到内存中，不写入localStorage
                    window._memoryCache = window._memoryCache || {}
                    window._memoryCache[key] = {
                        data: data,
                        time: Date.now()
                    }
                    return
                }
                
                // 对于记录数据，也限制数量
                if (key === this.keys.RECORDS && data && data.length > 100) {
                    console.log('【DataCache】记录数据量大(' + data.length + '条)，只缓存最近100条')
                    data = data.slice(0, 100)
                }
                
                try {
                    const jsonStr = JSON.stringify(data)
                    // 检查数据大小，超过500KB不缓存
                    if (jsonStr.length > 500000) {
                        console.log('【DataCache】数据太大(' + (jsonStr.length/1024).toFixed(1) + 'KB)，跳过缓存')
                        return
                    }
                    localStorage.setItem(key, jsonStr)
                    localStorage.setItem(key + '_time', Date.now().toString())
                } catch (e) {
                    console.warn('缓存写入失败:', e)
                    // 如果存储失败，尝试清理所有缓存
                    if (e.name === 'QuotaExceededError' || e.message.includes('QuotaExceededError')) {
                        console.log('存储空间不足，清理所有缓存...')
                        // 清理所有缓存
                        this.clear()
                        // 清理其他可能占用空间的localStorage项
                        const keysToRemove = ['stock', 'records', 'personnel', 'stock_items', 'operation_records']
                        keysToRemove.forEach(k => {
                            try { localStorage.removeItem(k) } catch(e) {}
                        })
                        console.log('已清理所有缓存')
                    }
                }
            },
            
            clear(key) {
                if (key) {
                    localStorage.removeItem(key)
                    localStorage.removeItem(key + '_time')
                } else {
                    // 清除所有缓存
                    Object.values(this.keys).forEach(k => {
                        localStorage.removeItem(k)
                        localStorage.removeItem(k + '_time')
                    })
                }
            },
            
            isValid(key) {
                const time = localStorage.getItem(key + '_time')
                if (!time) return false
                return (Date.now() - parseInt(time)) < this.TTL
            }
        }
        
        // 本地优先加载策略：先显示本地数据，后台同步云端数据
        async function refreshAllData(forceRefresh = false) {
            // 如果数据正在加载中，等待完成
            if (isDataLoading) {
                console.log('数据正在加载中，等待...')
                while (isDataLoading) {
                    await new Promise(resolve => setTimeout(resolve, 100))
                }
                // 使用已加载的数据渲染页面
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                renderPersonnelListWithData(globalPersonnelData)
                return
            }
            
            isDataLoading = true
            const totalStartTime = Date.now()
            
            try {
                console.log('开始刷新数据...', new Date().toLocaleTimeString())
                
                if (isOfflineMode) {
                    // 离线模式：从本地存储获取
                    globalStockData = await DataStorage.get('stock') || []
                    globalRecordsData = await DataStorage.get('records') || []
                    globalPersonnelData = await DataStorage.get('personnel') || []
                    
                    // 渲染页面
                    updateDashboardWithData(globalStockData, globalRecordsData)
                    renderStockListWithData(globalStockData)
                    renderRecordsListWithData(globalRecordsData)
                    renderPersonnelListWithData(globalPersonnelData)
                } else {
                    // 在线模式：本地优先策略
                    
                    // 1. 首先尝试从本地存储加载（立即显示）
                    const localStartTime = Date.now()
                    const localStock = await DataStorage.get('stock')
                    const localRecords = await DataStorage.get('records')
                    const localPersonnel = await DataStorage.get('personnel')
                    
                    if (localStock && !forceRefresh) {
                        console.log(`从本地存储加载数据，耗时: ${Date.now() - localStartTime}ms`)
                        globalStockData = localStock
                        globalRecordsData = localRecords || []
                        globalPersonnelData = localPersonnel || []
                        
                        // 立即渲染页面
                        const renderStartTime = Date.now()
                        updateDashboardWithData(globalStockData, globalRecordsData)
                        renderStockListWithData(globalStockData)
                        renderRecordsListWithData(globalRecordsData)
                        renderPersonnelListWithData(globalPersonnelData)
                        console.log(`页面渲染耗时: ${Date.now() - renderStartTime}ms`)
                        console.log(`首屏加载总耗时: ${Date.now() - totalStartTime}ms`)
                        
                        // 2. 后台同步云端数据（不阻塞UI）
                        setTimeout(() => syncWithCloud(), 100)
                        return
                    }
                    
                    // 3. 如果没有本地数据，从云端加载（首次加载）
                    console.log('本地无数据，从云端加载...')
                    await loadFromCloud()
                }
                
                const totalTime = Date.now() - totalStartTime
                console.log(`数据刷新总耗时: ${totalTime}ms`, new Date().toLocaleTimeString())
            } catch (error) {
                console.error('刷新数据失败:', error)
            } finally {
                isDataLoading = false
            }
        }
        
        // 从云端加载数据
        // 带超时的Promise包装器
        function withTimeout(promise, timeoutMs = 10000, errorMessage = '请求超时') {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
                )
            ])
        }
        
        async function loadFromCloud(forceRefresh = false) {
            const startTime = Date.now()
            
            // 检查supabaseClient是否初始化
            if (!supabaseClient) {
                console.error('supabaseClient未初始化，无法加载云端数据')
                showToast('未连接到服务器，请检查网络或切换到离线模式', 'error')
                return
            }
            
            // 如果不是强制刷新，先检查全局数据是否存在
            if (!forceRefresh && globalPersonnelData !== null && globalPersonnelData.length > 0) {
                console.log('【loadFromCloud】使用已有全局数据，跳过云端加载')
                renderPersonnelListWithData(globalPersonnelData)
                return
            }
            
            try {
                console.log('【loadFromCloud】开始加载云端数据...')
                
                // 并行加载所有数据，使用较短的超时时间
                const results = await Promise.allSettled([
                    // 人员数据
                    supabaseClient.from('profiles').select('*').then(r => ({ type: 'personnel', ...r })),
                    // 库存数据
                    supabaseClient.from('stock_items').select('*').limit(200).then(r => ({ type: 'stock', ...r })),
                    // 记录数据
                    supabaseClient.from('operation_records').select('*').order('created_at', { ascending: false }).limit(50).then(r => ({ type: 'records', ...r }))
                ])
                
                // 处理人员数据
                const personnelResult = results[0]
                if (personnelResult.status === 'fulfilled' && !personnelResult.value.error) {
                    globalPersonnelData = personnelResult.value.data || []
                    renderPersonnelListWithData(globalPersonnelData)
                    console.log(`【loadFromCloud】人员数据加载完成: ${globalPersonnelData.length}条`)
                } else {
                    console.warn('【loadFromCloud】人员数据加载失败，使用缓存')
                    globalPersonnelData = DataCache.get('personnel') || []
                    renderPersonnelListWithData(globalPersonnelData)
                }
                
                // 处理库存数据
                const stockResult = results[1]
                if (stockResult.status === 'fulfilled' && !stockResult.value.error) {
                    globalStockData = stockResult.value.data || []
                    console.log(`【loadFromCloud】库存数据加载完成: ${globalStockData.length}条`)
                } else {
                    console.warn('【loadFromCloud】库存数据加载失败，使用缓存')
                    globalStockData = DataCache.get('stock') || []
                }
                
                // 处理记录数据
                const recordsResult = results[2]
                if (recordsResult.status === 'fulfilled' && !recordsResult.value.error) {
                    globalRecordsData = recordsResult.value.data || []
                    console.log(`【loadFromCloud】记录数据加载完成: ${globalRecordsData.length}条`)
                } else {
                    console.warn('【loadFromCloud】记录数据加载失败，使用缓存')
                    globalRecordsData = DataCache.get('records') || []
                }
                
                console.log(`【loadFromCloud】云端数据加载完成: 库存${globalStockData?.length || 0}条, 记录${globalRecordsData?.length || 0}条, 人员${globalPersonnelData.length}条, 耗时: ${Date.now() - startTime}ms`)
                
                // 保存到本地
                await saveToLocal()
                
                // 渲染页面
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                
            } catch (error) {
                console.error('【loadFromCloud】从云端加载失败:', error)
                showToast('云端加载失败: ' + error.message, 'error')
                
                // 如果人员数据已经成功加载，不要覆盖它
                if (!globalPersonnelData || globalPersonnelData.length === 0) {
                    console.log('【loadFromCloud】人员数据未加载，使用本地数据')
                    globalPersonnelData = await DataStorage.get('personnel') || []
                } else {
                    console.log('【loadFromCloud】保留已加载的人员数据:', globalPersonnelData.length, '条')
                }
                
                // 只覆盖未加载成功的数据
                if (!globalStockData || globalStockData.length === 0) {
                    globalStockData = await DataStorage.get('stock') || []
                }
                if (!globalRecordsData || globalRecordsData.length === 0) {
                    globalRecordsData = await DataStorage.get('records') || []
                }
                
                updateDashboardWithData(globalStockData, globalRecordsData)
                renderStockListWithData(globalStockData)
                renderRecordsListWithData(globalRecordsData)
                renderPersonnelListWithData(globalPersonnelData)
            }
        }
        
        // 后台同步云端数据
        async function syncWithCloud() {
            if (isSyncing) return
            isSyncing = true
            
            console.log('开始后台同步云端数据...')
            const startTime = Date.now()
            
            try {
                // 并行加载所有数据
                const [stockResult, recordsResult, personnelResult] = await Promise.all([
                    supabaseClient.from('stock_items')
                        .select('*')
                        .limit(200),
                    supabaseClient.from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50),
                    supabaseClient.from('profiles').select('*')
                ])
                
                const cloudStock = stockResult.data || []
                const cloudRecords = recordsResult.data || []
                const cloudPersonnel = personnelResult.data || []
                
                const syncTime = Date.now() - startTime
                console.log(`后台同步完成: 库存${cloudStock.length}条, 记录${cloudRecords.length}条, 人员${cloudPersonnel.length}条, 耗时: ${syncTime}ms`)
                
                // 检查数据是否有变化
                const stockChanged = JSON.stringify(globalStockData) !== JSON.stringify(cloudStock)
                const recordsChanged = JSON.stringify(globalRecordsData) !== JSON.stringify(cloudRecords)
                const personnelChanged = JSON.stringify(globalPersonnelData) !== JSON.stringify(cloudPersonnel)
                
                if (stockChanged || recordsChanged || personnelChanged) {
                    console.log('检测到数据变化，更新页面...')
                    globalStockData = cloudStock
                    globalRecordsData = cloudRecords
                    globalPersonnelData = cloudPersonnel
                    
                    // 保存到本地
                    await saveToLocal()
                    
                    // 更新缓存
                    DataCache.set('stock', globalStockData)
                    DataCache.set('records', globalRecordsData)
                    DataCache.set('personnel', globalPersonnelData)
                    
                    // 更新页面
                    updateDashboardWithData(globalStockData, globalRecordsData)
                    renderStockListWithData(globalStockData)
                    renderRecordsListWithData(globalRecordsData)
                    renderPersonnelListWithData(globalPersonnelData)
                    
                    console.log('页面已更新为最新数据')
                } else {
                    console.log('数据无变化，无需更新')
                }
                
            } catch (error) {
                console.error('后台同步失败:', error)
            } finally {
                isSyncing = false
            }
        }
        
        // 保存数据到本地存储
        async function saveToLocal() {
            try {
                await DataStorage.set('stock', globalStockData)
                await DataStorage.set('records', globalRecordsData)
                await DataStorage.set('personnel', globalPersonnelData)
                await DataStorage.set('lastSyncTime', Date.now())
                
                // 同时更新缓存
                DataCache.set(DataCache.keys.STOCK, globalStockData)
                DataCache.set(DataCache.keys.RECORDS, globalRecordsData)
                DataCache.set(DataCache.keys.PERSONNEL, globalPersonnelData)
                
                console.log('数据已保存到本地存储和缓存')
            } catch (error) {
                console.error('保存到本地失败:', error)
            }
        }
        
        // 操作后同步数据（从云端获取最新数据并更新本地）
        async function syncAfterOperation() {
            console.log('操作完成，开始后台同步最新数据...')
            try {
                // 根据当前页面只同步必要的数据
                const currentPage = getCurrentPage()
                
                // 并行获取库存和记录（最常用的数据）
                const promises = [
                    supabaseClient.from('stock_items').select('*').limit(200),
                    supabaseClient.from('operation_records').select('*').order('created_at', { ascending: false }).limit(50)
                ]
                
                // 只有在人员页面才同步人员数据
                if (currentPage === 'personnel') {
                    promises.push(supabaseClient.from('profiles').select('*'))
                }
                
                const results = await Promise.all(promises)
                
                globalStockData = results[0].data || []
                globalRecordsData = results[1].data || []
                if (results[2]) {
                    globalPersonnelData = results[2].data || []
                    DataCache.set('personnel', globalPersonnelData)
                }
                
                // 保存到本地
                await saveToLocal()
                
                // 更新缓存
                DataCache.set('stock', globalStockData)
                DataCache.set('records', globalRecordsData)
                
                // 只更新当前页面
                if (currentPage === 'dashboard') {
                    updateDashboardWithData(globalStockData, globalRecordsData)
                } else if (currentPage === 'stock') {
                    renderStockListWithData(globalStockData)
                } else if (currentPage === 'records') {
                    renderRecordsListWithData(globalRecordsData)
                } else if (currentPage === 'personnel') {
                    renderPersonnelListWithData(globalPersonnelData)
                }
                
                console.log('后台同步完成')
            } catch (error) {
                console.error('后台同步失败:', error)
                // 同步失败不影响用户体验，数据已经在云端保存成功
            }
        }

        // 获取当前活动页面
        function getCurrentPage() {
            const activePage = document.querySelector('.page.active')
            if (activePage) {
                return activePage.id.replace('Page', '')
            }
            return 'dashboard'
        }
        
        // 刷新并同步数据（用户手动触发）- 根据当前页面刷新相应数据
        let isRefreshing = false
        
        async function refreshAndSyncData(forceFullSync = false) {
            // 防止重复点击
            if (isRefreshing) {
                console.log('【刷新同步】正在刷新中，忽略重复请求')
                showToast('正在刷新中，请稍候...', 'info')
                return
            }
            
            isRefreshing = true
            const currentPage = getCurrentPage()
            console.log(`【刷新同步】当前页面: ${currentPage}，用户手动触发数据刷新`, forceFullSync ? '(完整同步)' : '(快速刷新)')
            
            const refreshIcon = document.getElementById('refreshIcon')
            if (refreshIcon) {
                refreshIcon.classList.add('fa-spin')
            }
            
            showLoading(true)
            const startTime = Date.now()
            
            try {
                if (isOfflineMode) {
                    // 离线模式：根据当前页面刷新相应数据
                    console.log(`【刷新同步】离线模式，刷新${currentPage}页面数据`)
                    await refreshCurrentPageData(currentPage)
                    showToast('本地数据已刷新', 'success')
                } else {
                    // 在线模式：根据当前页面刷新相应数据
                    showToast(`正在刷新${getPageName(currentPage)}...`, 'info')
                    await refreshCurrentPageData(currentPage, forceFullSync)
                    const duration = Date.now() - startTime
                    showToast(`${getPageName(currentPage)}刷新完成 (${duration}ms)`, 'success')
                }
                
                const totalDuration = Date.now() - startTime
                console.log(`【刷新同步】完成，耗时: ${totalDuration}ms`)
            } catch (error) {
                console.error('【刷新同步】失败:', error)
                showToast('同步失败: ' + error.message, 'error')
            } finally {
                showLoading(false)
                if (refreshIcon) {
                    refreshIcon.classList.remove('fa-spin')
                }
                isRefreshing = false
                console.log('【刷新同步】重置刷新状态')
            }
        }
        
        // 获取页面名称
        function getPageName(page) {
            const names = {
                dashboard: '首页',
                stock: '库存',
                personnel: '人员',
                records: '记录',
                messages: '消息',
                settings: '设置'
            }
            return names[page] || '数据'
        }
        
        // 根据当前页面刷新相应数据
        async function refreshCurrentPageData(page, forceFullSync = false) {
            switch (page) {
                case 'dashboard':
                    await refreshDashboardData(forceFullSync)
                    break
                case 'stock':
                    await refreshStockData(forceFullSync)
                    break
                case 'personnel':
                    await refreshPersonnelData(forceFullSync)
                    break
                case 'records':
                    await refreshRecordsData(forceFullSync)
                    break
                case 'messages':
                    await refreshMessagesData(forceFullSync)
                    break
                default:
                    // 默认刷新所有数据
                    await refreshAllData(forceFullSync)
            }
        }
        
        // 刷新首页数据
        async function refreshDashboardData(forceFullSync = false) {
            console.log('【刷新】刷新首页数据')
            if (isOfflineMode) {
                globalStockData = LocalStorage.get('stock') || []
                globalRecordsData = LocalStorage.get('records') || []
                updateDashboardWithData(globalStockData, globalRecordsData)
                return
            }
            
            // 在线模式：快速获取数据，不等待
            try {
                // 使用较短的超时时间（5秒），快速响应
                const stockPromise = supabaseClient.from('stock_items').select('*').limit(100)
                const recordsPromise = supabaseClient.from('operation_records').select('*').order('created_at', { ascending: false }).limit(5)
                
                // 并行获取，最多等待5秒
                const results = await Promise.allSettled([
                    Promise.race([stockPromise, new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))]),
                    Promise.race([recordsPromise, new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))])
                ])
                
                // 处理结果
                let stockUpdated = false
                let recordsUpdated = false
                
                if (results[0].status === 'fulfilled' && !results[0].value.error) {
                    globalStockData = results[0].value.data || []
                    DataCache.set('stock', globalStockData)
                    stockUpdated = true
                    console.log('【刷新】库存数据加载成功:', globalStockData.length, '条')
                } else {
                    console.warn('【刷新】库存数据加载失败，使用缓存')
                    if (!globalStockData || globalStockData.length === 0) {
                        globalStockData = DataCache.get('stock') || []
                    }
                }
                
                if (results[1].status === 'fulfilled' && !results[1].value.error) {
                    globalRecordsData = results[1].value.data || []
                    DataCache.set('records', globalRecordsData)
                    recordsUpdated = true
                    console.log('【刷新】记录数据加载成功:', globalRecordsData.length, '条')
                } else {
                    console.warn('【刷新】记录数据加载失败，使用缓存')
                    if (!globalRecordsData || globalRecordsData.length === 0) {
                        globalRecordsData = DataCache.get('records') || []
                    }
                }
                
                // 立即更新页面
                updateDashboardWithData(globalStockData, globalRecordsData)
                
                // 后台同步其他数据（不阻塞）
                if (forceFullSync) {
                    setTimeout(() => {
                        syncWithCloud().catch(err => console.log('后台同步失败:', err))
                    }, 100)
                }
                
            } catch (err) {
                console.error('【刷新】首页数据加载异常:', err)
                // 使用缓存数据
                if (!globalStockData || globalStockData.length === 0) {
                    globalStockData = DataCache.get('stock') || []
                }
                if (!globalRecordsData || globalRecordsData.length === 0) {
                    globalRecordsData = DataCache.get('records') || []
                }
                updateDashboardWithData(globalStockData, globalRecordsData)
            }
        }
        
        // 刷新库存数据
        async function refreshStockData(forceFullSync = false) {
            console.log('【刷新】刷新库存数据')
            if (isOfflineMode) {
                globalStockData = LocalStorage.get('stock') || []
            } else {
                if (forceFullSync) {
                    await syncWithCloud()
                }
                try {
                    const result = await withTimeout(
                        supabaseClient.from('stock_items').select('*'),
                        20000,
                        '加载库存数据超时'
                    )
                    if (result.error) throw result.error
                    globalStockData = result.data || []
                    DataCache.set('stock', globalStockData)
                } catch (err) {
                    console.error('【刷新】库存数据加载失败:', err)
                    showToast('库存数据加载失败: ' + err.message, 'error')
                    // 使用缓存数据
                    globalStockData = DataCache.get('stock') || []
                }
            }
            renderStockListWithData(globalStockData)
        }
        
        // 刷新人员数据
        async function refreshPersonnelData(forceFullSync = false) {
            console.log('【刷新】刷新人员数据')
            if (isOfflineMode) {
                globalPersonnelData = LocalStorage.get('personnel') || []
            } else {
                if (forceFullSync) {
                    await syncWithCloud()
                }
                try {
                    const result = await withTimeout(
                        supabaseClient.from('profiles').select('*'),
                        15000,
                        '加载人员数据超时'
                    )
                    if (result.error) throw result.error
                    globalPersonnelData = result.data || []
                    DataCache.set('personnel', globalPersonnelData)
                } catch (err) {
                    console.error('【刷新】人员数据加载失败:', err)
                    showToast('人员数据加载失败: ' + err.message, 'error')
                    globalPersonnelData = DataCache.get('personnel') || []
                }
            }
            renderPersonnelListWithData(globalPersonnelData)
        }
        
        // 刷新记录数据
        async function refreshRecordsData(forceFullSync = false) {
            console.log('【刷新】刷新记录数据')
            if (isOfflineMode) {
                globalRecordsData = LocalStorage.get('records') || []
            } else {
                if (forceFullSync) {
                    await syncWithCloud()
                }
                try {
                    const result = await withTimeout(
                        supabaseClient.from('operation_records').select('*').order('created_at', { ascending: false }),
                        20000,
                        '加载记录数据超时'
                    )
                    if (result.error) throw result.error
                    globalRecordsData = result.data || []
                    DataCache.set('records', globalRecordsData)
                } catch (err) {
                    console.error('【刷新】记录数据加载失败:', err)
                    showToast('记录数据加载失败: ' + err.message, 'error')
                    globalRecordsData = DataCache.get('records') || []
                }
            }
            renderRecordsListWithData(globalRecordsData)
        }
        
        // 刷新消息数据
        async function refreshMessagesData(forceFullSync = false) {
            console.log('【刷新】刷新消息数据')
            renderMessagesList()
        }

        // 使用共享数据更新仪表板
        function updateDashboardWithData(stock, records) {
            if (!stock) stock = []
            if (!records) records = []
            
            // 计算统计数据
            const totalStock = stock.reduce((sum, item) => sum + (item.quantity || 0), 0)
            document.getElementById('totalStock').textContent = totalStock
            
            const today = new Date()
            // 计算距离过期的天数
            const oneDay = 24 * 60 * 60 * 1000
            
            // 找出即将过期的物品（30天内过期）
            const warningItems = stock.filter(item => {
                const dateStr = item.expiry_date || item.expiryDate
                const expiryDate = new Date(dateStr)
                // 计算距离过期的天数（过期日期 - 今天）
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                // 临期：0-30天内过期（包括今天过期）
                const isWarning = daysUntilExpiry >= 0 && daysUntilExpiry <= 30 && item.quantity > 0
                return isWarning
            })
            
            const expiryWarning = warningItems.length
            document.getElementById('expiryWarning').textContent = expiryWarning
            
            // 更新最近临期标准物质名称和闪烁效果
            updateNearestExpiryWarning(warningItems)
            
            // 计算状态分布（只统计正常、临期、过期三种状态）
            let normal = 0, warning = 0, expired = 0
            stock.forEach(item => {
                const dateStr = item.expiry_date || item.expiryDate
                const expiryDate = new Date(dateStr)
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                
                if (daysUntilExpiry < 0) {
                    // 已过期
                    expired++
                } else if (daysUntilExpiry <= 30) {
                    // 临期（0-30天）
                    warning++
                } else {
                    // 正常（>30天）
                    normal++
                }
            })

            if (stockStatusChart) {
                stockStatusChart.data.datasets[0].data = [normal, warning, expired]
                stockStatusChart.update()
            }
            
            // 加载最近活动
            const recentActivities = document.getElementById('recentActivities')
            if (records.length === 0) {
                recentActivities.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无活动记录</p></div>'
            } else {
                recentActivities.innerHTML = records.slice(0, 5).map(record => {
                    const icons = { in: 'fa-archive text-primary', out: 'fa-sign-out text-success', warning: 'fa-exclamation-triangle text-warning' }
                    const actions = { in: '入库', out: '出库', warning: '预警' }
                    return `
                        <div class="activity-item">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fa ${icons[record.type] || 'fa-info-circle'}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">${record.material_name || record.materialName} ${actions[record.type]}</p>
                                <p class="text-xs text-gray-500">${record.operator_name || record.operator} · ${new Date(record.created_at || record.date).toLocaleString('zh-CN')}</p>
                            </div>
                        </div>
                    `
                }).join('')
            }
        }
        
        async function refreshDashboard() {
            let stock = []
            let records = []
            
            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
                records = LocalStorage.get('records') || []
            } else {
                // 先检查缓存
                stock = DataCache.get('stock')
                records = DataCache.get('records')
                
                // 如果缓存不存在或过期，从Supabase获取
                if (!stock) {
                    const { data: stockData } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                    stock = stockData || []
                    DataCache.set('stock', stock)
                }
                
                if (!records) {
                    const { data: recordsData } = await supabaseClient
                        .from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(5)
                    records = recordsData || []
                    DataCache.set('records', records)
                }
            }
            
            // 计算统计数据
            const totalStock = stock.reduce((sum, item) => sum + (item.quantity || 0), 0)
            document.getElementById('totalStock').textContent = totalStock
            
            const today = new Date()
            const oneDay = 24 * 60 * 60 * 1000
            
            // 找出即将过期的物品（30天内过期）
            const warningItems = stock.filter(item => {
                const expiryDate = new Date(item.expiry_date || item.expiryDate)
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                return daysUntilExpiry >= 0 && daysUntilExpiry <= 30 && item.quantity > 0
            })
            
            const expiryWarning = warningItems.length
            document.getElementById('expiryWarning').textContent = expiryWarning
            
            // 更新最近临期标准物质名称和闪烁效果
            updateNearestExpiryWarning(warningItems)
            
            // 计算状态分布（只统计正常、临期、过期三种状态）
            let normal = 0, warning = 0, expired = 0
            stock.forEach(item => {
                const expiryDate = new Date(item.expiry_date || item.expiryDate)
                const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)
                if (daysUntilExpiry < 0) {
                    expired++
                } else if (daysUntilExpiry <= 30) {
                    warning++
                } else {
                    normal++
                }
            })

            if (stockStatusChart) {
                stockStatusChart.data.datasets[0].data = [normal, warning, expired]
                stockStatusChart.update()
            }
            
            // 加载最近活动
            const recentActivities = document.getElementById('recentActivities')
            if (records.length === 0) {
                recentActivities.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无活动记录</p></div>'
            } else {
                recentActivities.innerHTML = records.map(record => {
                    const icons = { in: 'fa-archive text-primary', out: 'fa-sign-out text-success', warning: 'fa-exclamation-triangle text-warning' }
                    const actions = { in: '入库', out: '出库', warning: '预警' }
                    return `
                        <div class="activity-item">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fa ${icons[record.type] || 'fa-info-circle'}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">${record.material_name || record.materialName} ${actions[record.type]}</p>
                                <p class="text-xs text-gray-500">${record.operator_name || record.operator} · ${new Date(record.created_at || record.date).toLocaleString('zh-CN')}</p>
                            </div>
                        </div>
                    `
                }).join('')
            }
        }

        // ==================== 库存管理 ====================
        let currentStockTab = 'all'

        // 分页相关变量
        let stockCurrentPage = 1
        const stockPageSize = 10
        let stockTotalPages = 1

        // 计算物品状态（根据有效期动态计算）
        function calculateItemStatus(expiryDateStr) {
            if (!expiryDateStr) return 'normal'
            const today = new Date()
            today.setHours(0, 0, 0, 0)  // 重置时间为当天零点
            const expiryDate = new Date(expiryDateStr)
            expiryDate.setHours(0, 0, 0, 0)  // 重置时间为当天零点
            const oneDay = 24 * 60 * 60 * 1000
            const daysUntilExpiry = Math.ceil((expiryDate - today) / oneDay)

            console.log('计算状态:', '有效期:', expiryDateStr, '距离过期:', daysUntilExpiry, '天')

            if (daysUntilExpiry < 0) {
                return 'expired'  // 已过期
            } else if (daysUntilExpiry <= 30) {
                return 'warning'  // 临期（0-30天）
            } else {
                return 'normal'   // 正常（>30天）
            }
        }

        // 使用共享数据渲染库存列表
        function renderStockListWithData(stock) {
            if (!stock) stock = []

            console.log('renderStockListWithData 被调用, 数据条数:', stock.length)

            // 为每个物品计算当前状态
            stock = stock.map(item => {
                const status = calculateItemStatus(item.expiry_date || item.expiryDate)
                if (item.name && (item.name.includes('汞') || item.name.includes('铜'))) {
                    console.log('物品:', item.name, '有效期:', item.expiry_date || item.expiryDate, '计算状态:', status)
                }
                return {
                    ...item,
                    currentStatus: status
                }
            })

            const search = document.getElementById('stockSearchInput')?.value?.toLowerCase() || ''

            let filtered = stock
            if (search) {
                filtered = filtered.filter(item =>
                    (item.name || '').toLowerCase().includes(search) ||
                    (item.code || '').toLowerCase().includes(search)
                )
                // 搜索时重置到第一页
                stockCurrentPage = 1
            }

            if (currentStockTab !== 'all') {
                filtered = filtered.filter(item => item.currentStatus === currentStockTab)
                // 切换标签时重置到第一页
                stockCurrentPage = 1
            }

            // 按名称分组
            const grouped = {}
            filtered.forEach(item => {
                if (!grouped[item.name]) {
                    grouped[item.name] = { items: [], total: 0 }
                }
                grouped[item.name].items.push(item)
                grouped[item.name].total += item.quantity
            })
            
            // 计算分页
            const groupNames = Object.keys(grouped)
            stockTotalPages = Math.ceil(groupNames.length / stockPageSize)
            if (stockTotalPages === 0) stockTotalPages = 1
            if (stockCurrentPage > stockTotalPages) stockCurrentPage = stockTotalPages
            if (stockCurrentPage < 1) stockCurrentPage = 1
            
            // 获取当前页的数据
            const startIndex = (stockCurrentPage - 1) * stockPageSize
            const endIndex = startIndex + stockPageSize
            const currentPageGroups = groupNames.slice(startIndex, endIndex)
            
            const container = document.getElementById('stockList')
            if (groupNames.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>暂无库存数据</p></div>'
                return
            }
            
            let html = currentPageGroups.map(name => {
                const group = grouped[name]
                const statusCounts = { normal: 0, warning: 0, expired: 0, low: 0 }
                group.items.forEach(item => {
                    // 使用动态计算的状态
                    statusCounts[item.currentStatus] = (statusCounts[item.currentStatus] || 0) + item.quantity
                })

                // 调试输出
                if (name.includes('汞') || name.includes('铜')) {
                    console.log(name + '分组状态统计:', statusCounts)
                    console.log(name + '物品列表:', group.items.map(i => ({name: i.name, expiry: i.expiry_date || i.expiryDate, status: i.currentStatus})))
                }

                let statusLabels = ''
                if (statusCounts.normal > 0) statusLabels += `<span class="ml-2 status-badge status-normal">正常:${statusCounts.normal}</span>`
                if (statusCounts.warning > 0) statusLabels += `<span class="ml-2 status-badge status-warning">临期:${statusCounts.warning}</span>`
                if (statusCounts.expired > 0) statusLabels += `<span class="ml-2 status-badge status-danger">过期:${statusCounts.expired}</span>`

                const groupId = 'group-' + name.replace(/\s+/g, '-')

                return `
                    <div class="stock-group">
                        <div class="stock-group-header flex justify-between items-center" onclick="toggleGroup('${groupId}')">
                            <div class="flex items-center">
                                <i class="fa fa-chevron-down mr-2 text-gray-400 transition-transform" id="arrow-${groupId}"></i>
                                <h3 class="font-semibold">${name}${statusLabels}</h3>
                            </div>
                            <span class="text-lg font-bold">${group.total}</span>
                        </div>
                        <div id="${groupId}" class="hidden">
                            ${group.items.map(item => `
                                <div class="stock-item">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium">唯一性标识: ${item.unique_id || item.uniqueId}</p>
                                            <p class="text-xs text-gray-500">有效期: ${item.expiry_date || item.expiryDate} | ${renderComponentsSummary(item)}</p>
                                            <span class="status-badge status-${item.currentStatus} mt-1">
                                                ${item.currentStatus === 'normal' ? '正常' : item.currentStatus === 'warning' ? '临期' : item.currentStatus === 'expired' ? '过期' : '库存不足'}
                                            </span>
                                        </div>
                                        <div class="flex space-x-1">
                                            <button onclick="showQRCode('${item.id}', '${item.unique_id || item.uniqueId}', '${item.name}')" class="px-2 py-1 bg-purple-500 text-white text-xs rounded" title="显示二维码">
                                                <i class="fa fa-qrcode"></i>
                                            </button>
                                            <button onclick="viewStockDetail('${item.id}')" class="px-2 py-1 bg-info text-white text-xs rounded">查看</button>
                                            <button onclick="quickOut('${item.id}')" class="px-2 py-1 bg-warning text-white text-xs rounded">出库</button>
                                            ${currentUser?.role === 'admin' ? `<button onclick="deleteStock('${item.id}')" class="px-2 py-1 bg-danger text-white text-xs rounded">删除</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
            }).join('')
            
            // 添加分页控件
            if (stockTotalPages > 1) {
                html += `
                    <div class="flex justify-center items-center mt-4 space-x-2">
                        <button onclick="changeStockPage(${stockCurrentPage - 1})" 
                            class="px-3 py-1 bg-gray-200 rounded ${stockCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${stockCurrentPage === 1 ? 'disabled' : ''}>
                            <i class="fa fa-chevron-left"></i> 上一页
                        </button>
                        <span class="text-sm text-gray-600">
                            第 ${stockCurrentPage} / ${stockTotalPages} 页
                        </span>
                        <button onclick="changeStockPage(${stockCurrentPage + 1})" 
                            class="px-3 py-1 bg-gray-200 rounded ${stockCurrentPage === stockTotalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${stockCurrentPage === stockTotalPages ? 'disabled' : ''}>
                            下一页 <i class="fa fa-chevron-right"></i>
                        </button>
                    </div>
                `
            }
            
            container.innerHTML = html
        }
        
        // 原来的renderStockList函数，用于单独调用时
        async function renderStockList() {
            console.log('renderStockList 被调用')
            let stock = []

            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
            } else {
                // 先检查缓存
                stock = DataCache.get('stock')
                console.log('从缓存获取数据:', stock ? stock.length : 0, '条')

                // 如果缓存不存在，从Supabase获取
                if (!stock) {
                    console.log('缓存为空，从Supabase获取')
                    try {
                        const { data, error } = await supabaseClient
                            .from('stock_items')
                            .select('*')
                            .order('created_at', { ascending: false })
                        
                        if (error) {
                            console.error('从Supabase获取库存数据失败:', error)
                            throw error
                        }
                        
                        stock = data || []
                        console.log('从Supabase获取库存数据成功:', stock.length, '条')
                        DataCache.set('stock', stock)
                    } catch (error) {
                        console.error('获取库存数据失败:', error)
                        showToast('获取库存数据失败: ' + error.message, 'error')
                        stock = []
                    }
                }
            }

            // 调用统一的渲染函数
            renderStockListWithData(stock)
        }
        
        // 切换库存列表页码
        function changeStockPage(page) {
            if (page < 1 || page > stockTotalPages) return
            stockCurrentPage = page
            renderStockListWithData(globalStockData)
            // 滚动到列表顶部
            const stockListEl = document.getElementById('stockList')
            if (stockListEl) {
                stockListEl.scrollIntoView({ behavior: 'smooth', block: 'start' })
            }
        }

        function switchStockTab(tab, element) {
            currentStockTab = tab
            document.querySelectorAll('.tab-nav-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')
            renderStockList()
        }

        function toggleGroup(id) {
            const el = document.getElementById(id)
            const arrow = document.getElementById('arrow-' + id)
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden')
                arrow.style.transform = 'rotate(180deg)'
            } else {
                el.classList.add('hidden')
                arrow.style.transform = 'rotate(0)'
            }
        }

        // ==================== 入库功能 ====================
        function showAddStockModal() {
            document.getElementById('addStockModal').classList.add('show')
            const date = new Date()
            date.setDate(date.getDate() + 30)
            document.querySelector('input[name="expiryDate"]').value = date.toISOString().split('T')[0]
        }

        function closeAddStockModal() {
            document.getElementById('addStockModal').classList.remove('show')
            document.getElementById('addStockForm').reset()
            document.getElementById('stockImagePreview').innerHTML = ''
            document.getElementById('stockImagePreview').classList.add('hidden')
            document.getElementById('stockUploadPlaceholder').classList.remove('hidden')
        }

        function toggleUniqueIdInput() {
            const type = document.querySelector('input[name="uniqueIdType"]:checked').value
            const input = document.getElementById('manualUniqueId')
            if (type === 'manual') {
                input.classList.remove('hidden')
                input.required = true
            } else {
                input.classList.add('hidden')
                input.required = false
            }
        }

        // 添加组分行
        function addComponentRow() {
            const container = document.getElementById('componentsContainer')
            const rows = container.querySelectorAll('.component-row')
            const newRow = document.createElement('div')
            newRow.className = 'component-row grid grid-cols-12 gap-2'
            newRow.innerHTML = `
                <div class="col-span-3">
                    <input type="text" name="componentName[]" class="form-input text-sm py-1" placeholder="如：锌">
                </div>
                <div class="col-span-3">
                    <input type="text" name="componentValue[]" class="form-input text-sm py-1" placeholder="如：100">
                </div>
                <div class="col-span-3">
                    <input type="text" name="componentUnit[]" class="form-input text-sm py-1" placeholder="如：μg/mL">
                </div>
                <div class="col-span-2">
                    <input type="text" name="componentUncertainty[]" class="form-input text-sm py-1" placeholder="如：0.5%">
                </div>
                <div class="col-span-1 flex items-center justify-center">
                    <button type="button" onclick="removeComponentRow(this)" class="text-red-500 hover:text-red-700">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `
            container.appendChild(newRow)
            updateRemoveButtons()
        }

        // 删除组分行
        function removeComponentRow(btn) {
            const row = btn.closest('.component-row')
            const container = document.getElementById('componentsContainer')
            const rows = container.querySelectorAll('.component-row')

            if (rows.length > 1) {
                row.remove()
                updateRemoveButtons()
            }
        }

        // 更新删除按钮显示状态
        function updateRemoveButtons() {
            const container = document.getElementById('componentsContainer')
            const rows = container.querySelectorAll('.component-row')
            const deleteButtons = container.querySelectorAll('.component-row button[onclick="removeComponentRow(this)"]')

            deleteButtons.forEach((btn, index) => {
                if (rows.length === 1) {
                    btn.classList.add('hidden')
                } else {
                    btn.classList.remove('hidden')
                }
            })
        }

        // 获取组分数据
        function getComponentsData() {
            const names = document.querySelectorAll('input[name="componentName[]"]')
            const values = document.querySelectorAll('input[name="componentValue[]"]')
            const units = document.querySelectorAll('input[name="componentUnit[]"]')
            const uncertainties = document.querySelectorAll('input[name="componentUncertainty[]"]')

            const components = []
            for (let i = 0; i < names.length; i++) {
                if (names[i].value || values[i].value) {
                    components.push({
                        name: names[i].value,
                        value: values[i].value,
                        unit: units[i].value,
                        uncertainty: uncertainties[i].value
                    })
                }
            }
            return components
        }

        // 将文件转换为Base64（带大小限制）
        function fileToBase64(file, maxSizeMB = 2) {
            return new Promise((resolve, reject) => {
                // 检查文件大小
                const maxSizeBytes = maxSizeMB * 1024 * 1024
                if (file.size > maxSizeBytes) {
                    reject(new Error(`文件大小超过${maxSizeMB}MB限制`))
                    return
                }

                const reader = new FileReader()
                reader.onload = () => resolve(reader.result)
                reader.onerror = reject
                reader.readAsDataURL(file)
            })
        }

        // 压缩图片
        async function compressImage(base64, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image()
                img.onload = () => {
                    const canvas = document.createElement('canvas')
                    let width = img.width
                    let height = img.height

                    // 按比例缩放
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width
                        width = maxWidth
                    }

                    canvas.width = width
                    canvas.height = height
                    const ctx = canvas.getContext('2d')
                    ctx.drawImage(img, 0, 0, width, height)

                    // 转换为压缩后的base64
                    const compressed = canvas.toDataURL('image/jpeg', quality)
                    resolve(compressed)
                }
                img.src = base64
            })
        }

        async function handleStockIn(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const quantity = parseInt(formData.get('quantity')) || 1
            const baseTime = Date.now()
            
            try {
                // 处理文件上传 - 区分图片和PDF
                const previewDiv = document.getElementById('stockImagePreview')
                const fileUrls = []
                
                // 获取原始文件输入
                const fileInput = document.getElementById('stockImages')
                const files = fileInput.files
                
                if (files.length > 0) {
                    for (const file of files) {
                        try {
                            if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                                // PDF文件：上传到Supabase Storage
                                const fileName = `stock/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.pdf`
                                
                                try {
                                    const { error } = await supabaseClient
                                        .storage
                                        .from('stock-images')
                                        .upload(fileName, file)
                                    
                                    if (error) {
                                        console.warn('PDF上传失败，使用Base64:', error)
                                        const base64 = await fileToBase64(file, 10)
                                        fileUrls.push(base64)
                                    } else {
                                        const result = supabaseClient
                                            .storage
                                            .from('stock-images')
                                            .getPublicUrl(fileName)
                                        console.log('getPublicUrl 完整返回:', result)
                                        
                                        // 处理不同的返回格式
                                        let publicUrl
                                        if (result && result.data) {
                                            publicUrl = result.data.publicUrl
                                        } else if (result && typeof result === 'object') {
                                            publicUrl = result.publicUrl || result.url
                                        }
                                        
                                        if (!publicUrl || typeof publicUrl !== 'string') {
                                            console.error('无法提取 publicUrl:', result)
                                            throw new Error('无法获取文件URL')
                                        }
                                        
                                        console.log('PDF上传成功:', publicUrl)
                                        fileUrls.push(publicUrl)
                                    }
                                } catch (uploadErr) {
                                    console.warn('PDF上传出错，使用Base64:', uploadErr)
                                    const base64 = await fileToBase64(file, 10)
                                    fileUrls.push(base64)
                                }
                            } else {
                                // 图片文件：压缩后处理
                                const base64 = await fileToBase64(file, 5)
                                const compressed = await compressImage(base64, 1200, 0.7)
                                fileUrls.push(compressed)
                            }
                        } catch (err) {
                            console.warn('文件处理失败:', err.message)
                            alert(`文件处理失败: ${err.message}`)
                            showLoading(false)
                            return
                        }
                    }
                }
                
                // 调试：查看fileUrls内容
                console.log('保存前的fileUrls:', fileUrls.map(url => url.substring(0, 100) + '...'))
                console.log('第一个URL长度:', fileUrls[0] ? fileUrls[0].length : 0)
                
                // 创建库存记录
                const records = []
                
                // 生成唯一性标识：批号-有效期年月日-序号
                const batchNumber = formData.get('batchNumber') || 'BATCH'
                const expiryDate = formData.get('expiryDate') || ''
                // 从有效期提取年月日，如 2025-12-31 -> 251231
                // 从有效期提取年月日，如 2026-03-27 -> 260327（取年份后两位）
                const dateMatch = expiryDate.match(/(\d{4})-(\d{2})-(\d{2})/)
                const yearMonthDay = dateMatch ? dateMatch[1].slice(-2) + dateMatch[2] + dateMatch[3] : new Date().toISOString().slice(2, 4) + new Date().toISOString().slice(5, 7) + new Date().toISOString().slice(8, 10)
                
                for (let i = 0; i < quantity; i++) {
                    let uniqueId
                    if (formData.get('uniqueIdType') === 'manual') {
                        uniqueId = `${formData.get('uniqueId')}-${String(i + 1).padStart(2, '0')}`
                    } else {
                        // 格式：批号-年月日-序号，如 ABC-251231-01
                        uniqueId = `${batchNumber}-${yearMonthDay}-${String(i + 1).padStart(2, '0')}`
                    }
                    
                    // 获取组分数据
                    const components = getComponentsData()

                    const stockItem = {
                        name: formData.get('name'),
                        code: formData.get('code'),
                        batch_number: formData.get('batchNumber'),
                        unique_id: uniqueId,
                        manufacturer: formData.get('manufacturer'),
                        // 保留旧字段用于兼容
                        concentration: components.length > 0 ? components[0].value : '',
                        unit: components.length > 0 ? components[0].unit : '',
                        uncertainty: components.length > 0 ? components[0].uncertainty : '',
                        // 新增组分字段（JSON格式存储所有组分）
                        components: components,
                        storage_condition: formData.get('storageCondition'),
                        dilution_condition: formData.get('dilutionCondition'),
                        quantity: 1,
                        expiry_date: formData.get('expiryDate'),
                        operator_id: currentUser?.id,
                        images: i === 0 ? fileUrls : []
                    }
                    
                    if (isOfflineMode) {
                        stockItem.id = Date.now() + i
                        stockItem.status = 'normal'
                        stockItem.created_at = new Date().toISOString()
                        const stock = LocalStorage.get('stock') || []
                        stock.push(stockItem)
                        LocalStorage.set('stock', stock)
                    } else {
                        // 检查 supabaseClient 是否可用
                        if (!supabaseClient) {
                            throw new Error('Supabase客户端未初始化，请刷新页面重试')
                        }

                        console.log('正在插入库存记录:', stockItem)

                        // 带重试机制的插入，如果唯一性标识重复则自动生成新的
                        let lastError = null
                        let currentUniqueId = uniqueId
                        for (let retry = 0; retry < 5; retry++) {
                            try {
                                // 更新唯一性标识
                                stockItem.unique_id = currentUniqueId
                                const { data, error } = await supabaseClient
                                    .from('stock_items')
                                    .insert([stockItem])
                                    .select()
                                if (error) {
                                    // 如果是唯一性标识重复错误，生成新的标识
                                    if (error.message && error.message.includes('unique constraint')) {
                                        // 序号自动递增，如 01 -> 03 -> 04
                                        const match = currentUniqueId.match(/^(.*-)(\d+)$/)
                                        if (match) {
                                            const prefix = match[1]
                                            const currentNum = parseInt(match[2], 10)
                                            currentUniqueId = `${prefix}${String(currentNum + 1).padStart(2, '0')}`
                                        } else {
                                            currentUniqueId = `${currentUniqueId}-02`
                                        }
                                        console.warn(`唯一性标识重复，递增序号: ${currentUniqueId}`)
                                        continue // 重试
                                    }
                                    throw error
                                }
                                records.push(data[0])
                                lastError = null
                                break
                            } catch (err) {
                                lastError = err
                                console.warn(`插入失败，第${retry + 1}次重试:`, err.message)
                                if (retry < 4) {
                                    await new Promise(r => setTimeout(r, 500))
                                }
                            }
                        }

                        if (lastError) {
                            console.error('插入库存记录失败:', lastError)
                            throw new Error('保存到数据库失败: ' + lastError.message)
                        }
                    }
                }
                
                // 添加操作记录
                try {
                    await addRecord('in', formData.get('name'), quantity, `批次号: ${formData.get('batchNumber') || 'N/A'}，入库${quantity}瓶`, fileUrls)
                } catch (recordError) {
                    console.error('添加操作记录失败:', recordError)
                    // 记录失败不影响入库成功
                }

                closeAddStockModal()
                // 操作成功后同步数据（使用setTimeout避免阻塞）
                setTimeout(() => {
                    syncAfterOperation().catch(err => console.error('后台同步失败:', err))
                }, 100)
                alert(`入库成功！已添加${quantity}瓶标准物质`)
            } catch (error) {
                console.error('入库错误详情:', error)
                let errorMsg = error.message
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = '网络连接失败，请检查网络后重试'
                }
                alert('入库失败: ' + errorMsg)
            } finally {
                showLoading(false)
            }
        }

        // ==================== 出库功能 ====================
        function showOutStockModal() {
            document.getElementById('outStockModal').classList.add('show')
            loadOutStockOptions()
        }

        function closeOutStockModal() {
            document.getElementById('outStockModal').classList.remove('show')
            document.getElementById('outStockForm').reset()
        }

        async function loadOutStockOptions() {
            const select = document.getElementById('outStockSelect')
            select.innerHTML = '<option value="">请选择</option>'
            
            let stock = []
            if (isOfflineMode) {
                stock = LocalStorage.get('stock') || []
            } else {
                const { data } = await supabaseClient.from('stock_items').select('*')
                stock = data || []
            }
            
            stock.forEach(item => {
                select.innerHTML += `<option value="${item.id}">${item.name}（${item.unique_id || item.uniqueId}）</option>`
            })
        }

        // 快速出库 - 直接出库当前物品
        async function quickOut(id) {
            if (!confirm('确定要出库该物品吗？')) return
            
            showLoading(true)
            try {
                let stockItem = null
                
                // 先从本地找到物品
                if (globalStockData) {
                    stockItem = globalStockData.find(s => s.id == id)
                }
                
                if (!stockItem && !isOfflineMode) {
                    // 本地没有，从数据库查询
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', id)
                        .single()
                    stockItem = data
                }
                
                if (!stockItem) throw new Error('库存不存在')
                
                if (isOfflineMode) {
                    // 离线模式：更新本地存储
                    const stock = LocalStorage.get('stock') || []
                    const newStock = stock.filter(s => s.id != id)
                    LocalStorage.set('stock', newStock)
                } else {
                    // 在线模式：删除数据库记录
                    await supabaseClient
                        .from('stock_items')
                        .delete()
                        .eq('id', id)
                }
                
                // 立即更新本地数据（不等待同步）
                if (globalStockData) {
                    globalStockData = globalStockData.filter(s => s.id != id)
                    DataCache.set('stock', globalStockData)
                }
                
                // 添加出库记录
                await addRecord('out', stockItem.name, 1, `快速出库，唯一性标识: ${stockItem.unique_id || stockItem.uniqueId}`, [])
                
                // 后台异步同步数据（不阻塞用户）
                setTimeout(() => {
                    syncAfterOperation().catch(err => console.log('后台同步失败:', err))
                }, 100)
                
                alert('出库成功！')
            } catch (error) {
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        async function handleStockOut(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const stockId = formData.get('stockId')
            
            try {
                // 获取库存信息
                let stockItem = null
                if (isOfflineMode) {
                    const stock = LocalStorage.get('stock') || []
                    stockItem = stock.find(s => s.id == stockId)
                } else {
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', stockId)
                        .single()
                    stockItem = data
                }
                
                if (!stockItem) throw new Error('库存不存在')
                
                // 处理图片
                const imageFiles = document.getElementById('outStockImages').files
                const imageUrls = []
                
                if (imageFiles.length > 0) {
                    for (let i = 0; i < imageFiles.length && i < 3; i++) {
                        const file = imageFiles[i]
                        
                        // 上传到Supabase Storage
                        const fileExt = file.name.split('.').pop()
                        const fileName = `out/${Date.now()}_${i}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`
                        
                        try {
                            const { error } = await supabaseClient.storage
                                .from('stock-images')
                                .upload(fileName, file)
                            
                            if (error) {
                                console.warn('Storage上传失败，使用Base64:', error)
                                const base64 = await fileToBase64(file)
                                imageUrls.push(base64)
                            } else {
                                const result = supabaseClient.storage
                                    .from('stock-images')
                                    .getPublicUrl(fileName)
                                let publicUrl
                                if (result && result.data) {
                                    publicUrl = result.data.publicUrl
                                } else if (result && typeof result === 'object') {
                                    publicUrl = result.publicUrl || result.url
                                }
                                if (!publicUrl || typeof publicUrl !== 'string') {
                                    throw new Error('无法获取文件URL')
                                }
                                imageUrls.push(publicUrl)
                            }
                        } catch (storageError) {
                            console.warn('Storage不可用，使用Base64:', storageError)
                            const base64 = await fileToBase64(file)
                            imageUrls.push(base64)
                        }
                    }
                }
                
                // 删除库存
                if (isOfflineMode) {
                    let stock = LocalStorage.get('stock') || []
                    stock = stock.filter(s => s.id != stockId)
                    LocalStorage.set('stock', stock)
                } else {
                    const { error } = await supabaseClient
                        .from('stock_items')
                        .delete()
                        .eq('id', stockId)
                    if (error) throw error
                }
                
                // 添加记录
                await addRecord('out', stockItem.name, 1, `唯一性标识: ${stockItem.unique_id || stockItem.uniqueId}，用途: ${formData.get('purpose') || '未填写'}`, imageUrls)
                
                closeOutStockModal()
                // 操作成功后同步数据
                await syncAfterOperation()
                alert('出库成功！')
            } catch (error) {
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        async function deleteStock(id) {
            if (!confirm('确定要删除这个标准物质吗？')) return
            
            try {
                if (isOfflineMode) {
                    let stock = LocalStorage.get('stock') || []
                    stock = stock.filter(s => s.id != id)
                    LocalStorage.set('stock', stock)
                } else {
                    const { error } = await supabaseClient
                        .from('stock_items')
                        .delete()
                        .eq('id', id)
                    if (error) throw error
                }
                
                // 操作成功后同步数据
                await syncAfterOperation()
                alert('删除成功！')
            } catch (error) {
                alert('删除失败: ' + error.message)
            }
        }

        // 渲染组分摘要（用于列表显示）
        function renderComponentsSummary(item) {
            const components = item.components || []

            if (components.length > 0) {
                if (components.length === 1) {
                    const c = components[0]
                    return `${c.name || ''} ${c.value || ''} ${c.unit || ''}`
                } else {
                    // 混标显示组分数量和第一个组分示例
                    const firstComp = components[0]
                    return `混标(${components.length}组分): ${firstComp.name || ''}等`
                }
            }

            // 兼容旧格式
            return `标准值: ${item.concentration || ''} ${item.unit || ''}`
        }

        // 渲染组分信息HTML
        function renderComponentsHtml(item) {
            const components = item.components || []

            // 如果有新格式的components字段
            if (components.length > 0) {
                return `
                    <div class="col-span-2">
                        <span class="text-gray-500">组分信息:</span>
                        <div class="mt-1 bg-gray-50 rounded p-2">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-gray-600 border-b">
                                        <th class="text-left py-1">组分</th>
                                        <th class="text-left py-1">标准值</th>
                                        <th class="text-left py-1">单位</th>
                                        <th class="text-left py-1">不确定度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${components.map(c => `
                                        <tr class="border-b border-gray-100 last:border-0">
                                            <td class="py-1">${c.name || '-'}</td>
                                            <td class="py-1">${c.value || '-'}</td>
                                            <td class="py-1">${c.unit || '-'}</td>
                                            <td class="py-1">${c.uncertainty || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `
            }

            // 兼容旧格式
            return `
                <div><span class="text-gray-500">标准值:</span> ${item.concentration || 'N/A'} ${item.unit || ''}</div>
                <div><span class="text-gray-500">不确定度:</span> ${item.uncertainty || 'N/A'}</div>
            `
        }

        async function viewStockDetail(id) {
            let item = null
            if (isOfflineMode) {
                const stock = LocalStorage.get('stock') || []
                item = stock.find(s => s.id == id)
            } else {
                // 从全局数据查找
                item = globalStockData?.find(s => s.id == id)
            }
            
            if (!item) return

            // 动态计算状态
            const currentStatus = calculateItemStatus(item.expiry_date || item.expiryDate)

            const statusText = {
                normal: '正常',
                warning: '临期',
                expired: '过期',
                low: '库存不足'
            }[currentStatus]
            
            let imagesHtml = ''
            const images = item.images || []
            console.log('查看详情 - 附件列表:', images)
            if (images.length > 0) {
                imagesHtml = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">相关附件</h3>
                        <div class="record-images">
                            ${images.map((img, idx) => {
                                const isPDF = img.toLowerCase().endsWith('.pdf') || 
                                             img.includes('application/pdf') ||
                                             img.startsWith('data:application/pdf')
                                // 提取文件名：URL格式取最后一部分，Base64格式显示为PDF文件或图片
                                let fileName
                                if (img.startsWith('data:')) {
                                    fileName = isPDF ? `PDF文件 ${idx + 1}` : `图片 ${idx + 1}`
                                } else {
                                    fileName = img.split('/').pop() || (isPDF ? 'PDF文件' : '图片')
                                }
                                // 生成唯一的ID用于查找
                                const uniqueId = 'attach_' + Date.now() + '_' + idx
                                // 将数据存储在全局变量中
                                if (!window.tempAttachments) window.tempAttachments = {}
                                window.tempAttachments[uniqueId] = { url: img, name: fileName, isPDF: isPDF }
                                
                                if (isPDF) {
                                    return `
                                        <div class="record-image-item" onclick="viewAttachment('${uniqueId}')" 
                                             style="background: #fee2e2; cursor: pointer;"
                                             title="点击查看PDF: ${fileName}">
                                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column;">
                                                <i class="fa fa-file-pdf-o" style="font-size: 32px; color: #dc2626;"></i>
                                                <span style="font-size: 10px; color: #666; margin-top: 4px; text-align: center; padding: 0 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;">${fileName}</span>
                                            </div>
                                        </div>
                                    `
                                } else {
                                    return `
                                        <div class="record-image-item" onclick="viewAttachment('${uniqueId}')" style="cursor: pointer;" title="点击查看大图: ${fileName}">
                                            <img src="${img}" alt="${fileName}">
                                        </div>
                                    `
                                }
                            }).join('')}
                        </div>
                    </div>
                `
            }
            
            // 构建完整的详情HTML
            let detailHtml = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-500">标准物质名称:</span> ${item.name || 'N/A'}</div>
                        <div><span class="text-gray-500">标准物质编号:</span> ${item.code || 'N/A'}</div>
                        <div><span class="text-gray-500">批次号:</span> ${item.batch_number || item.batchNumber || 'N/A'}</div>
                        <div><span class="text-gray-500">唯一性标识:</span> ${item.unique_id || item.uniqueId || 'N/A'}</div>
                        <div><span class="text-gray-500">生产厂家:</span> ${item.manufacturer || 'N/A'}</div>
                        <div><span class="text-gray-500">数量:</span> ${item.quantity || 0}</div>
                        <div><span class="text-gray-500">有效期:</span> ${item.expiry_date || item.expiryDate || 'N/A'}</div>
                        <div><span class="text-gray-500">状态:</span> <span class="status-badge status-${currentStatus}">${statusText}</span></div>
                        <div><span class="text-gray-500">保存条件:</span> ${item.storage_condition || item.storageCondition || 'N/A'}</div>
                        <div><span class="text-gray-500">稀释条件:</span> ${item.dilution_condition || item.dilutionCondition || 'N/A'}</div>
            `
            
            // 添加组分信息
            if (item.components && item.components.length > 0) {
                detailHtml += `
                    <div class="col-span-2 mt-4">
                        <h3 class="font-semibold mb-2">组分信息</h3>
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">组分名称</th>
                                    <th class="text-left py-2">标准值</th>
                                    <th class="text-left py-2">单位</th>
                                    <th class="text-left py-2">不确定度</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${item.components.map(c => `
                                    <tr class="border-b border-gray-100">
                                        <td class="py-2">${c.name || '-'}</td>
                                        <td class="py-2">${c.value || '-'}</td>
                                        <td class="py-2">${c.unit || '-'}</td>
                                        <td class="py-2">${c.uncertainty || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `
            } else if (item.concentration) {
                // 兼容旧格式
                detailHtml += `
                    <div><span class="text-gray-500">标准值:</span> ${item.concentration} ${item.unit || ''}</div>
                    <div><span class="text-gray-500">不确定度:</span> ${item.uncertainty || 'N/A'}</div>
                `
            }
            
            // 添加操作人信息 - 优先显示用户名，不显示ID
            if (item.operator_name) {
                detailHtml += `<div><span class="text-gray-500">录入人:</span> ${item.operator_name}</div>`
            } else if (item.operator_id) {
                // 如果没有operator_name，尝试从人员列表查找用户名
                const operator = globalPersonnelData?.find(p => p.id === item.operator_id)
                if (operator?.name) {
                    detailHtml += `<div><span class="text-gray-500">录入人:</span> ${operator.name}</div>`
                } else if (operator?.username) {
                    detailHtml += `<div><span class="text-gray-500">录入人:</span> ${operator.username}</div>`
                }
                // 如果找不到对应用户，不显示录入人信息
            }
            
            // 添加创建和更新时间
            detailHtml += `
                        <div><span class="text-gray-500">创建时间:</span> ${item.created_at || item.createdAt ? new Date(item.created_at || item.createdAt).toLocaleString('zh-CN') : 'N/A'}</div>
                        ${item.updated_at || item.updatedAt ? `<div><span class="text-gray-500">更新时间:</span> ${new Date(item.updated_at || item.updatedAt).toLocaleString('zh-CN')}</div>` : ''}
                    </div>
                    
                    ${imagesHtml}
                    
                    <div class="flex space-x-3 mt-4">
                        <button onclick="quickOut('${item.id}'); closeViewDetailModal();" class="flex-1 btn btn-warning">出库</button>
                        <button onclick="editStockItem('${item.id}'); closeViewDetailModal();" class="flex-1 btn btn-primary bg-blue-500 hover:bg-blue-600">编辑</button>
                        <button onclick="closeViewDetailModal()" class="flex-1 btn btn-secondary">关闭</button>
                    </div>
                </div>
            `
            
            document.getElementById('viewDetailContent').innerHTML = detailHtml
            
            document.getElementById('viewDetailModal').classList.add('show')
        }

        function closeViewDetailModal() {
            document.getElementById('viewDetailModal').classList.remove('show')
        }

        // ==================== 编辑标准物质功能 ====================
        let currentEditStockItem = null

        // 打开编辑模态框
        async function editStockItem(id) {
            let item = null
            if (isOfflineMode) {
                const stock = LocalStorage.get('stock') || []
                item = stock.find(s => s.id == id)
            } else {
                item = globalStockData?.find(s => s.id == id)
            }
            
            if (!item) {
                alert('找不到该物品')
                return
            }
            
            currentEditStockItem = item
            
            // 填充表单
            document.getElementById('editStockId').value = item.id
            document.getElementById('editStockName').value = item.name || ''
            document.getElementById('editStockUniqueId').value = item.unique_id || item.uniqueId || ''
            document.getElementById('editStockCode').value = item.code || ''
            document.getElementById('editStockBatchNumber').value = item.batch_number || item.batchNumber || ''
            document.getElementById('editStockManufacturer').value = item.manufacturer || ''
            document.getElementById('editStockExpiryDate').value = item.expiry_date || item.expiryDate || ''
            document.getElementById('editStockStorageCondition').value = item.storage_condition || item.storageCondition || ''
            document.getElementById('editStockDilutionCondition').value = item.dilution_condition || item.dilutionCondition || ''
            
            // 填充组分信息
            renderEditComponents(item.components || [])
            
            // 填充现有附件
            editExistingImages = item.images || []
            console.log('编辑 - 现有附件:', editExistingImages)
            editNewFiles = []
            document.getElementById('editNewFilesPreview').innerHTML = ''
            renderEditExistingFiles()
            
            // 显示模态框
            document.getElementById('editStockModal').classList.add('show')
        }

        // 关闭编辑模态框
        function closeEditStockModal() {
            document.getElementById('editStockModal').classList.remove('show')
            document.getElementById('editStockForm').reset()
            document.getElementById('editComponentsList').innerHTML = ''
            document.getElementById('editExistingFiles').innerHTML = ''
            document.getElementById('editNewFilesPreview').innerHTML = ''
            editNewFiles = []
            editExistingImages = []
            currentEditStockItem = null
        }

        // 渲染编辑组分列表
        function renderEditComponents(components) {
            const container = document.getElementById('editComponentsList')
            container.innerHTML = ''
            
            if (!components || components.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">暂无组分信息</p>'
                return
            }
            
            components.forEach((comp, index) => {
                const div = document.createElement('div')
                div.className = 'component-item bg-gray-50 p-2 rounded border border-gray-200'
                div.innerHTML = `
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <input type="text" class="form-input text-sm comp-name" placeholder="组分名称" value="${comp.name || ''}">
                        <input type="text" class="form-input text-sm comp-value" placeholder="标准值" value="${comp.value || comp.concentration || ''}">
                        <input type="text" class="form-input text-sm comp-unit" placeholder="单位" value="${comp.unit || ''}">
                        <input type="text" class="form-input text-sm comp-uncertainty" placeholder="不确定度" value="${comp.uncertainty || ''}">
                    </div>
                    <div class="flex justify-end">
                        <button type="button" onclick="removeEditComponent(this)" class="text-xs text-red-500 hover:text-red-700">
                            <i class="fa fa-trash mr-1"></i>删除
                        </button>
                    </div>
                `
                container.appendChild(div)
            })
        }

        // 添加编辑组分
        function addEditComponent() {
            const container = document.getElementById('editComponentsList')
            
            // 如果之前显示的是"暂无组分信息"，清空它
            if (container.querySelector('p.text-gray-400')) {
                container.innerHTML = ''
            }
            
            const div = document.createElement('div')
            div.className = 'component-item bg-gray-50 p-2 rounded border border-gray-200'
            div.innerHTML = `
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <input type="text" class="form-input text-sm comp-name" placeholder="组分名称">
                    <input type="text" class="form-input text-sm comp-value" placeholder="标准值">
                    <input type="text" class="form-input text-sm comp-unit" placeholder="单位">
                    <input type="text" class="form-input text-sm comp-uncertainty" placeholder="不确定度">
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="removeEditComponent(this)" class="text-xs text-red-500 hover:text-red-700">
                        <i class="fa fa-trash mr-1"></i>删除
                    </button>
                </div>
            `
            container.appendChild(div)
        }

        // 删除编辑组分
        function removeEditComponent(btn) {
            const item = btn.closest('.component-item')
            item.remove()
            
            // 如果没有组分了，显示提示
            const container = document.getElementById('editComponentsList')
            if (container.children.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">暂无组分信息</p>'
            }
        }

        // 收集编辑组分数据
        function collectEditComponents() {
            const container = document.getElementById('editComponentsList')
            const items = container.querySelectorAll('.component-item')
            const components = []
            
            items.forEach(item => {
                const name = item.querySelector('.comp-name').value.trim()
                const value = item.querySelector('.comp-value').value.trim()
                const unit = item.querySelector('.comp-unit').value.trim()
                const uncertainty = item.querySelector('.comp-uncertainty').value.trim()
                
                if (name || value) {
                    components.push({
                        name: name,
                        value: value,
                        concentration: value,
                        unit: unit,
                        uncertainty: uncertainty
                    })
                }
            })
            
            return components
        }

        // 编辑表单文件预览
        let editNewFiles = []
        let editExistingImages = []

        // 处理编辑文件预览
        function handleEditFilePreview(input) {
            const files = Array.from(input.files)
            const previewContainer = document.getElementById('editNewFilesPreview')
            
            // 检查总文件数限制
            if (editNewFiles.length + files.length > 5) {
                alert('最多只能上传5个文件')
                return
            }
            
            files.forEach(file => {
                // 检查文件类型
                if (!file.type.match(/image.*|application\/pdf/)) {
                    alert(`${file.name} 不是支持的文件格式`)
                    return
                }
                
                // 检查文件大小（限制10MB）
                if (file.size > 10 * 1024 * 1024) {
                    alert(`${file.name} 超过10MB限制`)
                    return
                }
                
                editNewFiles.push(file)
                
                const div = document.createElement('div')
                div.className = 'relative bg-gray-100 rounded p-2'
                
                if (file.type === 'application/pdf') {
                    // 创建PDF预览URL
                    const pdfUrl = URL.createObjectURL(file)
                    div.innerHTML = `
                        <div class="flex items-center justify-center h-20 bg-red-50 rounded cursor-pointer" 
                             onclick="viewPDF('${pdfUrl}', '${file.name}')"
                             title="点击预览PDF: ${file.name}">
                            <i class="fa fa-file-pdf-o text-red-500 text-2xl"></i>
                        </div>
                        <p class="text-xs text-gray-600 mt-1 truncate cursor-pointer" 
                           onclick="viewPDF('${pdfUrl}', '${file.name}')"
                           title="点击预览PDF: ${file.name}">${file.name}</p>
                        <button type="button" onclick="event.stopPropagation(); removeEditNewFile(${editNewFiles.length - 1}, this)" 
                            class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600"
                            title="删除">
                            <i class="fa fa-times"></i>
                        </button>
                    `
                } else {
                    const reader = new FileReader()
                    reader.onload = function(e) {
                        div.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-20 object-cover rounded">
                            <button type="button" onclick="removeEditNewFile(${editNewFiles.length - 1}, this)" 
                                class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600">
                                <i class="fa fa-times"></i>
                            </button>
                        `
                    }
                    reader.readAsDataURL(file)
                }
                
                previewContainer.appendChild(div)
            })
        }

        // 删除新上传的文件
        function removeEditNewFile(index, btn) {
            editNewFiles.splice(index, 1)
            btn.closest('.relative').remove()
        }

        // 删除现有附件
        function removeEditExistingFile(index) {
            editExistingImages.splice(index, 1)
            renderEditExistingFiles()
        }

        // 渲染现有附件
        function renderEditExistingFiles() {
            const container = document.getElementById('editExistingFiles')
            container.innerHTML = ''
            
            // 初始化临时附件存储
            if (!window.tempEditAttachments) window.tempEditAttachments = {}
            
            editExistingImages.forEach((url, index) => {
                const div = document.createElement('div')
                div.className = 'relative bg-gray-100 rounded p-2'
                
                const isPDF = url.toLowerCase().endsWith('.pdf') || 
                             url.includes('application/pdf') ||
                             url.startsWith('data:application/pdf')
                
                // 提取文件名
                let fileName
                if (url.startsWith('data:')) {
                    fileName = isPDF ? `PDF文件 ${index + 1}` : `图片 ${index + 1}`
                } else {
                    fileName = url.split('/').pop() || (isPDF ? 'PDF文件' : '图片')
                }
                
                // 生成唯一ID并存储数据
                const uniqueId = 'edit_attach_' + Date.now() + '_' + index
                window.tempEditAttachments[uniqueId] = { url: url, name: fileName, isPDF: isPDF }
                
                if (isPDF) {
                    div.innerHTML = `
                        <div class="flex items-center justify-center h-20 bg-red-50 rounded cursor-pointer" 
                             onclick="viewEditAttachment('${uniqueId}')"
                             title="点击查看PDF: ${fileName}">
                            <i class="fa fa-file-pdf-o text-red-500 text-2xl"></i>
                        </div>
                        <p class="text-xs text-gray-600 mt-1 truncate cursor-pointer" 
                           onclick="viewEditAttachment('${uniqueId}')"
                           title="${fileName}">${fileName}</p>
                        <button type="button" onclick="event.stopPropagation(); removeEditExistingFile(${index})" 
                            class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600"
                            title="删除">
                            <i class="fa fa-times"></i>
                        </button>
                    `
                } else {
                    div.innerHTML = `
                        <img src="${url}" class="w-full h-20 object-cover rounded cursor-pointer" 
                             onclick="viewEditAttachment('${uniqueId}')" title="点击查看大图: ${fileName}">
                        <button type="button" onclick="removeEditExistingFile(${index})" 
                            class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600">
                            <i class="fa fa-times"></i>
                        </button>
                    `
                }
                
                container.appendChild(div)
            })
        }
        
        // 查看编辑界面的附件
        function viewEditAttachment(uniqueId) {
            const attachment = window.tempEditAttachments && window.tempEditAttachments[uniqueId]
            if (!attachment) {
                alert('附件数据不存在')
                return
            }
            
            if (attachment.isPDF) {
                viewPDF(attachment.url, attachment.name)
            } else {
                viewImage(attachment.url, attachment.name)
            }
        }

        // 上传编辑表单文件到Supabase Storage
        async function uploadEditFiles(files) {
            if (!files || files.length === 0) return []
            
            const uploadedUrls = []
            
            for (const file of files) {
                try {
                    const fileExt = file.name.split('.').pop()
                    const fileName = `edit/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`
                    
                    const { error } = await supabaseClient
                        .storage
                        .from('stock-images')
                        .upload(fileName, file)
                    
                    if (error) {
                        console.warn('Storage上传失败，使用Base64:', error)
                        const base64 = await fileToBase64(file)
                        uploadedUrls.push(base64)
                    } else {
                        const result = supabaseClient
                            .storage
                            .from('stock-images')
                            .getPublicUrl(fileName)
                        let publicUrl
                        if (result && result.data) {
                            publicUrl = result.data.publicUrl
                        } else if (result && typeof result === 'object') {
                            publicUrl = result.publicUrl || result.url
                        }
                        if (!publicUrl || typeof publicUrl !== 'string') {
                            throw new Error('无法获取文件URL')
                        }
                        uploadedUrls.push(publicUrl)
                    }
                } catch (err) {
                    console.warn('Storage不可用，使用Base64:', err)
                    try {
                        const base64 = await fileToBase64(file)
                        uploadedUrls.push(base64)
                    } catch (base64Err) {
                        console.error('Base64转换失败:', base64Err)
                        alert(`上传 ${file.name} 失败`)
                    }
                }
            }
            
            return uploadedUrls
        }

        // 处理编辑提交
        async function handleEditStock(event) {
            event.preventDefault()
            
            const id = document.getElementById('editStockId').value
            
            // 收集组分信息
            const components = collectEditComponents()
            
            showLoading(true)
            
            try {
                // 上传新文件
                let newImageUrls = []
                if (editNewFiles.length > 0) {
                    newImageUrls = await uploadEditFiles(editNewFiles)
                }
                
                // 合并现有附件和新上传的附件
                const allImages = [...editExistingImages, ...newImageUrls]
                
                const updates = {
                    name: document.getElementById('editStockName').value.trim(),
                    unique_id: document.getElementById('editStockUniqueId').value.trim(),
                    code: document.getElementById('editStockCode').value.trim(),
                    batch_number: document.getElementById('editStockBatchNumber').value.trim(),
                    manufacturer: document.getElementById('editStockManufacturer').value.trim(),
                    expiry_date: document.getElementById('editStockExpiryDate').value,
                    storage_condition: document.getElementById('editStockStorageCondition').value.trim(),
                    dilution_condition: document.getElementById('editStockDilutionCondition').value.trim(),
                    components: components,
                    images: allImages,
                    updated_at: new Date().toISOString()
                }
                
                if (isOfflineMode) {
                    // 离线模式：更新本地存储
                    const stock = LocalStorage.get('stock') || []
                    const index = stock.findIndex(s => s.id == id)
                    if (index !== -1) {
                        stock[index] = { ...stock[index], ...updates }
                        LocalStorage.set('stock', stock)
                        globalStockData = stock
                        DataCache.set('stock', stock)
                    }
                } else {
                    // 在线模式：更新数据库
                    const { error } = await supabaseClient
                        .from('stock_items')
                        .update(updates)
                        .eq('id', id)
                    
                    if (error) throw error
                    
                    // 更新本地数据
                    const index = globalStockData.findIndex(s => s.id == id)
                    if (index !== -1) {
                        globalStockData[index] = { ...globalStockData[index], ...updates }
                        DataCache.set('stock', globalStockData)
                    }
                }
                
                // 刷新列表
                renderStockListWithData(globalStockData)
                
                closeEditStockModal()
                alert('修改成功！')
            } catch (error) {
                console.error('修改失败:', error)
                alert('修改失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // ==================== 记录管理 ====================
        async function addRecord(type, materialName, quantity, note, images = []) {
            const record = {
                type,
                material_name: materialName,
                quantity,
                operator_id: currentUser?.id,
                operator_name: currentUser?.name,
                note,
                images: images || []
            }
            
            if (isOfflineMode) {
                record.id = Date.now()
                record.created_at = new Date().toISOString()
                const records = LocalStorage.get('records') || []
                records.push(record)
                LocalStorage.set('records', records)
            } else {
                try {
                    const { error } = await supabaseClient.from('operation_records').insert([record])
                    if (error) {
                        console.error('添加记录失败:', error)
                        // 如果插入失败（可能是images字段不存在），尝试不带images插入
                        const recordWithoutImages = { ...record }
                        delete recordWithoutImages.images
                        await supabaseClient.from('operation_records').insert([recordWithoutImages])
                    }
                } catch (err) {
                    console.error('添加记录异常:', err)
                }
            }
        }

        // 使用共享数据渲染记录列表
        function renderRecordsListWithData(records) {
            if (!records) records = []
            renderRecordsListCore(records)
        }
        
        // 核心渲染函数
        function renderRecordsListCore(records) {
            const search = document.getElementById('recordsSearchInput')?.value?.toLowerCase() || ''
            
            if (search) {
                records = records.filter(r => 
                    (r.material_name || r.materialName || '').toLowerCase().includes(search) ||
                    (r.operator_name || r.operator || '').toLowerCase().includes(search)
                )
            }
            
            const container = document.getElementById('recordsList')
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-history text-4xl mb-2"></i><p>暂无操作记录</p></div>'
                return
            }
            
            const icons = { in: 'fa-archive text-blue-500', out: 'fa-sign-out text-green-500', warning: 'fa-exclamation-triangle text-yellow-500' }
            const types = { in: '入库', out: '出库', warning: '预警' }
            const badges = { in: 'bg-blue-100 text-blue-800', out: 'bg-green-100 text-green-800', warning: 'bg-yellow-100 text-yellow-800' }
            
            container.innerHTML = records.map(record => {
                let imagesHtml = ''
                const images = record.images || []
                if (images.length > 0) {
                    imagesHtml = `
                        <div class="record-images mt-3">
                            ${images.map((img, idx) => {
                                const isPDF = img.toLowerCase().endsWith('.pdf') || 
                                             img.includes('application/pdf') ||
                                             img.startsWith('data:application/pdf')
                                const isImage = img.startsWith('data:image') || 
                                               img.startsWith('http') ||
                                               img.startsWith('blob:')
                                
                                // 生成唯一ID
                                const uniqueId = 'record_' + record.id + '_' + idx
                                if (!window.tempAttachments) window.tempAttachments = {}
                                window.tempAttachments[uniqueId] = {
                                    url: img,
                                    name: isPDF ? `PDF文件 ${idx + 1}` : `图片 ${idx + 1}`,
                                    isPDF: isPDF
                                }
                                
                                if (isPDF) {
                                    return `
                                        <div class="record-image-item" 
                                             onclick="viewAttachment('${uniqueId}')" 
                                             style="background: #fee2e2;"
                                             title="点击查看PDF">
                                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column;">
                                                <i class="fa fa-file-pdf-o" style="font-size: 32px; color: #dc2626;"></i>
                                                <span style="font-size: 10px; color: #666; margin-top: 4px;">PDF</span>
                                            </div>
                                        </div>
                                    `
                                } else if (isImage) {
                                    return `
                                        <div class="record-image-item" 
                                             onclick="viewAttachment('${uniqueId}')" 
                                             title="点击查看大图">
                                            <img src="${img}" alt="记录图片" 
                                                onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;background:#f3f4f6;color:#9ca3af;font-size:12px;\\'>加载失败</div>'">
                                        </div>
                                    `
                                } else {
                                    return `
                                        <div class="record-image-item" 
                                             onclick="viewAttachment('${uniqueId}')"
                                             style="background: #f3f4f6;"
                                             title="点击查看文件">
                                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column;">
                                                <i class="fa fa-file-o" style="font-size: 32px; color: #6b7280;"></i>
                                                <span style="font-size: 10px; color: #666; margin-top: 4px;">文件</span>
                                            </div>
                                        </div>
                                    `
                                }
                            }).join('')}
                        </div>
                    `
                }
                
                return `
                    <div class="record-item">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                    <i class="fa ${icons[record.type]}"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">${record.material_name || record.materialName}</h3>
                                    <p class="text-sm text-gray-500">${record.operator_name || record.operator} · ${new Date(record.created_at || record.date).toLocaleString('zh-CN')}</p>
                                </div>
                            </div>
                            <span class="status-badge ${badges[record.type] || 'bg-gray-100 text-gray-600'}">${types[record.type]}</span>
                        </div>
                        <div class="mt-2">
                            <p class="text-sm">数量: ${record.quantity}</p>
                            <p class="text-sm text-gray-500">备注: ${record.note}</p>
                            ${imagesHtml}
                        </div>
                    </div>
                `
            }).join('')
        }
        
        async function renderRecordsList() {
            let records = []
            
            if (isOfflineMode) {
                records = LocalStorage.get('records') || []
            } else {
                // 先检查全局数据
                if (globalRecordsData) {
                    records = globalRecordsData
                } else {
                    const { data } = await supabaseClient
                        .from('operation_records')
                        .select('*')
                        .order('created_at', { ascending: false })
                    records = data || []
                }
            }
            
            renderRecordsListCore(records)
        }

        // ==================== 人员管理 ====================

        // 获取角色显示名称
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': '标准物质管理员',
                'chemist': '化验员',
                'user': '普通用户'
            }
            return roleNames[role] || '普通用户'
        }

        // 获取角色徽章样式类
        function getRoleBadgeClass(role) {
            const roleClasses = {
                'admin': 'bg-blue-100 text-blue-800',
                'chemist': 'bg-purple-100 text-purple-800',
                'user': 'bg-green-100 text-green-800'
            }
            return roleClasses[role] || 'bg-gray-100 text-gray-800'
        }

        // 判断是否为管理员（标准物质管理员）
        function isAdmin(user) {
            return user && user.role === 'admin'
        }

        // 判断是否为化验员
        function isChemist(user) {
            return user && user.role === 'chemist'
        }

        // 使用共享数据渲染人员列表
        function renderPersonnelListWithData(personnel) {
            if (!personnel) personnel = []
            renderPersonnelListCore(personnel)
        }
        
        // 核心渲染函数
        function renderPersonnelListCore(personnel) {
            const search = document.getElementById('personnelSearchInput')?.value?.toLowerCase() || ''
            
            if (search) {
                personnel = personnel.filter(p => 
                    (p.name || '').toLowerCase().includes(search) ||
                    (p.username || '').toLowerCase().includes(search)
                )
            }
            
            const container = document.getElementById('personnelList')
            if (personnel.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-users text-4xl mb-2"></i><p>暂无人员数据</p></div>'
                return
            }
            
            console.log('【renderPersonnelListCore】当前用户:', currentUser?.name, '角色:', currentUser?.role, '是否管理员:', isAdmin(currentUser))
            
            container.innerHTML = personnel.map(person => {
                const canEdit = isAdmin(currentUser) && person.id !== currentUser?.id
                console.log('【renderPersonnelListCore】人员:', person.name, 'ID:', person.id, '能否编辑:', canEdit)
                
                return `
                <div class="personnel-item">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${person.name}</h3>
                            <p class="text-sm text-gray-500">${person.username || person.email}</p>
                        </div>
                        <span class="status-badge ${getRoleBadgeClass(person.role)}">
                            ${getRoleDisplayName(person.role)}
                        </span>
                    </div>
                    ${canEdit ? `
                        <div class="flex justify-end space-x-2 mt-3">
                            <button onclick="showEditRoleModal('${person.id}', '${person.name}', '${person.role}')" class="text-primary text-sm">
                                <i class="fa fa-edit"></i> 修改角色
                            </button>
                            <button onclick="deletePersonnel('${person.id}')" class="text-danger text-sm">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </div>
                    ` : ''}
                </div>
            `}).join('')
        }
        
        async function renderPersonnelList() {
            let personnel = []
            
            console.log('【renderPersonnelList】开始渲染人员列表')
            
            if (isOfflineMode) {
                personnel = LocalStorage.get('personnel') || []
                console.log('【renderPersonnelList】离线模式，人员数量:', personnel.length)
            } else {
                // 先检查全局数据
                if (globalPersonnelData) {
                    console.log('【renderPersonnelList】使用全局缓存数据')
                    personnel = globalPersonnelData
                } else {
                    console.log('【renderPersonnelList】从Supabase获取数据')
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .order('created_at', { ascending: false })
                    
                    if (error) {
                        console.error('【renderPersonnelList】获取数据失败:', error)
                    }
                    
                    personnel = data || []
                    globalPersonnelData = personnel
                    console.log('【renderPersonnelList】获取到', personnel.length, '条人员数据')
                    
                    // 打印每个用户的角色
                    personnel.forEach(p => {
                        console.log('【renderPersonnelList】用户:', p.name, '角色:', p.role)
                    })
                }
            }
            
            renderPersonnelListCore(personnel)
        }

        function showAddPersonnelModal() {
            document.getElementById('addPersonnelModal').classList.add('show')
        }

        function closeAddPersonnelModal() {
            document.getElementById('addPersonnelModal').classList.remove('show')
            document.getElementById('addPersonnelForm').reset()
        }

        async function deletePersonnel(id) {
            if (!confirm('确定要删除这个人员吗？')) return
            
            showLoading(true)
            console.log('【删除人员】开始删除，ID:', id)
            
            try {
                if (isOfflineMode) {
                    // 离线模式：从本地删除
                    console.log('【删除人员】离线模式删除')
                    let personnel = LocalStorage.get('personnel') || []
                    personnel = personnel.filter(p => p.id != id)
                    LocalStorage.set('personnel', personnel)
                    
                    // 更新全局数据
                    globalPersonnelData = personnel
                    
                    showToast('删除成功（离线模式）', 'success')
                } else {
                    // 在线模式：尝试删除
                    console.log('【删除人员】在线模式，尝试删除profiles表')
                    
                    try {
                        // 先尝试删除profiles表中的记录
                        const { error: profileError } = await supabaseClient
                            .from('profiles')
                            .delete()
                            .eq('id', id)
                        
                        if (profileError) {
                            console.error('【删除人员】删除profiles失败:', profileError)
                            
                            // 如果是权限错误，使用本地标记删除
                            if (profileError.code === '42501' || 
                                profileError.message.includes('row-level security') ||
                                profileError.message.includes('permission')) {
                                console.log('【删除人员】权限不足，使用本地标记删除')
                                throw new Error('PERMISSION_FALLBACK')
                            }
                            
                            throw profileError
                        }
                        
                        console.log('【删除人员】profiles删除成功')
                        
                        // 尝试删除auth用户（可能会失败，因为需要admin权限）
                        try {
                            const { error: authError } = await supabaseClient.auth.admin.deleteUser(id)
                            if (authError) {
                                console.log('【删除人员】删除auth用户失败（需要admin权限）:', authError.message)
                                // 这不影响整体删除，因为profile已经删除了
                            } else {
                                console.log('【删除人员】auth用户删除成功')
                            }
                        } catch (authErr) {
                            console.log('【删除人员】删除auth用户失败:', authErr.message)
                        }
                        
                        showToast('删除成功', 'success')
                        
                    } catch (err) {
                        if (err.message === 'PERMISSION_FALLBACK') {
                            // 权限不足时，使用本地标记删除
                            console.log('【删除人员】切换到本地标记删除')
                            
                            // 从本地数据中移除
                            let localPersonnel = LocalStorage.get('personnel') || []
                            localPersonnel = localPersonnel.filter(p => p.id != id)
                            LocalStorage.set('personnel', localPersonnel)
                            
                            // 更新全局数据
                            globalPersonnelData = globalPersonnelData.filter(p => p.id != id)
                            
                            showToast('删除成功（本地模式）', 'success')
                        } else {
                            throw err
                        }
                    }
                }
                
                // 刷新人员列表
                await renderPersonnelList()
                console.log('【删除人员】完成')
                
            } catch (error) {
                console.error('【删除人员】失败:', error)
                showToast('删除失败: ' + error.message, 'error')
            } finally {
                showLoading(false)
            }
        }

        // 显示修改角色模态框
        function showEditRoleModal(userId, userName, currentRole) {
            document.getElementById('editRoleUserId').value = userId
            document.getElementById('editRoleUserName').textContent = userName
            document.getElementById('editRoleSelect').value = currentRole
            document.getElementById('editRoleModal').classList.add('show')
        }

        // 关闭修改角色模态框
        function closeEditRoleModal() {
            document.getElementById('editRoleModal').classList.remove('show')
            document.getElementById('editRoleForm').reset()
        }

        // 处理修改角色
        async function handleEditRole(e) {
            e.preventDefault()
            showLoading(true)
            
            const userId = document.getElementById('editRoleUserId').value
            const newRole = document.getElementById('editRoleSelect').value
            
            console.log('【修改角色】用户ID:', userId)
            console.log('【修改角色】新角色:', newRole)
            
            try {
                if (isOfflineMode) {
                    let personnel = LocalStorage.get('personnel') || []
                    const personIndex = personnel.findIndex(p => p.id === userId)
                    if (personIndex !== -1) {
                        personnel[personIndex].role = newRole
                        LocalStorage.set('personnel', personnel)
                    }
                } else {
                    console.log('【修改角色】开始更新...')
                    console.log('【修改角色】用户ID:', userId)
                    console.log('【修改角色】新角色:', newRole)
                    
                    // 由于RLS限制，我们使用另一种方式：
                    // 1. 尝试直接更新（如果RLS允许）
                    // 2. 如果失败，提示用户需要在Supabase中手动设置
                    
                    // 使用fetch直接调用Supabase REST API，添加正确的Content-Type
                    const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/profiles?id=eq.${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}`,
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({ role: newRole })
                    })
                    
                    const data = updateResponse.ok ? await updateResponse.json() : null
                    const error = updateResponse.ok ? null : { message: await updateResponse.text(), code: updateResponse.status }
                    
                    console.log('【修改角色】更新结果:', data, error)
                    
                    if (error) {
                        console.error('【修改角色】更新失败:', error)
                        
                        // 如果是RLS错误，提示用户
                        if (error.code === '42501' || error.message.includes('row-level security')) {
                            throw new Error('权限不足：请在Supabase控制台中设置RLS策略，允许管理员更新其他用户的角色。或者直接在Supabase数据库中修改。')
                        }
                        
                        throw error
                    }
                    
                    if (!data || data.length === 0) {
                        console.warn('【修改角色】更新返回空数据，可能未生效')
                    } else {
                        console.log('【修改角色】更新成功:', data)
                    }
                }
                
                closeEditRoleModal()
                
                // 强制刷新全局数据
                globalPersonnelData = null
                await renderPersonnelList()
                
                alert('角色修改成功！')
            } catch (error) {
                console.error('【修改角色】错误:', error)
                alert('修改失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 处理添加人员
        async function handleAddPersonnel(e) {
            e.preventDefault()
            showLoading(true)
            
            const formData = new FormData(e.target)
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            }
            
            try {
                if (isOfflineMode) {
                    // 离线模式：直接存储到本地
                    const personnel = LocalStorage.get('personnel') || []
                    if (personnel.some(p => p.username === userData.email)) {
                        throw new Error('该邮箱已被注册')
                    }
                    
                    const newUser = {
                        id: Date.now().toString(),
                        name: userData.name,
                        username: userData.email,
                        role: userData.role,
                        created_at: new Date().toISOString()
                    }
                    
                    personnel.push(newUser)
                    LocalStorage.set('personnel', personnel)
                } else {
                    // 在线模式：使用Supabase创建用户
                    console.log('【添加人员】开始Supabase注册:', userData.email)
                    
                    try {
                        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                            email: userData.email,
                            password: userData.password,
                            options: {
                                data: {
                                    name: userData.name,
                                    role: userData.role
                                }
                            }
                        })
                        
                        if (authError) {
                            console.error('【添加人员】Supabase错误:', authError)
                            
                            if (authError.message.includes('rate limit') || authError.message.includes('rate_limit')) {
                                // 频率限制时，自动切换到离线模式
                                console.log('【添加人员】遇到频率限制，切换到离线模式')
                                throw new Error('RATE_LIMIT_FALLBACK')
                            }
                            if (authError.message.includes('already registered') || authError.message.includes('already exists')) {
                                throw new Error('该邮箱已被注册')
                            }
                            
                            throw authError
                        }
                        
                        console.log('【添加人员】注册成功:', authData)
                        
                    } catch (err) {
                        // 如果是频率限制错误或连接问题，使用离线模式
                        if (err.message === 'RATE_LIMIT_FALLBACK' || 
                            err.message.includes('Failed to fetch') ||
                            err.message.includes('network')) {
                            
                            console.log('【添加人员】切换到离线模式添加')
                            
                            const personnel = LocalStorage.get('personnel') || []
                            if (personnel.some(p => p.username === userData.email)) {
                                throw new Error('该邮箱已被注册')
                            }
                            
                            const newUser = {
                                id: Date.now().toString(),
                                name: userData.name,
                                username: userData.email,
                                role: userData.role,
                                created_at: new Date().toISOString()
                            }
                            
                            personnel.push(newUser)
                            LocalStorage.set('personnel', personnel)
                            
                            alert('添加成功！（离线模式）')
                            
                        } else {
                            throw err
                        }
                    }
                }
                
                closeAddPersonnelModal()
                await renderPersonnelList()
                alert('添加成功！')
            } catch (error) {
                alert('添加失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // ==================== 扫码功能 ====================
        let scanStream = null
        let isScanning = false
        let scanAnimationId = null

        function showScanModal() {
            console.log('【showScanModal】开始执行')
            const modal = document.getElementById('scanModal')
            if (!modal) {
                console.error('【showScanModal】错误：找不到scanModal元素')
                alert('页面加载错误，请刷新重试')
                return
            }
            
            console.log('【showScanModal】找到模态框，准备显示')
            modal.classList.add('show')
            document.body.style.overflow = 'hidden' // 防止背景滚动
            console.log('【showScanModal】模态框已显示')

            const scanInput = document.getElementById('scanInput')
            const scanResult = document.getElementById('scanResult')

            if (scanInput) {
                scanInput.value = ''
                console.log('【showScanModal】输入框已清空')
                
                // 移动端延迟聚焦
                setTimeout(() => {
                    scanInput.focus()
                    console.log('【showScanModal】输入框已聚焦')
                    
                    // 移动端唤起键盘
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        console.log('【showScanModal】检测到移动设备，尝试唤起键盘')
                        scanInput.click()
                    }
                }, 300)
            } else {
                console.warn('【showScanModal】警告：找不到scanInput元素')
            }

            if (scanResult) {
                scanResult.classList.add('hidden')
                console.log('【showScanModal】结果区域已隐藏')
            }

            // 检查摄像头支持
            console.log('【showScanModal】开始检查摄像头支持')
            checkCameraSupport()
            
            console.log('【showScanModal】执行完成')
        }

        function closeScanModal() {
            console.log('关闭扫码模态框')
            stopCameraScan()
            const modal = document.getElementById('scanModal')
            if (modal) {
                modal.classList.remove('show')
            }
            document.body.style.overflow = '' // 恢复背景滚动
        }

        // 检查摄像头支持情况
        async function checkCameraSupport() {
            const cameraArea = document.getElementById('cameraScanArea')
            if (!cameraArea) {
                console.error('【摄像头】找不到cameraScanArea元素')
                return
            }

            console.log('【摄像头】开始检测...')
            console.log('【摄像头】协议:', location.protocol)
            console.log('【摄像头】hostname:', location.hostname)
            console.log('【摄像头】isSecureContext:', window.isSecureContext)
            console.log('【摄像头】mediaDevices:', typeof navigator.mediaDevices)
            console.log('【摄像头】getUserMedia:', navigator.mediaDevices ? typeof navigator.mediaDevices.getUserMedia : 'N/A')

            // 检查浏览器支持
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn('【摄像头】浏览器不支持摄像头API')
                cameraArea.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <i class="fa fa-camera-slash text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-600">当前浏览器不支持摄像头扫描</p>
                        <p class="text-xs text-gray-500 mt-1">请使用Chrome/Safari浏览器，或使用手动输入方式</p>
                    </div>
                `
                cameraArea.classList.remove('hidden')
                return
            }

            // 直接尝试显示摄像头区域，让用户点击启动
            console.log('【摄像头】浏览器支持摄像头，显示扫描区域')
            cameraArea.classList.remove('hidden')
        }

        // 启动摄像头扫描
        async function startCameraScan() {
            const video = document.getElementById('scanVideo')
            const loading = document.getElementById('scanLoading')

            if (!video || !loading) {
                console.error('找不到视频或加载元素')
                return
            }

            loading.classList.remove('hidden')

            try {
                // 停止之前的流
                if (scanStream) {
                    scanStream.getTracks().forEach(track => track.stop())
                }

                // 配置摄像头参数 - 适配移动端，优化扫码
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' }, // 后置摄像头
                        width: { ideal: 1920 },  // 提高分辨率
                        height: { ideal: 1080 },
                        focusMode: { ideal: 'continuous' },  // 自动对焦
                        // 尝试设置帧率
                        frameRate: { ideal: 30, min: 15 }
                    },
                    audio: false
                }

                console.log('请求摄像头权限...')
                scanStream = await navigator.mediaDevices.getUserMedia(constraints)
                
                // 尝试启用自动对焦（如果支持）
                const track = scanStream.getVideoTracks()[0]
                if (track && typeof track.getCapabilities === 'function') {
                    const capabilities = track.getCapabilities()
                    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                        track.applyConstraints({
                            advanced: [{ focusMode: 'continuous' }]
                        }).catch(e => console.log('自动对焦设置失败:', e))
                    }
                }

                video.srcObject = scanStream
                video.setAttribute('playsinline', true) // iOS内联播放
                video.setAttribute('webkit-playsinline', true)

                // 等待视频准备好
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve()
                    }
                })

                await video.play()
                isScanning = true
                loading.classList.add('hidden')

                console.log('摄像头启动成功，开始扫描')

                // 隐藏启动提示
                const hint = document.getElementById('cameraStartHint')
                if (hint) hint.classList.add('hidden')

                scanFrame()

            } catch (error) {
                console.error('摄像头启动失败:', error)
                loading.classList.add('hidden')

                let errorMsg = '无法启动摄像头'
                if (error.name === 'NotAllowedError') {
                    errorMsg = '摄像头权限被拒绝，请在浏览器设置中允许摄像头访问'
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '未找到摄像头设备'
                } else if (error.name === 'NotReadableError') {
                    errorMsg = '摄像头被其他应用占用'
                }

                alert(errorMsg + '\n\n请使用手动输入方式')
            }
        }

        // 停止摄像头扫描
        function stopCameraScan() {
            console.log('【扫码】停止摄像头扫描')
            isScanning = false

            if (scanAnimationId) {
                // 兼容requestAnimationFrame和setTimeout
                if (typeof cancelAnimationFrame !== 'undefined') {
                    cancelAnimationFrame(scanAnimationId)
                }
                clearTimeout(scanAnimationId)
                scanAnimationId = null
            }

            if (scanStream) {
                scanStream.getTracks().forEach(track => {
                    track.stop()
                })
                scanStream = null
            }

            const video = document.getElementById('scanVideo')
            if (video) {
                video.pause()
                video.srcObject = null
            }

            // 显示启动提示
            const hint = document.getElementById('cameraStartHint')
            if (hint) hint.classList.remove('hidden')
        }

        // 扫描帧 - 优化扫描频率和灵敏度
        let scanCount = 0
        let lastScanTime = 0
        
        function scanFrame() {
            if (!isScanning) return

            const video = document.getElementById('scanVideo')
            const canvas = document.getElementById('scanCanvas')

            if (!video || !canvas) return

            // 检查jsQR是否可用（5+App可能加载失败）
            if (typeof jsQR === 'undefined') {
                console.error('【扫码】jsQR库未加载，无法扫码')
                stopCameraScan()
                alert('扫码库加载失败，请使用手动输入')
                return
            }

            const ctx = canvas.getContext('2d', { willReadFrequently: true })

            if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
                // 设置canvas尺寸为视频尺寸
                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                    canvas.width = video.videoWidth
                    canvas.height = video.videoHeight
                }

                ctx.drawImage(video, 0, 0, canvas.width, canvas.height)

                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
                    
                    // 优化jsQR配置，提高灵敏度
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: 'attemptBoth',  // 尝试反转颜色
                        errorCorrectionLevel: 'L'            // 降低纠错级别以提高速度
                    })

                    if (code && code.data) {
                        console.log('【扫码】扫描成功:', code.data, '置信度:', code.binaryData?.length || 'N/A')
                        // 停止扫描
                        stopCameraScan()
                        // 处理扫描结果
                        handleScannedCode(code.data)
                        return
                    }
                    
                    // 每30帧输出一次调试信息
                    scanCount++
                    if (scanCount % 30 === 0) {
                        console.log('【扫码】扫描中... 已扫描', scanCount, '帧')
                    }
                } catch (e) {
                    // 忽略解码错误
                    if (scanCount % 50 === 0) {
                        console.warn('【扫码】解码错误:', e.message)
                    }
                }
            }

            // 继续扫描 - 提高扫描频率（50ms = 20fps，平衡性能和灵敏度）
            scanAnimationId = setTimeout(scanFrame, 50)
        }

        // 处理扫描到的二维码 - 快速显示结果
        function handleScannedCode(data) {
            console.log('【handleScannedCode】扫描到数据:', data)
            
            // 尝试解析二维码数据
            let searchTerm = data.trim()
            
            // 如果二维码包含URL，尝试提取唯一标识
            try {
                const url = new URL(searchTerm)
                const params = new URLSearchParams(url.search)
                if (params.has('id')) {
                    searchTerm = params.get('id')
                }
            } catch (e) {
                // 不是URL，直接使用
            }
            
            // 设置输入框值
            const scanInput = document.getElementById('scanInput')
            if (scanInput) {
                scanInput.value = searchTerm
            }
            
            // 使用全局库存数据快速查询（无需等待网络）
            const item = globalStockData.find(s => 
                (s.unique_id || s.uniqueId) === searchTerm ||
                s.name === searchTerm ||
                s.code === searchTerm ||
                s.id == searchTerm
            )
            
            if (!item) {
                showScanResult(null, searchTerm)
                return
            }
            
            // 找到物品，立即显示结果
            console.log('【handleScannedCode】找到物品:', item.name)
            showScanResult(item)
        }
        
        // 在扫码窗口显示结果
        function showScanResult(item, searchTerm) {
            const resultDiv = document.getElementById('scanResult')
            if (!resultDiv) return
            
            if (!item) {
                resultDiv.innerHTML = `
                    <div class="text-center text-red-500">
                        <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                        <p class="text-sm">未找到 "${searchTerm}"</p>
                    </div>
                `
                resultDiv.classList.remove('hidden')
                return
            }
            
            const uniqueId = item.unique_id || item.uniqueId || '-'
            
            // 获取标准值和单位
            let standardValue = ''
            let standardUnit = ''
            if (item.concentration) {
                standardValue = item.concentration
                standardUnit = item.unit || ''
            } else if (item.components && item.components.length > 0) {
                const c = item.components[0]
                standardValue = c.value || c.concentration || ''
                standardUnit = c.unit || ''
            }
            
            // 格式化有效期 - 支持多个字段名
            let validityDisplay = '-'
            const expiryValue = item.expiry_date || item.expiryDate || item.validity || item.valid_until
            if (expiryValue) {
                const date = new Date(expiryValue)
                if (!isNaN(date.getTime())) {
                    validityDisplay = date.getFullYear() + '-' + 
                        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(date.getDate()).padStart(2, '0')
                } else {
                    validityDisplay = expiryValue
                }
            }
            
            resultDiv.innerHTML = `
                <div class="text-left">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-800 text-base">${item.name}</h3>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${uniqueId}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div><span class="text-gray-500">标准值:</span> ${standardValue || '-'}</div>
                        <div><span class="text-gray-500">单位:</span> ${standardUnit || '-'}</div>
                        <div><span class="text-gray-500">稀释条件:</span> ${item.dilution_condition || item.dilutionCondition || '-'}</div>
                        <div><span class="text-gray-500">有效期:</span> ${validityDisplay}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="quickOutbound('${item.id}')" class="flex-1 btn btn-primary py-2 text-base">
                            <i class="fa fa-sign-out mr-1"></i>直接出库
                        </button>
                        <button onclick="viewDetailFromScan('${item.id}')" class="flex-1 btn btn-secondary py-2 text-base">
                            <i class="fa fa-eye mr-1"></i>查看详情
                        </button>
                    </div>
                </div>
            `
            resultDiv.classList.remove('hidden')
        }
        
        // 从扫码窗口查看详情
        function viewDetailFromScan(itemId) {
            closeScanModal()
            setTimeout(() => {
                switchPage('stock')
                setTimeout(() => {
                    viewStockDetail(itemId)
                }, 100)
            }, 300)
        }
        
        // 快速出库
        async function quickOutbound(itemId) {
            if (!confirm('确认出库该物品？')) return
            
            showLoading(true)
            try {
                await directOut(itemId)
                // 出库成功后关闭扫码模态框
                closeScanModal()
            } catch (error) {
                console.error('出库失败:', error)
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 处理扫码输入 - 快速查询显示
        function handleScan() {
            console.log('【handleScan】开始执行')
            const input = document.getElementById('scanInput').value.trim()
            
            if (!input) {
                alert('请输入唯一标识码')
                return
            }
            
            // 使用全局库存数据快速查询（无需等待网络）
            const item = globalStockData.find(s => {
                const uniqueId = s.unique_id || s.uniqueId
                return uniqueId === input || s.name === input || s.code === input || s.id == input
            })
            
            if (!item) {
                showScanResult(null, input)
                return
            }
            
            // 找到物品，立即显示结果
            console.log('【handleScan】找到物品:', item.name)
            showScanResult(item)
        }

        // 监听回车键
        document.addEventListener('DOMContentLoaded', function() {
            const scanInput = document.getElementById('scanInput')
            if (scanInput) {
                scanInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleScan()
                    }
                })
            }
        })

        // 搜索并显示结果
        async function searchAndShowResult(searchTerm) {
            console.log('【searchAndShowResult】开始搜索:', searchTerm)
            console.log('【searchAndShowResult】当前模式:', isOfflineMode ? '离线' : '在线')
            
            let stock = []
            if (isOfflineMode) {
                console.log('【searchAndShowResult】离线模式，从本地存储获取')
                stock = LocalStorage.get('stock') || []
                console.log('【searchAndShowResult】本地库存数量:', stock.length)
            } else {
                console.log('【searchAndShowResult】在线模式，从Supabase获取')
                // 检查supabaseClient是否初始化
                if (!supabaseClient) {
                    console.error('【searchAndShowResult】supabaseClient未初始化，无法搜索')
                    alert('未连接到服务器，请检查网络或切换到离线模式')
                    return
                }
                
                try {
                    const { data, error } = await supabaseClient.from('stock_items').select('*')
                    if (error) {
                        console.error('【searchAndShowResult】查询库存失败:', error)
                        throw error
                    }
                    stock = data || []
                    console.log('【searchAndShowResult】从Supabase获取库存数量:', stock.length)
                } catch (error) {
                    console.error('【searchAndShowResult】搜索失败:', error)
                    alert('搜索失败: ' + error.message)
                    return
                }
            }
            
            // 搜索匹配项（支持唯一标识、名称、编号）
            console.log('【searchAndShowResult】开始匹配搜索词:', searchTerm)
            const item = stock.find(s => {
                const uniqueId = s.unique_id || s.uniqueId
                const match = uniqueId === searchTerm || s.name === searchTerm || s.code === searchTerm || s.id == searchTerm
                if (match) {
                    console.log('【searchAndShowResult】找到匹配项:', s.name, '唯一标识:', uniqueId)
                }
                return match
            })
            
            const resultDiv = document.getElementById('scanResult')
            console.log('【searchAndShowResult】结果div元素:', resultDiv ? '存在' : '不存在')
            
            if (!resultDiv) {
                console.error('【searchAndShowResult】错误：找不到scanResult元素')
                return
            }
            
            console.log('【searchAndShowResult】是否找到匹配项:', item ? '是' : '否')
            
            if (item) {
                // 动态计算状态
                const currentStatus = calculateItemStatus(item.expiry_date || item.expiryDate)
                console.log('【searchAndShowResult】物品状态:', currentStatus)

                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-lg text-green-800">${item.name}</h3>
                            <span class="px-2 py-1 rounded text-xs ${currentStatus === 'normal' ? 'bg-green-100 text-green-700' : currentStatus === 'expired' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${currentStatus === 'normal' ? '正常' : currentStatus === 'expired' ? '过期' : '临期'}
                            </span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <p><span class="text-gray-500">编号：</span>${item.code}</p>
                            <p><span class="text-gray-500">唯一标识：</span>${item.unique_id || item.uniqueId}</p>
                            <p><span class="text-gray-500">批次号：</span>${item.batch_number || item.batchNumber}</p>
                            <p><span class="text-gray-500">有效期：</span>${item.expiry_date || item.expiryDate}</p>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="directOut('${item.id}')" class="btn btn-success flex-1">
                                <i class="fa fa-sign-out mr-1"></i>直接出库
                            </button>
                            <button onclick="scanViewDetail('${item.id}')" class="btn btn-secondary flex-1">
                                <i class="fa fa-eye mr-1"></i>详情
                            </button>
                        </div>
                    </div>
                `
                resultDiv.classList.remove('hidden')
                console.log('【searchAndShowResult】已显示匹配结果')
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-exclamation-circle text-red-500 mr-2 text-xl"></i>
                            <div>
                                <p class="font-medium text-red-800">未找到匹配项</p>
                                <p class="text-sm text-red-600">未找到唯一标识为 "${searchTerm}" 的标准物质</p>
                            </div>
                        </div>
                    </div>
                `
                resultDiv.classList.remove('hidden')
                console.log('【searchAndShowResult】已显示未找到提示')
            }
            
            // 强制刷新结果区域显示
            resultDiv.style.display = 'block'
            console.log('【searchAndShowResult】结果区域display设置为block')
        }

        // 直接出库（无需选择）
        async function directOut(id) {
            console.log('【directOut】开始执行，ID:', id)
            
            // 使用自定义确认对话框替代confirm（5+App兼容性更好）
            const confirmed = await showConfirmDialog('确定要出库该物品吗？')
            if (!confirmed) {
                console.log('【directOut】用户取消出库')
                return
            }
            
            console.log('【directOut】用户确认出库')
            showLoading(true)
            
            try {
                let stockItem = null
                
                // 先从本地找到物品
                if (globalStockData) {
                    stockItem = globalStockData.find(s => s.id == id)
                    console.log('【directOut】从本地找到物品:', stockItem?.name)
                }
                
                if (!stockItem && !isOfflineMode) {
                    // 本地没有，从数据库查询
                    console.log('【directOut】从数据库查询物品')
                    const { data, error } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', id)
                        .single()
                    
                    if (error) {
                        console.error('【directOut】查询错误:', error)
                        throw error
                    }
                    stockItem = data
                    console.log('【directOut】查询到物品:', stockItem?.name)
                }
                
                if (!stockItem) throw new Error('库存不存在')
                
                if (isOfflineMode) {
                    // 离线模式：更新本地存储
                    const stock = LocalStorage.get('stock') || []
                    const newStock = stock.filter(s => s.id != id)
                    LocalStorage.set('stock', newStock)
                    console.log('【directOut】离线模式删除成功')
                } else {
                    // 在线模式：删除数据库记录
                    const { error: deleteError } = await supabaseClient
                        .from('stock_items')
                        .delete()
                        .eq('id', id)
                    
                    if (deleteError) {
                        console.error('【directOut】删除错误:', deleteError)
                        throw deleteError
                    }
                    console.log('【directOut】删除成功')
                }
                
                // 立即更新本地数据（不等待同步）
                if (globalStockData) {
                    globalStockData = globalStockData.filter(s => s.id != id)
                    DataCache.set('stock', globalStockData)
                    console.log('【directOut】本地数据已更新')
                }
                
                // 添加出库记录
                console.log('【directOut】添加出库记录')
                await addRecord('out', stockItem.name, 1, `扫码出库，唯一性标识: ${stockItem.unique_id || stockItem.uniqueId}`, [])
                
                // 后台异步同步数据（不阻塞用户）
                console.log('【directOut】启动后台同步')
                setTimeout(() => {
                    syncAfterOperation().catch(err => console.log('后台同步失败:', err))
                }, 100)
                
                console.log('【directOut】出库成功')
                alert('出库成功！')
            } catch (error) {
                console.error('【directOut】出库失败:', error)
                alert('出库失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }
        
        // 自定义确认对话框（5+App兼容性更好）
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                // 尝试使用原生confirm
                try {
                    const result = confirm(message)
                    resolve(result)
                } catch (e) {
                    console.error('confirm失败，使用备用方案:', e)
                    // 备用方案：使用prompt
                    const result = prompt(message + '\n\n输入"yes"确认出库：') === 'yes'
                    resolve(result)
                }
            })
        }

        // 扫码后查看详情
        function scanViewDetail(id) {
            closeScanModal()
            viewStockDetail(id)
        }

        // ==================== 二维码功能 ====================
        let currentQRItem = null  // 存储当前二维码对应的物品信息

        async function showQRCode(id, uniqueId, name) {
            const modal = document.getElementById('qrCodeModal')
            const container = document.getElementById('qrCodeContainer')

            // 先显示模态框和加载状态，提升用户体验
            document.getElementById('qrItemName').textContent = name
            document.getElementById('qrItemUniqueId').textContent = uniqueId
            container.innerHTML = '<div class="flex items-center justify-center" style="width:240px;height:240px;"><div class="spinner" style="width:40px;height:40px;"></div></div>'
            modal.classList.add('show')

            // 尝试从全局数据中获取物品信息，避免网络请求
            let item = null
            
            // 先从globalStockData中查找
            if (globalStockData && globalStockData.length > 0) {
                item = globalStockData.find(s => s.id == id)
            }
            
            // 如果没找到，尝试从DOM中查找（库存列表中可能已有）
            if (!item) {
                const stockItem = document.querySelector(`[data-item-id="${id}"]`)
                if (stockItem) {
                    item = {
                        id: id,
                        unique_id: uniqueId,
                        name: name
                    }
                }
            }
            
            // 如果还没找到，且是离线模式，从本地存储查找
            if (!item && isOfflineMode) {
                const stock = LocalStorage.get('stock') || []
                item = stock.find(s => s.id == id)
            }
            
            // 如果还没找到，且是在线模式，从Supabase查询（异步，不阻塞）
            if (!item && !isOfflineMode) {
                try {
                    const { data } = await supabaseClient
                        .from('stock_items')
                        .select('*')
                        .eq('id', id)
                        .single()
                    item = data
                } catch (e) {
                    console.warn('从Supabase获取物品信息失败:', e)
                }
            }

            // 如果还是没找到，使用传入的基本信息创建item
            if (!item) {
                item = {
                    id: id,
                    unique_id: uniqueId,
                    uniqueId: uniqueId,
                    name: name
                }
            }

            // 保存当前物品信息供打印使用
            currentQRItem = item

            // 生成二维码数据 - 直接使用唯一标识，确保二维码简单好识别
            const qrData = generateQRCodeData(item)

            // 使用 QRCode.js 生成二维码
            container.innerHTML = ''

            // 创建 canvas 元素
            const canvas = document.createElement('canvas')
            container.appendChild(canvas)

            QRCode.toCanvas(canvas, qrData, {
                width: 240,
                height: 240,
                margin: 4,
                errorCorrectionLevel: 'L', // 低纠错级别，使二维码更简单、块更大
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) {
                    console.error('二维码生成失败:', error)
                    container.innerHTML = '<p class="text-red-500">二维码生成失败</p>'
                } else {
                    console.log('✓ 二维码生成成功，尺寸: 240x240，纠错级别: L')
                }
            })
        }

        // 生成二维码数据 - 使用简洁格式，确保二维码简单好识别
        function generateQRCodeData(item) {
            // 只使用唯一标识作为二维码内容，确保二维码简单、大块、好识别
            const uniqueId = item.unique_id || item.uniqueId || item.id

            console.log('生成的二维码内容:', uniqueId)
            console.log('二维码内容长度:', uniqueId.length, '字符')

            return uniqueId
        }

        function closeQRCodeModal() {
            document.getElementById('qrCodeModal').classList.remove('show')
        }

        // ==================== 蓝牙标签打印机功能 ====================
        // 支持德佟、微打等便携标签打印机 - 40x30mm 热敏标签纸
        // 使用CPCL指令集进行打印

        // 打印机配置
        const PRINTER_CONFIG = {
            width: 40,          // 标签宽度 mm
            height: 30,         // 标签高度 mm
            dpi: 203,           // 打印分辨率
            // 德佟打印机常用的服务UUID列表
            detongServiceUUIDs: [
                '0000ff00-0000-1000-8000-00805f9b34fb',  // 常见UUID
                '49535343-fe7d-4ae5-8fa9-9fafd205e455',  // 另一种常见UUID
                'e7810a71-73ae-499d-8c15-faa9aef0c3f2'   // 备用UUID
            ],
            // 微打打印机蓝牙服务UUID
            weidaServiceUUID: '000018f0-0000-1000-8000-00805f9b34fb',
            weidaWriteUUID: '00002af1-0000-1000-8000-00805f9b34fb',
            // 通用SPP服务UUID
            sppServiceUUID: '00001101-0000-1000-8000-00805f9b34fa'
        }

        let bluetoothPrinter = null  // 打印机连接实例
        let printerType = null       // 打印机类型: 'detong', 'weida', 'generic'
        let savedPrinterMAC = null   // 保存的打印机MAC地址

        // ==================== 德佟打印机蓝牙打印方案 ====================

        // 使用德佟蓝牙打印（主方案）
        async function printLabelWithDetongDTPWeb() {
            if (!currentQRItem) {
                alert('请先选择要打印的物品')
                return
            }

            // 检查浏览器是否支持蓝牙
            if (!navigator.bluetooth) {
                console.log('浏览器不支持蓝牙API')
                alert('您的浏览器不支持蓝牙功能\n\n将使用浏览器打印方式')
                printLabelWithBrowser()
                return
            }

            // 检查是否在HTTPS环境
            if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert('蓝牙功能需要在HTTPS环境下使用\n\n将使用浏览器打印方式')
                printLabelWithBrowser()
                return
            }

            // 显示状态提示
            const statusDiv = document.createElement('div')
            statusDiv.id = 'printStatus'
            statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-spinner fa-spin"></i> 正在搜索德佟打印机...</div>'
            document.body.appendChild(statusDiv)

            try {
                // 尝试连接蓝牙打印机
                const connected = await connectDetongPrinter()
                if (connected) {
                    statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,128,0,0.9);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-check"></i> 打印机已连接，正在发送打印指令...</div>'
                    await printWithBluetooth()
                    statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,128,0,0.9);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-check-circle"></i> 打印任务已发送！</div>'
                    setTimeout(() => statusDiv.remove(), 2000)
                } else {
                    statusDiv.remove()
                    // 蓝牙连接失败，使用浏览器打印
                    printLabelWithBrowser()
                }
            } catch (error) {
                console.error('打印失败:', error)
                statusDiv.remove()

                if (error.name === 'NotFoundError') {
                    alert('未找到蓝牙打印机，请确保打印机已开启并在附近')
                } else if (error.name === 'SecurityError') {
                    alert('蓝牙权限被拒绝，请检查浏览器权限设置')
                } else if (error.name === 'NotSupportedError') {
                    alert('当前浏览器不支持蓝牙功能\n\n将使用浏览器打印方式')
                    printLabelWithBrowser()
                    return
                } else {
                    alert('蓝牙打印失败: ' + error.message + '\n\n将使用浏览器打印方式')
                }

                // 使用浏览器打印作为备选
                printLabelWithBrowser()
            }
        }

        // 连接德佟打印机（专门适配DP27P）
        async function connectDetongPrinter() {
            try {
                console.log('=== 连接德佟打印机 ===')

                // 请求蓝牙设备 - 专门搜索德佟打印机
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [
                        '0000ff00-0000-1000-8000-00805f9b34fb',  // 德佟常用UUID
                        '49535343-fe7d-4ae5-8fa9-9fafd205e455',  // 另一种常见UUID
                        'e7810a71-73ae-499d-8c15-faa9aef0c3f2',  // 德佟DP系列UUID
                        '000018f0-0000-1000-8000-00805f9b34fb',  // 标准打印机服务
                        '0000ae00-0000-1000-8000-00805f9b34fb'   // 德佟特定UUID
                    ]
                })

                console.log('选择的设备:', device.name)

                // 判断打印机类型
                const deviceName = (device.name || '').toUpperCase()
                if (deviceName.includes('DETONG') || deviceName.includes('德佟') || deviceName.includes('DP')) {
                    printerType = 'detong'
                    console.log('识别为德佟打印机:', device.name)
                } else {
                    printerType = 'generic'
                    console.log('识别为通用打印机:', device.name)
                }

                // 连接到GATT服务器
                console.log('正在连接GATT服务器...')
                const server = await device.gatt.connect()
                console.log('GATT服务器已连接')

                // 获取服务
                let service = null
                let writeCharacteristic = null

                // 德佟打印机常用的服务UUID列表
                const serviceUUIDs = [
                    '0000ff00-0000-1000-8000-00805f9b34fb',
                    '49535343-fe7d-4ae5-8fa9-9fafd205e455',
                    'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
                    '000018f0-0000-1000-8000-00805f9b34fb',
                    '0000ae00-0000-1000-8000-00805f9b34fb'
                ]

                // 尝试获取服务
                for (const uuid of serviceUUIDs) {
                    try {
                        console.log('尝试获取服务:', uuid)
                        service = await server.getPrimaryService(uuid)
                        console.log('✓ 找到服务:', uuid)
                        break
                    } catch (e) {
                        console.log('✗ 服务不存在:', uuid)
                    }
                }

                if (!service) {
                    // 尝试获取所有服务
                    console.log('尝试获取所有服务...')
                    const services = await server.getPrimaryServices()
                    console.log('可用服务数量:', services.length)

                    if (services.length > 0) {
                        service = services[0]
                        console.log('使用第一个可用服务:', service.uuid)
                    } else {
                        throw new Error('未找到可用的蓝牙服务')
                    }
                }

                // 获取特征值
                console.log('正在获取特征值...')
                const characteristics = await service.getCharacteristics()
                console.log('可用特征值数量:', characteristics.length)

                for (const char of characteristics) {
                    console.log('特征值:', char.uuid, '属性:', {
                        write: char.properties.write,
                        writeWithoutResponse: char.properties.writeWithoutResponse,
                        notify: char.properties.notify,
                        read: char.properties.read
                    })

                    if (char.properties.write || char.properties.writeWithoutResponse) {
                        writeCharacteristic = char
                        console.log('✓ 找到可写特征值:', char.uuid)
                        break
                    }
                }

                if (!writeCharacteristic) {
                    throw new Error('未找到可写的特征值')
                }

                // 保存连接
                bluetoothPrinter = {
                    device: device,
                    server: server,
                    service: service,
                    characteristic: writeCharacteristic,
                    type: printerType
                }

                console.log('✓ 打印机连接成功')
                return true

            } catch (error) {
                console.error('连接打印机失败:', error)
                throw error
            }
        }

        // 打印标签（40x30mm）- 二维码 + 唯一性标识
        async function printLabelWithWeida() {
            if (!currentQRItem) {
                alert('请先选择要打印的物品')
                return
            }

            // 检测设备类型
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
            const isWeixin = /MicroMessenger/i.test(navigator.userAgent)

            // 微信内置浏览器不支持蓝牙，直接使用浏览器打印
            if (isWeixin) {
                console.log('微信内置浏览器，使用浏览器打印')
                printLabelWithBrowser()
                return
            }

            // 检查浏览器是否支持蓝牙
            if (!navigator.bluetooth) {
                console.log('浏览器不支持蓝牙，使用浏览器打印')
                printLabelWithBrowser()
                return
            }

            // 显示提示
            const statusDiv = document.createElement('div')
            statusDiv.id = 'printStatus'
            statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-spinner fa-spin"></i> 正在连接蓝牙打印机...</div>'
            document.body.appendChild(statusDiv)

            try {
                // 尝试连接蓝牙打印机
                const connected = await connectBluetoothPrinter()
                if (connected) {
                    statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,128,0,0.9);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-check"></i> 打印机已连接，正在发送打印指令...</div>'
                    await printWithBluetooth()
                    statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,128,0,0.9);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-check-circle"></i> 打印任务已发送！</div>'
                    setTimeout(() => statusDiv.remove(), 2000)
                } else {
                    statusDiv.remove()
                    // 蓝牙连接失败，使用浏览器打印
                    printLabelWithBrowser()
                }
            } catch (error) {
                console.error('打印失败:', error)
                statusDiv.remove()

                // 根据错误类型给出不同的提示
                if (error.name === 'NotFoundError') {
                    // 用户取消了选择或没有找到设备
                    console.log('用户取消了蓝牙设备选择')
                    return  // 静默返回，不打扰用户
                } else if (error.name === 'SecurityError') {
                    alert('蓝牙权限被拒绝，请检查浏览器权限设置')
                } else {
                    alert('蓝牙打印失败: ' + error.message + '\n\n将使用浏览器打印方式')
                }

                // 使用浏览器打印作为备选
                printLabelWithBrowser()
            }
        }

        // 连接蓝牙打印机（德佟H5方案 - CPCL指令）
        async function connectBluetoothPrinter() {
            try {
                console.log('=== 德佟H5蓝牙打印方案 ===')
                console.log('正在搜索蓝牙打印机...')

                // 请求蓝牙设备 - 接受所有设备
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [
                        '0000ff00-0000-1000-8000-00805f9b34fb',
                        '49535343-fe7d-4ae5-8fa9-9fafd205e455',
                        'e7810a71-73ae-499d-8c15-faa9aef0c3f2',
                        '000018f0-0000-1000-8000-00805f9b34fb'
                    ]
                })

                console.log('找到设备:', device.name, 'ID:', device.id)

                // 判断打印机类型
                const deviceName = device.name.toUpperCase()
                if (deviceName.includes('DETONG') || deviceName.includes('德佟')) {
                    printerType = 'detong'
                    console.log('识别为德佟打印机')
                } else {
                    printerType = 'generic'
                    console.log('识别为通用打印机')
                }

                // 连接GATT服务器
                console.log('正在连接GATT服务器...')
                const server = await device.gatt.connect()
                console.log('✓ 已连接到GATT服务器')

                // 尝试获取服务
                let service = null
                let writeCharacteristic = null

                // 德佟打印机常用的服务UUID列表
                const serviceUUIDs = [
                    '0000ff00-0000-1000-8000-00805f9b34fb',
                    '49535343-fe7d-4ae5-8fa9-9fafd205e455',
                    'e7810a71-73ae-499d-8c15-faa9aef0c3f2'
                ]

                // 尝试连接已知的服务
                for (const uuid of serviceUUIDs) {
                    try {
                        console.log('尝试连接服务:', uuid)
                        service = await server.getPrimaryService(uuid)
                        console.log('✓ 成功连接到服务')

                        // 获取特征值
                        const characteristics = await service.getCharacteristics()
                        console.log('找到', characteristics.length, '个特征值')

                        if (characteristics.length > 0) {
                            // 找到可写的特征值
                            writeCharacteristic = characteristics.find(c =>
                                c.properties.write || c.properties.writeWithoutResponse
                            )
                            if (!writeCharacteristic) {
                                writeCharacteristic = characteristics[0]
                            }

                            console.log('✓ 使用特征值:', writeCharacteristic.uuid)
                            console.log('  可写:', writeCharacteristic.properties.write)
                            console.log('  无响应写:', writeCharacteristic.properties.writeWithoutResponse)
                            break
                        }
                    } catch (e) {
                        console.log('✗ 服务不可用:', e.message)
                    }
                }

                // 如果已知UUID都失败了，尝试获取所有服务
                if (!service) {
                    console.log('尝试获取所有服务...')
                    try {
                        const services = await server.getPrimaryServices()
                        console.log('找到', services.length, '个服务')

                        for (const svc of services) {
                            try {
                                const characteristics = await svc.getCharacteristics()
                                if (characteristics.length > 0) {
                                    service = svc
                                    writeCharacteristic = characteristics.find(c =>
                                        c.properties.write || c.properties.writeWithoutResponse
                                    ) || characteristics[0]
                                    console.log('✓ 使用服务:', svc.uuid)
                                    break
                                }
                            } catch (e) {
                                console.log('服务', svc.uuid, '获取特征值失败')
                            }
                        }
                    } catch (e) {
                        console.error('获取所有服务失败:', e.message)
                    }
                }

                if (!service || !writeCharacteristic) {
                    throw new Error('无法找到可用的蓝牙服务或特征值')
                }

                // 保存打印机信息
                bluetoothPrinter = {
                    device: device,
                    server: server,
                    service: service,
                    characteristic: writeCharacteristic,
                    type: printerType
                }

                // 保存MAC地址到本地存储
                savedPrinterMAC = device.id
                LocalStorage.set('savedPrinterMAC', savedPrinterMAC)
                LocalStorage.set('savedPrinterName', device.name)

                console.log('✓ 打印机连接成功')
                return true

            } catch (error) {
                console.error('蓝牙连接失败:', error)

                if (error.name === 'NotFoundError') {
                    console.log('用户取消了设备选择')
                    return false
                }

                throw error
            }
        }

        // 使用蓝牙打印机打印
        async function printWithBluetooth() {
            if (!bluetoothPrinter) {
                throw new Error('打印机未连接')
            }

            try {
                // 根据打印机类型生成对应的打印指令
                let printData
                console.log('生成打印指令，打印机类型:', bluetoothPrinter.type)

                // 德佟打印机使用CPCL指令
                printData = generateDetongPrintCommands()

                console.log('打印指令长度:', printData.length, '字节')
                console.log('原始数据:', new TextDecoder().decode(printData))

                // 更新状态提示
                const statusDiv = document.getElementById('printStatus')
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,128,0,0.9);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-spinner fa-spin"></i> 正在发送打印数据...</div>'
                }

                // 检查特征值属性
                console.log('特征值属性:')
                console.log('  write:', bluetoothPrinter.characteristic.properties.write)
                console.log('  writeWithoutResponse:', bluetoothPrinter.characteristic.properties.writeWithoutResponse)

                // 发送数据 - 尝试使用writeWithoutResponse（更适合打印机）
                const chunkSize = 20  // 蓝牙LE标准MTU通常是20字节
                const totalChunks = Math.ceil(printData.length / chunkSize)

                for (let i = 0; i < printData.length; i += chunkSize) {
                    const chunk = printData.slice(i, i + chunkSize)
                    const chunkNum = Math.floor(i / chunkSize) + 1

                    console.log(`发送数据块 ${chunkNum}/${totalChunks}, 大小: ${chunk.length} 字节`)
                    console.log('数据内容:', new TextDecoder().decode(chunk))

                    try {
                        // 优先使用writeWithoutResponse（更快，不需要确认）
                        if (bluetoothPrinter.characteristic.properties.writeWithoutResponse) {
                            await bluetoothPrinter.characteristic.writeValue(chunk)
                        } else {
                            await bluetoothPrinter.characteristic.writeValue(chunk)
                        }
                        console.log(`✓ 数据块 ${chunkNum} 发送成功`)
                    } catch (writeError) {
                        console.error(`✗ 发送数据块 ${chunkNum} 失败:`, writeError)
                        throw new Error(`发送打印数据失败: ${writeError.message}`)
                    }

                    // 更新进度
                    if (statusDiv && totalChunks > 1) {
                        const progress = Math.round((chunkNum / totalChunks) * 100)
                        statusDiv.innerHTML = `<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,128,0,0.9);color:white;padding:20px;border-radius:10px;z-index:9999;"><i class="fa fa-spinner fa-spin"></i> 正在发送打印数据... ${progress}%</div>`
                    }

                    // 小延迟确保打印机处理
                    await new Promise(r => setTimeout(r, 200))
                }

                console.log('✓ 打印指令已发送完成')

                // 等待打印机处理
                await new Promise(r => setTimeout(r, 500))
                console.log('✓ 打印应该已完成')

            } catch (error) {
                console.error('蓝牙打印失败:', error)
                throw error
            }
        }

        // 生成德佟打印机指令（CPCL指令集 - 德佟DP系列原生支持）
        function generateDetongPrintCommands() {
            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''
            const name = currentQRItem.name || ''

            console.log('生成德佟CPCL指令...')
            console.log('名称:', name)
            console.log('唯一标识:', uniqueId)

            // 使用CPCL指令集（德佟DP系列原生支持）
            // 标签尺寸：40mm x 30mm (约 236 x 177 像素 @ 203dpi)
            const commands = []

            // CPCL指令头
            // ! 0 200 200 300 1 - 标签高度300点，1份
            commands.push('! 0 200 200 300 1')

            // 设置打印区域
            commands.push('PAGE-WIDTH 240')

            // 打印名称（字体4，位置10,20）
            const shortName = name.length > 12 ? name.substring(0, 12) : name
            commands.push(`TEXT 4 0 10 20 ${shortName}`)

            // 打印唯一标识（字体4，位置10,55）
            commands.push(`TEXT 4 0 10 55 ID:${uniqueId}`)

            // 打印QR码（德佟CPCL格式）
            // BARCODE QR x y M U [data]
            // x=10, y=90, M=2(模型), U=6(单元大小)
            commands.push('BARCODE QR 10 90 M 2 U 6')
            commands.push(`MA,${uniqueId}`)
            commands.push('ENDQR')

            // 打印指令
            commands.push('PRINT')

            const cpclData = commands.join('\r\n') + '\r\n'
            console.log('CPCL指令:', cpclData)
            console.log('CPCL指令长度:', cpclData.length, '字节')

            // 转换为Uint8Array
            const encoder = new TextEncoder()
            return encoder.encode(cpclData)
        }

        // 文本转字节数组（ASCII）
        function textToBytes(text) {
            const bytes = []
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i)
                if (charCode < 256) {
                    bytes.push(charCode)
                } else {
                    // 对于非ASCII字符，使用问号替代
                    bytes.push(0x3F)  // '?'
                }
            }
            return bytes
        }

        // 生成通用ESC/POS打印指令
        function generateGenericPrintCommands() {
            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''
            const name = currentQRItem.name || ''

            // 创建打印指令数组
            const commands = []

            // ESC @ - 初始化打印机
            commands.push(0x1B, 0x40)

            // 设置标签尺寸（40x30mm）
            // 不同打印机指令不同，这里使用通用设置

            // ESC a 1 - 居中对齐
            commands.push(0x1B, 0x61, 0x01)

            // 设置字体大小（放大2倍）
            commands.push(0x1D, 0x21, 0x11)

            // 打印名称
            const shortName = name.length > 8 ? name.substring(0, 8) : name
            commands.push(...stringToBytes(shortName))
            commands.push(0x0A)  // 换行

            // 恢复正常字体大小
            commands.push(0x1D, 0x21, 0x00)

            // 打印唯一标识
            commands.push(...stringToBytes(uniqueId))
            commands.push(0x0A, 0x0A)  // 换两行

            // 打印QR码（如果打印机支持）
            // GS k m n d1...dn - 打印QR码
            const qrData = generateQRCodeData(currentQRItem)
            const qrBytes = stringToBytes(qrData)

            // QR码模型选择 (GS ( k pL pH cn fn n1)
            commands.push(0x1D, 0x28, 0x6B, 0x04, 0x00, 0x31, 0x41, 0x32, 0x00)

            // QR码大小设置
            commands.push(0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x43, 0x05)

            // QR码错误纠正级别
            commands.push(0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x45, 0x30)

            // QR码数据存储
            const dataLen = qrBytes.length + 3
            commands.push(0x1D, 0x28, 0x6B, dataLen & 0xFF, (dataLen >> 8) & 0xFF, 0x31, 0x50, 0x30)
            commands.push(...qrBytes)

            // QR码打印
            commands.push(0x1D, 0x28, 0x6B, 0x03, 0x00, 0x31, 0x51, 0x30)

            // 换行
            commands.push(0x0A)

            // GS V 0 - 切纸（如果支持）
            // commands.push(0x1D, 0x56, 0x00)

            return new Uint8Array(commands)
        }

        // 字符串转字节数组（UTF-8）
        function stringToBytes(str) {
            const encoder = new TextEncoder()
            return Array.from(encoder.encode(str))
        }

        // 使用浏览器打印（备选方案）- 优化40x30mm标签布局
        function printLabelWithBrowser() {
            if (!currentQRItem) {
                alert('请先选择要打印的物品')
                return
            }

            // 创建打印窗口
            const printWindow = window.open('', '_blank', 'width=400,height=300')
            if (!printWindow) {
                alert('请允许弹出窗口以进行打印')
                return
            }

            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''
            const name = currentQRItem.name || ''

            // 获取二维码图片数据
            const canvas = document.querySelector('#qrCodeContainer canvas')
            const qrImageData = canvas ? canvas.toDataURL('image/png') : ''

            // 创建40x30mm标签的打印HTML - 优化布局
            printWindow.document.write(`
                <!DOCTYPE html>
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>标签打印</title>
                    <style>
                        /* 打印设置 - 强制无边距 */
                        @page {
                            size: 40mm 30mm portrait;
                            margin: 0mm 0mm 0mm 0mm;
                            padding: 0mm;
                        }
                        
                        /* 基础重置 */
                        *, *::before, *::after {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        html {
                            margin: 0;
                            padding: 0;
                            width: 40mm;
                            height: 30mm;
                        }
                        
                        body {
                            margin: 0;
                            padding: 0;
                            width: 40mm;
                            height: 30mm;
                            min-width: 40mm;
                            min-height: 30mm;
                            max-width: 40mm;
                            max-height: 30mm;
                            overflow: hidden;
                            font-family: Arial, sans-serif;
                            font-size: 8pt;
                            line-height: 1;
                            background: white;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        
                        /* 标签容器 - 左边距调至0 */
                        .label-container {
                            width: 40mm;
                            height: 30mm;
                            margin: -3mm 0 0 -10mm;
                            padding: 8mm 2mm 2mm 2mm;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: flex-start;
                            background: white;
                            page-break-inside: avoid;
                            break-inside: avoid;
                        }
                        
                        .material-name {
                            font-size: 9pt;
                            font-weight: 900;
                            text-align: center;
                            color: #000;
                            max-width: 36mm;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                            line-height: 1.1;
                            margin-bottom: 1mm;
                        }
                        
                        .qr-code {
                            width: 16mm;
                            height: 16mm;
                            object-fit: contain;
                            line-height: 1;
                            display: block;
                        }
                        
                        .unique-id {
                            font-size: 8pt;
                            font-weight: 900;
                            text-align: center;
                            word-break: break-all;
                            line-height: 1.1;
                            margin-top: 1mm;
                            max-width: 36mm;
                        }
                        
                        /* 打印时强制样式 */
                        @media print {
                            @page {
                                margin: 0;
                                padding: 0;
                                size: 40mm 30mm;
                            }
                            html, body {
                                margin: 0 !important;
                                padding: 0 !important;
                                width: 40mm !important;
                                height: 30mm !important;
                            }
                            .label-container {
                                margin: 0 !important;
                                padding: 2mm 1mm 1mm 1mm !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="label-container">
                        <div class="material-name">${name}</div>
                        ${qrImageData ? `<img class="qr-code" src="${qrImageData}" alt="二维码">` : '<div style="width:16mm;height:16mm;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:6pt;line-height:1;">二维码</div>'}
                        <div class="unique-id">${uniqueId}</div>
                    </div>
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            }, 200);
                        };
                    <\/script>
                </body>
                </html>
            `)

            printWindow.document.close()
        }

        // 简版打印 - 只打印二维码和唯一性标识
        function printLabelSimple() {
            if (!currentQRItem) {
                alert('请先选择要打印的物品')
                return
            }

            // 创建打印窗口
            const printWindow = window.open('', '_blank', 'width=400,height=300')
            if (!printWindow) {
                alert('请允许弹出窗口以进行打印')
                return
            }

            const uniqueId = currentQRItem.unique_id || currentQRItem.uniqueId || ''

            // 获取二维码图片数据
            const canvas = document.querySelector('#qrCodeContainer canvas')
            const qrImageData = canvas ? canvas.toDataURL('image/png') : ''

            // 创建简版标签打印HTML - 只包含二维码和唯一性标识
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>简版标签打印</title>
                    <style>
                        /* 打印设置 - 强制无边距 */
                        @page {
                            size: 40mm 30mm portrait;
                            margin: 0mm;
                            padding: 0mm;
                        }
                        
                        /* 基础重置 */
                        *, *::before, *::after {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        html, body {
                            margin: 0;
                            padding: 0;
                            width: 40mm;
                            height: 30mm;
                            overflow: hidden;
                            font-family: Arial, sans-serif;
                            background: white;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        
                        /* 简版标签容器 - 内容居中 */
                        .label-simple {
                            width: 40mm;
                            height: 30mm;
                            margin: -2mm 0 0 -10mm;
                            padding: 0mm 2mm 2mm 2mm;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: flex-start;
                            background: white;
                        }
                        
                        .qr-code {
                            width: 18mm;
                            height: 18mm;
                            object-fit: contain;
                            display: block;
                            margin-bottom: 4mm;
                            margin-top: 0;
                        }
                        
                        .unique-id {
                            font-size: 9pt;
                            font-weight: 900;
                            text-align: center;
                            word-break: break-all;
                            line-height: 1.2;
                            max-width: 36mm;
                            margin-top: 2mm;
                        }
                        
                        /* 打印时强制样式 */
                        @media print {
                            @page {
                                margin: 0;
                                padding: 0;
                                size: 40mm 30mm;
                            }
                            html, body {
                                margin: 0 !important;
                                padding: 0 !important;
                                width: 40mm !important;
                                height: 30mm !important;
                            }
                            .label-simple {
                                margin: 0 !important;
                                padding: 0mm 2mm 2mm 2mm !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="label-simple">
                        ${qrImageData ? `<img class="qr-code" src="${qrImageData}" alt="二维码">` : '<div style="width:18mm;height:18mm;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:6pt;margin-bottom:4mm;">二维码</div>'}
                        <div class="unique-id">${uniqueId}</div>
                    </div>
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            }, 200);
                        };
                    <\/script>
                </body>
                </html>
            `)

            printWindow.document.close()
        }

        // ==================== AI智能识别功能 ====================
        // 豆包大模型配置 - 火山方舟
        // 使用API Key认证（Bearer Token）
        const DOUBAO_CONFIG = {
            API_KEY: '7b4f3ff4-1ee0-4b4c-8551-0441674dbdbe',
            ENDPOINT: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
            MODEL: 'doubao-seed-1-6-lite-251015'
        }

        // AI识别相关变量
        let aiStream = null
        let aiImages = []  // 存储多张图片
        let aiExtractedData = {}
        let isPDF = false

        // 显示AI识别模态框
        function showAIRecognizeModal() {
            document.getElementById('aiRecognizeModal').classList.add('show')
            resetAIRecognizeModal()
        }

        // 关闭AI识别模态框
        function closeAIRecognizeModal() {
            stopAICamera()
            document.getElementById('aiRecognizeModal').classList.remove('show')
        }

        // 重置AI识别模态框
        function resetAIRecognizeModal() {
            document.getElementById('aiStep1').classList.remove('hidden')
            document.getElementById('aiStep2').classList.add('hidden')
            document.getElementById('aiStep3').classList.add('hidden')
            document.getElementById('aiPreviewContainer').classList.add('hidden')
            document.getElementById('aiPreview2Container').classList.add('hidden')
            document.getElementById('aiPlaceholder').classList.remove('hidden')
            document.getElementById('aiVideo').classList.add('hidden')
            document.getElementById('aiCameraControls').classList.add('hidden')
            document.getElementById('aiAddPhotoBtn').classList.add('hidden')
            aiImages = []
            aiExtractedData = {}
            isPDF = false
        }

        // 返回步骤1
        function backToAIStep1() {
            resetAIRecognizeModal()
        }

        // 启动摄像头
        async function startAICamera() {
            const video = document.getElementById('aiVideo')
            try {
                aiStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                })
                video.srcObject = aiStream
                video.play()
                video.classList.remove('hidden')
                document.getElementById('aiPlaceholder').classList.add('hidden')
                document.getElementById('aiPreviewContainer').classList.add('hidden')
                document.getElementById('aiCameraControls').classList.remove('hidden')
            } catch (error) {
                alert('无法启动摄像头，请确保已授予权限')
            }
        }

        // 停止摄像头
        function stopAICamera() {
            if (aiStream) {
                aiStream.getTracks().forEach(track => track.stop())
                aiStream = null
            }
            document.getElementById('aiVideo').classList.add('hidden')
            document.getElementById('aiCameraControls').classList.add('hidden')
            if (aiImages.length === 0) {
                document.getElementById('aiPlaceholder').classList.remove('hidden')
            }
        }

        // 拍照
        function captureAIPhoto() {
            const video = document.getElementById('aiVideo')
            const canvas = document.getElementById('aiCanvas')
            const ctx = canvas.getContext('2d')
            canvas.width = video.videoWidth
            canvas.height = video.videoHeight
            ctx.drawImage(video, 0, 0)
            const imageData = canvas.toDataURL('image/jpeg', 0.9)
            
            addAIImage(imageData)
            stopAICamera()
            
            // 如果只有1张图片，显示"再拍一张"按钮
            if (aiImages.length === 1) {
                document.getElementById('aiAddPhotoBtn').classList.remove('hidden')
            } else if (aiImages.length >= 2) {
                // 2张图片后开始识别
                document.getElementById('aiAddPhotoBtn').classList.add('hidden')
                startAIRecognition(aiImages)
            }
        }

        // 添加图片到列表
        function addAIImage(imageData) {
            aiImages.push(imageData)
            updateAIPreview()
        }

        // 更新预览显示
        function updateAIPreview() {
            document.getElementById('aiPlaceholder').classList.add('hidden')
            document.getElementById('aiPreviewContainer').classList.remove('hidden')
            
            if (aiImages.length >= 1) {
                document.getElementById('aiPreviewImg1').src = aiImages[0]
            }
            if (aiImages.length >= 2) {
                document.getElementById('aiPreviewImg2').src = aiImages[1]
                document.getElementById('aiPreview2Container').classList.remove('hidden')
            }
        }

        // 处理文件选择（支持PDF）
        async function handleAIFileSelect(event) {
            const file = event.target.files[0]
            if (!file) return
            
            // 检查文件类型
            if (file.type === 'application/pdf') {
                isPDF = true
                await handlePDFUpload(file)
            } else {
                // 图片文件
                isPDF = false
                const reader = new FileReader()
                reader.onload = function(e) {
                    addAIImage(e.target.result)
                    // 单张图片直接识别
                    if (aiImages.length === 1) {
                        startAIRecognition(aiImages)
                    }
                }
                reader.readAsDataURL(file)
            }
        }

        // 处理PDF上传
        async function handlePDFUpload(file) {
            try {
                console.log('开始处理PDF文件:', file.name, '大小:', file.size, '类型:', file.type)
                
                // 检查文件大小
                if (file.size === 0) {
                    throw new Error('PDF文件为空')
                }
                
                // 使用PDF.js解析PDF
                const pdfData = await file.arrayBuffer()
                console.log('PDF数据读取成功, 大小:', pdfData.byteLength)
                
                if (pdfData.byteLength === 0) {
                    throw new Error('PDF数据为空')
                }
                
                // 检查PDF文件头
                const header = new Uint8Array(pdfData.slice(0, 5))
                const headerStr = String.fromCharCode(...header)
                console.log('PDF文件头:', headerStr)
                
                if (headerStr !== '%PDF-') {
                    console.warn('PDF文件头可能不正确:', headerStr)
                }
                
                // 检查pdfjsLib是否可用
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js库未加载，无法解析PDF文件')
                }
                
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise
                console.log('PDF解析成功, 总页数:', pdf.numPages)
                
                const totalPages = pdf.numPages
                if (totalPages === 0) {
                    throw new Error('PDF没有页面')
                }
                
                const pagesToExtract = Math.min(2, totalPages)
                console.log('将提取', pagesToExtract, '页')
                
                // 提取每一页为图片
                for (let pageNum = 1; pageNum <= pagesToExtract; pageNum++) {
                    console.log('正在处理第', pageNum, '页...')
                    const page = await pdf.getPage(pageNum)
                    const scale = 2
                    const viewport = page.getViewport({ scale })
                    
                    const canvas = document.createElement('canvas')
                    const ctx = canvas.getContext('2d')
                    canvas.width = viewport.width
                    canvas.height = viewport.height
                    
                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.9)
                    addAIImage(imageData)
                    console.log('第', pageNum, '页转换完成')
                }
                
                // 开始识别
                startAIRecognition(aiImages)
                
            } catch (error) {
                console.error('PDF解析失败:', error)
                console.error('错误详情:', error.message, error.stack)
                alert('PDF解析失败: ' + error.message)
            }
        }

        // CORS代理
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ]
        
        async function fetchWithProxy(url, options = {}) {
            let lastError = null
            
            for (const proxy of CORS_PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url)
                    const response = await fetch(proxyUrl, options)
                    const text = await response.text()
                    
                    if (text.trim().startsWith('<') || text.includes('<!DOCTYPE')) {
                        console.warn(`代理 ${proxy} 返回HTML错误，尝试下一个`)
                        continue
                    }
                    
                    return {
                        ok: response.ok,
                        status: response.status,
                        text: () => Promise.resolve(text),
                        json: () => {
                            try {
                                return Promise.resolve(JSON.parse(text))
                            } catch (e) {
                                return Promise.reject(new Error('JSON解析失败'))
                            }
                        }
                    }
                } catch (error) {
                    console.warn(`代理 ${proxy} 失败:`, error.message)
                    lastError = error
                }
            }
            
            throw new Error('所有代理都失败: ' + (lastError?.message || '未知错误'))
        }

        // 豆包API使用AK/SK签名认证
        // 参考文档：https://www.volcengine.com/docs/82379/1298458
        
        // Base64解码函数
        function base64Decode(base64) {
            const binaryString = atob(base64)
            const bytes = new Uint8Array(binaryString.length)
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i)
            }
            return bytes
        }

        // 生成火山方舟签名
        async function generateVolcanoSignature(method, uri, body) {
            const accessKeyId = DOUBAO_CONFIG.ACCESS_KEY_ID
            // Secret Key是Base64编码的，需要解码
            const secretKey = base64Decode(DOUBAO_CONFIG.SECRET_ACCESS_KEY)
            
            // 调试：打印解码后的Secret Key长度
            console.log('Secret Key长度:', secretKey.length)
            console.log('Secret Key (hex):', Array.from(secretKey).map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32) + '...')
            
            // 1. 生成时间戳
            const now = new Date()
            const date = now.toISOString().slice(0, 10).replace(/-/g, '')  // YYYYMMDD
            const xDate = now.toUTCString()  // RFC1123格式
            
            // 2. 计算body的SHA256哈希
            const bodyHash = await sha256Hash(body || '')
            
            // 3. 构建规范请求
            const contentType = 'application/json'
            const canonicalHeaders = `content-type:${contentType}\n` +
                `host:ark.cn-beijing.volces.com\n` +
                `x-content-sha256:${bodyHash}\n` +
                `x-date:${xDate}\n`
            const signedHeaders = 'content-type;host;x-content-sha256;x-date'
            
            // 4. 构建待签名字符串
            const credentialScope = `${date}/cn-beijing/ark/request`
            const canonicalRequest = `${method}\n${uri}\n\n${canonicalHeaders}\n${signedHeaders}\n${bodyHash}`
            const canonicalRequestHash = await sha256Hash(canonicalRequest)
            const stringToSign = `HMAC-SHA256\n${xDate}\n${credentialScope}\n${canonicalRequestHash}`
            
            // 调试信息
            console.log('Canonical Request:', canonicalRequest)
            console.log('String to Sign:', stringToSign)
            
            // 5. 计算签名
            // kDate = HMAC_SHA256(secretKey, date)
            const kDate = await hmacSha256(secretKey, date)
            const kRegion = await hmacSha256(kDate, 'cn-beijing')
            const kService = await hmacSha256(kRegion, 'ark')
            const kSigning = await hmacSha256(kService, 'request')
            const signature = await hmacSha256Hex(kSigning, stringToSign)
            
            console.log('Signature:', signature)
            
            // 6. 构建Authorization头
            const authorization = `HMAC-SHA256 Credential=${accessKeyId}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`
            
            const headers = {
                'Authorization': authorization,
                'X-Date': xDate,
                'X-Content-Sha256': bodyHash,
                'Host': 'ark.cn-beijing.volces.com',
                'Content-Type': 'application/json'
            }
            
            console.log('请求头:', headers)
            
            return headers
        }

        // SHA256哈希
        async function sha256Hash(message) {
            const msgBuffer = new TextEncoder().encode(message)
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer)
            const hashArray = Array.from(new Uint8Array(hashBuffer))
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        }

        // HMAC-SHA256 (返回ArrayBuffer)
        async function hmacSha256(key, message) {
            let keyBuffer
            if (typeof key === 'string') {
                keyBuffer = new TextEncoder().encode(key)
            } else if (key instanceof Uint8Array) {
                keyBuffer = key
            } else if (key instanceof ArrayBuffer) {
                keyBuffer = new Uint8Array(key)
            } else {
                keyBuffer = new Uint8Array(key)
            }
            
            const msgBuffer = new TextEncoder().encode(message)
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBuffer,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            )
            
            return crypto.subtle.sign('HMAC', cryptoKey, msgBuffer)
        }

        // HMAC-SHA256 (返回Hex字符串)
        async function hmacSha256Hex(key, message) {
            const signature = await hmacSha256(key, message)
            const hashArray = Array.from(new Uint8Array(signature))
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        }

        // 开始AI识别
        async function startAIRecognition(images) {
            document.getElementById('aiStep1').classList.add('hidden')
            document.getElementById('aiStep2').classList.remove('hidden')
            document.getElementById('aiStatus').textContent = `正在AI分析${images.length}张图片...`
            
            try {
                aiExtractedData = await callDoubaoVisionAI(images)
                displayAIResult(aiExtractedData)
                
                document.getElementById('aiStep2').classList.add('hidden')
                document.getElementById('aiStep3').classList.remove('hidden')
            } catch (error) {
                console.error('AI识别失败:', error)
                alert('识别失败: ' + error.message)
                backToAIStep1()
            }
        }

        // 调用豆包多模态模型
        async function callDoubaoVisionAI(images) {
            // 处理多张图片
            const imageContents = images.map(imgData => {
                let base64 = imgData
                if (base64.includes(',')) {
                    base64 = base64.split(',')[1]
                }
                return {
                    type: 'image_url',
                    image_url: {
                        url: `data:image/jpeg;base64,${base64}`
                    }
                }
            })
            
            const prompt = `提取标准物质标签信息，直接返回JSON：

单标格式：
{"name":"","code":"","batchNumber":"","manufacturer":"","isMixedStandard":false,"components":[{"name":"","value":"","unit":"","uncertainty":""}],"storageCondition":"","dilutionCondition":"","expiryDate":""}

混标格式（多个组分）：
{"name":"","code":"","batchNumber":"","manufacturer":"","isMixedStandard":true,"components":[{"name":"铜","value":"100","unit":"μg/mL","uncertainty":"0.5%"},{"name":"锌","value":"100","unit":"μg/mL","uncertainty":"0.5%"},{"name":"铅","value":"100","unit":"μg/mL","uncertainty":"0.5%"}],"storageCondition":"","dilutionCondition":"","expiryDate":""}

规则：
1. 只输出JSON，不要任何其他内容
2. isMixedStandard: true表示混标，false表示单标
3. components数组包含所有组分，每个组分有name(组分名)、value(标准值)、unit(单位)、uncertainty(不确定度)
4. 单标时components数组只有1个元素
5. 混标时components数组有多个元素
6. 日期格式YYYY-MM-DD
7. 找不到的字段留空
8. 禁止解释、禁止思考过程`

            const requestBody = JSON.stringify({
                model: DOUBAO_CONFIG.MODEL,
                messages: [
                    {
                        role: 'system',
                        content: '你只输出JSON，禁止任何解释、思考过程、markdown格式。直接返回纯JSON文本。'
                    },
                    {
                        role: 'user',
                        content: [
                            ...imageContents,
                            {
                                type: 'text',
                                text: prompt
                            }
                        ]
                    }
                ],
                temperature: 0,
                max_tokens: 400,
                stream: false
            })
            
            // 使用API Key认证（Bearer Token）
            const authHeaders = {
                'Authorization': `Bearer ${DOUBAO_CONFIG.API_KEY}`,
                'Content-Type': 'application/json'
            }
            
            let responseText = ''
            try {
                // 先尝试直接调用，看具体错误
                let response
                try {
                    response = await fetch(DOUBAO_CONFIG.ENDPOINT, {
                        method: 'POST',
                        headers: authHeaders,
                        body: requestBody
                    })
                } catch (directError) {
                    console.log('直接调用失败，尝试代理:', directError.message)
                    response = await fetchWithProxy(DOUBAO_CONFIG.ENDPOINT, {
                        method: 'POST',
                        headers: authHeaders,
                        body: requestBody
                    })
                }
                
                responseText = await response.text()
                console.log('豆包API原始响应:', responseText)
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} - ${responseText.substring(0, 200)}`)
                }
            } catch (fetchError) {
                console.error('API请求错误:', fetchError)
                throw new Error('API请求失败: ' + fetchError.message)
            }
            
            let result
            try {
                result = JSON.parse(responseText)
            } catch (parseError) {
                console.error('JSON解析失败:', responseText)
                throw new Error('返回格式错误')
            }
            
            const aiContent = result.choices?.[0]?.message?.content || ''
            console.log('AI返回内容:', aiContent)
            
            if (!aiContent) {
                throw new Error('AI返回内容为空')
            }
            
            try {
                return JSON.parse(aiContent)
            } catch (e) {
                const jsonMatch = aiContent.match(/\{[\s\S]*?\}/)
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0])
                }
                throw new Error('无法解析JSON')
            }
        }

        // 显示AI识别结果
        function displayAIResult(data) {
            const preview = document.getElementById('aiResultPreview')

            // 基础字段
            const fields = [
                { key: 'name', label: '名称' },
                { key: 'code', label: '编号' },
                { key: 'batchNumber', label: '批号' },
                { key: 'manufacturer', label: '厂家' },
                { key: 'storageCondition', label: '保存条件' },
                { key: 'dilutionCondition', label: '稀释条件' },
                { key: 'expiryDate', label: '有效期' }
            ]

            let html = ''

            // 显示基础字段
            fields.forEach(field => {
                const value = data[field.key]
                if (value) {
                    html += `<div class="flex justify-between py-1 border-b border-gray-200">
                        <span class="text-gray-500">${field.label}:</span>
                        <span class="font-medium">${value}</span>
                    </div>`
                }
            })

            // 显示组分信息（支持混标）
            if (data.components && Array.isArray(data.components) && data.components.length > 0) {
                const isMixed = data.isMixedStandard || data.components.length > 1
                html += `<div class="py-2 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-500">${isMixed ? '混标组分' : '组分信息'}:</span>
                        <span class="text-xs text-primary">${data.components.length}个组分</span>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-600 text-xs">
                                    <th class="text-left py-1">组分</th>
                                    <th class="text-left py-1">标准值</th>
                                    <th class="text-left py-1">单位</th>
                                    <th class="text-left py-1">不确定度</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.components.map(c => `
                                    <tr class="border-t border-gray-200">
                                        <td class="py-1">${c.name || '-'}</td>
                                        <td class="py-1">${c.value || c.concentration || '-'}</td>
                                        <td class="py-1">${c.unit || '-'}</td>
                                        <td class="py-1">${c.uncertainty || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`
            } else if (data.concentration) {
                // 兼容旧格式
                html += `<div class="flex justify-between py-1 border-b border-gray-200">
                    <span class="text-gray-500">标准值:</span>
                    <span class="font-medium">${data.concentration} ${data.unit || ''}</span>
                </div>`
                if (data.uncertainty) {
                    html += `<div class="flex justify-between py-1 border-b border-gray-200">
                        <span class="text-gray-500">不确定度:</span>
                        <span class="font-medium">${data.uncertainty}</span>
                    </div>`
                }
            }

            if (!html) {
                html = '<p class="text-gray-400">未能识别到有效信息</p>'
            }

            preview.innerHTML = html
        }

        // 应用AI结果到表单
        function applyAIResult() {
            const form = document.getElementById('addStockForm')

            if (aiExtractedData.name) form.querySelector('[name="name"]').value = aiExtractedData.name
            if (aiExtractedData.code) form.querySelector('[name="code"]').value = aiExtractedData.code
            if (aiExtractedData.batchNumber) form.querySelector('[name="batchNumber"]').value = aiExtractedData.batchNumber
            if (aiExtractedData.manufacturer) form.querySelector('[name="manufacturer"]').value = aiExtractedData.manufacturer
            if (aiExtractedData.storageCondition) form.querySelector('[name="storageCondition"]').value = aiExtractedData.storageCondition
            if (aiExtractedData.dilutionCondition) form.querySelector('[name="dilutionCondition"]').value = aiExtractedData.dilutionCondition
            if (aiExtractedData.expiryDate) form.querySelector('[name="expiryDate"]').value = aiExtractedData.expiryDate

            // 处理组分信息（支持混标）
            if (aiExtractedData.components && Array.isArray(aiExtractedData.components)) {
                fillComponentsWithAIData(aiExtractedData.components)
            } else if (aiExtractedData.concentration) {
                // 兼容旧格式：单标
                fillComponentsWithAIData([{
                    name: '',
                    value: aiExtractedData.concentration,
                    unit: aiExtractedData.unit || '',
                    uncertainty: aiExtractedData.uncertainty || ''
                }])
            }

            closeAIRecognizeModal()
            const isMixed = aiExtractedData.isMixedStandard || (aiExtractedData.components && aiExtractedData.components.length > 1)
            alert(`识别结果已填入表单${isMixed ? '（检测到混标，已自动添加' + aiExtractedData.components.length + '个组分）' : ''}，请核对后保存`)
        }

        // 使用AI数据填充组分表格
        function fillComponentsWithAIData(components) {
            const container = document.getElementById('componentsContainer')

            // 清除现有的组分行（保留表头）
            const rows = container.querySelectorAll('.component-row')
            rows.forEach(row => row.remove())

            // 为每个组分创建一行
            components.forEach((comp, index) => {
                const newRow = document.createElement('div')
                newRow.className = 'component-row grid grid-cols-12 gap-2'
                newRow.innerHTML = `
                    <div class="col-span-3">
                        <input type="text" name="componentName[]" class="form-input text-sm py-1" placeholder="如：铜" value="${comp.name || ''}">
                    </div>
                    <div class="col-span-3">
                        <input type="text" name="componentValue[]" class="form-input text-sm py-1" placeholder="如：100" value="${comp.value || comp.concentration || ''}">
                    </div>
                    <div class="col-span-3">
                        <input type="text" name="componentUnit[]" class="form-input text-sm py-1" placeholder="如：μg/mL" value="${comp.unit || ''}">
                    </div>
                    <div class="col-span-2">
                        <input type="text" name="componentUncertainty[]" class="form-input text-sm py-1" placeholder="如：0.5%" value="${comp.uncertainty || ''}">
                    </div>
                    <div class="col-span-1 flex items-center justify-center">
                        <button type="button" onclick="removeComponentRow(this)" class="text-red-500 hover:text-red-700 ${index === 0 ? 'hidden' : ''}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `
                container.appendChild(newRow)
            })

            updateRemoveButtons()
        }

        // ==================== 设置功能 ====================
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show')
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show')
            document.getElementById('changePasswordForm').reset()
        }

        async function handleChangePassword(e) {
            e.preventDefault()
            showLoading(true)
            
            const newPassword = e.target.newPassword.value
            const confirmPassword = e.target.confirmPassword.value
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的密码不一致！')
                showLoading(false)
                return
            }
            
            try {
                if (isOfflineMode) {
                    // 离线模式更新密码
                    let personnel = LocalStorage.get('personnel') || []
                    const user = personnel.find(p => p.id == currentUser.id)
                    if (user) {
                        user.password = newPassword
                        LocalStorage.set('personnel', personnel)
                        currentUser.password = newPassword
                        LocalStorage.set('currentUser', currentUser)
                    }
                } else {
                    const { error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    })
                    if (error) throw error
                }
                
                closeChangePasswordModal()
                alert('密码修改成功！')
            } catch (error) {
                alert('修改失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // ==================== Excel导出 ====================
        async function exportData() {
            showLoading(true)
            console.log('【导出数据】开始导出...')
            const startTime = Date.now()
            
            try {
                let stock = []
                let records = []
                let personnel = []
                
                if (isOfflineMode) {
                    console.log('【导出数据】离线模式，从本地存储读取')
                    stock = LocalStorage.get('stock') || []
                    records = LocalStorage.get('records') || []
                    personnel = LocalStorage.get('personnel') || []
                } else {
                    console.log('【导出数据】在线模式，优先使用缓存数据')
                    
                    // 优先使用全局缓存数据，避免网络请求
                    stock = globalStockData || []
                    records = globalRecordsData || []
                    personnel = globalPersonnelData || []
                    
                    // 如果缓存为空，才从Supabase获取
                    const fetchPromises = []
                    
                    if (stock.length === 0) {
                        console.log('【导出数据】库存缓存为空，从Supabase获取')
                        fetchPromises.push(
                            supabaseClient.from('stock_items').select('*')
                                .then(({ data }) => { stock = data || []; return null })
                        )
                    } else {
                        console.log('【导出数据】使用库存缓存，数量:', stock.length)
                        fetchPromises.push(Promise.resolve(null))
                    }
                    
                    if (records.length === 0) {
                        console.log('【导出数据】记录缓存为空，从Supabase获取（限制1000条）')
                        fetchPromises.push(
                            supabaseClient.from('operation_records')
                                .select('*')
                                .order('created_at', { ascending: false })
                                .limit(1000)  // 限制记录数量，避免数据过大
                                .then(({ data }) => { records = data || []; return null })
                        )
                    } else {
                        console.log('【导出数据】使用记录缓存，数量:', records.length)
                        fetchPromises.push(Promise.resolve(null))
                    }
                    
                    if (personnel.length === 0) {
                        console.log('【导出数据】人员缓存为空，从Supabase获取')
                        fetchPromises.push(
                            supabaseClient.from('profiles').select('*')
                                .then(({ data }) => { personnel = data || []; return null })
                        )
                    } else {
                        console.log('【导出数据】使用人员缓存，数量:', personnel.length)
                        fetchPromises.push(Promise.resolve(null))
                    }
                    
                    await Promise.all(fetchPromises)
                }
                
                console.log('【导出数据】数据准备完成，开始生成Excel...')
                console.log('【导出数据】库存:', stock.length, '条，记录:', records.length, '条，人员:', personnel.length, '条')
                
                const wb = XLSX.utils.book_new()
                
                // 库存数据
                const stockData = stock.map(item => ({
                    '标准物质名称': item.name,
                    '编号': item.code,
                    '批次号': item.batch_number || item.batchNumber,
                    '唯一标识': item.unique_id || item.uniqueId,
                    '数量': item.quantity,
                    '有效期': item.expiry_date || item.expiryDate,
                    '状态': item.status
                }))
                
                const stockWS = XLSX.utils.json_to_sheet(stockData)
                XLSX.utils.book_append_sheet(wb, stockWS, "库存数据")
                
                // 记录数据
                const recordsData = records.map(r => ({
                    '类型': r.type === 'in' ? '入库' : '出库',
                    '物质名称': r.material_name || r.materialName,
                    '数量': r.quantity,
                    '操作人': r.operator_name || r.operator,
                    '时间': new Date(r.created_at || r.date).toLocaleString('zh-CN'),
                    '备注': r.note
                }))
                
                const recordsWS = XLSX.utils.json_to_sheet(recordsData)
                XLSX.utils.book_append_sheet(wb, recordsWS, "操作记录")
                
                // 人员数据
                const personnelData = personnel.map(p => ({
                    '姓名': p.name,
                    '邮箱': p.email,
                    '角色': p.role === 'admin' ? '管理员' : (p.role === 'chemist' ? '化验员' : '普通用户'),
                    '创建时间': p.created_at ? new Date(p.created_at).toLocaleString('zh-CN') : ''
                }))
                
                const personnelWS = XLSX.utils.json_to_sheet(personnelData)
                XLSX.utils.book_append_sheet(wb, personnelWS, "人员数据")
                
                console.log('【导出数据】Excel生成完成，开始下载...')
                
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' })
                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' })
                const link = document.createElement('a')
                link.href = URL.createObjectURL(blob)
                link.download = `标准物质管理数据_${new Date().toISOString().slice(0, 10)}.xlsx`
                link.click()
                
                const endTime = Date.now()
                console.log(`【导出数据】导出成功，耗时: ${endTime - startTime}ms`)
                showToast('数据导出成功', 'success')
            } catch (error) {
                console.error('【导出数据】导出失败:', error)
                showToast('导出失败: ' + error.message, 'error')
            } finally {
                showLoading(false)
            }
        }

        function s2ab(s) {
            const buf = new ArrayBuffer(s.length)
            const view = new Uint8Array(buf)
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF
            return buf
        }

        // ==================== Excel导入 ====================
        function importData() {
            const input = document.createElement('input')
            input.type = 'file'
            input.accept = '.xlsx,.xls'
            input.onchange = async (e) => {
                const file = e.target.files[0]
                if (!file) return
                
                showLoading(true)
                try {
                    const data = await file.arrayBuffer()
                    const workbook = XLSX.read(data, { type: 'array' })
                    
                    let importCount = 0
                    
                    // 导入库存数据
                    const stockSheet = workbook.Sheets['库存数据']
                    if (stockSheet) {
                        const stockData = XLSX.utils.sheet_to_json(stockSheet)
                        const formattedStock = stockData.map(row => ({
                            id: generateId(),
                            name: row['标准物质名称'] || '',
                            code: row['编号'] || '',
                            batch_number: row['批次号'] || '',
                            unique_id: row['唯一标识'] || '',
                            quantity: parseInt(row['数量']) || 0,
                            expiry_date: row['有效期'] || '',
                            status: row['状态'] || '正常',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }))
                        
                        if (isOfflineMode) {
                            const existing = LocalStorage.get('stock') || []
                            LocalStorage.set('stock', [...existing, ...formattedStock])
                        } else {
                            // 在线模式：批量插入到Supabase
                            for (const item of formattedStock) {
                                await supabaseClient.from('stock_items').insert([item])
                            }
                        }
                        importCount += formattedStock.length
                    }
                    
                    // 导入记录数据
                    const recordsSheet = workbook.Sheets['操作记录']
                    if (recordsSheet) {
                        const recordsData = XLSX.utils.sheet_to_json(recordsSheet)
                        const formattedRecords = recordsData.map(row => ({
                            id: generateId(),
                            type: row['类型'] === '入库' ? 'in' : 'out',
                            material_name: row['物质名称'] || '',
                            quantity: parseInt(row['数量']) || 0,
                            operator_name: row['操作人'] || '',
                            note: row['备注'] || '',
                            created_at: new Date().toISOString()
                        }))
                        
                        if (isOfflineMode) {
                            const existing = LocalStorage.get('records') || []
                            LocalStorage.set('records', [...existing, ...formattedRecords])
                        } else {
                            // 在线模式：批量插入到Supabase
                            for (const record of formattedRecords) {
                                await supabaseClient.from('operation_records').insert([record])
                            }
                        }
                        importCount += formattedRecords.length
                    }
                    
                    showToast(`成功导入 ${importCount} 条数据`, 'success')
                    
                    // 刷新页面数据
                    if (typeof loadDashboardData === 'function') loadDashboardData()
                    if (typeof loadStockData === 'function') loadStockData()
                    if (typeof loadRecordsData === 'function') loadRecordsData()
                    
                } catch (error) {
                    console.error('导入失败:', error)
                    showToast('导入失败: ' + error.message, 'error')
                } finally {
                    showLoading(false)
                }
            }
            input.click()
        }

        // ==================== 离线模式切换 ====================
        function toggleOfflineMode() {
            // 切换离线模式状态
            isOfflineMode = !isOfflineMode
            LocalStorage.set('offlineMode', isOfflineMode)
            
            const status = document.getElementById('offlineStatus')
            if (status) status.textContent = isOfflineMode ? '当前: 离线' : '当前: 在线'
            
            if (isOfflineMode) {
                // 切换到离线模式，初始化本地数据
                if (!LocalStorage.get('personnel')) {
                    LocalStorage.set('personnel', [
                        { id: '1', name: '系统管理员', username: 'admin@example.com', password: 'admin123', role: 'admin' }
                    ])
                }
                alert('已切换到离线模式，数据将保存在本地')
            } else {
                alert('已切换到在线模式，请重新登录')
                location.reload()
            }
        }

        // ==================== 数据管理 ====================
        function clearAllData() {
            if (!confirm('确定要清空所有数据吗？此操作不可恢复！')) return
            
            if (isOfflineMode) {
                LocalStorage.set('stock', [])
                LocalStorage.set('records', [])
                LocalStorage.set('messages', [])
            } else {
                alert('在线模式下无法一键清空，请使用Supabase Dashboard')
                return
            }
            
            refreshAllData()
            alert('所有数据已清空！')
        }

        // ==================== 实时订阅 ====================
        function setupRealtimeSubscriptions() {
            try {
                // 订阅库存变化
                supabaseClient
                    .channel('stock_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'stock_items' },
                        (payload) => {
                            console.log('库存变化:', payload)
                            refreshDashboard()
                            renderStockList()
                        }
                    )
                    .subscribe()
            } catch (error) {
                console.error('设置实时订阅失败:', error)
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body })
            }
        }

        // 更新最近临期预警显示（在统计卡片中）
        function updateNearestExpiryWarning(warningItems) {
            const nameElement = document.getElementById('nearestExpiryName')
            const countElement = document.getElementById('expiryWarning')
            const iconElement = document.getElementById('warningTriangleIcon')
            
            if (warningItems.length > 0) {
                // 按过期日期排序，找出最近要过期的
                warningItems.sort((a, b) => {
                    const dateA = new Date(a.expiry_date || a.expiryDate)
                    const dateB = new Date(b.expiry_date || b.expiryDate)
                    return dateA - dateB
                })
                
                // 获取最近要过期的标准物质
                const nearestItem = warningItems[0]
                const nearestExpiryName = nearestItem.name
                const nearestExpiryDate = new Date(nearestItem.expiry_date || nearestItem.expiryDate)
                
                // 计算剩余天数
                const today = new Date()
                today.setHours(0, 0, 0, 0)
                nearestExpiryDate.setHours(0, 0, 0, 0)
                const daysRemaining = Math.ceil((nearestExpiryDate - today) / (1000 * 60 * 60 * 24))
                
                // 统计该标准物质的即将过期数量
                const nameCount = warningItems.filter(item => item.name === nearestExpiryName)
                    .reduce((sum, item) => sum + (item.quantity || 0), 0)
                
                // 更新显示：名称+剩余天数显示在上方，数量显示在下方
                nameElement.textContent = `${nearestExpiryName} · 剩余${daysRemaining}天过期`
                countElement.textContent = nameCount
                
                // 添加闪烁动画到三角叹号
                iconElement.classList.add('blink-animation')
            } else {
                // 没有预警时恢复默认显示
                nameElement.textContent = '近效期预警'
                countElement.textContent = '0'
                iconElement.classList.remove('blink-animation')
            }
        }

        // ==================== 通用功能 ====================
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay')
            if (show) overlay.classList.add('show')
            else overlay.classList.remove('show')
        }

        // Toast提示函数
        function showToast(message, type = 'info') {
            console.log(`[Toast-${type}] ${message}`)
            
            // 创建toast元素
            const toast = document.createElement('div')
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'
            
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in`
            toast.innerHTML = `<i class="fa ${icon}"></i><span>${message}</span>`
            
            document.body.appendChild(toast)
            
            // 3秒后自动移除
            setTimeout(() => {
                toast.style.opacity = '0'
                toast.style.transition = 'opacity 0.5s'
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast)
                    }
                }, 500)
            }, 3000)
        }

        function closeModalOnBg(event, modalId) {
            if (event.target.id === modalId) {
                document.getElementById(modalId).classList.remove('show')
            }
        }

        // 网络诊断函数
        async function testConnection() {
            const diagnosticDiv = document.getElementById('diagnosticInfo')
            const statusDiv = document.getElementById('connectionStatus')
            
            diagnosticDiv.classList.remove('hidden')
            diagnosticDiv.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 正在诊断...'
            
            const results = []
            
            // 1. 检查浏览器在线状态
            results.push(`浏览器在线状态: ${navigator.onLine ? '✅ 在线' : '❌ 离线'}`)
            
            // 2. 检查Supabase连接
            try {
                const start = Date.now()
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    method: 'HEAD',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY
                    }
                })
                const latency = Date.now() - start
                results.push(`Supabase连接: ${response.ok ? '✅ 正常' : '❌ 失败'} (${latency}ms)`)
                results.push(`HTTP状态: ${response.status}`)
            } catch (err) {
                results.push(`Supabase连接: ❌ 失败`)
                results.push(`错误: ${err.message}`)
            }
            
            // 3. 检查当前页面信息
            results.push(`当前域名: ${window.location.hostname}`)
            results.push(`协议: ${window.location.protocol}`)
            results.push(`用户代理: ${navigator.userAgent.substring(0, 50)}...`)
            
            // 4. 检查Supabase客户端状态
            results.push(`Supabase客户端: ${supabaseClient ? '✅ 已初始化' : '❌ 未初始化'}`)
            
            // 5. 测试profiles表查询
            if (supabaseClient) {
                try {
                    const { data, error, count } = await supabaseClient
                        .from('profiles')
                        .select('*', { count: 'exact' })
                    
                    if (error) {
                        results.push(`Profiles表查询: ❌ 失败 - ${error.message}`)
                    } else {
                        results.push(`Profiles表查询: ✅ 成功 (${data?.length || 0}条记录)`)
                        results.push(`当前用户ID: ${currentUser?.id || '未登录'}`)
                        results.push(`用户角色: ${currentUser?.role || '未知'}`)
                    }
                } catch (err) {
                    results.push(`Profiles表查询: ❌ 异常 - ${err.message}`)
                }
            }
            
            diagnosticDiv.innerHTML = results.join('<br>')
            statusDiv.textContent = '诊断完成'
        }
        
        // 切换到离线模式
        function switchToOfflineMode() {
            console.log('【用户操作】切换到离线模式')
            isOfflineMode = true
            LocalStorage.set('offlineMode', true)
            
            // 检查本地是否有用户数据
            const offlineUser = LocalStorage.get('currentUser')
            if (offlineUser) {
                currentUser = offlineUser
                showApp()
                showToast('已进入离线模式', 'success')
            } else {
                // 创建默认离线用户
                const defaultUser = {
                    id: 'offline_' + Date.now(),
                    name: '离线用户',
                    username: 'offline@local.com',
                    role: 'admin'
                }
                currentUser = defaultUser
                LocalStorage.set('currentUser', defaultUser)
                showApp()
                showToast('已进入离线模式（默认用户）', 'success')
            }
        }
        
        // 自动切换到离线模式（网络请求失败时调用）
        function autoSwitchToOfflineMode(errorMessage) {
            console.log('【自动切换】网络请求失败，准备切换到离线模式:', errorMessage)
            
            // 检查是否已经加载了本地数据
            const localStock = LocalStorage.get('stock') || []
            const localRecords = LocalStorage.get('records') || []
            const localPersonnel = LocalStorage.get('personnel') || []
            
            if (localStock.length > 0 || localRecords.length > 0) {
                // 有本地数据，切换到离线模式
                isOfflineMode = true
                LocalStorage.set('offlineMode', true)
                
                // 使用本地数据
                globalStockData = localStock
                globalRecordsData = localRecords
                globalPersonnelData = localPersonnel
                
                // 检查本地用户
                const offlineUser = LocalStorage.get('currentUser')
                if (offlineUser) {
                    currentUser = offlineUser
                } else {
                    // 创建默认离线用户
                    currentUser = {
                        id: 'offline_' + Date.now(),
                        name: '离线用户',
                        username: 'offline@local.com',
                        role: 'admin'
                    }
                    LocalStorage.set('currentUser', currentUser)
                }
                
                showApp()
                showToast('网络连接失败，已自动切换到离线模式', 'warning')
                console.log('【自动切换】已切换到离线模式，使用本地数据')
            } else {
                // 没有本地数据，显示错误
                showToast('网络连接失败，且没有本地数据', 'error')
                console.log('【自动切换】无法切换到离线模式，没有本地数据')
            }
        }
        
        // 页面加载时检查连接状态
        window.addEventListener('load', () => {
            const statusDiv = document.getElementById('connectionStatus')
            if (statusDiv) {
                if (navigator.onLine) {
                    statusDiv.textContent = '网络连接正常'
                    statusDiv.className = 'text-xs text-green-600 mb-2 text-center'
                } else {
                    statusDiv.textContent = '当前处于离线状态'
                    statusDiv.className = 'text-xs text-orange-600 mb-2 text-center'
                }
            }
        })
        
        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show')
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('show')
            document.getElementById('registerForm').reset()
        }

        // ==================== 人员消息功能 ====================
        let currentMessageTab = 'received'
        let currentMessages = []
        let currentReplyMessageId = null

        // 切换消息标签
        function switchMessageTab(tab, element) {
            currentMessageTab = tab

            // 更新标签样式
            document.querySelectorAll('#messagesPage .tab-nav-item').forEach(item => {
                item.classList.remove('active')
            })
            element.classList.add('active')

            // 重新渲染消息列表
            renderMessagesList()
        }

        // 渲染消息列表
        async function renderMessagesList() {
            const container = document.getElementById('messagesList')

            if (isOfflineMode) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-wifi text-4xl mb-2 text-gray-400"></i>
                        <p>离线模式下无法查看消息</p>
                    </div>
                `
                return
            }

            // 检查currentUser是否存在
            if (!currentUser || !currentUser.id) {
                console.error('【renderMessagesList】currentUser未定义或没有id')
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-user-times text-4xl mb-2 text-red-500"></i>
                        <p>用户未登录，请重新登录</p>
                    </div>
                `
                return
            }

            try {
                showLoading(true)

                let query = supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })

                if (currentMessageTab === 'received') {
                    query = query.eq('recipient_id', currentUser.id)
                } else {
                    query = query.eq('sender_id', currentUser.id)
                }

                const { data: messages, error } = await query

                if (error) throw error

                currentMessages = messages || []

                if (currentMessages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fa fa-comments text-4xl mb-2"></i>
                            <p>暂无${currentMessageTab === 'received' ? '收到' : '发送'}的消息</p>
                        </div>
                    `
                    return
                }

                container.innerHTML = currentMessages.map(msg => {
                    const isUnread = currentMessageTab === 'received' && !msg.is_read
                    const senderName = msg.sender_name || '未知用户'
                    const recipientName = msg.recipient_name || '未知用户'
                    const displayName = currentMessageTab === 'received' ? senderName : `发给: ${recipientName}`
                    const time = new Date(msg.created_at).toLocaleString('zh-CN')
                    const preview = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '')

                    return `
                        <div class="message-item ${isUnread ? 'unread' : ''}" onclick="openMessageDetail('${msg.id}')">
                            <div class="message-item-header">
                                <span class="message-sender">
                                    ${escapeHtml(displayName)}
                                    ${isUnread ? '<span class="unread-dot"></span>' : ''}
                                </span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-preview">${escapeHtml(preview)}</div>
                        </div>
                    `
                }).join('')

            } catch (error) {
                console.error('加载消息失败:', error)
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-exclamation-circle text-4xl mb-2 text-red-500"></i>
                        <p>加载消息失败: ${error.message || '未知错误'}</p>
                    </div>
                `
            } finally {
                showLoading(false)
            }
        }

        // 显示发送消息模态框
        async function showSendMessageModal() {
            if (isOfflineMode) {
                alert('离线模式下无法发送消息')
                return
            }

            // 加载人员列表
            const recipientSelect = document.getElementById('messageRecipient')
            recipientSelect.innerHTML = '<option value="">选择接收人</option>'

            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('id, name')
                    .neq('id', currentUser.id)

                if (error) throw error

                users.forEach(user => {
                    const option = document.createElement('option')
                    option.value = user.id
                    option.textContent = user.name || '未命名用户'
                    recipientSelect.appendChild(option)
                })
            } catch (error) {
                console.error('加载人员列表失败:', error)
            }

            document.getElementById('sendMessageModal').classList.add('show')
        }

        function closeSendMessageModal() {
            document.getElementById('sendMessageModal').classList.remove('show')
            document.getElementById('sendMessageForm').reset()
        }

        // 处理发送消息
        async function handleSendMessage(event) {
            event.preventDefault()

            const formData = new FormData(event.target)
            const recipientId = formData.get('recipient_id')
            const content = formData.get('content')

            if (!recipientId || !content.trim()) {
                alert('请填写完整信息')
                return
            }

            try {
                showLoading(true)

                // 获取接收人名称
                const { data: recipient } = await supabaseClient
                    .from('profiles')
                    .select('name')
                    .eq('id', recipientId)
                    .single()

                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        sender_id: currentUser.id,
                        sender_name: currentUser.name || currentUser.email,
                        recipient_id: recipientId,
                        recipient_name: recipient?.name || '未知用户',
                        content: content.trim(),
                        is_read: false
                    }])

                if (error) throw error

                alert('消息发送成功！')
                closeSendMessageModal()

                // 如果当前在发送的消息标签页，刷新列表
                if (currentMessageTab === 'sent') {
                    renderMessagesList()
                }

            } catch (error) {
                console.error('发送消息失败:', error)
                alert('发送消息失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 打开消息详情
        async function openMessageDetail(messageId) {
            const message = currentMessages.find(m => m.id === messageId)
            if (!message) return

            currentReplyMessageId = messageId

            const isReceived = currentMessageTab === 'received'
            const senderName = message.sender_name || '未知用户'
            const recipientName = message.recipient_name || '未知用户'
            const time = new Date(message.created_at).toLocaleString('zh-CN')

            // 如果是收到的消息，标记为已读
            if (isReceived && !message.is_read) {
                try {
                    await supabaseClient
                        .from('messages')
                        .update({ is_read: true })
                        .eq('id', messageId)

                    message.is_read = true
                    renderMessagesList()
                    updateUnreadBadge()
                } catch (error) {
                    console.error('标记已读失败:', error)
                }
            }

            document.getElementById('messageDetailContent').innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-500 mb-2">
                        <span><strong>发送人:</strong> ${escapeHtml(senderName)}</span>
                        <span>${time}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500 mb-4">
                        <span><strong>接收人:</strong> ${escapeHtml(recipientName)}</span>
                        <span>${message.is_read ? '已读' : '未读'}</span>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="whitespace-pre-wrap">${escapeHtml(message.content)}</p>
                    </div>
                </div>
            `

            // 只有在收到的消息中才显示回复区域
            document.getElementById('messageReplySection').style.display = isReceived ? 'block' : 'none'
            document.getElementById('replyContent').value = ''

            document.getElementById('messageDetailModal').classList.add('show')
        }

        function closeMessageDetailModal() {
            document.getElementById('messageDetailModal').classList.remove('show')
            currentReplyMessageId = null
        }

        // 发送回复
        async function sendReply() {
            const content = document.getElementById('replyContent').value.trim()

            if (!content) {
                alert('请输入回复内容')
                return
            }

            if (!currentReplyMessageId) return

            const originalMessage = currentMessages.find(m => m.id === currentReplyMessageId)
            if (!originalMessage) return

            try {
                showLoading(true)

                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        sender_id: currentUser.id,
                        sender_name: currentUser.name || currentUser.email,
                        recipient_id: originalMessage.sender_id,
                        recipient_name: originalMessage.sender_name,
                        content: content,
                        is_read: false,
                        parent_id: currentReplyMessageId
                    }])

                if (error) throw error

                alert('回复发送成功！')
                closeMessageDetailModal()

                // 刷新消息列表
                if (currentMessageTab === 'sent') {
                    renderMessagesList()
                }

            } catch (error) {
                console.error('发送回复失败:', error)
                alert('发送回复失败: ' + error.message)
            } finally {
                showLoading(false)
            }
        }

        // 更新未读消息徽章
        async function updateUnreadBadge() {
            if (isOfflineMode || !currentUser) {
                document.getElementById('unreadBadge').classList.add('hidden')
                document.getElementById('messageNavIcon').classList.remove('message-blink')
                return
            }

            // 检查supabaseClient是否初始化
            if (!supabaseClient) {
                console.log('【更新未读徽章】supabaseClient未初始化')
                return
            }

            try {
                console.log('【更新未读徽章】查询用户ID:', currentUser.id)
                
                // 使用更简单的方式查询
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('id')
                    .eq('recipient_id', currentUser.id)
                    .eq('is_read', false)

                if (error) {
                    console.error('【更新未读徽章】查询错误:', error)
                    // 如果是400错误，可能是表不存在或权限问题
                    if (error.code === '400' || error.status === 400) {
                        console.log('【更新未读徽章】可能是messages表不存在或权限问题')
                        // 隐藏徽章，不显示错误
                        document.getElementById('unreadBadge').classList.add('hidden')
                        document.getElementById('messageNavIcon').classList.remove('message-blink')
                        return
                    }
                    throw error
                }

                const count = data ? data.length : 0
                console.log('【更新未读徽章】未读消息数:', count)

                const badge = document.getElementById('unreadBadge')
                const icon = document.getElementById('messageNavIcon')

                if (count && count > 0) {
                    badge.textContent = count > 99 ? '99+' : count
                    badge.classList.remove('hidden')
                    icon.classList.add('message-blink')
                } else {
                    badge.classList.add('hidden')
                    icon.classList.remove('message-blink')
                }

            } catch (error) {
                console.error('【更新未读徽章】失败:', error)
                // 出错时隐藏徽章，不影响用户体验
                document.getElementById('unreadBadge').classList.add('hidden')
                document.getElementById('messageNavIcon').classList.remove('message-blink')
            }
        }

        // 启动消息轮询
        let messagePollingInterval = null

        function startMessagePolling() {
            // 立即更新一次
            updateUnreadBadge()

            // 每30秒轮询一次
            messagePollingInterval = setInterval(() => {
                updateUnreadBadge()
            }, 30000)
        }

        function stopMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval)
                messagePollingInterval = null
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }

        function previewImages(input, previewId) {
            const preview = document.getElementById(previewId)
            const placeholder = preview.nextElementSibling
            
            if (input.files.length > 3) {
                alert('最多只能上传3张图片')
                input.value = ''
                return
            }
            
            preview.innerHTML = ''
            preview.classList.remove('hidden')
            placeholder.classList.add('hidden')
            
            Array.from(input.files).forEach((file) => {
                const reader = new FileReader()
                reader.onload = function(e) {
                    preview.innerHTML += `
                        <div class="image-preview-item">
                            <img src="${e.target.result}" alt="">
                            <button type="button" onclick="this.parentElement.remove(); checkPreviewEmpty('${previewId}')" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    `
                }
                reader.readAsDataURL(file)
            })
        }

        // 处理入库表单图片/PDF上传
        async function handleStockImagesWithPDF(input, previewId, placeholderId) {
            const preview = document.getElementById(previewId)
            const placeholder = document.getElementById(placeholderId)
            
            if (input.files.length > 3) {
                alert('最多只能上传3个文件')
                input.value = ''
                return
            }
            
            preview.innerHTML = ''
            preview.classList.remove('hidden')
            placeholder.classList.add('hidden')
            
            let fileCount = 0
            
            for (const file of Array.from(input.files)) {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // 处理PDF文件
                    try {
                        console.log('开始解析PDF:', file.name, '大小:', file.size, '类型:', file.type)
                        
                        if (file.size === 0) {
                            throw new Error('PDF文件为空')
                        }
                        
                        const pdfData = await file.arrayBuffer()
                        console.log('PDF数据读取成功, 大小:', pdfData.byteLength)
                        
                        if (pdfData.byteLength === 0) {
                            throw new Error('PDF数据为空')
                        }
                        
                        // 检查PDF文件头
                        const header = new Uint8Array(pdfData.slice(0, 5))
                        const headerStr = String.fromCharCode(...header)
                        console.log('PDF文件头:', headerStr)
                        
                        // 检查pdfjsLib是否可用
                        if (typeof pdfjsLib === 'undefined') {
                            throw new Error('PDF.js库未加载，无法解析PDF文件')
                        }
                        
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise
                        console.log('PDF解析成功, 总页数:', pdf.numPages)
                        
                        // 只提取PDF第一页作为预览
                        const page = await pdf.getPage(1)
                        const scale = 1.5
                        const viewport = page.getViewport({ scale })
                        
                        const canvas = document.createElement('canvas')
                        const ctx = canvas.getContext('2d')
                        canvas.width = viewport.width
                        canvas.height = viewport.height
                        
                        await page.render({
                            canvasContext: ctx,
                            viewport: viewport
                        }).promise
                        
                        const imageData = canvas.toDataURL('image/jpeg', 0.9)
                        console.log('PDF转换成功，图片数据长度:', imageData.length)
                        
                        // 创建PDF预览URL（用于点击查看完整PDF）
                        const pdfObjectUrl = URL.createObjectURL(file)
                        
                        // 创建预览元素
                        const previewDiv = document.createElement('div')
                        previewDiv.className = 'image-preview-item relative cursor-pointer'
                        previewDiv.title = `点击预览完整PDF: ${file.name} (${pdf.numPages}页)`
                        previewDiv.innerHTML = `
                            <img src="${imageData}" alt="PDF预览" 
                                 onload="console.log('PDF预览图片加载成功')" 
                                 onerror="console.error('PDF预览图片加载失败')"
                                 onclick="viewPDF('${pdfObjectUrl}', '${file.name}')">
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 text-center"
                                 onclick="viewPDF('${pdfObjectUrl}', '${file.name}')">
                                <i class="fa fa-file-pdf-o"></i> ${file.name.substring(0, 15)}... (${pdf.numPages}页)
                            </div>
                            <button type="button" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs pdf-remove-btn">
                                <i class="fa fa-times"></i>
                            </button>
                        `
                        // 使用事件监听器而不是onclick
                        previewDiv.querySelector('.pdf-remove-btn').addEventListener('click', function(e) {
                            e.stopPropagation()
                            previewDiv.remove()
                            checkPreviewEmpty(previewId)
                        })
                        
                        preview.appendChild(previewDiv)
                        fileCount++
                    } catch (error) {
                        console.error('PDF解析失败:', error)
                        console.error('错误详情:', error.message, error.stack)
                        alert(`PDF文件 "${file.name}" 解析失败: ${error.message}`)
                    }
                } else {
                    // 处理图片文件
                    const reader = new FileReader()
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div')
                        previewDiv.className = 'image-preview-item relative'
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="">
                            <button type="button" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs img-remove-btn">
                                <i class="fa fa-times"></i>
                            </button>
                        `
                        previewDiv.querySelector('.img-remove-btn').addEventListener('click', function() {
                            previewDiv.remove()
                            checkPreviewEmpty(previewId)
                        })
                        preview.appendChild(previewDiv)
                    }
                    reader.readAsDataURL(file)
                    fileCount++
                }
            }
        }

        function checkPreviewEmpty(previewId) {
            const preview = document.getElementById(previewId)
            const placeholder = preview.nextElementSibling
            if (preview.children.length === 0) {
                preview.classList.add('hidden')
                placeholder.classList.remove('hidden')
            }
        }

        function viewImage(imageData, caption) {
            const viewerImage = document.getElementById('viewerImage')
            const viewerCaption = document.getElementById('viewerCaption')
            
            // 显示加载中
            viewerImage.style.opacity = '0.5'
            viewerCaption.textContent = caption + ' (加载中...)'
            document.getElementById('imageViewerModal').classList.add('show')
            
            // 创建新图片对象预加载
            const img = new Image()
            img.onload = function() {
                viewerImage.src = imageData
                viewerImage.style.opacity = '1'
                viewerCaption.textContent = caption
            }
            img.onerror = function() {
                viewerImage.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="400" height="300" fill="%23f0f0f0"/><text x="200" y="150" text-anchor="middle" font-size="16" fill="%23999">图片加载失败</text></svg>'
                viewerImage.style.opacity = '1'
                viewerCaption.textContent = caption + ' (加载失败)'
                console.error('图片加载失败:', imageData.substring(0, 100) + '...')
            }
            img.src = imageData
        }

        // 查看附件（统一处理图片和PDF）
        function viewAttachment(uniqueId) {
            const attachment = window.tempAttachments && window.tempAttachments[uniqueId]
            if (!attachment) {
                alert('附件数据不存在')
                return
            }
            
            console.log('查看附件:', attachment.name, '类型:', attachment.isPDF ? 'PDF' : '图片')
            
            if (attachment.isPDF) {
                viewPDF(attachment.url, attachment.name)
            } else {
                viewImage(attachment.url, attachment.name)
            }
        }

        // 查看PDF预览
        function viewPDF(pdfUrl, caption) {
            console.log('查看PDF:', pdfUrl ? pdfUrl.substring(0, 100) + '...' : '空')
            if (!pdfUrl) {
                alert('PDF链接为空')
                return
            }
            
            // 检查是否是Base64格式的PDF
            if (pdfUrl.startsWith('data:application/pdf')) {
                console.log('Base64 PDF，直接打开')
            } else if (pdfUrl.startsWith('data:image')) {
                console.error('错误：这是图片数据，不是PDF')
                alert('文件格式错误，这是图片不是PDF')
                return
            } else if (pdfUrl.startsWith('blob:')) {
                console.log('Blob URL，直接打开')
            } else if (pdfUrl.startsWith('http')) {
                console.log('HTTP URL，直接打开')
            } else {
                console.warn('未知的PDF格式:', pdfUrl.substring(0, 50))
            }
            
            // 直接使用浏览器内置的PDF查看器
            const newWindow = window.open(pdfUrl, '_blank')
            if (!newWindow) {
                alert('请允许打开新窗口以查看PDF')
            }
        }

        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.remove('show')
        }
    </script>
</body>
</html>